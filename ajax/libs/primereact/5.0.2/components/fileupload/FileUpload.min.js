"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.FileUpload=void 0;var _react=_interopRequireWildcard(require("react")),_propTypes=_interopRequireDefault(require("prop-types")),_Button=require("../button/Button"),_Messages=require("../messages/Messages"),_ProgressBar=require("../progressbar/ProgressBar"),_DomHandler=_interopRequireDefault(require("../utils/DomHandler")),_ClassNames=require("../utils/ClassNames"),_Ripple=require("../ripple/Ripple"),_ObjectUtils=_interopRequireDefault(require("../utils/ObjectUtils"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return _getRequireWildcardCache=function(){return e},e}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache();if(t&&t.has(e))return t.get(e);var r,a,o={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(r in e)Object.prototype.hasOwnProperty.call(e,r)&&((a=i?Object.getOwnPropertyDescriptor(e,r):null)&&(a.get||a.set)?Object.defineProperty(o,r,a):o[r]=e[r]);return o.default=e,t&&t.set(e,o),o}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _createForOfIteratorHelper(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var a=0,t=function(){};return{s:t,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:t}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,n=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return i=e.done,e},e:function(e){n=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(n)throw o}}}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,a=new Array(t);r<t;r++)a[r]=e[r];return a}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(r){var a=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(r);return _possibleConstructorReturn(this,a?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var FileUpload=function(){_inherits(r,_react.Component);var t=_createSuper(r);function r(e){return _classCallCheck(this,r),(e=t.call(this,e)).state={files:[],msgs:[],focused:!1},e.choose=e.choose.bind(_assertThisInitialized(e)),e.upload=e.upload.bind(_assertThisInitialized(e)),e.clear=e.clear.bind(_assertThisInitialized(e)),e.onFileSelect=e.onFileSelect.bind(_assertThisInitialized(e)),e.onDragEnter=e.onDragEnter.bind(_assertThisInitialized(e)),e.onDragOver=e.onDragOver.bind(_assertThisInitialized(e)),e.onDragLeave=e.onDragLeave.bind(_assertThisInitialized(e)),e.onDrop=e.onDrop.bind(_assertThisInitialized(e)),e.onKeyDown=e.onKeyDown.bind(_assertThisInitialized(e)),e.onFocus=e.onFocus.bind(_assertThisInitialized(e)),e.onBlur=e.onBlur.bind(_assertThisInitialized(e)),e.onSimpleUploaderClick=e.onSimpleUploaderClick.bind(_assertThisInitialized(e)),e.duplicateIEEvent=!1,e}return _createClass(r,[{key:"hasFiles",value:function(){return this.state.files&&0<this.state.files.length}},{key:"isImage",value:function(e){return/^image\//.test(e.type)}},{key:"chooseDisabled",value:function(){return this.props.disabled||this.props.fileLimit&&this.props.fileLimit<=this.state.files.length+this.uploadedFileCount}},{key:"uploadDisabled",value:function(){return this.props.disabled||!this.hasFiles()}},{key:"cancelDisabled",value:function(){return this.props.disabled||!this.hasFiles()}},{key:"remove",value:function(e,t){this.clearInputElement();var r=_toConsumableArray(this.state.files),a=this.state.files[t];r.splice(t,1),this.setState({files:r}),this.props.onRemove&&this.props.onRemove({originalEvent:e,file:a})}},{key:"clearInputElement",value:function(){this.fileInput.value=""}},{key:"clearIEInput",value:function(){this.fileInput&&(this.duplicateIEEvent=!0,this.fileInput.value="")}},{key:"formatSize",value:function(e){if(0===e)return"0 B";var t=Math.floor(Math.log(e)/Math.log(1e3));return parseFloat((e/Math.pow(1e3,t)).toFixed(3))+" "+["B","KB","MB","GB","TB","PB","EB","ZB","YB"][t]}},{key:"onFileSelect",value:function(e){var t=this;if("drop"!==e.type&&this.isIE11()&&this.duplicateIEEvent)this.duplicateIEEvent=!1;else{this.setState({msgs:[]}),this.files=this.state.files||[];for(var r=(e.dataTransfer||e.target).files,a=0;a<r.length;a++){var o=r[a];this.isFileSelected(o)||this.validate(o)&&(this.isImage(o)&&(o.objectURL=window.URL.createObjectURL(o)),this.files.push(o))}this.setState({files:this.files},function(){t.hasFiles()&&t.props.auto&&t.upload()}),this.props.onSelect&&this.props.onSelect({originalEvent:e,files:r}),"drop"!==e.type&&this.isIE11()?this.clearIEInput():this.clearInputElement(),"basic"===this.props.mode&&0<this.files.length&&(this.fileInput.style.display="none")}}},{key:"isFileSelected",value:function(e){var t=_createForOfIteratorHelper(this.state.files);try{for(t.s();!(r=t.n()).done;){var r=r.value;if(r.name+r.type+r.size===e.name+e.type+e.size)return!0}}catch(e){t.e(e)}finally{t.f()}return!1}},{key:"isIE11",value:function(){return!!window.MSInputMethodContext&&!!document.documentMode}},{key:"validate",value:function(e){if(this.props.maxFileSize&&e.size>this.props.maxFileSize){var t={severity:"error",summary:this.props.invalidFileSizeMessageSummary.replace("{0}",e.name),detail:this.props.invalidFileSizeMessageDetail.replace("{0}",this.formatSize(this.props.maxFileSize))};return"advanced"===this.props.mode&&this.messagesUI.show(t),this.props.onValidationFail&&this.props.onValidationFail(e),!1}return!0}},{key:"upload",value:function(){var t=this;if(this.props.customUpload)this.props.fileLimit&&(this.uploadedFileCount+=this.state.files.length),this.props.uploadHandler&&this.props.uploadHandler({files:this.state.files});else{this.setState({msgs:[]});var e=new XMLHttpRequest,r=new FormData;this.props.onBeforeUpload&&this.props.onBeforeUpload({xhr:e,formData:r});var a=_createForOfIteratorHelper(this.state.files);try{for(a.s();!(o=a.n()).done;){var o=o.value;r.append(this.props.name,o,o.name)}}catch(e){a.e(e)}finally{a.f()}e.upload.addEventListener("progress",function(e){e.lengthComputable&&t.setState({progress:Math.round(100*e.loaded/e.total)}),t.props.onProgress&&t.props.onProgress({originalEvent:e,progress:t.progress})}),e.onreadystatechange=function(){4===e.readyState&&(t.setState({progress:0}),200<=e.status&&e.status<300?(t.props.fileLimit&&(t.uploadedFileCount+=t.state.files.length),t.props.onUpload&&t.props.onUpload({xhr:e,files:t.state.files})):t.props.onError&&t.props.onError({xhr:e,files:t.state.files}),t.clear())},e.open("POST",this.props.url,!0),this.props.onBeforeSend&&this.props.onBeforeSend({xhr:e,formData:r}),e.withCredentials=this.props.withCredentials,e.send(r)}}},{key:"clear",value:function(){this.setState({files:[]}),this.props.onClear&&this.props.onClear(),this.clearInputElement()}},{key:"choose",value:function(){this.fileInput.click()}},{key:"onFocus",value:function(){this.setState({focused:!0})}},{key:"onBlur",value:function(){this.setState({focused:!1})}},{key:"onKeyDown",value:function(e){13===e.which&&this.choose()}},{key:"onDragEnter",value:function(e){this.props.disabled||(e.stopPropagation(),e.preventDefault())}},{key:"onDragOver",value:function(e){this.props.disabled||(_DomHandler.default.addClass(this.content,"p-fileupload-highlight"),e.stopPropagation(),e.preventDefault())}},{key:"onDragLeave",value:function(){this.props.disabled||_DomHandler.default.removeClass(this.content,"p-fileupload-highlight")}},{key:"onDrop",value:function(e){var t;this.props.disabled||(_DomHandler.default.removeClass(this.content,"p-fileupload-highlight"),e.stopPropagation(),e.preventDefault(),t=(e.dataTransfer||e.target).files,(this.props.multiple||t&&1===t.length)&&this.onFileSelect(e))}},{key:"onSimpleUploaderClick",value:function(){this.hasFiles()?this.upload():this.fileInput.click()}},{key:"renderChooseButton",value:function(){var t=this,e=(0,_ClassNames.classNames)("p-button p-fileupload-choose p-component",{"p-disabled":this.props.disabled,"p-focus":this.state.focused});return _react.default.createElement("span",{className:e,onClick:this.choose,onKeyDown:this.onKeyDown,onFocus:this.onFocus,onBlur:this.onBlur,tabIndex:0},_react.default.createElement("input",{ref:function(e){return t.fileInput=e},type:"file",onChange:this.onFileSelect,multiple:this.props.multiple,accept:this.props.accept,disabled:this.chooseDisabled()}),_react.default.createElement("span",{className:"p-button-icon p-button-icon-left p-clickable pi pi-fw pi-plus"}),_react.default.createElement("span",{className:"p-button-label p-clickable"},this.props.chooseLabel),_react.default.createElement(_Ripple.Ripple,null))}},{key:"renderFiles",value:function(){var n=this;return _react.default.createElement("div",{className:"p-fileupload-files"},this.state.files.map(function(e,t){var r=n.isImage(e)?_react.default.createElement("div",null,_react.default.createElement("img",{alt:e.name,role:"presentation",src:e.objectURL,width:n.props.previewWidth})):null,a=_react.default.createElement("div",null,e.name),o=_react.default.createElement("div",null,n.formatSize(e.size)),i=_react.default.createElement("div",null,_react.default.createElement(_Button.Button,{type:"button",icon:"pi pi-times",onClick:function(e){return n.remove(e,t)}}));return _react.default.createElement("div",{className:"p-fileupload-row",key:e.name+e.type+e.size},r,a,o,i)}))}},{key:"renderEmptyContent",value:function(){return this.props.emptyTemplate&&!this.hasFiles()?_ObjectUtils.default.getJSXElement(this.props.emptyTemplate,this.props):null}},{key:"renderAdvanced",value:function(){var e,t,r,a,o=this,i=(0,_ClassNames.classNames)("p-fileupload p-fileupload-advanced p-component",this.props.className),n=this.renderChooseButton(),s=this.renderEmptyContent();return this.props.auto||(e=_react.default.createElement(_Button.Button,{type:"button",label:this.props.uploadLabel,icon:"pi pi-upload",onClick:this.upload,disabled:this.uploadDisabled()}),t=_react.default.createElement(_Button.Button,{type:"button",label:this.props.cancelLabel,icon:"pi pi-times",onClick:this.clear,disabled:this.cancelDisabled()})),this.hasFiles()&&(r=this.renderFiles(),a=_react.default.createElement(_ProgressBar.ProgressBar,{value:this.state.progress,showValue:!1})),_react.default.createElement("div",{id:this.props.id,className:i,style:this.props.style},_react.default.createElement("div",{className:"p-fileupload-buttonbar"},n,e,t),_react.default.createElement("div",{ref:function(e){o.content=e},className:"p-fileupload-content",onDragEnter:this.onDragEnter,onDragOver:this.onDragOver,onDragLeave:this.onDragLeave,onDrop:this.onDrop},a,_react.default.createElement(_Messages.Messages,{ref:function(e){return o.messagesUI=e}}),r,s))}},{key:"renderBasic",value:function(){var t=this,e=(0,_ClassNames.classNames)("p-fileupload p-fileupload-basic p-component",this.props.className),r=(0,_ClassNames.classNames)("p-button p-component p-fileupload-choose",{"p-fileupload-choose-selected":this.hasFiles(),"p-disabled":this.props.disabled,"p-focus":this.state.focused}),a=(0,_ClassNames.classNames)("p-button-icon p-button-icon-left pi",{"pi-plus":!this.hasFiles()||this.props.auto,"pi-upload":this.hasFiles()&&!this.props.auto}),o=!this.props.auto&&this.hasFiles()?this.state.files[0].name:this.props.chooseLabel;return _react.default.createElement("div",{className:e},_react.default.createElement(_Messages.Messages,{ref:function(e){return t.messagesUI=e}}),_react.default.createElement("span",{className:r,onMouseUp:this.onSimpleUploaderClick,onKeyDown:this.onKeyDown,onFocus:this.onFocus,onBlur:this.onBlur,tabIndex:0},_react.default.createElement("span",{className:a}),_react.default.createElement("span",{className:"p-button-label p-clickable"},o),!this.hasFiles()&&_react.default.createElement("input",{ref:function(e){return t.fileInput=e},type:"file",accept:this.props.accept,disabled:this.props.disabled,onChange:this.onFileSelect}),_react.default.createElement(_Ripple.Ripple,null)))}},{key:"render",value:function(){return"advanced"===this.props.mode?this.renderAdvanced():"basic"===this.props.mode?this.renderBasic():void 0}}]),r}();_defineProperty(exports.FileUpload=FileUpload,"defaultProps",{id:null,name:null,url:null,mode:"advanced",multiple:!1,accept:null,disabled:!1,auto:!1,maxFileSize:null,invalidFileSizeMessageSummary:"{0}: Invalid file size, ",invalidFileSizeMessageDetail:"maximum upload size is {0}.",style:null,className:null,widthCredentials:!1,previewWidth:50,chooseLabel:"Choose",uploadLabel:"Upload",cancelLabel:"Cancel",customUpload:!1,emptyTemplate:null,onBeforeUpload:null,onBeforeSend:null,onUpload:null,onError:null,onClear:null,onSelect:null,onProgress:null,onValidationFail:null,uploadHandler:null,onRemove:null}),_defineProperty(FileUpload,"propTypes",{id:_propTypes.default.string,name:_propTypes.default.string,url:_propTypes.default.string,mode:_propTypes.default.string,multiple:_propTypes.default.bool,accept:_propTypes.default.string,disabled:_propTypes.default.bool,auto:_propTypes.default.bool,maxFileSize:_propTypes.default.number,invalidFileSizeMessageSummary:_propTypes.default.string,invalidFileSizeMessageDetail:_propTypes.default.string,style:_propTypes.default.object,className:_propTypes.default.string,widthCredentials:_propTypes.default.bool,previewWidth:_propTypes.default.number,chooseLabel:_propTypes.default.string,uploadLabel:_propTypes.default.string,cancelLabel:_propTypes.default.string,customUpload:_propTypes.default.bool,emptyTemplate:_propTypes.default.any,onBeforeUpload:_propTypes.default.func,onBeforeSend:_propTypes.default.func,onUpload:_propTypes.default.func,onError:_propTypes.default.func,onClear:_propTypes.default.func,onSelect:_propTypes.default.func,onProgress:_propTypes.default.func,onValidationFail:_propTypes.default.func,uploadHandler:_propTypes.default.func,onRemove:_propTypes.default.func});