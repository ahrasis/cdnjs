"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TableBody=void 0;var _react=_interopRequireWildcard(require("react")),_BodyRow=require("./BodyRow"),_DomHandler=_interopRequireDefault(require("../utils/DomHandler")),_ObjectUtils=_interopRequireDefault(require("../utils/ObjectUtils")),_RowTogglerButton=require("./RowTogglerButton");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return _getRequireWildcardCache=function(){return e},e}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache();if(t&&t.has(e))return t.get(e);var o,r,n={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(o in e)Object.prototype.hasOwnProperty.call(e,o)&&((r=i?Object.getOwnPropertyDescriptor(e,o):null)&&(r.get||r.set)?Object.defineProperty(n,o,r):n[o]=e[o]);return n.default=e,t&&t.set(e,n),n}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ownKeys(t,e){var o,r=Object.keys(t);return Object.getOwnPropertySymbols&&(o=Object.getOwnPropertySymbols(t),e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,o)),r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(o),!0).forEach(function(e){_defineProperty(t,e,o[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):ownKeys(Object(o)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))})}return t}function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,r=new Array(t);o<t;o++)r[o]=e[o];return r}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(o){var r=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(o);return _possibleConstructorReturn(this,r?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var TableBody=function(){_inherits(o,_react.Component);var t=_createSuper(o);function o(e){return _classCallCheck(this,o),(e=t.call(this,e)).onRowClick=e.onRowClick.bind(_assertThisInitialized(e)),e.onRowRightClick=e.onRowRightClick.bind(_assertThisInitialized(e)),e.onRowTouchEnd=e.onRowTouchEnd.bind(_assertThisInitialized(e)),e.onRowToggle=e.onRowToggle.bind(_assertThisInitialized(e)),e.onRadioClick=e.onRadioClick.bind(_assertThisInitialized(e)),e.onCheckboxClick=e.onCheckboxClick.bind(_assertThisInitialized(e)),e.onRowDragEnd=e.onRowDragEnd.bind(_assertThisInitialized(e)),e.onRowDragLeave=e.onRowDragLeave.bind(_assertThisInitialized(e)),e.onRowDrop=e.onRowDrop.bind(_assertThisInitialized(e)),e}return _createClass(o,[{key:"onRowClick",value:function(e){var t,o,r,n,i,a,s=e.originalEvent.target.nodeName;"INPUT"===s||"BUTTON"===s||"A"===s||_DomHandler.default.hasClass(e.originalEvent.target,"p-clickable")||(this.props.onRowClick&&this.props.onRowClick(e),this.props.selectionMode&&(t=e.data,o=e.index,this.isMultipleSelectionMode()&&e.originalEvent.shiftKey&&null!==this.anchorRowIndex?(_DomHandler.default.clearSelection(),this.rangeRowIndex=o,i=this.selectRange(e)):(r=this.isSelected(t),s=!this.rowTouched&&this.props.metaKeySelection,this.anchorRowIndex=o,this.rangeRowIndex=o,this.anchorRowFirst=this.props.first,s?(s=e.originalEvent.metaKey||e.originalEvent.ctrlKey,r&&s?(i=this.isSingleSelectionMode()?null:(n=this.findIndexInSelection(t),this.props.selection.filter(function(e,t){return t!==n})),this.props.onRowUnselect&&this.props.onRowUnselect({originalEvent:e.originalEvent,data:t,type:"row"})):(this.isSingleSelectionMode()?i=t:this.isMultipleSelectionMode()&&(i=s&&this.props.selection?_toConsumableArray(this.props.selection):[],i=[].concat(_toConsumableArray(i),[t])),this.props.onRowSelect&&this.props.onRowSelect({originalEvent:e.originalEvent,data:t,type:"row"}))):this.isSingleSelectionMode()?r?(i=null,this.props.onRowUnselect&&this.props.onRowUnselect({originalEvent:e.originalEvent,data:t,type:"row"})):(i=t,this.props.onRowSelect&&this.props.onRowSelect({originalEvent:e.originalEvent,data:t,type:"row"})):(i=r?(a=this.findIndexInSelection(t),this.props.selection.filter(function(e,t){return t!==a})):[].concat(_toConsumableArray(this.props.selection||[]),[t]),this.props.onRowSelect&&this.props.onRowSelect({originalEvent:e.originalEvent,data:t,type:"row"}))),this.props.onSelectionChange&&this.props.onSelectionChange({originalEvent:e.originalEvent,value:i})),this.rowTouched=!1)}},{key:"selectRange",value:function(e){var t,o,r=this.props.lazy&&this.props.paginator;r&&(this.anchorRowIndex+=this.anchorRowFirst,this.rangeRowIndex+=this.props.first),o=this.rangeRowIndex>this.anchorRowIndex?(t=this.anchorRowIndex,this.rangeRowIndex):this.rangeRowIndex<this.anchorRowIndex?(t=this.rangeRowIndex,this.anchorRowIndex):(t=this.rangeRowIndex,this.rangeRowIndex),r&&(t=Math.max(t-this.props.first,0),o-=this.props.first);for(var n=this.props.value,i=[],a=t;a<=o;a++){var s=n[a];i.push(s),this.props.onRowSelect&&this.props.onRowSelect({originalEvent:e.originalEvent,data:s,type:"row"})}return i}},{key:"onRowTouchEnd",value:function(){this.rowTouched=!0}},{key:"onRowRightClick",value:function(e){this.props.onContextMenu&&(_DomHandler.default.clearSelection(),this.props.onContextMenuSelectionChange&&this.props.onContextMenuSelectionChange({originalEvent:e.originalEvent,value:e.data}),this.props.onContextMenu&&this.props.onContextMenu({originalEvent:e.originalEvent,value:this.props.node}),e.originalEvent.preventDefault())}},{key:"onRadioClick",value:function(e){var t,o=e.data;this.isSelected(o)?(t=null,this.props.onRowUnselect&&this.props.onRowUnselect({originalEvent:e.originalEvent,data:o,type:"radio"})):(t=o,this.props.onRowSelect&&this.props.onRowSelect({originalEvent:e.originalEvent,data:o,type:"radio"})),this.props.onSelectionChange&&this.props.onSelectionChange({originalEvent:e.originalEvent,value:t})}},{key:"onCheckboxClick",value:function(e){var o,t,r=e.data;this.isSelected(r)?(o=this.findIndexInSelection(r),t=this.props.selection.filter(function(e,t){return t!==o}),this.props.onRowUnselect&&this.props.onRowUnselect({originalEvent:e.originalEvent,data:r,type:"checkbox"})):(t=[].concat(_toConsumableArray(this.props.selection||[]),[r]),this.props.onRowSelect&&this.props.onRowSelect({originalEvent:e.originalEvent,data:r,type:"checkbox"})),this.props.onSelectionChange&&this.props.onSelectionChange({originalEvent:e.originalEvent,value:t})}},{key:"isSingleSelectionMode",value:function(){return"single"===this.props.selectionMode}},{key:"isMultipleSelectionMode",value:function(){return"multiple"===this.props.selectionMode}},{key:"isSelected",value:function(e){return!(!e||!this.props.selection)&&(this.props.selection instanceof Array?-1<this.findIndexInSelection(e):this.equals(e,this.props.selection))}},{key:"isContextMenuSelected",value:function(e){return!(!e||!this.props.contextMenuSelection)&&this.equals(e,this.props.contextMenuSelection)}},{key:"equals",value:function(e,t){return"equals"===this.compareSelectionBy?e===t:_ObjectUtils.default.equals(e,t,this.props.dataKey)}},{key:"findIndexInSelection",value:function(e){var t=-1;if(this.props.selection)for(var o=0;o<this.props.selection.length;o++)if(this.equals(e,this.props.selection[o])){t=o;break}return t}},{key:"onRowToggle",value:function(e){var t,o,r=this.props.dataKey;r?(r=String(_ObjectUtils.default.resolveFieldData(e.data,r)),null!=(t=this.props.expandedRows?_objectSpread({},this.props.expandedRows):{})[r]?(delete t[r],this.props.onRowCollapse&&this.props.onRowCollapse({originalEvent:e,data:e.data})):(t[r]=!0,this.props.onRowExpand&&this.props.onRowExpand({originalEvent:e,data:e.data}))):(o=this.findExpandedRowIndex(e.data),t=this.props.expandedRows?_toConsumableArray(this.props.expandedRows):[],-1!==o?(t=t.filter(function(e,t){return t!==o}),this.props.onRowCollapse&&this.props.onRowCollapse({originalEvent:e,data:e.data})):(t.push(e.data),this.props.onRowExpand&&this.props.onRowExpand({originalEvent:e,data:e.data}))),this.props.onRowToggle&&this.props.onRowToggle({data:t})}},{key:"findExpandedRowIndex",value:function(e){var t=-1;if(this.props.expandedRows)for(var o=0;o<this.props.expandedRows.length;o++)if(_ObjectUtils.default.equals(this.props.expandedRows[o],e)){t=o;break}return t}},{key:"isRowExpanded",value:function(e){var t=this.props.dataKey;if(t){t=String(_ObjectUtils.default.resolveFieldData(e,t));return this.props.expandedRows&&null!=this.props.expandedRows[t]}return-1!==this.findExpandedRowIndex(e)}},{key:"isSelectionEnabled",value:function(){if(this.props.selectionMode||null!=this.props.frozenSelectionMode)return!0;if(!Array.isArray(this.props.children))return this.props.children&&null!=this.props.children.selectionMode;for(var e=0;e<this.props.children.length;e++)if(this.props.children[e].props.selectionMode)return!0;return!1}},{key:"onRowDragStart",value:function(e,t){this.rowDragging=!0,this.draggedRowIndex=t,e.dataTransfer.setData("text","b")}},{key:"onRowDragEnd",value:function(){this.rowDragging=!1,this.draggedRowIndex=null,this.droppedRowIndex=null}},{key:"onRowDragOver",value:function(e,t){var o,r,n;this.rowDragging&&this.draggedRowIndex!==t&&(o=e.rowElement,n=_DomHandler.default.getOffset(o).top+_DomHandler.default.getWindowScrollTop(),r=e.originalEvent.pageY,e=n+_DomHandler.default.getOuterHeight(o)/2,n=o.previousElementSibling,r<e?(_DomHandler.default.removeClass(o,"p-datatable-dragpoint-bottom"),this.droppedRowIndex=t,n?_DomHandler.default.addClass(n,"p-datatable-dragpoint-bottom"):_DomHandler.default.addClass(o,"p-datatable-dragpoint-top")):(n?_DomHandler.default.removeClass(n,"p-datatable-dragpoint-bottom"):_DomHandler.default.addClass(o,"p-datatable-dragpoint-top"),this.droppedRowIndex=t+1,_DomHandler.default.addClass(o,"p-datatable-dragpoint-bottom")))}},{key:"onRowDragLeave",value:function(e){var t=e.rowElement,e=t.previousElementSibling;e&&_DomHandler.default.removeClass(e,"p-datatable-dragpoint-bottom"),_DomHandler.default.removeClass(t,"p-datatable-dragpoint-bottom"),_DomHandler.default.removeClass(t,"p-datatable-dragpoint-top")}},{key:"onRowDrop",value:function(e){var t,o;null!=this.droppedRowIndex&&(t=this.draggedRowIndex>this.droppedRowIndex?this.droppedRowIndex:0===this.droppedRowIndex?0:this.droppedRowIndex-1,o=_toConsumableArray(this.props.value),_ObjectUtils.default.reorderArray(o,this.draggedRowIndex,t),this.props.onRowReorder&&this.props.onRowReorder({originalEvent:e,value:o,dragIndex:this.draggedRowIndex,dropIndex:this.droppedRowIndex})),this.onRowDragLeave(e),this.onRowDragEnd(e)}},{key:"renderRowGroupHeader",value:function(e,t){var o=null;return"subheader"===this.props.rowGroupMode&&this.props.expandableRowGroups&&(o=_react.default.createElement(_RowTogglerButton.RowTogglerButton,{onClick:this.onRowToggle,rowData:e,expanded:this.isRowExpanded(e)})),_react.default.createElement("tr",{key:t+"_rowgroupheader",className:"p-rowgroup-header"},_react.default.createElement("td",{colSpan:_react.default.Children.count(this.props.children)},o,_react.default.createElement("span",{className:"p-rowgroup-header-name"},this.props.rowGroupHeaderTemplate(e,t))))}},{key:"renderRowGroupFooter",value:function(e,t){return _react.default.createElement("tr",{key:t+"_rowgroupfooter",className:"p-rowgroup-footer"},this.props.rowGroupFooterTemplate(e,t))}},{key:"render",value:function(){var h=this,e=this.props.rows||0,t=this.props.first||0,f=this.isSelectionEnabled(),o=this.props.rowGroupMode,w=o&&"subheader"===o,g=o&&"rowspan"===o,R=!1;if(this.props.value&&this.props.value.length){y=[];for(var v=this.props.lazy?0:t,r=this.props.virtualScroll?v+2*e:v+e||this.props.value.length,n=v;n<r;n++)if("break"===function(t){if(t>=h.props.value.length)return"break";var e,o=h.props.value[t],r=h.isRowExpanded(o),n=!!f&&h.isSelected(h.props.value[t]),i=h.isContextMenuSelected(o),a=void 0;if(w&&(e=_ObjectUtils.default.resolveFieldData(o,h.props.groupField),c=_ObjectUtils.default.resolveFieldData(h.props.value[t-1],h.props.groupField),0!==t&&e===c||(y.push(h.renderRowGroupHeader(o,t)),R=r)),g){var s=t,l=_ObjectUtils.default.resolveFieldData(o,h.props.sortField);if(t===v||_ObjectUtils.default.resolveFieldData(h.props.value[t-1],h.props.sortField)!==l)for(var p=l,a=0;l===p;){a++;var d=h.props.value[++s];if(!d)break;p=_ObjectUtils.default.resolveFieldData(d,h.props.sortField)}}var u,c=h.props.expandableRowGroups&&w&&R;h.props.expandableRowGroups&&!c||(i=_react.default.createElement(_BodyRow.BodyRow,{key:t,value:h.props.value,rowData:o,rowIndex:t,onClick:h.onRowClick,onDoubleClick:h.props.onRowDoubleClick,onRightClick:h.onRowRightClick,onTouchEnd:h.onRowTouchEnd,onRowToggle:h.onRowToggle,expanded:r,selectionMode:h.props.selectionMode,onRadioClick:h.onRadioClick,onCheckboxClick:h.onCheckboxClick,selected:n,contextMenuSelected:i,rowClassName:h.props.rowClassName,sortField:h.props.sortField,rowGroupMode:h.props.rowGroupMode,groupRowSpan:a,onDragStart:function(e){return h.onRowDragStart(e,t)},onDragEnd:h.onRowDragEnd,onDragOver:function(e){return h.onRowDragOver(e,t)},onDragLeave:h.onRowDragLeave,onDrop:h.onRowDrop,virtualScroll:h.props.virtualScroll,virtualRowHeight:h.props.virtualRowHeight,editMode:h.props.editMode,rowEditorValidator:h.props.rowEditorValidator,onRowEditInit:h.props.onRowEditInit,onRowEditSave:h.props.onRowEditSave,onRowEditCancel:h.props.onRowEditCancel,showRowReorderElement:h.props.showRowReorderElement,showSelectionElement:h.props.showSelectionElement},h.props.children),y.push(i)),!r||w&&h.props.expandableRowGroups||(u=h.props.rowExpansionTemplate(o),u=_react.default.createElement("tr",{key:t+"_expanded"},_react.default.createElement("td",{colSpan:h.props.children.length},u)),y.push(u)),!w||h.props.expandableRowGroups&&!c||(u=_ObjectUtils.default.resolveFieldData(o,h.props.groupField),c=_ObjectUtils.default.resolveFieldData(h.props.value[t+1],h.props.groupField),t!==h.props.value.length-1&&u===c||y.push(h.renderRowGroupFooter(o,t)))}(n))break}else var e=this.props.emptyMessage,y=this.props.loading||null===e?null:_react.default.createElement("tr",{className:"p-datatable-emptymessage"},_react.default.createElement("td",{colSpan:this.props.children.length},"function"==typeof e?e(this.props.frozen):e));return _react.default.createElement("tbody",{className:"p-datatable-tbody"},y)}}]),o}();exports.TableBody=TableBody;