"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.InputMask=void 0;var _react=_interopRequireWildcard(require("react")),_propTypes=_interopRequireDefault(require("prop-types")),_reactDom=_interopRequireDefault(require("react-dom")),_DomHandler=_interopRequireDefault(require("../utils/DomHandler")),_InputText=require("../inputtext/InputText"),_ClassNames=require("../utils/ClassNames"),_Tooltip=require("../tooltip/Tooltip");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var t=new WeakMap;return _getRequireWildcardCache=function(){return t},t}function _interopRequireWildcard(t){if(t&&t.__esModule)return t;if(null===t||"object"!==_typeof(t)&&"function"!=typeof t)return{default:t};var e=_getRequireWildcardCache();if(e&&e.has(t))return e.get(t);var i,s,n={},r=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(i in t)Object.prototype.hasOwnProperty.call(t,i)&&((s=r?Object.getOwnPropertyDescriptor(t,i):null)&&(s.get||s.set)?Object.defineProperty(n,i,s):n[i]=t[i]);return n.default=t,e&&e.set(t,n),n}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _createSuper(i){var s=_isNativeReflectConstruct();return function(){var t,e=_getPrototypeOf(i);return _possibleConstructorReturn(this,s?(t=_getPrototypeOf(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments))}}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}var InputMask=function(){_inherits(i,_react.Component);var e=_createSuper(i);function i(t){return _classCallCheck(this,i),(t=e.call(this,t)).onFocus=t.onFocus.bind(_assertThisInitialized(t)),t.onBlur=t.onBlur.bind(_assertThisInitialized(t)),t.onKeyDown=t.onKeyDown.bind(_assertThisInitialized(t)),t.onKeyPress=t.onKeyPress.bind(_assertThisInitialized(t)),t.onInput=t.onInput.bind(_assertThisInitialized(t)),t.handleInputChange=t.handleInputChange.bind(_assertThisInitialized(t)),t}return _createClass(i,[{key:"caret",value:function(t,e){var i,s,n;if(this.input.offsetParent&&this.input===document.activeElement)return"number"!=typeof t?(this.input.setSelectionRange?(s=this.input.selectionStart,n=this.input.selectionEnd):document.selection&&document.selection.createRange&&(n=(s=0-(i=document.selection.createRange()).duplicate().moveStart("character",-1e5))+i.text.length),{begin:s,end:n}):(s=t,n="number"==typeof e?e:s,void(this.input.setSelectionRange?this.input.setSelectionRange(s,n):this.input.createTextRange&&((i=this.input.createTextRange()).collapse(!0),i.moveEnd("character",n),i.moveStart("character",s),i.select())))}},{key:"isCompleted",value:function(){for(var t=this.firstNonMaskPos;t<=this.lastRequiredNonMaskPos;t++)if(this.tests[t]&&this.buffer[t]===this.getPlaceholder(t))return!1;return!0}},{key:"getPlaceholder",value:function(t){return t<this.props.slotChar.length?this.props.slotChar.charAt(t):this.props.slotChar.charAt(0)}},{key:"getValue",value:function(){return this.props.unmask?this.getUnmaskedValue():this.input&&this.input.value}},{key:"seekNext",value:function(t){for(;++t<this.len&&!this.tests[t];);return t}},{key:"seekPrev",value:function(t){for(;0<=--t&&!this.tests[t];);return t}},{key:"shiftL",value:function(t,e){var i,s;if(!(t<0)){for(i=t,s=this.seekNext(e);i<this.len;i++)if(this.tests[i]){if(!(s<this.len&&this.tests[i].test(this.buffer[s])))break;this.buffer[i]=this.buffer[s],this.buffer[s]=this.getPlaceholder(s),s=this.seekNext(s)}this.writeBuffer(),this.caret(Math.max(this.firstNonMaskPos,t))}}},{key:"shiftR",value:function(t){for(var e,i,s=t,n=this.getPlaceholder(t);s<this.len;s++)if(this.tests[s]){if(e=this.seekNext(s),i=this.buffer[s],this.buffer[s]=n,!(e<this.len&&this.tests[e].test(i)))break;n=i}}},{key:"handleAndroidInput",value:function(t){var e=this.input.value,i=this.caret();if(this.oldVal&&this.oldVal.length&&this.oldVal.length>e.length){for(this.checkVal(!0);0<i.begin&&!this.tests[i.begin-1];)i.begin--;if(0===i.begin)for(;i.begin<this.firstNonMaskPos&&!this.tests[i.begin];)i.begin++;this.caret(i.begin,i.begin)}else{for(this.checkVal(!0);i.begin<this.len&&!this.tests[i.begin];)i.begin++;this.caret(i.begin,i.begin)}this.props.onComplete&&this.isCompleted()&&this.props.onComplete({originalEvent:t,value:this.getValue()})}},{key:"onBlur",value:function(t){this.focus=!1,this.checkVal(),this.updateModel(t),this.updateFilledState(),this.props.onBlur&&this.props.onBlur(t),this.input.value!==this.focusText&&((t=document.createEvent("HTMLEvents")).initEvent("change",!0,!1),this.input.dispatchEvent(t))}},{key:"onKeyDown",value:function(t){var e,i,s;this.props.readonly||(e=t.which||t.keyCode,s=/iphone/i.test(_DomHandler.default.getUserAgent()),this.oldVal=this.input.value,8===e||46===e||s&&127===e?(s=(i=this.caret()).begin,(i=i.end)-s==0&&(s=46!==e?this.seekPrev(s):i=this.seekNext(s-1),i=46===e?this.seekNext(i):i),this.clearBuffer(s,i),this.shiftL(s,i-1),this.updateModel(t),t.preventDefault()):13===e?(this.onBlur(t),this.updateModel(t)):27===e&&(this.input.value=this.focusText,this.caret(0,this.checkVal()),this.updateModel(t),t.preventDefault()))}},{key:"onKeyPress",value:function(t){var e,i,s,n,r,o=this;this.props.readonly||(r=t.which||t.keyCode,e=this.caret(),t.ctrlKey||t.altKey||t.metaKey||r<32||(r&&13!==r&&(e.end-e.begin!=0&&(this.clearBuffer(e.begin,e.end),this.shiftL(e.begin,e.end-1)),(i=this.seekNext(e.begin-1))<this.len&&(r=String.fromCharCode(r),this.tests[i].test(r)&&(this.shiftR(i),this.buffer[i]=r,this.writeBuffer(),s=this.seekNext(i),/android/i.test(_DomHandler.default.getUserAgent())?setTimeout(function(){o.caret(s)},0):this.caret(s),e.begin<=this.lastRequiredNonMaskPos&&(n=this.isCompleted()))),t.preventDefault()),this.updateModel(t),this.props.onComplete&&n&&this.props.onComplete({originalEvent:t,value:this.getValue()})))}},{key:"clearBuffer",value:function(t,e){for(var i=t;i<e&&i<this.len;i++)this.tests[i]&&(this.buffer[i]=this.getPlaceholder(i))}},{key:"writeBuffer",value:function(){this.input.value=this.buffer.join("")}},{key:"checkVal",value:function(t){this.isValueChecked=!0;for(var e,i=this.input.value,s=-1,n=0,r=0;n<this.len;n++)if(this.tests[n]){for(this.buffer[n]=this.getPlaceholder(n);r++<i.length;)if(e=i.charAt(r-1),this.tests[n].test(e)){this.buffer[n]=e,s=n;break}if(r>i.length){this.clearBuffer(n+1,this.len);break}}else this.buffer[n]===i.charAt(r)&&r++,n<this.partialPosition&&(s=n);return t?this.writeBuffer():s+1<this.partialPosition?this.props.autoClear||this.buffer.join("")===this.defaultBuffer?(this.input.value&&(this.input.value=""),this.clearBuffer(0,this.len)):this.writeBuffer():(this.writeBuffer(),this.input.value=this.input.value.substring(0,s+1)),this.partialPosition?n:this.firstNonMaskPos}},{key:"onFocus",value:function(t){var e,i=this;this.props.readonly||(this.focus=!0,clearTimeout(this.caretTimeoutId),this.focusText=this.input.value,e=this.checkVal(),this.caretTimeoutId=setTimeout(function(){i.input===document.activeElement&&(i.writeBuffer(),e===i.props.mask.replace("?","").length?i.caret(0,e):i.caret(e),i.updateFilledState())},10),this.props.onFocus&&this.props.onFocus(t))}},{key:"onInput",value:function(t){this.androidChrome?this.handleAndroidInput(t):this.handleInputChange(t)}},{key:"handleInputChange",value:function(t){var e;this.props.readonly||(e=this.checkVal(!0),this.caret(e),this.updateModel(t),this.props.onComplete&&this.isCompleted()&&this.props.onComplete({originalEvent:t,value:this.getValue()}))}},{key:"getUnmaskedValue",value:function(){for(var t=[],e=0;e<this.buffer.length;e++){var i=this.buffer[e];this.tests[e]&&i!==this.getPlaceholder(e)&&t.push(i)}return t.join("")}},{key:"updateModel",value:function(t){var e;this.props.onChange&&(e=this.props.unmask?this.getUnmaskedValue():t&&t.target.value,this.props.onChange({originalEvent:t,value:this.defaultBuffer!==e?e:"",stopPropagation:function(){},preventDefault:function(){},target:{name:this.props.name,id:this.props.id,value:this.defaultBuffer!==e?e:""}}))}},{key:"updateFilledState",value:function(){this.input&&this.input.value&&0<this.input.value.length?_DomHandler.default.addClass(this.input,"p-filled"):_DomHandler.default.removeClass(this.input,"p-filled")}},{key:"updateValue",value:function(){var t=this;this.input&&(null==this.props.value?this.input.value="":(this.input.value=this.props.value,this.checkVal(),setTimeout(function(){t.input&&(t.writeBuffer(),t.checkVal())},10)),this.focusText=this.input.value),this.updateFilledState()}},{key:"isValueUpdated",value:function(){return this.props.unmask?this.props.value!==this.getUnmaskedValue():this.defaultBuffer!==this.input.value&&this.input.value!==this.props.value}},{key:"init",value:function(){this.tests=[],this.partialPosition=this.props.mask.length,this.len=this.props.mask.length,this.firstNonMaskPos=null,this.defs={9:"[0-9]",a:"[A-Za-z]","*":"[A-Za-z0-9]"};var t=_DomHandler.default.getUserAgent();this.androidChrome=/chrome/i.test(t)&&/android/i.test(t);for(var e=this.props.mask.split(""),i=0;i<e.length;i++){var s=e[i];"?"===s?(this.len--,this.partialPosition=i):this.defs[s]?(this.tests.push(new RegExp(this.defs[s])),null===this.firstNonMaskPos&&(this.firstNonMaskPos=this.tests.length-1),i<this.partialPosition&&(this.lastRequiredNonMaskPos=this.tests.length-1)):this.tests.push(null)}this.buffer=[];for(var n=0;n<e.length;n++){var r=e[n];"?"!==r&&(this.defs[r]?this.buffer.push(this.getPlaceholder(n)):this.buffer.push(r))}this.defaultBuffer=this.buffer.join("")}},{key:"componentDidMount",value:function(){this.init(),this.updateValue(),this.props.tooltip&&this.renderTooltip()}},{key:"componentDidUpdate",value:function(t){t.tooltip!==this.props.tooltip&&(this.tooltip?this.tooltip.updateContent(this.props.tooltip):this.renderTooltip()),this.isValueUpdated()&&this.updateValue(),t.mask!==this.props.mask&&(this.init(),this.updateValue(),this.updateModel())}},{key:"componentWillUnmount",value:function(){this.tooltip&&(this.tooltip.destroy(),this.tooltip=null)}},{key:"renderTooltip",value:function(){this.tooltip=(0,_Tooltip.tip)({target:this.input,content:this.props.tooltip,options:this.props.tooltipOptions})}},{key:"render",value:function(){var e=this,t=(0,_ClassNames.classNames)("p-inputmask",this.props.className);return _react.default.createElement(_InputText.InputText,{id:this.props.id,ref:function(t){return e.input=_reactDom.default.findDOMNode(t)},type:this.props.type,name:this.props.name,style:this.props.style,className:t,placeholder:this.props.placeholder,size:this.props.size,maxLength:this.props.maxlength,tabIndex:this.props.tabindex,disabled:this.props.disabled,readOnly:this.props.readonly,onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onKeyDown,onKeyPress:this.onKeyPress,onInput:this.onInput,onPaste:this.handleInputChange,required:this.props.required,"aria-labelledby":this.props.ariaLabelledBy})}}]),i}();_defineProperty(exports.InputMask=InputMask,"defaultProps",{id:null,value:null,type:"text",mask:null,slotChar:"_",autoClear:!0,unmask:!1,style:null,className:null,placeholder:null,size:null,maxlength:null,tabindex:null,disabled:!1,readonly:!1,name:null,required:!1,tooltip:null,tooltipOptions:null,ariaLabelledBy:null,onComplete:null,onChange:null,onFocus:null,onBlur:null}),_defineProperty(InputMask,"propTypes",{id:_propTypes.default.string,value:_propTypes.default.string,type:_propTypes.default.string,mask:_propTypes.default.string,slotChar:_propTypes.default.string,autoClear:_propTypes.default.bool,unmask:_propTypes.default.bool,style:_propTypes.default.object,className:_propTypes.default.string,placeholder:_propTypes.default.string,size:_propTypes.default.number,maxlength:_propTypes.default.number,tabindex:_propTypes.default.number,disabled:_propTypes.default.bool,readonly:_propTypes.default.bool,name:_propTypes.default.string,required:_propTypes.default.bool,tooltip:_propTypes.default.string,tooltipOptions:_propTypes.default.object,ariaLabelledBy:_propTypes.default.string,onComplete:_propTypes.default.func,onChange:_propTypes.default.func,onFocus:_propTypes.default.func,onBlur:_propTypes.default.func});