"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ColorPicker=void 0;var _react=_interopRequireWildcard(require("react")),_propTypes=_interopRequireDefault(require("prop-types")),_DomHandler=_interopRequireDefault(require("../utils/DomHandler")),_ClassNames=require("../utils/ClassNames"),_ColorPickerPanel=require("./ColorPickerPanel"),_Tooltip=require("../tooltip/Tooltip"),_ObjectUtils=_interopRequireDefault(require("../utils/ObjectUtils")),_reactTransitionGroup=require("react-transition-group"),_UniqueComponentId=_interopRequireDefault(require("../utils/UniqueComponentId")),_ConnectedOverlayScrollHandler=_interopRequireDefault(require("../utils/ConnectedOverlayScrollHandler"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return _getRequireWildcardCache=function(){return e},e}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache();if(t&&t.has(e))return t.get(e);var n,i,o={},r=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(n in e)Object.prototype.hasOwnProperty.call(e,n)&&((i=r?Object.getOwnPropertyDescriptor(e,n):null)&&(i.get||i.set)?Object.defineProperty(o,n,i):o[n]=e[n]);return o.default=e,t&&t.set(e,o),o}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _extends(){return(_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,i=arguments[t];for(n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e}).apply(this,arguments)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(n){var i=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(n);return _possibleConstructorReturn(this,i?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ColorPicker=function(){_inherits(i,_react.Component);var t=_createSuper(i);function i(e){return _classCallCheck(this,i),(e=t.call(this,e)).state={overlayVisible:!1},e.onInputClick=e.onInputClick.bind(_assertThisInitialized(e)),e.onInputKeydown=e.onInputKeydown.bind(_assertThisInitialized(e)),e.onOverlayEnter=e.onOverlayEnter.bind(_assertThisInitialized(e)),e.onOverlayEntered=e.onOverlayEntered.bind(_assertThisInitialized(e)),e.onOverlayExit=e.onOverlayExit.bind(_assertThisInitialized(e)),e.id=e.props.id||(0,_UniqueComponentId.default)(),e}return _createClass(i,[{key:"onHueMousedown",value:function(e){this.props.disabled||(this.hueDragging=!0,this.bindDocumentMouseMoveListener(),this.bindDocumentMouseUpListener(),this.pickHue(e),_DomHandler.default.addClass(this.container,"p-colorpicker-dragging"))}},{key:"pickHue",value:function(e){var t=this.hueView.getBoundingClientRect().top+(window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0);this.hsbValue=this.validateHSB({h:Math.floor(360*(150-Math.max(0,Math.min(150,e.pageY-t)))/150),s:100,b:100}),this.updateColorSelector(),this.updateHue(),this.updateModel()}},{key:"onColorMousedown",value:function(e){this.props.disabled||(this.colorDragging=!0,this.bindDocumentMouseMoveListener(),this.bindDocumentMouseUpListener(),this.pickColor(e),_DomHandler.default.addClass(this.container,"p-colorpicker-dragging"))}},{key:"pickColor",value:function(e){var t=this.colorSelector.getBoundingClientRect(),n=t.top+(window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0),t=t.left+document.body.scrollLeft,t=Math.floor(100*Math.max(0,Math.min(150,e.pageX-t))/150),n=Math.floor(100*(150-Math.max(0,Math.min(150,e.pageY-n)))/150);this.hsbValue=this.validateHSB({h:this.hsbValue.h,s:t,b:n}),this.updateColorHandle(),this.updateInput(),this.updateModel()}},{key:"updateModel",value:function(){switch(this.props.format){case"hex":this.onChange(this.HSBtoHEX(this.hsbValue));break;case"rgb":this.onChange(this.HSBtoRGB(this.hsbValue));break;case"hsb":this.onChange(this.hsbValue)}}},{key:"toHSB",value:function(e){var t;if(e)switch(this.props.format){case"hex":t=this.HEXtoHSB(e);break;case"rgb":t=this.RGBtoHSB(e);break;case"hsb":t=e}else t=this.HEXtoHSB(this.props.defaultColor);return t}},{key:"updateHSBValue",value:function(e){this.hsbValue=this.toHSB(e)}},{key:"areHSBEqual",value:function(e,t){return e.h===t.h&&e.s===t.s&&e.b===t.b}},{key:"onChange",value:function(e){this.props.onChange&&this.props.onChange({value:e,stopPropagation:function(){},preventDefault:function(){},target:{name:this.props.name,id:this.id,value:e}})}},{key:"updateColorSelector",value:function(){var e;this.colorSelector&&(e=this.validateHSB({h:this.hsbValue.h,s:100,b:100}),this.colorSelector.style.backgroundColor="#"+this.HSBtoHEX(e))}},{key:"updateColorHandle",value:function(){this.colorHandle&&(this.colorHandle.style.left=Math.floor(150*this.hsbValue.s/100)+"px",this.colorHandle.style.top=Math.floor(150*(100-this.hsbValue.b)/100)+"px")}},{key:"updateHue",value:function(){this.hueHandle&&(this.hueHandle.style.top=Math.floor(150-150*this.hsbValue.h/360)+"px")}},{key:"updateInput",value:function(){this.input&&(this.input.style.backgroundColor="#"+this.HSBtoHEX(this.hsbValue))}},{key:"show",value:function(){this.setState({overlayVisible:!0})}},{key:"hide",value:function(){this.setState({overlayVisible:!1})}},{key:"onOverlayEnter",value:function(){this.panel.element.style.zIndex=String(_DomHandler.default.generateZIndex()),this.alignPanel()}},{key:"onOverlayEntered",value:function(){this.bindDocumentClickListener(),this.bindScrollListener(),this.bindResizeListener()}},{key:"onOverlayExit",value:function(){this.unbindDocumentClickListener(),this.unbindScrollListener(),this.unbindResizeListener()}},{key:"onInputClick",value:function(){this.togglePanel()}},{key:"togglePanel",value:function(){this.state.overlayVisible?this.hide():this.show()}},{key:"onInputKeydown",value:function(e){switch(e.which){case 32:this.togglePanel(),e.preventDefault();break;case 27:case 9:this.hide()}}},{key:"bindDocumentClickListener",value:function(){var t=this;this.documentClickListener||(this.documentClickListener=function(e){t.state.overlayVisible&&t.isOutsideClicked(e)&&t.hide()},document.addEventListener("click",this.documentClickListener))}},{key:"unbindDocumentClickListener",value:function(){this.documentClickListener&&(document.removeEventListener("click",this.documentClickListener),this.documentClickListener=null)}},{key:"bindScrollListener",value:function(){var e=this;this.scrollHandler||(this.scrollHandler=new _ConnectedOverlayScrollHandler.default(this.container,function(){e.state.overlayVisible&&e.hide()})),this.scrollHandler.bindScrollListener()}},{key:"unbindScrollListener",value:function(){this.scrollHandler&&this.scrollHandler.unbindScrollListener()}},{key:"bindResizeListener",value:function(){var e=this;this.resizeListener||(this.resizeListener=function(){e.state.overlayVisible&&e.hide()},window.addEventListener("resize",this.resizeListener))}},{key:"unbindResizeListener",value:function(){this.resizeListener&&(window.removeEventListener("resize",this.resizeListener),this.resizeListener=null)}},{key:"isOutsideClicked",value:function(e){return this.container&&!(this.container.isSameNode(e.target)||this.container.contains(e.target)||this.panel&&this.panel.element&&this.panel.element.contains(e.target))}},{key:"bindDocumentMouseMoveListener",value:function(){this.documentMouseMoveListener||(this.documentMouseMoveListener=this.onDocumentMouseMove.bind(this),document.addEventListener("mousemove",this.documentMouseMoveListener))}},{key:"onDocumentMouseMove",value:function(e){this.colorDragging&&this.pickColor(e),this.hueDragging&&this.pickHue(e)}},{key:"unbindDocumentMouseMoveListener",value:function(){this.documentMouseMoveListener&&(document.removeEventListener("mousemove",this.documentMouseMoveListener),this.documentMouseMoveListener=null)}},{key:"bindDocumentMouseUpListener",value:function(){this.documentMouseUpListener||(this.documentMouseUpListener=this.onDocumentMouseUp.bind(this),document.addEventListener("mouseup",this.documentMouseUpListener))}},{key:"onDocumentMouseUp",value:function(){this.colorDragging=!1,this.hueDragging=!1,_DomHandler.default.removeClass(this.container,"p-colorpicker-dragging"),this.unbindDocumentMouseMoveListener(),this.unbindDocumentMouseUpListener()}},{key:"unbindDocumentMouseUpListener",value:function(){this.documentMouseUpListener&&(document.removeEventListener("mouseup",this.documentMouseUpListener),this.documentMouseUpListener=null)}},{key:"validateHSB",value:function(e){return{h:Math.min(360,Math.max(0,e.h)),s:Math.min(100,Math.max(0,e.s)),b:Math.min(100,Math.max(0,e.b))}}},{key:"validateRGB",value:function(e){return{r:Math.min(255,Math.max(0,e.r)),g:Math.min(255,Math.max(0,e.g)),b:Math.min(255,Math.max(0,e.b))}}},{key:"validateHEX",value:function(e){var t=6-e.length;if(0<t){for(var n=[],i=0;i<t;i++)n.push("0");n.push(e),e=n.join("")}return e}},{key:"HEXtoRGB",value:function(e){e=parseInt(-1<e.indexOf("#")?e.substring(1):e,16);return{r:e>>16,g:(65280&e)>>8,b:255&e}}},{key:"HEXtoHSB",value:function(e){return this.RGBtoHSB(this.HEXtoRGB(e))}},{key:"RGBtoHSB",value:function(e){var t={h:0,s:0,b:0},n=Math.min(e.r,e.g,e.b),i=Math.max(e.r,e.g,e.b),n=i-n;return t.b=i,t.s=0!==i?255*n/i:0,0!==t.s?e.r===i?t.h=(e.g-e.b)/n:e.g===i?t.h=2+(e.b-e.r)/n:t.h=4+(e.r-e.g)/n:t.h=-1,t.h*=60,t.h<0&&(t.h+=360),t.s*=100/255,t.b*=100/255,t}},{key:"HSBtoRGB",value:function(e){var t={r:null,g:null,b:null},n=Math.round(e.h),i=Math.round(255*e.s/100),o=Math.round(255*e.b/100);return 0===i?t={r:o,g:o,b:o}:(o=n%60*((e=o)-(i=(255-i)*o/255))/60,360===n&&(n=0),n<60?(t.r=e,t.b=i,t.g=i+o):n<120?(t.g=e,t.b=i,t.r=e-o):n<180?(t.g=e,t.r=i,t.b=i+o):n<240?(t.b=e,t.r=i,t.g=e-o):n<300?(t.b=e,t.g=i,t.r=i+o):n<360?(t.r=e,t.g=i,t.b=e-o):(t.r=0,t.g=0,t.b=0)),{r:Math.round(t.r),g:Math.round(t.g),b:Math.round(t.b)}}},{key:"RGBtoHEX",value:function(e){var t,n=[e.r.toString(16),e.g.toString(16),e.b.toString(16)];for(t in n)1===n[t].length&&(n[t]="0"+n[t]);return n.join("")}},{key:"HSBtoHEX",value:function(e){return this.RGBtoHEX(this.HSBtoRGB(e))}},{key:"componentDidMount",value:function(){this.updateHSBValue(this.props.value),this.updateUI(),this.props.tooltip&&this.renderTooltip()}},{key:"componentDidUpdate",value:function(e){this.updateUI(),e.tooltip!==this.props.tooltip&&(this.tooltip?this.tooltip.updateContent(this.props.tooltip):this.renderTooltip())}},{key:"componentWillUnmount",value:function(){this.unbindDocumentClickListener(),this.unbindDocumentMouseMoveListener(),this.unbindDocumentMouseUpListener(),this.unbindResizeListener(),this.scrollHandler&&(this.scrollHandler.destroy(),this.scrollHandler=null),this.tooltip&&(this.tooltip.destroy(),this.tooltip=null)}},{key:"updateUI",value:function(){this.updateHue(),this.updateColorHandle(),this.updateInput(),this.updateColorSelector()}},{key:"alignPanel",value:function(){var e=this.input.parentElement;this.props.appendTo?(this.panel.element.style.minWidth=_DomHandler.default.getWidth(e)+"px",_DomHandler.default.absolutePosition(this.panel.element,e)):_DomHandler.default.relativePosition(this.panel.element,e)}},{key:"renderTooltip",value:function(){this.tooltip=(0,_Tooltip.tip)({target:this.container,content:this.props.tooltip,options:this.props.tooltipOptions})}},{key:"renderColorSelector",value:function(){var t=this;return _react.default.createElement("div",{ref:function(e){return t.colorSelector=e},className:"p-colorpicker-color-selector",onMouseDown:this.onColorMousedown.bind(this)},_react.default.createElement("div",{className:"p-colorpicker-color"},_react.default.createElement("div",{ref:function(e){return t.colorHandle=e},className:"p-colorpicker-color-handle"})))}},{key:"renderHue",value:function(){var t=this;return _react.default.createElement("div",{ref:function(e){return t.hueView=e},className:"p-colorpicker-hue",onMouseDown:this.onHueMousedown.bind(this)},_react.default.createElement("div",{ref:function(e){return t.hueHandle=e},className:"p-colorpicker-hue-handle"}))}},{key:"renderContent",value:function(){var e=this.renderColorSelector(),t=this.renderHue();return _react.default.createElement("div",{className:"p-colorpicker-content"},e,t)}},{key:"renderInput",value:function(){var t=this;if(this.props.inline)return null;var e=(0,_ClassNames.classNames)("p-colorpicker-preview p-inputtext",{"p-disabled":this.props.disabled}),n=_ObjectUtils.default.findDiffKeys(this.props,i.defaultProps);return _react.default.createElement("input",_extends({ref:function(e){return t.input=e},type:"text",className:e,readOnly:"readonly",id:this.props.inputId,tabIndex:this.props.tabIndex,disabled:this.props.disabled,onClick:this.onInputClick,onKeyDown:this.onInputKeydown},n))}},{key:"render",value:function(){var t=this,e=(0,_ClassNames.classNames)("p-colorpicker p-component",{"p-colorpicker-overlay":!this.props.inline},this.props.className),n=this.renderContent(),i=this.renderInput();return _react.default.createElement("div",{ref:function(e){return t.container=e},id:this.id,style:this.props.style,className:e},i,_react.default.createElement(_reactTransitionGroup.CSSTransition,{classNames:"p-connected-overlay",in:this.props.inline||this.state.overlayVisible,timeout:{enter:120,exit:100},unmountOnExit:!0,onEnter:this.onOverlayEnter,onEntered:this.onOverlayEntered,onExit:this.onOverlayExit},_react.default.createElement(_ColorPickerPanel.ColorPickerPanel,{ref:function(e){return t.panel=e},appendTo:this.props.appendTo,inline:this.props.inline,disabled:this.props.disabled},n)))}}]),i}();_defineProperty(exports.ColorPicker=ColorPicker,"defaultProps",{id:null,value:null,style:null,className:null,defaultColor:"ff0000",inline:!1,format:"hex",appendTo:null,disabled:!1,tabIndex:null,inputId:null,tooltip:null,tooltipOptions:null,onChange:null}),_defineProperty(ColorPicker,"propTypes",{id:_propTypes.default.string,value:_propTypes.default.any,style:_propTypes.default.object,className:_propTypes.default.string,defaultColor:_propTypes.default.string,inline:_propTypes.default.bool,format:_propTypes.default.string,appendTo:_propTypes.default.any,disabled:_propTypes.default.bool,tabIndex:_propTypes.default.string,inputId:_propTypes.default.string,tooltip:_propTypes.default.string,tooltipOptions:_propTypes.default.object,onChange:_propTypes.default.func});