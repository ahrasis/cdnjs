"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Autocomplete=exports.autocompleteFactory=void 0;var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r,o=arguments[t];for(r in o)Object.prototype.hasOwnProperty.call(o,r)&&(e[r]=o[r])}return e},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],o=!0,n=!1,s=void 0;try{for(var a,u=e[Symbol.iterator]();!(o=(a=u.next()).done)&&(r.push(a.value),!t||r.length!==t);o=!0);}catch(e){n=!0,s=e}finally{try{!o&&u.return&&u.return()}finally{if(n)throw s}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_createClass=function(){function o(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_propTypes=require("prop-types"),_propTypes2=_interopRequireDefault(_propTypes),_reactDom=require("react-dom"),_reactDom2=_interopRequireDefault(_reactDom),_classnames4=require("classnames"),_classnames5=_interopRequireDefault(_classnames4),_reactCssThemr=require("react-css-themr"),_identifiers=require("../identifiers.js"),_Chip=require("../chip/Chip.js"),_Chip2=_interopRequireDefault(_Chip),_Input=require("../input/Input.js"),_Input2=_interopRequireDefault(_Input),_events=require("../utils/events.js"),_events2=_interopRequireDefault(_events);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _objectWithoutProperties(e,t){var r,o={};for(r in e)0<=t.indexOf(r)||Object.prototype.hasOwnProperty.call(e,r)&&(o[r]=e[r]);return o}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var POSITION={AUTO:"auto",DOWN:"down",UP:"up"},factory=function(o,a){var e=(_inherits(n,_react.Component),_createClass(n,[{key:"componentWillReceiveProps",value:function(e){this.props.multiple||(e=e.query||this.query(e.value),this.updateQuery(e,!1))}},{key:"shouldComponentUpdate",value:function(e,t){return!this.state.focus&&t.focus&&this.props.direction===POSITION.AUTO&&(t=this.calculateDirection(),this.state.direction!==t&&this.setState({direction:t})),!0}},{key:"calculateDirection",value:function(){if("auto"!==this.props.direction)return this.props.direction;var e=_reactDom2.default.findDOMNode(this.inputNode).getBoundingClientRect(),t=window.innerHeight||document.documentElement.offsetHeight;return e.top>t/2+e.height?"up":"down"}},{key:"query",value:function(e){var t="";return!this.props.multiple&&e&&(t=this.source().get(""+e)||e),t}},{key:"selectOrCreateActiveItem",value:function(e){var t=this.state.active;t||(t=this.props.allowCreate?this.state.query:[].concat(_toConsumableArray(this.suggestions().keys()))[0],this.setState({active:t})),this.select(e,t)}},{key:"normalise",value:function(e){for(var t="áâäąáâäąččććççĉĉďđďđééěëēėęéěëēėęĝĝğğġġģģĥĥħħíîíîĩĩīīĭĭįįi̇ıĵĵķķĸĺĺļļŀŀłłĺľĺľňńņŋŋņňńŉóöôőøōōóöőôøřřŕŕŗŗššśśŝŝşşţţťťŧŧũũūūŭŭůůűűúüúüűųųŵŵýyŷŷýyžžźźżżß",r="",o=0;o<e.length;o++)-1!==t.indexOf(e.charAt(o))?r+="AAAAAAAACCCCCCCCDDDDEEEEEEEEEEEEEGGGGGGGGHHHHIIIIIIIIIIIIIIJJKKKLLLLLLLLLLLLNNNNNNNNNOOOOOOOOOOOORRRRRRSSSSSSSSTTTTTTUUUUUUUUUUUUUUUUUWWYYYYYYZZZZZZS".charAt(t.indexOf(e.charAt(o))):r+=e.charAt(o);return r.toLowerCase().trim()}},{key:"suggestions",value:function(){var e=new Map,t=this.state.query||(this.props.multiple?"":this.props.value),r=this.normalise(""+t),o=this.values(),n=this.source();if(this.props.multiple){var s=!0,a=!1,u=void 0;try{for(var i=n[Symbol.iterator]();!(s=(l=i.next()).done);s=!0){var l=_slicedToArray(l.value,2),p=l[0],c=l[1];!o.has(p)&&this.matches(this.normalise(c),r)&&e.set(p,c)}}catch(e){a=!0,u=e}finally{try{!s&&i.return&&i.return()}finally{if(a)throw u}}}else if(r&&!this.state.showAllSuggestions){var h=!0,f=!1,y=void 0;try{for(var d=n[Symbol.iterator]();!(h=(_=d.next()).done);h=!0){var _=_slicedToArray(_.value,2),p=_[0],c=_[1];this.matches(this.normalise(c),r)&&e.set(p,c)}}catch(e){f=!0,y=e}finally{try{!h&&d.return&&d.return()}finally{if(f)throw y}}}else e=n;return e}},{key:"matches",value:function(e,t){var r=this.props.suggestionMatch;return"disabled"===r||("start"===r?e.startsWith(t):"anywhere"===r?e.includes(t):"word"===r?new RegExp("\\b"+t,"g").test(e):"none"===r&&e)}},{key:"source",value:function(){var t=this.props.source;return t.hasOwnProperty("length")?new Map(t.map(function(e){return Array.isArray(e)?[].concat(_toConsumableArray(e)):[e,e]})):new Map(Object.keys(t).map(function(e){return[""+e,t[e]]}))}},{key:"values",value:function(){var e=(e=this.props.multiple?this.props.value:[this.props.value])||[];if(this.props.showSelectedWhenNotInSource&&this.isValueAnObject())return new Map(Object.entries(e));var t=new Map,r=e.map(function(e){return""+e}),o=!0,n=!1,s=void 0;try{for(var a=this.source()[Symbol.iterator]();!(o=(i=a.next()).done);o=!0){var u=_slicedToArray(i.value,2),i=u[0],u=u[1];-1!==r.indexOf(i)&&t.set(i,u)}}catch(e){n=!0,s=e}finally{try{!o&&a.return&&a.return()}finally{if(n)throw s}}return t}},{key:"unselect",value:function(e,t){if(!this.props.disabled){var r=this.values(this.props.value);if(r.delete(e),this.isValueAnObject())return this.handleChange(this.mapToObject(r),t);this.handleChange([].concat(_toConsumableArray(r.keys())),t)}}},{key:"isValueAnObject",value:function(){return!Array.isArray(this.props.value)&&"object"===_typeof(this.props.value)}},{key:"mapToObject",value:function(e){return Array.from(e).reduce(function(e,t){var r=_slicedToArray(t,2),t=r[0],r=r[1];return e[t]=r,e},{})}},{key:"renderSelected",value:function(){var r=this;if(this.props.multiple){var e=[].concat(_toConsumableArray(this.values())).map(function(e){var t=_slicedToArray(e,2),e=t[0],t=t[1];return _react2.default.createElement(o,{key:e,className:r.props.theme.value,deletable:!0,onDeleteClick:r.unselect.bind(r,e)},t)});return _react2.default.createElement("ul",{className:this.props.theme.values},e)}}},{key:"renderSuggestions",value:function(){var o=this,n=this.props.theme,e=[].concat(_toConsumableArray(this.suggestions())).map(function(e){var t=_slicedToArray(e,2),r=t[0],e=t[1],t=(0,_classnames5.default)(n.suggestion,_defineProperty({},n.active,o.state.active===r));return _react2.default.createElement("li",{id:r,key:r,className:t,onMouseDown:o.handleMouseDown,onMouseOver:o.handleSuggestionHover},e)});return _react2.default.createElement("ul",{className:(0,_classnames5.default)(n.suggestions,_defineProperty({},n.up,"up"===this.state.direction)),ref:function(e){o.suggestionsNode=e}},e)}},{key:"render",value:function(){var t=this,e=this.props,r=(e.allowCreate,e.error),o=e.label,n=(e.source,e.suggestionMatch,e.query,e.selectedPosition,e.keepFocusOnChange,e.showSuggestionsWhenValueIsSet,e.showSelectedWhenNotInSource,e.onQueryChange,e.theme),s=_objectWithoutProperties(e,["allowCreate","error","label","source","suggestionMatch","query","selectedPosition","keepFocusOnChange","showSuggestionsWhenValueIsSet","showSelectedWhenNotInSource","onQueryChange","theme"]),e=(0,_classnames5.default)(n.autocomplete,_defineProperty({},n.focus,this.state.focus),this.props.className);return _react2.default.createElement("div",{"data-react-toolbox":"autocomplete",className:e},"above"===this.props.selectedPosition?this.renderSelected():null,_react2.default.createElement(a,_extends({},s,{ref:function(e){t.inputNode=e},autoComplete:"off",className:n.input,error:r,label:o,onBlur:this.handleQueryBlur,onChange:this.handleQueryChange,onFocus:this.handleQueryFocus,onKeyDown:this.handleQueryKeyDown,onKeyUp:this.handleQueryKeyUp,theme:n,themeNamespace:"input",value:this.state.query})),this.renderSuggestions(),"below"===this.props.selectedPosition?this.renderSelected():null)}}]),n);function n(){var e,s;_classCallCheck(this,n);for(var t=arguments.length,r=Array(t),o=0;o<t;o++)r[o]=arguments[o];return(e=s=_possibleConstructorReturn(this,(e=n.__proto__||Object.getPrototypeOf(n)).call.apply(e,[this].concat(r)))).state={direction:s.props.direction,focus:!1,showAllSuggestions:s.props.showSuggestionsWhenValueIsSet,query:s.props.query||s.query(s.props.value),isValueAnObject:!1},s.handleChange=function(e,t){var r=s.props.multiple?e:e[0],o=s.props.showSuggestionsWhenValueIsSet,e=s.query(r);s.props.onChange&&s.props.onChange(r,t),s.props.keepFocusOnChange?s.setState({query:e,showAllSuggestions:o}):s.setState({focus:!1,query:e,showAllSuggestions:o},function(){_reactDom2.default.findDOMNode(s).querySelector("input").blur()}),s.updateQuery(e,s.props.query)},s.handleMouseDown=function(e){s.selectOrCreateActiveItem(e)},s.handleQueryBlur=function(e){s.state.focus&&s.setState({focus:!1}),s.props.onBlur&&s.props.onBlur(e,s.state.active)},s.updateQuery=function(e,t){t&&s.props.onQueryChange&&s.props.onQueryChange(e),s.setState({query:e})},s.handleQueryChange=function(e){e=s.clearQuery?"":e;s.clearQuery=!1,s.updateQuery(e,!0),s.setState({showAllSuggestions:!e&&s.props.showSuggestionsWhenValueIsSet,active:null})},s.handleQueryFocus=function(e){s.suggestionsNode.scrollTop=0,s.setState({active:"",focus:!0}),s.props.onFocus&&s.props.onFocus(e)},s.handleQueryKeyDown=function(e){s.clearQuery=8===e.which&&s.props.showSuggestionsWhenValueIsSet&&s.state.showAllSuggestions,13===e.which&&s.selectOrCreateActiveItem(e)},s.handleQueryKeyUp=function(e){var t;27===e.which&&_reactDom2.default.findDOMNode(s).querySelector("input").blur(),-1!==[40,38].indexOf(e.which)&&((e=(t=[].concat(_toConsumableArray(s.suggestions().keys()))).indexOf(s.state.active)+(40===e.which?1:-1))<0&&(e=t.length-1),e>=t.length&&(e=0),s.setState({active:t[e]}))},s.handleSuggestionHover=function(e){s.setState({active:e.target.id})},s.select=function(e,t){_events2.default.pauseEvent(e);var r=s.values(s.props.value),o=s.source(),n=void 0===t?e.target.id:t;if(s.isValueAnObject()){o=Array.from(o).reduce(function(e,t){var r=_slicedToArray(t,2),t=r[0],r=r[1];return t===n&&(e[t]=r),e},{});return 0===Object.keys(o).length&&n&&(o[n]=n),s.handleChange(Object.assign(s.mapToObject(r),o),e)}s.handleChange([n].concat(_toConsumableArray(r.keys())),e)},_possibleConstructorReturn(s,e)}return e.propTypes={allowCreate:_propTypes2.default.bool,className:_propTypes2.default.string,direction:_propTypes2.default.oneOf(["auto","up","down"]),disabled:_propTypes2.default.bool,error:_propTypes2.default.oneOfType([_propTypes2.default.string,_propTypes2.default.node]),keepFocusOnChange:_propTypes2.default.bool,label:_propTypes2.default.oneOfType([_propTypes2.default.string,_propTypes2.default.node]),multiple:_propTypes2.default.bool,onBlur:_propTypes2.default.func,onChange:_propTypes2.default.func,onFocus:_propTypes2.default.func,onQueryChange:_propTypes2.default.func,query:_propTypes2.default.string,selectedPosition:_propTypes2.default.oneOf(["above","below","none"]),showSelectedWhenNotInSource:_propTypes2.default.bool,showSuggestionsWhenValueIsSet:_propTypes2.default.bool,source:_propTypes2.default.any,suggestionMatch:_propTypes2.default.oneOf(["disabled","start","anywhere","word","none"]),theme:_propTypes2.default.shape({active:_propTypes2.default.string,autocomplete:_propTypes2.default.string,focus:_propTypes2.default.string,input:_propTypes2.default.string,suggestion:_propTypes2.default.string,suggestions:_propTypes2.default.string,up:_propTypes2.default.string,value:_propTypes2.default.string,values:_propTypes2.default.string}),value:_propTypes2.default.any},e.defaultProps={allowCreate:!1,className:"",direction:"auto",keepFocusOnChange:!1,multiple:!0,selectedPosition:"above",showSelectedWhenNotInSource:!1,showSuggestionsWhenValueIsSet:!1,source:{},suggestionMatch:"start"},e},Autocomplete=factory(_Chip2.default,_Input2.default);exports.default=(0,_reactCssThemr.themr)(_identifiers.AUTOCOMPLETE)(Autocomplete),exports.autocompleteFactory=factory,exports.Autocomplete=Autocomplete;