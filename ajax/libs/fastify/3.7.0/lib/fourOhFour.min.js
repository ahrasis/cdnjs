"use strict";const FindMyWay=require("find-my-way"),Reply=require("./reply"),Request=require("./request"),Context=require("./context"),{kRoutePrefix:kRoutePrefix,kCanSetNotFoundHandler:kCanSetNotFoundHandler,kFourOhFourLevelInstance:kFourOhFourLevelInstance,kReply:kReply,kRequest:kRequest,kContentTypeParser:kContentTypeParser,kBodyLimit:kBodyLimit,kLogLevel:kLogLevel,kFourOhFourContext:kFourOhFourContext,kHooks:kHooks,kErrorHandler:kErrorHandler}=require("./symbols.js"),{lifecycleHooks:lifecycleHooks}=require("./hooks"),fourOhFourContext={config:{},onSend:[],onError:[]};function fourOhFour(e){const{logger:o,genReqId:t}=e,r=FindMyWay({defaultRoute:function(e,n){var i=t(e),u=o.child({reqId:i});u.info({req:e},"incoming request");var a=new Request(i,null,e,null,u,fourOhFourContext),s=new Reply(n,a,u);a.log.warn("the default handler for 404 did not catch this, this is likely a fastify bug, please report it"),a.log.warn(r.prettyPrint()),s.code(404).send(new Error("Not Found"))}});return{router:r,setNotFoundHandler:function(e,o,t,i){void 0===this[kCanSetNotFoundHandler]&&(this[kCanSetNotFoundHandler]=!0);void 0===this[kFourOhFourContext]&&(this[kFourOhFourContext]=null);const u=this,a=this[kRoutePrefix]||"/";if(!1===this[kCanSetNotFoundHandler])throw new Error(`Not found handler already set for Fastify instance with prefix: '${a}'`);"object"==typeof e&&(e.preHandler&&(Array.isArray(e.preHandler)?e.preHandler=e.preHandler.map(e=>e.bind(u)):e.preHandler=e.preHandler.bind(u)),e.preValidation&&(Array.isArray(e.preValidation)?e.preValidation=e.preValidation.map(e=>e.bind(u)):e.preValidation=e.preValidation.bind(u)));"function"==typeof e&&(o=e,e=void 0);e=e||{},o?(this[kFourOhFourLevelInstance][kCanSetNotFoundHandler]=!1,o=o.bind(this)):o=n;this.after((n,u)=>{(function(e,o,t,n,i){const u=new Context(o.schema,t,this[kReply],this[kRequest],this[kContentTypeParser],o.config||{},this[kErrorHandler],this[kBodyLimit],this[kLogLevel]);if(n.once("preReady",()=>{const e=this[kFourOhFourContext];for(const t of lifecycleHooks){const r=this[kHooks][t].concat(o[t]||[]).map(e=>e.bind(this));e[t]=r.length?r:null}}),null!==this[kFourOhFourContext]&&"/"===e)return void Object.assign(this[kFourOhFourContext],u);this[kFourOhFourLevelInstance][kFourOhFourContext]=u,r.all(e+(e.endsWith("/")?"*":"/*"),i,u),r.all(e,i,u)}).call(this,a,e,o,t,i),u(n)})},setContext:function(e,o){const t=Object.assign({},e[kFourOhFourContext]);t.onSend=o.onSend,o[kFourOhFourContext]=t},arrange404:function(e){e[kFourOhFourLevelInstance]=e,e[kCanSetNotFoundHandler]=!0}};function n(e,o){const{url:t,method:r}=e.raw,n=`Route ${r}:${t} not found`;e.log.info(n),o.code(404).send({message:n,error:"Not Found",statusCode:404})}}module.exports=fourOhFour;