import{w as warn,E as extractModule,W as WidgetBehavior,i as isEqual,d as deepQueryAll}from"./index-16504bb3.js";const VALIDATORS={email:t=>extractModule(import("./index-7ef6987f.js").then(function(t){return t.i})).then(e=>!t||e.validate(t)),maxlength:(t,e)=>t.length<=Number(e),minlength:(t,e)=>t.length>=Number(e),required:t=>{switch(typeof t){case"string":return t.length>0;case"number":return t==t;case"boolean":return!0;default:return null!=t}}};function checkErrors(t,e){const i=Object.keys(e),r={};return Object.keys(t).forEach(e=>{const i=t[e];"object"==typeof i&&i.$errors&&(r[e]=i.$errors)}),Promise.all(i.map(i=>{const r=e[i];if(!r)return!0;const s=Object.keys(r);return Promise.all(s.map(e=>{const s=r[e],n=VALIDATORS[e];return"function"==typeof s?s(t[i]):n?n(t[i],s):(warn("unknown validator",e),!0)})).then(t=>{return!t.every(t=>t)&&s.reduce((e,i,r)=>(t[r]||(e[i]=!0),e),{})})})).then(t=>i.reduce((e,i,r)=>(t[r]&&(e[i]=t[r]),e),r)).then(()=>{return!!Object.keys(r).length&&r})}function mergeObjects(t,e){return[t,e].reduce(function(t,e){return Object.keys(e).forEach(function(i){t[i]=e[i]}),t},{})}function isArray(t){return"[object Array]"==={}.toString.call(t)}function isJsonObject(t){return!(isArray(t)||"object"!=typeof t||!t||t instanceof Blob||t instanceof Date)}function isAppendFunctionPresent(t){return"function"==typeof t.append}function isGlobalFormDataPresent(){return"function"==typeof FormData}function getDefaultFormData(){if(isGlobalFormDataPresent())return new FormData}function convert(t,e){if(e&&e.initialFormData){if(!isAppendFunctionPresent(e.initialFormData))throw"initialFormData must have an append function."}else if(!isGlobalFormDataPresent())throw"This environment does not have global form data. options.initialFormData must be specified.";let i=mergeObjects({initialFormData:getDefaultFormData(),showLeafArrayIndexes:!0,includeNullValues:!1,mapping:function(t){return"boolean"==typeof t?+t?"1":"0":t}},e||{});return convertRecursively(t,i,i.initialFormData)}function convertRecursively(t,e,i,r){let s=0;for(let n in t){if(t.hasOwnProperty(n)){let a=r||n,o=e.mapping(t[n]);if(r&&isJsonObject(t)&&(a=r+"["+n+"]"),r&&isArray(t)&&(a=isArray(o)||e.showLeafArrayIndexes?r+"["+s+"]":r+"[]"),isArray(o)||isJsonObject(o))convertRecursively(o,e,i,a);else if(o instanceof FileList)for(let t=0;t<o.length;t++)i.append(a+"["+t+"]",o.item(t));else o instanceof Blob?i.append(a,o,o.name):o instanceof Date?i.append(a,o.toISOString()):(null===o&&e.includeNullValues||null!==o)&&void 0!==o&&i.append(a,o)}s++}return i}class FormBehavior extends WidgetBehavior{static get params(){return{input:!0,primary:!0,provideValue:!1,contextValue:!1}}init(){this.value={},this.validators={},this.checks={},this.fields={},super.init();const{host:t}=this;t.nuSetMod("form",!0),this.value||(this.value={}),this.setContext("form",this),this.context.value=null,this.on("nu-blur",t=>{const e=t.detail;this.fields[e]&&this.verifyData(e)}),this.provideAction("submit",()=>{this.verifyData().then(t=>{t&&(this.emit("input","formdata"===this.type?convert(this.value):{...this.value||{}}),this.control())})})}verifyData(t){return(t?Promise.resolve():this.setDirty()).then(()=>this.validate()).then(e=>(this.setErrorProps(t),e))}connected(){super.connected(),setTimeout(()=>this.validate(!0))}setValue(t,e){if("object"!=typeof t)return;const i=JSON.stringify(t);JSON.stringify(t)!==this._serializedValue&&t&&(this._serializedValue=i,this.value=t,e||this.validate().then(t=>{t&&this.emit("input",this.value)}),this.control())}setFieldValue(t,e){const{fields:i}=this;isEqual(this.value[t],e)||(null!=e?(this.value[t]=e,i[t]&&this.resetFieldWarning(t)):delete this.value[t],this.validate())}registerCheck(t,e,i,r){this.validators[t]||(this.validators[t]={}),this.checks[t]||(this.checks[t]={}),this.validators[t][i]=r,this.checks[t][i]=e}registerField(t,e){this.fields[t]=e}unregisterCheck(t,e){delete this.validators[t][e],delete this.checks[t][e]}unregisterField(t){delete this.fields[t]}connectForm(){super.connectForm();const t=this.validators;this.validators=Object.create(this.form.validators),Object.keys(t).forEach(e=>{this.validators[e]=t[e]})}validate(t){return checkErrors(this.value,this.validators).then(t=>(t?this.value.$errors=t:delete this.value.$errors,!t))}setDirty(){const t=deepQueryAll(this.host,"[is-form]");return this.dirty=!0,Promise.all(t.map(t=>t.use("form").then(t=>t.setDirty().then(()=>t.validate()).then(()=>t.setErrorProps()))))}setErrorProps(t){const e=Object.keys(this.validators),i=this.value.$errors||{},r=this.fields,s=this.checks;e.forEach(e=>{if(t&&t!==e)return;const n=Object.keys(this.validators[e]),a=s[e];let o=!1;for(let t of n)i&&i[e]&&i[e][t]&&!o?(o=!0,a[t].setValidity(!1)):a[t].setValidity(!0);r[e]&&r[e].setValidity(!o)})}resetFieldWarning(t){const e=this.fields[t],i=Object.keys(this.validators[t]||{});for(let e of i){const i=`--check-${t}-${e}`;this.host.style.setProperty(i,"none")}e&&e.setValidity(!0)}}export default FormBehavior;