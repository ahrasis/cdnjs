var parse=require("../parse"),html=require("../static").html,text=require("../static").text,updateDOM=parse.update,utils=require("../utils"),domEach=utils.domEach,cloneDom=utils.cloneDom,isHtml=utils.isHtml,slice=Array.prototype.slice,domhandler=require("domhandler"),DomUtils=require("htmlparser2").DomUtils;exports._makeDomArray=function(t,n){return null==t?[]:t.cheerio?n?cloneDom(t.get(),t.options):t.get():Array.isArray(t)?t.reduce(function(t,e){return t.concat(this._makeDomArray(e,n))}.bind(this),[]):"string"==typeof t?parse(t,this.options,!1).children:n?cloneDom([t]):[t]};var _insert=function(o){return function(){var r=slice.call(arguments),i=this.length-1;return domEach(this,function(t,e){var n="function"==typeof r[0]?r[0].call(e,t,html(e.children)):r,t=this._makeDomArray(n,t<i);o(t,e.children,e)})}},uniqueSplice=function(t,e,n,r,i){for(var o,c,l,s=[e,n].concat(r),h=t[e-1]||null,a=t[e+n]||null,u=0,p=r.length;u<p;++u)o=(l=(c=r[u]).parent)&&l.children.indexOf(r[u]),l&&-1<o&&(l.children.splice(o,1),i===l&&o<e&&s[0]--),c.parent=i,c.prev&&(c.prev.next=c.next||null),c.next&&(c.next.prev=c.prev||null),c.prev=r[u-1]||h,c.next=r[u+1]||a;return h&&(h.next=r[0]),a&&(a.prev=r[r.length-1]),t.splice.apply(t,s)};function _wrap(h){return function(t){for(var e="function"==typeof t&&t,n=this.length-1,r=this.parents().last(),i=0;i<this.length;i++){var o,c,l,s=this[i];for(e&&(t=e.call(s,i)),"string"!=typeof t||isHtml(t)||(t=r.find(t).clone()),c=(o=this._makeDomArray(t,i<n).slice(0,1))[0],l=0;c&&c.children&&!(l>=c.children.length);)"tag"===c.children[l].type?(c=c.children[l],l=0):l++;h(s,c,o)}return this}}exports.appendTo=function(t){return t.cheerio||(t=this.constructor.call(this.constructor,t,null,this._originalRoot)),t.append(this),this},exports.prependTo=function(t){return t.cheerio||(t=this.constructor.call(this.constructor,t,null,this._originalRoot)),t.prepend(this),this},exports.append=_insert(function(t,e,n){uniqueSplice(e,e.length,0,t,n)}),exports.prepend=_insert(function(t,e,n){uniqueSplice(e,0,0,t,n)}),exports.wrap=_wrap(function(t,e,n){var r=t.parent,i=r.children,o=i.indexOf(t);updateDOM([t],e),uniqueSplice(i,o,0,n,r)}),exports.wrapInner=_wrap(function(t,e,n){updateDOM(t.children,e),updateDOM(n,t)}),exports.after=function(){var o=slice.call(arguments),c=this.length-1;return domEach(this,function(t,e){var n,r,i=e.parent;i&&((r=(n=i.children).indexOf(e))<0||(e="function"==typeof o[0]?o[0].call(e,t,html(e.children)):o,t=this._makeDomArray(e,t<c),uniqueSplice(n,r+1,0,t,i)))}),this},exports.insertAfter=function(t){var o=[],c=this;return"string"==typeof t&&(t=this.constructor.call(this.constructor,t,null,this._originalRoot)),t=this._makeDomArray(t),c.remove(),domEach(t,function(t,e){var n,r=c._makeDomArray(c.clone()),i=e.parent;i&&((e=(n=i.children).indexOf(e))<0||(uniqueSplice(n,e+1,0,r,i),o.push(r)))}),this.constructor.call(this.constructor,this._makeDomArray(o))},exports.before=function(){var o=slice.call(arguments),c=this.length-1;return domEach(this,function(t,e){var n,r,i=e.parent;i&&((r=(n=i.children).indexOf(e))<0||(e="function"==typeof o[0]?o[0].call(e,t,html(e.children)):o,t=this._makeDomArray(e,t<c),uniqueSplice(n,r,0,t,i)))}),this},exports.insertBefore=function(t){var o=[],c=this;return"string"==typeof t&&(t=this.constructor.call(this.constructor,t,null,this._originalRoot)),t=this._makeDomArray(t),c.remove(),domEach(t,function(t,e){var n,r=c._makeDomArray(c.clone()),i=e.parent;i&&((e=(n=i.children).indexOf(e))<0||(uniqueSplice(n,e,0,r,i),o.push(r)))}),this.constructor.call(this.constructor,this._makeDomArray(o))},exports.remove=function(t){var e=this;return t&&(e=e.filter(t)),domEach(e,function(t,e){DomUtils.removeElement(e),e.prev=e.next=e.parent=null}),this},exports.replaceWith=function(o){var c=this;return domEach(this,function(t,e){var n,r,i=e.parent;i&&(n=i.children,r=c._makeDomArray("function"==typeof o?o.call(e,t,e):o),updateDOM(r,null),t=n.indexOf(e),uniqueSplice(n,t,1,r,i),e.parent=e.prev=e.next=null)}),this},exports.empty=function(){return domEach(this,function(t,e){e.children.forEach(function(t){t.next=t.prev=t.parent=null}),e.children.length=0}),this},exports.html=function(r){if(void 0===r)return this[0]&&this[0].children?html(this[0].children,this.options):null;var i=this.options;return domEach(this,function(t,e){e.children.forEach(function(t){t.next=t.prev=t.parent=null});var n=r.cheerio?r.clone().get():parse(""+r,i,!1).children;updateDOM(n,e)}),this},exports.toString=function(){return html(this,this.options)},exports.text=function(r){if(void 0===r)return text(this);if("function"!=typeof r)return domEach(this,function(t,e){e.children.forEach(function(t){t.next=t.prev=t.parent=null});var n=new domhandler.Text(r);updateDOM(n,e)}),this;var n=this;return domEach(this,function(t,e){return exports.text.call(n._make(e),r.call(e,t,text([e])))})},exports.clone=function(){return this._make(cloneDom(this.get(),this.options))};