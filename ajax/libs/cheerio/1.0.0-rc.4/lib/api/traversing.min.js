var select=require("cheerio-select"),utils=require("../utils"),domEach=utils.domEach,uniqueSort=require("htmlparser2").DomUtils.uniqueSort,isTag=utils.isTag;function getFilterFn(e){return"function"==typeof e?function(t,r){return e.call(t,r,t)}:e.cheerio?e.is.bind(e):function(t){return e===t}}function traverseParents(t,r,e,i){for(var n=[];r&&n.length<i&&"root"!==r.type;)e&&!exports.filter.call([r],e,t).length||n.push(r),r=r.parent;return n}exports.find=function(t){var r=this.toArray().reduce(function(t,r){return t.concat(r.children.filter(isTag))},[]),i=this.constructor.contains;if(t&&"string"!=typeof t)return e=t.cheerio?t.get():[t],this._make(e.filter(function(t){for(var r=0,e=this.length;r<e;++r)if(i(this[r],t))return!0},this));var e={__proto__:this.options,context:this.toArray()};return this._make(select.select(t||"",r,e))},exports.parent=function(t){var e=[];return domEach(this,function(t,r){r=r.parent;r&&"root"!==r.type&&e.indexOf(r)<0&&e.push(r)}),arguments.length&&(e=exports.filter.call(e,t,this)),this._make(e)},exports.parents=function(r){var e=[];return this.get().reverse().forEach(function(t){traverseParents(this,t.parent,r,1/0).forEach(function(t){-1===e.indexOf(t)&&e.push(t)})},this),this._make(e)},exports.parentsUntil=function(t,r){var e,i,n=[];return"string"==typeof t?e=select.select(t,this.parents().toArray(),this.options)[0]:t&&t.cheerio?i=t.toArray():t&&(e=t),this.toArray().reverse().forEach(function(t){for(;(t=t.parent)&&(e&&t!==e||i&&-1===i.indexOf(t)||!e&&!i);)isTag(t)&&-1===n.indexOf(t)&&n.push(t)},this),this._make(r?select.select(r,n,this.options):n)},exports.closest=function(e){var i=[];return e&&domEach(this,function(t,r){r=traverseParents(this,r,e,1)[0];r&&i.indexOf(r)<0&&i.push(r)}),this._make(i)},exports.next=function(t){if(!this[0])return this;var r=[];return this.toArray().forEach(function(t){for(;t=t.next;)if(isTag(t))return void r.push(t)}),t?exports.filter.call(r,t,this):this._make(r)},exports.nextAll=function(t){if(!this[0])return this;var r=[];return this.toArray().forEach(function(t){for(;t=t.next;)isTag(t)&&-1===r.indexOf(t)&&r.push(t)}),t?exports.filter.call(r,t,this):this._make(r)},exports.nextUntil=function(t,r){if(!this[0])return this;var e,i,n=[];return"string"==typeof t?e=select.select(t,this.nextAll().get(),this.options)[0]:t&&t.cheerio?i=t.get():t&&(e=t),this.toArray().forEach(function(t){for(;(t=t.next)&&(e&&t!==e||i&&-1===i.indexOf(t)||!e&&!i);)isTag(t)&&-1===n.indexOf(t)&&n.push(t)}),r?exports.filter.call(n,r,this):this._make(n)},exports.prev=function(t){if(!this[0])return this;var r=[];return this.toArray().forEach(function(t){for(;t=t.prev;)if(isTag(t))return void r.push(t)}),t?exports.filter.call(r,t,this):this._make(r)},exports.prevAll=function(t){if(!this[0])return this;var r=[];return this.toArray().forEach(function(t){for(;t=t.prev;)isTag(t)&&-1===r.indexOf(t)&&r.push(t)}),t?exports.filter.call(r,t,this):this._make(r)},exports.prevUntil=function(t,r){if(!this[0])return this;var e,i,n=[];return"string"==typeof t?e=select.select(t,this.prevAll().get(),this.options)[0]:t&&t.cheerio?i=t.get():t&&(e=t),this.toArray().forEach(function(t){for(;(t=t.prev)&&(e&&t!==e||i&&-1===i.indexOf(t)||!e&&!i);)isTag(t)&&-1===n.indexOf(t)&&n.push(t)}),r?exports.filter.call(n,r,this):this._make(n)},exports.siblings=function(t){var r=this.parent(),r=(r?r.children():this.siblingsAndMe()).toArray().filter(function(t){return isTag(t)&&!this.is(t)},this);return void 0!==t?exports.filter.call(r,t,this):this._make(r)},exports.children=function(t){var r=this.toArray().reduce(function(t,r){return t.concat(r.children.filter(isTag))},[]);return void 0===t?this._make(r):exports.filter.call(r,t,this)},exports.contents=function(){var t=this.toArray().reduce(function(t,r){return t.concat(r.children)},[]);return this._make(t)},exports.each=function(t){for(var r=0,e=this.length;r<e&&!1!==t.call(this[r],r,this[r]);)++r;return this},exports.map=function(t){for(var r=[],e=0;e<this.length;e++){var i=this[e],i=t.call(i,e,i);null!=i&&(r=r.concat(i))}return this._make(r)},exports.filter=function(t,r){r=r||this;var e=this.toArray?this.toArray():this,e="string"==typeof t?select.filter(t,e,r.options):e.filter(getFilterFn(t));return r._make(e)},exports.not=function(t,r){var e,i,n=(r=r||this).toArray?r.toArray():r,n="string"==typeof t?(e=new Set(select.filter(t,n,this.options)),n.filter(function(t){return!e.has(t)})):(i=getFilterFn(t),n.filter(function(t,r){return!i(t,r)}));return r._make(n)},exports.has=function(t){var r=this;return exports.filter.call(this,function(){return 0<r._make(this).find(t).length})},exports.first=function(){return 1<this.length?this._make(this[0]):this},exports.last=function(){return 1<this.length?this._make(this[this.length-1]):this},exports.eq=function(t){return 0===(t=+t)&&this.length<=1?this:(t<0&&(t=this.length+t),this[t]?this._make(this[t]):this._make([]))},exports.get=function(t){return null==t?Array.prototype.slice.call(this):this[t<0?this.length+t:t]},exports.index=function(t){var r,e=0===arguments.length?(r=this.parent().children(),this[0]):"string"==typeof t?(r=this._make(t),this[0]):(r=this,t.cheerio?t[0]:t);return r.get().indexOf(e)},exports.slice=function(){return this._make([].slice.apply(this,arguments))},exports.end=function(){return this.prevObject||this._make([])},exports.add=function(t,r){for(var e=this._make(t,r),i=uniqueSort(e.get().concat(this.get())),n=0;n<i.length;++n)e[n]=i[n];return e.length=i.length,e},exports.addBack=function(t){return this.add(arguments.length?this.prevObject.filter(t):this.prevObject)};