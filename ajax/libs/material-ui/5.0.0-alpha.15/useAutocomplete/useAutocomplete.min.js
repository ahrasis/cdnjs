import _extends from"@babel/runtime/helpers/esm/extends";import*as React from"react";import{setRef,useEventCallback,useControlled,unstable_useId as useId}from"../utils";function stripDiacritics(e){return void 0!==e.normalize?e.normalize("NFD").replace(/[\u0300-\u036f]/g,""):e}export function createFilterOptions(e={}){const{ignoreAccents:t=!0,ignoreCase:n=!0,limit:r,matchFrom:o="any",stringify:i,trim:l=!1}=e;return(e,{inputValue:a,getOptionLabel:s})=>{let u=l?a.trim():a;n&&(u=u.toLowerCase()),t&&(u=stripDiacritics(u));const c=e.filter(e=>{let r=(i||s)(e);return n&&(r=r.toLowerCase()),t&&(r=stripDiacritics(r)),"start"===o?0===r.indexOf(u):r.indexOf(u)>-1});return"number"==typeof r?c.slice(0,r):c}};function findIndex(e,t){for(let n=0;n<e.length;n+=1)if(t(e[n]))return n;return-1}const defaultFilterOptions=createFilterOptions(),pageSize=5;export default function useAutocomplete(e){const{autoComplete:t=!1,autoHighlight:n=!1,autoSelect:r=!1,blurOnSelect:o=!1,clearOnBlur:i=!e.freeSolo,clearOnEscape:l=!1,componentName:a="useAutocomplete",debug:s=!1,defaultValue:u=(e.multiple?[]:null),disableClearable:c=!1,disableCloseOnSelect:d=!1,disabledItemsFocusable:p=!1,disableListWrap:f=!1,filterOptions:g=defaultFilterOptions,filterSelectedOptions:b=!1,freeSolo:h=!1,getOptionDisabled:v,getOptionLabel:m=(e=>{var t;return null!==(t=e.label)&&void 0!==t?t:e}),getOptionSelected:x=((e,t)=>e===t),groupBy:y,handleHomeEndKeys:O=!e.freeSolo,id:k,includeInputInList:S=!1,inputValue:C,multiple:D=!1,onChange:E,onClose:R,onHighlightChange:w,onInputChange:I,onOpen:A,open:$,openOnFocus:T=!1,options:L,selectOnFocus:N=!e.freeSolo,value:M}=e,P=useId(k);let V=m;"production"!==process.env.NODE_ENV&&(V=(e=>{const t=m(e);if("string"!=typeof t){const n=void 0===t?"undefined":`${typeof t} (${t})`;console.error(`Material-UI: The \`getOptionLabel\` method of ${a} returned ${n} instead of a string for ${JSON.stringify(e)}.`)}return t}));const F=React.useRef(!1),H=React.useRef(!0),q=React.useRef(null),z=React.useRef(null),[_,B]=React.useState(null),[K,U]=React.useState(-1),J=n?0:-1,j=React.useRef(J),[Y,W]=useControlled({controlled:M,default:u,name:a}),[G,Q]=useControlled({controlled:C,default:"",name:a,state:"inputValue"}),[X,Z]=React.useState(!1),ee=useEventCallback((e,t)=>{let n;if(D)n="";else if(null==t)n="";else{const e=V(t);n="string"==typeof e?e:""}G!==n&&(Q(n),I&&I(e,n,"reset"))});React.useEffect(()=>{ee(null,Y)},[Y,ee]);const[te,ne]=useControlled({controlled:$,default:!1,name:a,state:"open"}),[re,oe]=React.useState(!0),ie=!D&&null!=Y&&G===V(Y),le=te,ae=le?g(L.filter(e=>!b||!(D?Y:[Y]).some(t=>null!==t&&x(e,t))),{inputValue:ie&&re?"":G,getOptionLabel:V}):[],se=te&&ae.length>0;if("production"!==process.env.NODE_ENV&&null!==Y&&!h&&L.length>0){const e=(D?Y:[Y]).filter(e=>!L.some(t=>x(t,e)));e.length>0&&console.warn([`Material-UI: The value provided to ${a} is invalid.`,`None of the options match with \`${e.length>1?JSON.stringify(e):JSON.stringify(e[0])}\`.`,"You can use the `getOptionSelected` prop to customize the equality test."].join("\n"))}const ue=useEventCallback(e=>{-1===e?q.current.focus():_.querySelector(`[data-tag-index="${e}"]`).focus()});React.useEffect(()=>{D&&K>Y.length-1&&(U(-1),ue(-1))},[Y,D,K,ue]);const ce=useEventCallback(({event:e,index:t,reason:n="auto"})=>{if(j.current=t,-1===t?q.current.removeAttribute("aria-activedescendant"):q.current.setAttribute("aria-activedescendant",`${P}-option-${t}`),w&&w(e,-1===t?null:ae[t],n),!z.current)return;const r=z.current.querySelector("[data-focus]");r&&(r.removeAttribute("data-focus"),r.classList.remove("Mui-focusVisible"));const o=z.current.parentElement.querySelector('[role="listbox"]');if(!o)return;if(-1===t)return void(o.scrollTop=0);const i=z.current.querySelector(`[data-option-index="${t}"]`);if(i&&(i.setAttribute("data-focus","true"),"keyboard"===n&&i.classList.add("Mui-focusVisible"),o.scrollHeight>o.clientHeight&&"mouse"!==n)){const e=i,t=o.clientHeight+o.scrollTop,n=e.offsetTop+e.offsetHeight;n>t?o.scrollTop=n-o.clientHeight:e.offsetTop-e.offsetHeight*(y?1.3:0)<o.scrollTop&&(o.scrollTop=e.offsetTop-e.offsetHeight*(y?1.3:0))}}),de=useEventCallback(({event:e,diff:n,direction:r="next",reason:o="auto"})=>{if(!le)return;const i=function(e,t){if(!z.current||-1===e)return-1;let n=e;for(;;){if("next"===t&&n===ae.length||"previous"===t&&-1===n)return-1;const e=z.current.querySelector(`[data-option-index="${n}"]`),r=!p&&(!e||e.disabled||"true"===e.getAttribute("aria-disabled"));if(!(e&&!e.hasAttribute("tabindex")||r))return n;n+="next"===t?1:-1}}((()=>{const e=ae.length-1;if("reset"===n)return J;if("start"===n)return 0;if("end"===n)return e;const t=j.current+n;return t<0?-1===t&&S?-1:f&&-1!==j.current||Math.abs(n)>1?0:e:t>e?t===e+1&&S?-1:f||Math.abs(n)>1?e:0:t})(),r);if(ce({index:i,reason:o,event:e}),t&&"reset"!==n)if(-1===i)q.current.value=G;else{const e=V(ae[i]);q.current.value=e,0===e.toLowerCase().indexOf(G.toLowerCase())&&G.length>0&&q.current.setSelectionRange(G.length,e.length)}}),pe=React.useCallback(()=>{if(!le)return;const e=D?Y[0]:Y;if(0!==ae.length&&null!=e){if(z.current)if(null==e)j.current>=ae.length-1?ce({index:ae.length-1}):ce({index:j.current});else{const t=ae[j.current];if(D&&t&&-1!==findIndex(Y,e=>x(t,e)))return;const n=findIndex(ae,t=>x(t,e));-1===n?de({diff:"reset"}):ce({index:n})}}else de({diff:"reset"})},[0===ae.length,!D&&Y,b,de,ce,le,G,D]),fe=useEventCallback(e=>{setRef(z,e),e&&pe()});React.useEffect(()=>{pe()},[pe]);const ge=e=>{te||(ne(!0),oe(!0),A&&A(e))},be=(e,t)=>{te&&(ne(!1),R&&R(e,t))},he=(e,t,n,r)=>{Y!==t&&(E&&E(e,t,n,r),W(t))},ve=React.useRef(!1),me=(e,t,n="select-option",r="options")=>{let i=n,l=t;if(D){if(l=Array.isArray(Y)?Y.slice():[],"production"!==process.env.NODE_ENV){const e=l.filter(e=>x(t,e));e.length>1&&console.error([`Material-UI: The \`getOptionSelected\` method of ${a} do not handle the arguments correctly.`,`The component expects a single value to match a given option but found ${e.length} matches.`].join("\n"))}const e=findIndex(l,e=>x(t,e));-1===e?l.push(t):"freeSolo"!==r&&(l.splice(e,1),i="remove-option")}ee(e,l),he(e,l,i,{option:t}),d||e.ctrlKey||e.metaKey||be(e,i),(!0===o||"touch"===o&&ve.current||"mouse"===o&&!ve.current)&&q.current.blur()};const xe=(e,t)=>{if(!D)return;be(e,"toggleInput");let n=K;-1===K?""===G&&"previous"===t&&(n=Y.length-1):((n+="next"===t?1:-1)<0&&(n=0),n===Y.length&&(n=-1)),n=function(e,t){if(-1===e)return-1;let n=e;for(;;){if("next"===t&&n===Y.length||"previous"===t&&-1===n)return-1;const e=_.querySelector(`[data-tag-index="${n}"]`);if(e&&e.hasAttribute("tabindex")&&!e.disabled&&"true"!==e.getAttribute("aria-disabled"))return n;n+="next"===t?1:-1}}(n,t),U(n),ue(n)},ye=e=>{F.current=!0,Q(""),I&&I(e,"","clear"),he(e,D?[]:null,"clear")},Oe=e=>{ce({event:e,index:Number(e.currentTarget.getAttribute("data-option-index")),reason:"mouse"})},ke=()=>{ve.current=!0},Se=e=>{const t=Number(e.currentTarget.getAttribute("data-option-index"));me(e,ae[t],"select-option"),ve.current=!1},Ce=e=>{te?be(e,"toggleInput"):ge(e)},De=e=>{e.target.getAttribute("id")!==P&&e.preventDefault()},Ee=()=>{q.current.focus(),N&&H.current&&q.current.selectionEnd-q.current.selectionStart==0&&q.current.select(),H.current=!1};let Re=h&&G.length>0;Re=Re||(D?Y.length>0:null!==Y);let we=ae;if(y){const e=new Map;let t=!1;we=ae.reduce((n,r,o)=>{const i=y(r);return n.length>0&&n[n.length-1].group===i?n[n.length-1].options.push(r):("production"!==process.env.NODE_ENV&&(e.get(i)&&!t&&(console.warn(`Material-UI: The options provided combined with the \`groupBy\` method of ${a} returns duplicated headers.`,"You can solve the issue by sorting the options with the output of `groupBy`."),t=!0),e.set(i,!0)),n.push({key:o,index:o,group:i,options:[r]})),n},[])}return{getRootProps:(e={})=>_extends({"aria-owns":se?`${P}-listbox`:null,role:"combobox","aria-expanded":se},e,{onKeyDown:(e=>n=>{if(-1!==K&&-1===["ArrowLeft","ArrowRight"].indexOf(n.key)&&(U(-1),ue(-1)),229!==n.which)switch(n.key){case"Home":le&&O&&(n.preventDefault(),de({diff:"start",direction:"next",reason:"keyboard",event:n}));break;case"End":le&&O&&(n.preventDefault(),de({diff:"end",direction:"previous",reason:"keyboard",event:n}));break;case"PageUp":n.preventDefault(),de({diff:-pageSize,direction:"previous",reason:"keyboard",event:n}),ge(n);break;case"PageDown":n.preventDefault(),de({diff:pageSize,direction:"next",reason:"keyboard",event:n}),ge(n);break;case"ArrowDown":n.preventDefault(),de({diff:1,direction:"next",reason:"keyboard",event:n}),ge(n);break;case"ArrowUp":n.preventDefault(),de({diff:-1,direction:"previous",reason:"keyboard",event:n}),ge(n);break;case"ArrowLeft":xe(n,"previous");break;case"ArrowRight":xe(n,"next");break;case"Enter":if(-1!==j.current&&le){const e=ae[j.current],r=!!v&&v(e);if(n.preventDefault(),r)return;me(n,e,"select-option"),t&&q.current.setSelectionRange(q.current.value.length,q.current.value.length)}else h&&""!==G&&!1===ie&&(D&&n.preventDefault(),me(n,G,"create-option","freeSolo"));break;case"Escape":le?(n.preventDefault(),n.stopPropagation(),be(n,"escape")):l&&(""!==G||D&&Y.length>0)&&(n.preventDefault(),n.stopPropagation(),ye(n));break;case"Backspace":if(D&&""===G&&Y.length>0){const e=-1===K?Y.length-1:K,t=Y.slice();t.splice(e,1),he(n,t,"remove-option",{option:Y[e]})}}e.onKeyDown&&e.onKeyDown(n)})(e),onMouseDown:De,onClick:Ee}),getInputLabelProps:()=>({id:`${P}-label`,htmlFor:P}),getInputProps:()=>({id:P,value:G,onBlur:e=>{null!==z.current&&z.current.parentElement.contains(document.activeElement)?q.current.focus():(Z(!1),H.current=!0,F.current=!1,s&&""!==G||(r&&-1!==j.current&&le?me(e,ae[j.current],"blur"):r&&h&&""!==G?me(e,G,"blur","freeSolo"):i&&ee(e,Y),be(e,"blur")))},onFocus:e=>{Z(!0),T&&!F.current&&ge(e)},onChange:e=>{const t=e.target.value;G!==t&&(Q(t),oe(!1),I&&I(e,t,"input")),""===t?c||D||he(e,null,"clear"):ge(e)},onMouseDown:e=>{""!==G&&te||Ce(e)},"aria-activedescendant":le?"":null,"aria-autocomplete":t?"both":"list","aria-controls":se?`${P}-listbox`:null,autoComplete:"off",ref:q,autoCapitalize:"none",spellCheck:"false"}),getClearProps:()=>({tabIndex:-1,onClick:ye}),getPopupIndicatorProps:()=>({tabIndex:-1,onClick:Ce}),getTagProps:({index:e})=>({key:e,"data-tag-index":e,tabIndex:-1,onDelete:(e=>t=>{const n=Y.slice();n.splice(e,1),he(t,n,"remove-option",{option:Y[e]})})(e)}),getListboxProps:()=>({role:"listbox",id:`${P}-listbox`,"aria-labelledby":`${P}-label`,ref:fe,onMouseDown:e=>{e.preventDefault()}}),getOptionProps:({index:e,option:t})=>{const n=(D?Y:[Y]).some(e=>null!=e&&x(t,e)),r=!!v&&v(t);return{key:e,tabIndex:-1,role:"option",id:`${P}-option-${e}`,onMouseOver:Oe,onClick:Se,onTouchStart:ke,"data-option-index":e,"aria-disabled":r,"aria-selected":n}},id:P,inputValue:G,value:Y,dirty:Re,popupOpen:le,focused:X||-1!==K,anchorEl:_,setAnchorEl:B,focusedTag:K,groupedOptions:we}};