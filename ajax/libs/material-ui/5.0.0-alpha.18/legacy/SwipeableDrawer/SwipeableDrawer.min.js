import _objectWithoutProperties from"@babel/runtime/helpers/esm/objectWithoutProperties";import _extends from"@babel/runtime/helpers/esm/extends";import*as React from"react";import PropTypes from"prop-types";import{elementTypeAcceptingRef}from"@material-ui/utils";import{getThemeProps}from"@material-ui/styles";import Drawer,{getAnchor,isHorizontal}from"../Drawer/Drawer";import ownerDocument from"../utils/ownerDocument";import ownerWindow from"../utils/ownerWindow";import useEventCallback from"../utils/useEventCallback";import useEnhancedEffect from"../utils/useEnhancedEffect";import{duration}from"../styles/transitions";import useTheme from"../styles/useTheme";import{getTransitionProps}from"../transitions/utils";import NoSsr from"../NoSsr";import SwipeArea from"./SwipeArea";var UNCERTAINTY_THRESHOLD=3,DRAG_STARTED_SIGNAL=20,nodeThatClaimedTheSwipe=null;export function reset(){nodeThatClaimedTheSwipe=null};function calculateCurrentX(e,r,t){return"right"===e?t.body.offsetWidth-r[0].pageX:r[0].pageX}function calculateCurrentY(e,r,t){return"bottom"===e?t.innerHeight-r[0].clientY:r[0].clientY}function getMaxTranslate(e,r){return e?r.clientWidth:r.clientHeight}function getTranslate(e,r,t,n){return Math.min(Math.max(t?r-e:n+r-e,0),n)}function getDomTreeShapes(e,r){for(var t=[];e&&e!==r.parentElement;){var n=ownerWindow(r).getComputedStyle(e);"absolute"===n.getPropertyValue("position")||"hidden"===n.getPropertyValue("overflow-x")?t=[]:(e.clientWidth>0&&e.scrollWidth>e.clientWidth||e.clientHeight>0&&e.scrollHeight>e.clientHeight)&&t.push(e),e=e.parentElement}return t}function findNativeHandler(e){var r=e.domTreeShapes,t=e.start,n=e.current,a=e.anchor,o={x:"scrollLeft",y:"scrollTop"},i={x:"scrollWidth",y:"scrollHeight"},s={x:"clientWidth",y:"clientHeight"};return r.some(function(e){var r=n>=t;"top"!==a&&"left"!==a||(r=!r);var c="left"===a||"right"===a?"x":"y",u=e[o[c]],l=u>0,p=u+e[s[c]]<e[i[c]];return r&&p||!r&&l?e:null})}var iOS="undefined"!=typeof navigator&&/iPad|iPhone|iPod/.test(navigator.userAgent),transitionDurationDefault={enter:duration.enteringScreen,exit:duration.leavingScreen},SwipeableDrawer=React.forwardRef(function(e,r){var t=useTheme(),n=getThemeProps({name:"MuiSwipeableDrawer",props:_extends({},e),theme:t}),a=n.anchor,o=void 0===a?"left":a,i=n.disableBackdropTransition,s=void 0!==i&&i,c=n.disableDiscovery,u=void 0!==c&&c,l=n.disableSwipeToOpen,p=void 0===l?iOS:l,d=n.hideBackdrop,T=n.hysteresis,m=void 0===T?.52:T,f=n.minFlingVelocity,h=void 0===f?450:f,v=n.ModalProps,g=(v=void 0===v?{}:v).BackdropProps,y=_objectWithoutProperties(v,["BackdropProps"]),w=n.onClose,P=n.onOpen,S=n.open,b=n.PaperProps,R=void 0===b?{}:b,D=n.SwipeAreaProps,E=n.swipeAreaWidth,A=void 0===E?20:E,C=n.transitionDuration,x=void 0===C?transitionDurationDefault:C,H=n.variant,_=void 0===H?"temporary":H,N=_objectWithoutProperties(n,["anchor","disableBackdropTransition","disableDiscovery","disableSwipeToOpen","hideBackdrop","hysteresis","minFlingVelocity","ModalProps","onClose","onOpen","open","PaperProps","SwipeAreaProps","swipeAreaWidth","transitionDuration","variant"]),M=React.useState(!1),W=M[0],Y=M[1],k=React.useRef({isSwiping:null}),O=React.useRef(),L=React.useRef(),X=React.useRef(),B=React.useRef(!1),I=React.useRef();useEnhancedEffect(function(){I.current=null},[S]);var G=React.useCallback(function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=r.mode,a=void 0===n?null:n,i=r.changeTransition,c=void 0===i||i,u=getAnchor(t,o),l=-1!==["right","bottom"].indexOf(u)?1:-1,p=isHorizontal(o),T=p?"translate(".concat(l*e,"px, 0)"):"translate(0, ".concat(l*e,"px)"),m=X.current.style;m.webkitTransform=T,m.transform=T;var f="";if(a&&(f=t.transitions.create("all",getTransitionProps({timeout:x},{mode:a}))),c&&(m.webkitTransition=f,m.transition=f),!s&&!d){var h=L.current.style;h.opacity=1-e/getMaxTranslate(p,X.current),c&&(h.webkitTransition=f,h.transition=f)}},[o,s,d,t,x]),j=useEventCallback(function(e){if(B.current)if(nodeThatClaimedTheSwipe=null,B.current=!1,Y(!1),k.current.isSwiping){k.current.isSwiping=null;var r,n=getAnchor(t,o),a=isHorizontal(o);r=a?calculateCurrentX(n,e.changedTouches,ownerDocument(e.currentTarget)):calculateCurrentY(n,e.changedTouches,ownerWindow(e.currentTarget));var i=a?k.current.startX:k.current.startY,s=getMaxTranslate(a,X.current),c=getTranslate(r,i,S,s),u=c/s;Math.abs(k.current.velocity)>h&&(I.current=1e3*Math.abs((s-c)/k.current.velocity)),S?k.current.velocity>h||u>m?w():G(0,{mode:"exit"}):k.current.velocity<-h||1-u>m?P():G(getMaxTranslate(a,X.current),{mode:"enter"})}else k.current.isSwiping=null}),V=useEventCallback(function(e){if(X.current&&B.current&&(null==nodeThatClaimedTheSwipe||nodeThatClaimedTheSwipe===k.current)){var r=getAnchor(t,o),n=isHorizontal(o),a=calculateCurrentX(r,e.touches,ownerDocument(e.currentTarget)),i=calculateCurrentY(r,e.touches,ownerWindow(e.currentTarget));if(S&&X.current.contains(e.target)&&null==nodeThatClaimedTheSwipe){var s=findNativeHandler({domTreeShapes:getDomTreeShapes(e.target,X.current),start:n?k.current.startX:k.current.startY,current:n?a:i,anchor:o});if(s)return void(nodeThatClaimedTheSwipe=s);nodeThatClaimedTheSwipe=k.current}if(null==k.current.isSwiping){var c=Math.abs(a-k.current.startX),l=Math.abs(i-k.current.startY);c>l&&e.cancelable&&e.preventDefault();var p=n?c>l&&c>UNCERTAINTY_THRESHOLD:l>c&&l>UNCERTAINTY_THRESHOLD;if(!0===p||(n?l>UNCERTAINTY_THRESHOLD:c>UNCERTAINTY_THRESHOLD)){if(k.current.isSwiping=p,!p)return void j(e);k.current.startX=a,k.current.startY=i,u||S||(n?k.current.startX-=DRAG_STARTED_SIGNAL:k.current.startY-=DRAG_STARTED_SIGNAL)}}if(k.current.isSwiping){var d=getMaxTranslate(n,X.current),T=n?k.current.startX:k.current.startY;S&&!k.current.paperHit&&(T=Math.min(T,d));var m=getTranslate(n?a:i,T,S,d);if(S)if(k.current.paperHit)0===m&&(k.current.startX=a,k.current.startY=i);else{if(!(n?a<d:i<d))return;k.current.paperHit=!0,k.current.startX=a,k.current.startY=i}null===k.current.lastTranslate&&(k.current.lastTranslate=m,k.current.lastTime=performance.now()+1);var f=(m-k.current.lastTranslate)/(performance.now()-k.current.lastTime)*1e3;k.current.velocity=.4*k.current.velocity+.6*f,k.current.lastTranslate=m,k.current.lastTime=performance.now(),e.cancelable&&e.preventDefault(),G(m)}}}),z=useEventCallback(function(e){if(!e.defaultPrevented&&!e.defaultMuiPrevented&&(!S||L.current.contains(e.target)||X.current.contains(e.target))){var r=getAnchor(t,o),n=isHorizontal(o),a=calculateCurrentX(r,e.touches,ownerDocument(e.currentTarget)),i=calculateCurrentY(r,e.touches,ownerWindow(e.currentTarget));if(!S){if(p||e.target!==O.current)return;if(n){if(a>A)return}else if(i>A)return}e.defaultMuiPrevented=!0,nodeThatClaimedTheSwipe=null,k.current.startX=a,k.current.startY=i,Y(!0),!S&&X.current&&G(getMaxTranslate(n,X.current)+(u?15:-DRAG_STARTED_SIGNAL),{changeTransition:!1}),k.current.velocity=0,k.current.lastTime=null,k.current.lastTranslate=null,k.current.paperHit=!1,B.current=!0}});return React.useEffect(function(){if("temporary"===_){var e=ownerDocument(X.current);return e.addEventListener("touchstart",z),e.addEventListener("touchmove",V,{passive:!S}),e.addEventListener("touchend",j),function(){e.removeEventListener("touchstart",z),e.removeEventListener("touchmove",V,{passive:!S}),e.removeEventListener("touchend",j)}}},[_,S,z,V,j]),React.useEffect(function(){return function(){nodeThatClaimedTheSwipe===k.current&&(nodeThatClaimedTheSwipe=null)}},[]),React.useEffect(function(){S||Y(!1)},[S]),React.createElement(React.Fragment,null,React.createElement(Drawer,_extends({open:!("temporary"!==_||!W)||S,variant:_,ModalProps:_extends({BackdropProps:_extends({},g,{ref:L})},y),PaperProps:_extends({},R,{style:_extends({pointerEvents:"temporary"!==_||S?"":"none"},R.style),ref:X}),anchor:o,transitionDuration:I.current||x,onClose:w,ref:r},N)),!p&&"temporary"===_&&React.createElement(NoSsr,null,React.createElement(SwipeArea,_extends({anchor:o,ref:O,width:A},D))))});"production"!==process.env.NODE_ENV&&(SwipeableDrawer.propTypes={anchor:PropTypes.oneOf(["bottom","left","right","top"]),children:PropTypes.node,disableBackdropTransition:PropTypes.bool,disableDiscovery:PropTypes.bool,disableSwipeToOpen:PropTypes.bool,hideBackdrop:PropTypes.bool,hysteresis:PropTypes.number,minFlingVelocity:PropTypes.number,ModalProps:PropTypes.shape({BackdropProps:PropTypes.shape({component:elementTypeAcceptingRef})}),onClose:PropTypes.func.isRequired,onOpen:PropTypes.func.isRequired,open:PropTypes.bool.isRequired,PaperProps:PropTypes.shape({component:elementTypeAcceptingRef,style:PropTypes.object}),SwipeAreaProps:PropTypes.object,swipeAreaWidth:PropTypes.number,transitionDuration:PropTypes.oneOfType([PropTypes.number,PropTypes.shape({appear:PropTypes.number,enter:PropTypes.number,exit:PropTypes.number})]),variant:PropTypes.oneOf(["permanent","persistent","temporary"])});export default SwipeableDrawer;