!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase)}(this,function(Ev){"use strict";try{(function(){function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var f,t=e(Ev),r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function n(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function m(e,a,s,u){return new(s=s||Promise)(function(n,t){function r(e){try{o(u.next(e))}catch(e){t(e)}}function i(e){try{o(u.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,i)}o((u=u.apply(e,a||[])).next())})}function g(n,r){var i,o,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,o&&(a=2&t[0]?o.return:t[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,t[1])).done)return a;switch(o=0,a&&(t=[2&t[0],a.value]),t[0]){case 0:case 1:a=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,o=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){s.label=t[1];break}if(6===t[0]&&s.label<a[1]){s.label=a[1],a=t;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(t);break}a[2]&&s.ops.pop(),s.trys.pop();continue}t=r.call(n,s)}catch(e){t=[6,e],o=0}finally{i=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}function a(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;for(var r=Array(e),i=0,t=0;t<n;t++)for(var o=arguments[t],a=0,s=o.length;a<s;a++,i++)r[i]=o[a];return r}function s(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;for(var r=Array(e),i=0,t=0;t<n;t++)for(var o=arguments[t],a=0,s=o.length;a<s;a++,i++)r[i]=o[a];return r}(St=f=f||{})[St.DEBUG=0]="DEBUG",St[St.VERBOSE=1]="VERBOSE",St[St.INFO=2]="INFO",St[St.WARN=3]="WARN",St[St.ERROR=4]="ERROR",St[St.SILENT=5]="SILENT";function i(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(!(t<e.logLevel)){var i=(new Date).toISOString(),o=c[t];if(!o)throw new Error("Attempted to log a message with an invalid logType (value: "+t+")");console[o].apply(console,s(["["+i+"]  "+e.name+":"],n))}}var o={debug:f.DEBUG,verbose:f.VERBOSE,info:f.INFO,warn:f.WARN,error:f.ERROR,silent:f.SILENT},u=f.INFO,c=((It={})[f.DEBUG]="log",It[f.VERBOSE]="log",It[f.INFO]="info",It[f.WARN]="warn",It[f.ERROR]="error",It),l=(Object.defineProperty(h.prototype,"logLevel",{get:function(){return this._logLevel},set:function(e){if(!(e in f))throw new TypeError('Invalid value "'+e+'" assigned to `logLevel`');this._logLevel=e},enumerable:!1,configurable:!0}),h.prototype.setLogLevel=function(e){this._logLevel="string"==typeof e?o[e]:e},Object.defineProperty(h.prototype,"logHandler",{get:function(){return this._logHandler},set:function(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"userLogHandler",{get:function(){return this._userLogHandler},set:function(e){this._userLogHandler=e},enumerable:!1,configurable:!0}),h.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._userLogHandler&&this._userLogHandler.apply(this,s([this,f.DEBUG],e)),this._logHandler.apply(this,s([this,f.DEBUG],e))},h.prototype.log=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._userLogHandler&&this._userLogHandler.apply(this,s([this,f.VERBOSE],e)),this._logHandler.apply(this,s([this,f.VERBOSE],e))},h.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._userLogHandler&&this._userLogHandler.apply(this,s([this,f.INFO],e)),this._logHandler.apply(this,s([this,f.INFO],e))},h.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._userLogHandler&&this._userLogHandler.apply(this,s([this,f.WARN],e)),this._logHandler.apply(this,s([this,f.WARN],e))},h.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._userLogHandler&&this._userLogHandler.apply(this,s([this,f.ERROR],e)),this._logHandler.apply(this,s([this,f.ERROR],e))},h);function h(e){this.name=e,this._logLevel=u,this._logHandler=i,this._userLogHandler=null}function d(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}var p,y="FirebaseError",v=(n(b,p=Error),b);function b(e,t,n){t=p.call(this,t)||this;return t.code=e,t.customData=n,t.name=y,Object.setPrototypeOf(t,b.prototype),Error.captureStackTrace&&Error.captureStackTrace(t,w.prototype.create),t}var w=(T.prototype.create=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r,i=t[0]||{},o=this.service+"/"+e,e=this.errors[e],e=e?(r=i,e.replace(S,function(e,t){var n=r[t];return null!=n?String(n):"<"+t+"?>"})):"Error",e=this.serviceName+": "+e+" ("+o+").";return new v(o,e,i)},T);function T(e,t,n){this.service=e,this.serviceName=t,this.errors=n}var S=/\{\$([^}]+)}/g,I=function(e,t){return(I=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)};function E(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}var C,D="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},_={},k=D||self;function A(){}function N(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function x(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}var O="closure_uid_"+(1e9*Math.random()>>>0),R=0;function L(e,t,n){return e.call.apply(e.bind,arguments)}function P(t,n,e){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var e=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(e,r),t.apply(n,e)}}return function(){return t.apply(n,arguments)}}function M(e,t,n){return(M=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?L:P).apply(null,arguments)}function q(t){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function F(){return Date.now()}function B(e,o){function t(){}t.prototype=o.prototype,e.X=o.prototype,e.prototype=new t,(e.prototype.constructor=e).Kb=function(e,t,n){for(var r=Array(arguments.length-2),i=2;i<arguments.length;i++)r[i-2]=arguments[i];return o.prototype[t].apply(e,r)}}function V(){this.j=this.j,this.i=this.i}V.prototype.j=!1,V.prototype.ja=function(){var e;!this.j&&(this.j=!0,this.G(),0)&&(e=this,Object.prototype.hasOwnProperty.call(e,O)&&e[O]||(e[O]=++R))},V.prototype.G=function(){if(this.i)for(;this.i.length;)this.i.shift()()};var U=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(e,t){if("string"==typeof e)return"string"!=typeof t||1!=t.length?-1:e.indexOf(t,0);for(var n=0;n<e.length;n++)if(n in e&&e[n]===t)return n;return-1},K=Array.prototype.forEach?function(e,t,n){Array.prototype.forEach.call(e,t,n)}:function(e,t,n){for(var r=e.length,i="string"==typeof e?e.split(""):e,o=0;o<r;o++)o in i&&t.call(n,i[o],o,e)};function j(){return Array.prototype.concat.apply([],arguments)}function z(e){var t=e.length;if(0<t){for(var n=Array(t),r=0;r<t;r++)n[r]=e[r];return n}return[]}function Q(e){return/^[\s\xa0]*$/.test(e)}var G,W=String.prototype.trim?function(e){return e.trim()}:function(e){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(e)[1]};function H(e,t){return-1!=e.indexOf(t)}function Y(e,t){return e<t?-1:t<e?1:0}e:{var X=k.navigator;if(X){X=X.userAgent;if(X){G=X;break e}}G=""}function J(e,t,n){for(var r in e)t.call(n,e[r],r,e)}function $(e){var t,n={};for(t in e)n[t]=e[t];return n}var Z="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function ee(e){for(var t,n,r=1;r<arguments.length;r++){for(t in n=arguments[r])e[t]=n[t];for(var i=0;i<Z.length;i++)t=Z[i],Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}}function te(e){return te[" "](e),e}te[" "]=A;var ne,re=H(G,"Opera"),ie=H(G,"Trident")||H(G,"MSIE"),oe=H(G,"Edge"),ae=oe||ie,se=H(G,"Gecko")&&!(H(G.toLowerCase(),"webkit")&&!H(G,"Edge"))&&!(H(G,"Trident")||H(G,"MSIE"))&&!H(G,"Edge"),ue=H(G.toLowerCase(),"webkit")&&!H(G,"Edge");function ce(){var e=k.document;return e?e.documentMode:void 0}e:{var le="",he=(he=G,se?/rv:([^\);]+)(\)|;)/.exec(he):oe?/Edge\/([\d\.]+)/.exec(he):ie?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(he):ue?/WebKit\/(\S+)/.exec(he):re?/(?:Version)[ \/]?(\S+)/.exec(he):void 0);if(he&&(le=he?he[1]:""),ie){he=ce();if(null!=he&&he>parseFloat(le)){ne=String(he);break e}}ne=le}var fe={};function de(s){return e=s,t=function(){for(var e=0,t=W(String(ne)).split("."),n=W(String(s)).split("."),r=Math.max(t.length,n.length),i=0;0==e&&i<r;i++){var o=t[i]||"",a=n[i]||"";do{if(o=/(\d*)(\D*)(.*)/.exec(o)||["","","",""],a=/(\d*)(\D*)(.*)/.exec(a)||["","","",""],0==o[0].length&&0==a[0].length)break;e=Y(0==o[1].length?0:parseInt(o[1],10),0==a[1].length?0:parseInt(a[1],10))||Y(0==o[2].length,0==a[2].length)||Y(o[2],a[2]),o=o[3],a=a[3]}while(0==e)}return 0<=e},n=fe,Object.prototype.hasOwnProperty.call(n,e)?n[e]:n[e]=t(e);var e,t,n}var pe=k.document&&ie?ce()||(parseInt(ne,10)||void 0):void 0,ye=!ie||9<=Number(pe),me=ie&&!de("9"),ge=function(){if(!k.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{k.addEventListener("test",A,t),k.removeEventListener("test",A,t)}catch(e){}return e}();function ve(e,t){this.type=e,this.a=this.target=t,this.defaultPrevented=!1}function be(e,t){if(ve.call(this,e?e.type:""),this.relatedTarget=this.a=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.pointerId=0,this.pointerType="",this.c=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.a=t,t=e.relatedTarget){if(se){e:{try{te(t.nodeName);var i=!0;break e}catch(e){}i=!1}i||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:we[e.pointerType]||"",(this.c=e).defaultPrevented&&this.b()}}ve.prototype.b=function(){this.defaultPrevented=!0},B(be,ve);var we={2:"touch",3:"pen",4:"mouse"};be.prototype.b=function(){be.X.b.call(this);var e=this.c;if(e.preventDefault)e.preventDefault();else if(e.returnValue=!1,me)try{(e.ctrlKey||112<=e.keyCode&&e.keyCode<=123)&&(e.keyCode=-1)}catch(e){}};var Te="closure_listenable_"+(1e6*Math.random()|0),Se=0;function Ie(e,t,n,r,i){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.ca=i,this.key=++Se,this.Y=this.Z=!1}function Ee(e){e.Y=!0,e.listener=null,e.proxy=null,e.src=null,e.ca=null}function Ce(e){this.src=e,this.a={},this.b=0}function De(e,t){var n,r,i,o=t.type;o in e.a&&(n=e.a[o],(i=0<=(r=U(n,t)))&&Array.prototype.splice.call(n,r,1),i&&(Ee(t),0==e.a[o].length&&(delete e.a[o],e.b--)))}function _e(e,t,n,r){for(var i=0;i<e.length;++i){var o=e[i];if(!o.Y&&o.listener==t&&o.capture==!!n&&o.ca==r)return i}return-1}Ce.prototype.add=function(e,t,n,r,i){var o=e.toString();(e=this.a[o])||(e=this.a[o]=[],this.b++);var a=_e(e,t,r,i);return-1<a?(t=e[a],n||(t.Z=!1)):((t=new Ie(t,this.src,o,!!r,i)).Z=n,e.push(t)),t};var ke="closure_lm_"+(1e6*Math.random()|0),Ae={};function Ne(e,t,n,r,i){if(r&&r.once)return function e(t,n,r,i,o){if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,i,o);return null}r=Fe(r);return t&&t[Te]?t.wa(n,r,x(i)?!!i.capture:!!i,o):xe(t,n,r,!0,i,o)}(e,t,n,r,i);if(Array.isArray(t)){for(var o=0;o<t.length;o++)Ne(e,t[o],n,r,i);return null}return n=Fe(n),e&&e[Te]?e.va(t,n,x(r)?!!r.capture:!!r,i):xe(e,t,n,!1,r,i)}function xe(e,t,n,r,i,o){if(!t)throw Error("Invalid event type");var a=x(i)?!!i.capture:!!i;if(a&&!ye)return null;var s,u,c=Me(e);if(c||(e[ke]=c=new Ce(e)),(n=c.add(t,n,r,a,o)).proxy)return n;if(s=Pe,r=u=ye?function(e){return s.call(u.src,u.listener,e)}:function(e){if(!(e=s.call(u.src,u.listener,e)))return e},(n.proxy=r).src=e,r.listener=n,e.addEventListener)ge||(i=a),void 0===i&&(i=!1),e.addEventListener(t.toString(),r,i);else if(e.attachEvent)e.attachEvent(Re(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function Oe(e){var t,n,r;"number"!=typeof e&&e&&!e.Y&&((t=e.src)&&t[Te]?De(t.c,e):(n=e.type,r=e.proxy,t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(Re(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=Me(t))?(De(n,e),0==n.b&&(n.src=null,t[ke]=null)):Ee(e)))}function Re(e){return e in Ae?Ae[e]:Ae[e]="on"+e}function Le(e,t){var n=e.listener,r=e.ca||e.src;return e.Z&&Oe(e),n.call(r,t)}function Pe(e,t){if(e.Y)return!0;if(ye)return Le(e,new be(t,this));if(!t)e:{t=["window","event"];for(var n=k,r=0;r<t.length;r++)if(null==(n=n[t[r]])){t=null;break e}t=n}return Le(e,t=new be(t,this))}function Me(e){return(e=e[ke])instanceof Ce?e:null}var qe="__closure_events_fn_"+(1e9*Math.random()>>>0);function Fe(t){return"function"==typeof t?t:(t[qe]||(t[qe]=function(e){return t.handleEvent(e)}),t[qe])}function Be(){V.call(this),this.c=new Ce(this),(this.J=this).C=null}function Ve(e,t){var n,r=e.C;if(r)for(n=[];r;r=r.C)n.push(r);if(e=e.J,r=t.type||t,"string"==typeof t?t=new ve(t,e):t instanceof ve?t.target=t.target||e:(a=t,ee(t=new ve(r,e),a)),a=!0,n)for(var i=n.length-1;0<=i;i--)var o=t.a=n[i],a=Ue(o,r,!0,t)&&a;if(a=Ue(o=t.a=e,r,!0,t)&&a,a=Ue(o,r,!1,t)&&a,n)for(i=0;i<n.length;i++)a=Ue(o=t.a=n[i],r,!1,t)&&a}function Ue(e,t,n,r){if(!(t=e.c.a[String(t)]))return!0;t=t.concat();for(var i=!0,o=0;o<t.length;++o){var a,s,u=t[o];u&&!u.Y&&u.capture==n&&(a=u.listener,s=u.ca||u.src,u.Z&&De(e.c,u),i=!1!==a.call(s,r)&&i)}return i&&!r.defaultPrevented}B(Be,V),Be.prototype[Te]=!0,(C=Be.prototype).addEventListener=function(e,t,n,r){Ne(this,e,t,n,r)},C.removeEventListener=function(e,t,n,r){!function e(t,n,r,i,o){if(Array.isArray(n))for(var a=0;a<n.length;a++)e(t,n[a],r,i,o);else i=x(i)?!!i.capture:!!i,r=Fe(r),t&&t[Te]?(t=t.c,(n=String(n).toString())in t.a&&-1<(r=_e(a=t.a[n],r,i,o))&&(Ee(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete t.a[n],t.b--))):(t=t&&Me(t))&&(n=t.a[n.toString()],t=-1,n&&(t=_e(n,r,i,o)),(r=-1<t?n[t]:null)&&Oe(r))}(this,e,t,n,r)},C.G=function(){if(Be.X.G.call(this),this.c){var e,t=this.c;for(e in t.a){for(var n=t.a[e],r=0;r<n.length;r++)Ee(n[r]);delete t.a[e],t.b--}}this.C=null},C.va=function(e,t,n,r){return this.c.add(String(e),t,!1,n,r)},C.wa=function(e,t,n,r){return this.c.add(String(e),t,!0,n,r)};var Ke=k.JSON.stringify;function je(){this.b=this.a=null}var ze,Qe=(Ge.prototype.get=function(){var e;return 0<this.b?(this.b--,e=this.a,this.a=e.next,e.next=null):e=this.c(),e},new Ge(function(){return new We},function(e){e.reset()}));function Ge(e,t){this.c=e,this.f=t,this.b=0,this.a=null}function We(){this.next=this.b=this.a=null}function He(e,t){var n;ze||(n=k.Promise.resolve(void 0),ze=function(){n.then(Je)}),Ye||(ze(),Ye=!0),Xe.add(e,t)}je.prototype.add=function(e,t){var n=Qe.get();n.set(e,t),this.b?this.b.next=n:this.a=n,this.b=n},We.prototype.set=function(e,t){this.a=e,this.b=t,this.next=null};var Ye=!(We.prototype.reset=function(){this.next=this.b=this.a=null}),Xe=new je;function Je(){for(var e,t;n=t=void 0,n=null,(t=Xe).a&&(n=t.a,t.a=t.a.next,t.a||(t.b=null),n.next=null),e=n;){try{e.a.call(e.b)}catch(e){!function(e){k.setTimeout(function(){throw e},0)}(e)}var n=Qe;n.f(e),n.b<100&&(n.b++,e.next=n.a,n.a=e)}Ye=!1}function $e(e,t){Be.call(this),this.b=e||1,this.a=t||k,this.f=M(this.Za,this),this.g=F()}function Ze(e){e.aa=!1,e.M&&(e.a.clearTimeout(e.M),e.M=null)}function et(e,t,n){if("function"==typeof e)n&&(e=M(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=M(e.handleEvent,e)}return 2147483647<Number(t)?-1:k.setTimeout(e,t||0)}B($e,Be),(C=$e.prototype).aa=!1,C.M=null,C.Za=function(){var e;this.aa&&(0<(e=F()-this.g)&&e<.8*this.b?this.M=this.a.setTimeout(this.f,this.b-e):(this.M&&(this.a.clearTimeout(this.M),this.M=null),Ve(this,"tick"),this.aa&&(Ze(this),this.start())))},C.start=function(){this.aa=!0,this.M||(this.M=this.a.setTimeout(this.f,this.b),this.g=F())},C.G=function(){$e.X.G.call(this),Ze(this),delete this.a};var tt,nt,rt,it=(I(nt=at,rt=tt=V),nt.prototype=null===rt?Object.create(rt):(ot.prototype=rt.prototype,new ot),at.prototype.f=function(e){this.b=arguments,this.a?this.c=!0:function e(t){t.a=et(function(){t.a=null,t.c&&(t.c=!1,e(t))},t.h);var n=t.b;t.b=null,t.g.apply(null,n)}(this)},at.prototype.G=function(){tt.prototype.G.call(this),this.a&&(k.clearTimeout(this.a),this.a=null,this.c=!1,this.b=null)},at);function ot(){this.constructor=nt}function at(e,t){var n=tt.call(this)||this;return n.g=e,n.h=t,n.b=null,n.c=!1,n.a=null,n}function st(e){V.call(this),this.b=e,this.a={}}B(st,V);var ut=[];function ct(e,t,n,r){Array.isArray(n)||(n&&(ut[0]=n.toString()),n=ut);for(var i=0;i<n.length;i++){var o=Ne(t,n[i],r||e.handleEvent,!1,e.b||e);if(!o)break;e.a[o.key]=o}}function lt(e){J(e.a,function(e,t){this.a.hasOwnProperty(t)&&Oe(e)},e),e.a={}}function ht(){this.a=!0}function ft(e,t,n,r){e.info(function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.a)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(r.length<2)){var i=r[1];if(Array.isArray(i)&&!(i.length<1)){r=i[0];if("noop"!=r&&"stop"!=r&&"close"!=r)for(var o=1;o<i.length;o++)i[o]=""}}}return Ke(n)}catch(e){return t}}(e,n)+(r?" "+r:"")})}st.prototype.G=function(){st.X.G.call(this),lt(this)},st.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},ht.prototype.info=function(){};var dt={},pt=null;function yt(){return pt=pt||new Be}function mt(e){ve.call(this,dt.Fa,e)}function gt(e){var t=yt();Ve(t,new mt(t))}function vt(e,t){ve.call(this,dt.STAT_EVENT,e),this.stat=t}function bt(e){var t=yt();Ve(t,new vt(t,e))}function wt(e){ve.call(this,dt.Ga,e)}function Tt(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return k.setTimeout(function(){e()},t)}dt.Fa="serverreachability",B(mt,ve),dt.STAT_EVENT="statevent",B(vt,ve),dt.Ga="timingevent",B(wt,ve);var St={NO_ERROR:0,$a:1,nb:2,mb:3,hb:4,lb:5,ob:6,Da:7,TIMEOUT:8,rb:9},It={fb:"complete",Bb:"success",Ea:"error",Da:"abort",tb:"ready",ub:"readystatechange",TIMEOUT:"timeout",pb:"incrementaldata",sb:"progress",ib:"downloadprogress",Jb:"uploadprogress"};function Et(){}function Ct(e){var t;return(t=e.a)||(t=e.a={}),t}function Dt(){}Et.prototype.a=null;var _t,D={OPEN:"a",eb:"b",Ea:"c",qb:"d"};function kt(){ve.call(this,"d")}function At(){ve.call(this,"c")}function Nt(){}function xt(e,t,n,r){this.g=e,this.c=t,this.f=n,this.S=r||1,this.J=new st(this),this.P=Ot,e=ae?125:void 0,this.R=new $e(e),this.B=null,this.b=!1,this.j=this.l=this.i=this.H=this.u=this.T=this.o=null,this.s=[],this.a=null,this.D=0,this.h=this.m=null,this.N=-1,this.A=!1,this.O=0,this.F=null,this.V=this.C=this.U=this.I=!1}B(kt,ve),B(At,ve),B(Nt,Et),_t=new Nt;var Ot=45e3,Rt={},Lt={};function Pt(e,t,n){e.H=1,e.i=nn(Xt(t)),e.j=n,e.I=!0,Mt(e,null)}function Mt(e,t){e.u=F(),Ft(e),e.l=Xt(e.i);var a,s,u,c,l,h,n=e.l,r=e.S;Array.isArray(r)||(r=[String(r)]),mn(n.b,"t",r),e.D=0,e.a=cr(e.g,e.g.C?t:null),0<e.O&&(e.F=new it(M(e.Ca,e,e.a),e.O)),ct(e.J,e.a,"readystatechange",e.Xa),t=e.B?$(e.B):{},e.j?(e.m||(e.m="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.a.ba(e.l,e.m,e.j,t)):(e.m="GET",e.a.ba(e.l,e.m,null,t)),gt(1),a=e.c,s=e.m,u=e.l,c=e.f,l=e.S,h=e.j,a.info(function(){if(a.a)if(h)for(var e="",t=h.split("&"),n=0;n<t.length;n++){var r,i,o=t[n].split("=");1<o.length&&(r=o[0],o=o[1],e=2<=(i=r.split("_")).length&&"type"==i[1]?e+(r+"=")+o+"&":e+(r+"=redacted&"))}else e=null;else e=h;return"XMLHTTP REQ ("+c+") [attempt "+l+"]: "+s+"\n"+u+"\n"+e})}function qt(e,t,n){for(var r,i,o,a=!0;!e.A&&e.D<n.length;){var s=(s=n,o=i=void 0,i=(r=e).D,-1==(o=s.indexOf("\n",i))?Lt:(i=Number(s.substring(i,o)),isNaN(i)?Rt:(o+=1)+i>s.length?Lt:(s=s.substr(o,i),r.D=o+i,s)));if(s==Lt){4==t&&(e.h=4,bt(14),a=!1),ft(e.c,e.f,null,"[Incomplete Response]");break}if(s==Rt){e.h=4,bt(15),ft(e.c,e.f,n,"[Invalid Chunk]"),a=!1;break}ft(e.c,e.f,s,null),jt(e,s)}4==t&&0==n.length&&(e.h=1,bt(16),a=!1),e.b=e.b&&a,a?0<n.length&&!e.V&&(e.V=!0,(t=e.g).a==e&&t.U&&!t.F&&(t.c.info("Great, no buffering proxy detected. Bytes received: "+n.length),tr(t),t.F=!0,bt(11))):(ft(e.c,e.f,n,"[Invalid Chunked Response]"),Kt(e),Ut(e))}function Ft(e){e.T=F()+e.P,Bt(e,e.P)}function Bt(e,t){if(null!=e.o)throw Error("WatchDog timer not null");e.o=Tt(M(e.Va,e),t)}function Vt(e){e.o&&(k.clearTimeout(e.o),e.o=null)}function Ut(e){0==e.g.v||e.A||ir(e.g,e)}function Kt(e){Vt(e);var t=e.F;t&&"function"==typeof t.ja&&t.ja(),e.F=null,Ze(e.R),lt(e.J),e.a&&(t=e.a,e.a=null,t.abort(),t.ja())}function jt(e,t){try{var n,r,i,o,a,s=e.g;if(0!=s.v&&(s.a==e||In(s.b,e)))if(s.I=e.N,!e.C&&In(s.b,e)&&3==s.v){try{var u=s.ka.a.parse(t)}catch(e){u=null}if(Array.isArray(u)&&3==u.length){var c=u;if(0==c[0]){e:if(!s.j){if(s.a){if(!(s.a.u+3e3<e.u))break e;rr(s),Gn(s)}er(s),bt(18)}}else s.oa=c[1],0<s.oa-s.P&&c[2]<37500&&s.H&&0==s.o&&!s.m&&(s.m=Tt(M(s.Sa,s),6e3));if(Sn(s.b)<=1&&s.ea){try{s.ea()}catch(e){}s.ea=void 0}}else ar(s,11)}else if(!e.C&&s.a!=e||rr(s),!Q(t))for(t=u=s.ka.a.parse(t),u=0;u<t.length;u++){c=t[u],s.P=c[0],c=c[1],2==s.v?"c"==c[0]?(s.J=c[1],s.ga=c[2],null!=(r=c[3])&&(s.ha=r,s.c.info("VER="+s.ha)),null!=(o=c[4])&&(s.pa=o,s.c.info("SVER="+s.pa)),null!=(r=c[5])&&"number"==typeof r&&0<r&&(n=1.5*r,s.D=n,s.c.info("backChannelRequestTimeoutMs_="+n)),n=s,(o=e.a)&&(!(r=o.a?o.a.getResponseHeader("X-Client-Wire-Protocol"):null)||!(i=n.b).a&&(H(r,"spdy")||H(r,"quic")||H(r,"h2"))&&(i.f=i.g,i.a=new Set,i.b&&(En(i,i.b),i.b=null)),!n.A||(a=o.a?o.a.getResponseHeader("X-HTTP-Session-Id"):null)&&(n.na=a,tn(n.B,n.A,a))),s.v=3,s.f&&s.f.ta(),s.U&&(s.N=F()-e.u,s.c.info("Handshake RTT: "+s.N+"ms")),i=e,(n=s).la=ur(n,n.C?n.ga:null,n.fa),i.C?(Cn(n.b,i),o=i,(a=n.D)&&o.setTimeout(a),o.o&&(Vt(o),Ft(o)),n.a=i):Zn(n),0<s.g.length&&Yn(s)):"stop"!=c[0]&&"close"!=c[0]||ar(s,7):3==s.v&&("stop"==c[0]||"close"==c[0]?"stop"==c[0]?ar(s,7):Qn(s):"noop"!=c[0]&&s.f&&s.f.sa(c),s.o=0)}gt(4)}catch(e){}}function zt(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(N(e)||"string"==typeof e)K(e,t,void 0);else{if(e.L&&"function"==typeof e.L)var n=e.L();else if(e.K&&"function"==typeof e.K)n=void 0;else if(N(e)||"string"==typeof e){n=[];for(var r=e.length,i=0;i<r;i++)n.push(i)}else for(i in n=[],r=0,e)n[r++]=i;i=(r=function(e){if(e.K&&"function"==typeof e.K)return e.K();if("string"==typeof e)return e.split("");if(N(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e)).length;for(var o=0;o<i;o++)t.call(void 0,r[o],n&&n[o],e)}}function Qt(e,t){this.b={},this.a=[],this.c=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(e)if(e instanceof Qt)for(n=e.L(),r=0;r<n.length;r++)this.set(n[r],e.get(n[r]));else for(r in e)this.set(r,e[r])}function Gt(e){if(e.c!=e.a.length){for(var t=0,n=0;t<e.a.length;){var r=e.a[t];Wt(e.b,r)&&(e.a[n++]=r),t++}e.a.length=n}if(e.c!=e.a.length){for(var i={},n=t=0;t<e.a.length;)Wt(i,r=e.a[t])||(i[e.a[n++]=r]=1),t++;e.a.length=n}}function Wt(e,t){return Object.prototype.hasOwnProperty.call(e,t)}(C=xt.prototype).setTimeout=function(e){this.P=e},C.Xa=function(e){e=e.target;var t=this.F;t&&3==Un(e)?t.f():this.Ca(e)},C.Ca=function(e){try{if(e==this.a)e:{var t=Un(this.a),n=this.a.ua(),r=this.a.W();if(!(t<3||3==t&&!ae&&!this.a.$())){this.A||4!=t||7==n||gt(8==n||r<=0?3:2),Vt(this);var i=this.a.W();this.N=i;n=this.a.$();if(this.b=200==i,r=this.c,s=this.m,u=this.l,c=this.f,l=this.S,h=t,f=i,r.info(function(){return"XMLHTTP RESP ("+c+") [ attempt "+l+"]: "+s+"\n"+u+"\n"+h+" "+f}),this.b){if(this.U&&!this.C){t:{if(this.a){var o=this.a;if((o=o.a?o.a.getResponseHeader("X-HTTP-Initial-Response"):null)&&!Q(o)){var a=o;break t}}a=null}if(!a){this.b=!1,this.h=3,bt(12),Kt(this),Ut(this);break e}ft(this.c,this.f,a,"Initial handshake response via X-HTTP-Initial-Response"),this.C=!0,jt(this,a)}this.I?(qt(this,t,n),ae&&this.b&&3==t&&(ct(this.J,this.R,"tick",this.Wa),this.R.start())):(ft(this.c,this.f,n,null),jt(this,n)),4==t&&Kt(this),this.b&&!this.A&&(4==t?ir(this.g,this):(this.b=!1,Ft(this)))}else 400==i&&0<n.indexOf("Unknown SID")?(this.h=3,bt(12)):(this.h=0,bt(13)),Kt(this),Ut(this)}}}catch(e){}var s,u,c,l,h,f},C.Wa=function(){var e,t;this.a&&(e=Un(this.a),t=this.a.$(),this.D<t.length&&(Vt(this),qt(this,e,t),this.b&&4!=e&&Ft(this)))},C.cancel=function(){this.A=!0,Kt(this)},C.Va=function(){this.o=null;var e,t,n=F();0<=n-this.T?(e=this.c,t=this.l,e.info(function(){return"TIMEOUT: "+t}),2!=this.H&&(gt(3),bt(17)),Kt(this),this.h=2,Ut(this)):Bt(this,this.T-n)},(C=Qt.prototype).K=function(){Gt(this);for(var e=[],t=0;t<this.a.length;t++)e.push(this.b[this.a[t]]);return e},C.L=function(){return Gt(this),this.a.concat()},C.get=function(e,t){return Wt(this.b,e)?this.b[e]:t},C.set=function(e,t){Wt(this.b,e)||(this.c++,this.a.push(e)),this.b[e]=t},C.forEach=function(e,t){for(var n=this.L(),r=0;r<n.length;r++){var i=n[r],o=this.get(i);e.call(t,o,i,this)}};var Ht=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^\\/?#]*)@)?([^\\/?#]*?)(?::([0-9]+))?(?=[\\/?#]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function Yt(e,t){var n;this.c=this.j=this.f="",this.h=null,this.i=this.g="",this.a=!1,e instanceof Yt?(this.a=void 0!==t?t:e.a,Jt(this,e.f),this.j=e.j,$t(this,e.c),Zt(this,e.h),this.g=e.g,t=e.b,(n=new fn).c=t.c,t.a&&(n.a=new Qt(t.a),n.b=t.b),en(this,n),this.i=e.i):e&&(n=String(e).match(Ht))?(this.a=!!t,Jt(this,n[1]||"",!0),this.j=rn(n[2]||""),$t(this,n[3]||"",!0),Zt(this,n[4]),this.g=rn(n[5]||"",!0),en(this,n[6]||"",!0),this.i=rn(n[7]||"")):(this.a=!!t,this.b=new fn(null,this.a))}function Xt(e){return new Yt(e)}function Jt(e,t,n){e.f=n?rn(t,!0):t,e.f&&(e.f=e.f.replace(/:$/,""))}function $t(e,t,n){e.c=n?rn(t,!0):t}function Zt(e,t){if(t){if(t=Number(t),isNaN(t)||t<0)throw Error("Bad port number "+t);e.h=t}else e.h=null}function en(e,t,n){var r,i;t instanceof fn?(e.b=t,r=e.b,(i=e.a)&&!r.f&&(dn(r),r.c=null,r.a.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(pn(this,t),mn(this,n,e))},r)),r.f=i):(n||(t=on(t,ln)),e.b=new fn(t,e.a))}function tn(e,t,n){e.b.set(t,n)}function nn(e){return tn(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^F()).toString(36)),e}function rn(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function on(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,an),n&&(e=e.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),e):null}function an(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}Yt.prototype.toString=function(){var e=[],t=this.f;t&&e.push(on(t,sn,!0),":");var n=this.c;return!n&&"file"!=t||(e.push("//"),(t=this.j)&&e.push(on(t,sn,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.h)&&e.push(":",String(n))),(n=this.g)&&(this.c&&"/"!=n.charAt(0)&&e.push("/"),e.push(on(n,"/"==n.charAt(0)?cn:un,!0))),(n=this.b.toString())&&e.push("?",n),(n=this.i)&&e.push("#",on(n,hn)),e.join("")};var sn=/[#\/\?@]/g,un=/[#\?:]/g,cn=/[#\?]/g,ln=/[#\?@]/g,hn=/#/g;function fn(e,t){this.b=this.a=null,this.c=e||null,this.f=!!t}function dn(n){n.a||(n.a=new Qt,n.b=0,n.c&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r,i=e[n].indexOf("="),o=null;0<=i?(r=e[n].substring(0,i),o=e[n].substring(i+1)):r=e[n],t(r,o?decodeURIComponent(o.replace(/\+/g," ")):"")}}}(n.c,function(e,t){n.add(decodeURIComponent(e.replace(/\+/g," ")),t)}))}function pn(e,t){dn(e),t=gn(e,t),Wt(e.a.b,t)&&(e.c=null,e.b-=e.a.get(t).length,Wt((e=e.a).b,t)&&(delete e.b[t],e.c--,e.a.length>2*e.c&&Gt(e)))}function yn(e,t){return dn(e),t=gn(e,t),Wt(e.a.b,t)}function mn(e,t,n){pn(e,t),0<n.length&&(e.c=null,e.a.set(gn(e,t),z(n)),e.b+=n.length)}function gn(e,t){return t=String(t),e.f&&(t=t.toLowerCase()),t}(C=fn.prototype).add=function(e,t){dn(this),this.c=null,e=gn(this,e);var n=this.a.get(e);return n||this.a.set(e,n=[]),n.push(t),this.b+=1,this},C.forEach=function(n,r){dn(this),this.a.forEach(function(e,t){K(e,function(e){n.call(r,e,t,this)},this)},this)},C.L=function(){dn(this);for(var e=this.a.K(),t=this.a.L(),n=[],r=0;r<t.length;r++)for(var i=e[r],o=0;o<i.length;o++)n.push(t[r]);return n},C.K=function(e){dn(this);var t=[];if("string"==typeof e)yn(this,e)&&(t=j(t,this.a.get(gn(this,e))));else{e=this.a.K();for(var n=0;n<e.length;n++)t=j(t,e[n])}return t},C.set=function(e,t){return dn(this),this.c=null,yn(this,e=gn(this,e))&&(this.b-=this.a.get(e).length),this.a.set(e,[t]),this.b+=1,this},C.get=function(e,t){return e&&0<(e=this.K(e)).length?String(e[0]):t},C.toString=function(){if(this.c)return this.c;if(!this.a)return"";for(var e=[],t=this.a.L(),n=0;n<t.length;n++)for(var r=t[n],i=encodeURIComponent(String(r)),r=this.K(r),o=0;o<r.length;o++){var a=i;""!==r[o]&&(a+="="+encodeURIComponent(String(r[o]))),e.push(a)}return this.c=e.join("&")};var vn=function(e,t){this.b=e,this.a=t};function bn(e){this.g=e||wn,e=k.PerformanceNavigationTiming?0<(e=k.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(k.ia&&k.ia.ya&&k.ia.ya()&&k.ia.ya().Lb),this.f=e?this.g:1,this.a=null,1<this.f&&(this.a=new Set),this.b=null,this.c=[]}var wn=10;function Tn(e){return e.b||e.a&&e.a.size>=e.f}function Sn(e){return e.b?1:e.a?e.a.size:0}function In(e,t){return e.b?e.b==t:e.a&&e.a.has(t)}function En(e,t){e.a?e.a.add(t):e.b=t}function Cn(e,t){e.b&&e.b==t?e.b=null:e.a&&e.a.has(t)&&e.a.delete(t)}function Dn(e){var t,n;if(null!=e.b)return e.c.concat(e.b.s);if(null==e.a||0===e.a.size)return z(e.c);var r=e.c;try{for(var i=E(e.a.values()),o=i.next();!o.done;o=i.next())var a=o.value,r=r.concat(a.s)}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}return r}function _n(){}function kn(){this.a=new _n}function An(e,t,n,r,i){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,i(r)}catch(e){}}bn.prototype.cancel=function(){var t,e;if(this.c=Dn(this),this.b)this.b.cancel(),this.b=null;else if(this.a&&0!==this.a.size){try{for(var n=E(this.a.values()),r=n.next();!r.done;r=n.next()){r.value.cancel()}}catch(e){t={error:e}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}this.a.clear()}},_n.prototype.stringify=function(e){return k.JSON.stringify(e,void 0)},_n.prototype.parse=function(e){return k.JSON.parse(e,void 0)};var Nn=k.JSON.parse;function xn(e){Be.call(this),this.headers=new Qt,this.H=e||null,this.b=!1,this.s=this.a=null,this.B="",this.h=0,this.f="",this.g=this.A=this.l=this.u=!1,this.o=0,this.m=null,this.I=On,this.D=this.F=!1}B(xn,Be);var On="",Rn=/^https?$/i,Ln=["POST","PUT"];function Pn(e){return"content-type"==e.toLowerCase()}function Mn(e,t){e.b=!1,e.a&&(e.g=!0,e.a.abort(),e.g=!1),e.f=t,e.h=5,qn(e),Bn(e)}function qn(e){e.u||(e.u=!0,Ve(e,"complete"),Ve(e,"error"))}function Fn(e){if(e.b&&void 0!==_&&(!e.s[1]||4!=Un(e)||2!=e.W()))if(e.l&&4==Un(e))et(e.za,0,e);else if(Ve(e,"readystatechange"),4==Un(e)){e.b=!1;try{var t,n,r,i,o=e.W();e:switch(o){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var a=!0;break e;default:a=!1}(t=a)||((n=0===o)&&(!(i=String(e.B).match(Ht)[1]||null)&&k.self&&k.self.location&&(i=(r=k.self.location.protocol).substr(0,r.length-1)),n=!Rn.test(i?i.toLowerCase():"")),t=n);if(t)Ve(e,"complete"),Ve(e,"success");else{e.h=6;try{var s=2<Un(e)?e.a.statusText:""}catch(o){s=""}e.f=s+" ["+e.W()+"]",qn(e)}}finally{Bn(e)}}}function Bn(e,t){if(e.a){Vn(e);var n=e.a,r=e.s[0]?A:null;e.a=null,e.s=null,t||Ve(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function Vn(e){e.a&&e.D&&(e.a.ontimeout=null),e.m&&(k.clearTimeout(e.m),e.m=null)}function Un(e){return e.a?e.a.readyState:0}function Kn(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}var i;r||(i="",J(n,function(e,t){i+=t,i+=":",i+=e,i+="\r\n"}),n=i,"string"==typeof e?null!=n&&encodeURIComponent(String(n)):tn(e,t,n))}function jn(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function zn(e){this.pa=0,this.g=[],this.c=new ht,this.ga=this.la=this.B=this.fa=this.a=this.na=this.A=this.V=this.i=this.O=this.l=null,this.Oa=this.R=0,this.La=jn("failFast",!1,e),this.H=this.m=this.j=this.h=this.f=null,this.S=!0,this.I=this.oa=this.P=-1,this.T=this.o=this.u=0,this.Ha=jn("baseRetryDelayMs",5e3,e),this.Ra=jn("retryDelaySeedMs",1e4,e),this.Ma=jn("forwardChannelMaxRetries",2,e),this.ma=jn("forwardChannelRequestTimeoutMs",2e4,e),this.Na=e&&e.g||void 0,this.D=void 0,this.C=e&&e.supportsCrossDomainXhr||!1,this.J="",this.b=new bn(e&&e.concurrentRequestLimit),this.ka=new kn,this.da=e&&e.fastHandshake||!1,this.Ia=e&&e.b||!1,e&&e.f&&(this.c.a=!1),e&&e.forceLongPolling&&(this.S=!1),this.U=!this.da&&this.S&&e&&e.detectBufferingProxy||!1,this.ea=void 0,this.N=0,this.F=!1,this.s=null,(this.Ka=e&&e.c||!1)&&this.c.info("Opt-in to enable Chrome Origin Trials.")}function Qn(e){var t,n;Wn(e),3==e.v&&(t=e.R++,tn(n=Xt(e.B),"SID",e.J),tn(n,"RID",t),tn(n,"TYPE","terminate"),Jn(e,n),(t=new xt(e,e.c,t,void 0)).H=2,t.i=nn(Xt(n)),n=!1,k.navigator&&k.navigator.sendBeacon&&(n=k.navigator.sendBeacon(t.i.toString(),"")),!n&&k.Image&&((new Image).src=t.i,n=!0),n||(t.a=cr(t.g,null),t.a.ba(t.i)),t.u=F(),Ft(t)),sr(e)}function Gn(e){e.a&&(tr(e),e.a.cancel(),e.a=null)}function Wn(e){Gn(e),e.j&&(k.clearTimeout(e.j),e.j=null),rr(e),e.b.cancel(),e.h&&("number"==typeof e.h&&k.clearTimeout(e.h),e.h=null)}function Hn(e,t){e.g.push(new vn(e.Oa++,t)),3==e.v&&Yn(e)}function Yn(e){Tn(e.b)||e.h||(e.h=!0,He(e.Ba,e),e.u=0)}function Xn(e,t){var n=t?t.f:e.R++,r=Xt(e.B);tn(r,"SID",e.J),tn(r,"RID",n),tn(r,"AID",e.P),Jn(e,r),e.i&&e.l&&Kn(r,e.i,e.l),n=new xt(e,e.c,n,e.u+1),null===e.i&&(n.B=e.l),t&&(e.g=t.s.concat(e.g)),t=$n(e,n,1e3),n.setTimeout(Math.round(.5*e.ma)+Math.round(.5*e.ma*Math.random())),En(e.b,n),Pt(n,r,t)}function Jn(e,n){e.f&&zt({},function(e,t){tn(n,t,e)})}function $n(e,t,n){n=Math.min(e.g.length,n);var r=e.f?M(e.f.Ja,e.f,e):null;e:for(var i=e.g,o=-1;;){var a=["count="+n];-1==o?0<n?(o=i[0].b,a.push("ofs="+o)):o=0:a.push("ofs="+o);for(var s=!0,u=0;u<n;u++){var c=i[u].b,l=i[u].a;if((c-=o)<0)o=Math.max(0,i[u].b-100),s=!1;else try{!function(e,r,t){var i=t||"";try{zt(e,function(e,t){var n=e;x(e)&&(n=Ke(e)),r.push(i+t+"="+encodeURIComponent(n))})}catch(e){throw r.push(i+"type="+encodeURIComponent("_badmap")),e}}(l,a,"req"+c+"_")}catch(e){r&&r(l)}}if(s){r=a.join("&");break e}}return e=e.g.splice(0,n),t.s=e,r}function Zn(e){e.a||e.j||(e.T=1,He(e.Aa,e),e.o=0)}function er(e){return!(e.a||e.j||3<=e.o)&&(e.T++,e.j=Tt(M(e.Aa,e),or(e,e.o)),e.o++,1)}function tr(e){null!=e.s&&(k.clearTimeout(e.s),e.s=null)}function nr(e){e.a=new xt(e,e.c,"rpc",e.T),null===e.i&&(e.a.B=e.l),e.a.O=0;var t=Xt(e.la);tn(t,"RID","rpc"),tn(t,"SID",e.J),tn(t,"CI",e.H?"0":"1"),tn(t,"AID",e.P),Jn(e,t),tn(t,"TYPE","xmlhttp"),e.i&&e.l&&Kn(t,e.i,e.l),e.D&&e.a.setTimeout(e.D);var n=e.a;e=e.ga,n.H=1,n.i=nn(Xt(t)),n.j=null,n.I=!0,Mt(n,e)}function rr(e){null!=e.m&&(k.clearTimeout(e.m),e.m=null)}function ir(e,t){var n,r=null;if(e.a==t){rr(e),tr(e),e.a=null;var i=2}else{if(!In(e.b,t))return;r=t.s,Cn(e.b,t),i=1}if(e.I=t.N,0!=e.v)if(t.b){1==i?(r=t.j?t.j.length:0,t=F()-t.u,n=e.u,Ve(i=yt(),new wt(i)),Yn(e)):Zn(e)}else if(3==(n=t.h)||0==n&&0<e.I||!(1==i&&function(e,t){if(!(Sn(e.b)>=e.b.f-(e.h?1:0))){if(e.h)return e.g=t.s.concat(e.g),1;if(!(1==e.v||2==e.v||e.u>=(e.La?0:e.Ma)))return e.h=Tt(M(e.Ba,e,t),or(e,e.u)),e.u++,1}}(e,t)||2==i&&er(e)))switch(r&&0<r.length&&(t=e.b,t.c=t.c.concat(r)),n){case 1:ar(e,5);break;case 4:ar(e,10);break;case 3:ar(e,6);break;default:ar(e,2)}}function or(e,t){var n=e.Ha+Math.floor(Math.random()*e.Ra);return e.f||(n*=2),n*t}function ar(e,t){var n,r,i,o;e.c.info("Error code "+t),2==t?(r=null,e.f&&(r=null),o=M(e.Ya,e),r||(r=new Yt("//www.google.com/images/cleardot.gif"),k.location&&"http"==k.location.protocol||Jt(r,"https"),nn(r)),n=r.toString(),r=o,o=new ht,k.Image?((i=new Image).onload=q(An,o,i,"TestLoadImage: loaded",!0,r),i.onerror=q(An,o,i,"TestLoadImage: error",!1,r),i.onabort=q(An,o,i,"TestLoadImage: abort",!1,r),i.ontimeout=q(An,o,i,"TestLoadImage: timeout",!1,r),k.setTimeout(function(){i.ontimeout&&i.ontimeout()},1e4),i.src=n):r(!1)):bt(2),e.v=0,e.f&&e.f.ra(t),sr(e),Wn(e)}function sr(e){e.v=0,e.I=-1,e.f&&(0==Dn(e.b).length&&0==e.g.length||(e.b.c.length=0,z(e.g),e.g.length=0),e.f.qa())}function ur(e,t,n){var r,i,o,a,s,u=(a=n)instanceof Yt?Xt(a):new Yt(a,void 0);return""!=u.c?(t&&$t(u,t+"."+u.c),Zt(u,u.h)):(s=k.location,r=s.protocol,i=t?t+"."+s.hostname:s.hostname,o=+s.port,a=n,s=new Yt(null,void 0),r&&Jt(s,r),i&&$t(s,i),o&&Zt(s,o),a&&(s.g=a),u=s),e.V&&J(e.V,function(e,t){tn(u,t,e)}),t=e.A,n=e.na,t&&n&&tn(u,t,n),tn(u,"VER",e.ha),Jn(e,u),u}function cr(e,t){if(t&&!e.C)throw Error("Can't create secondary domain capable XhrIo object.");return(t=new xn(e.Na)).F=e.C,t}function lr(){}function hr(){if(ie&&!(10<=Number(pe)))throw Error("Environmental error: no available transport.")}function fr(e,t){Be.call(this),this.a=new zn(t),this.o=e,this.b=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.a.l=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.a&&(e?e["X-WebChannel-Client-Profile"]=t.a:e={"X-WebChannel-Client-Profile":t.a}),this.a.O=e,(e=t&&t.httpHeadersOverwriteParam)&&!Q(e)&&(this.a.i=e),this.m=t&&t.supportsCrossDomainXhr||!1,this.l=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!Q(t)&&(this.a.A=t,null!==(e=this.b)&&t in e&&(t in(e=this.b)&&delete e[t])),this.f=new yr(this)}function dr(e){kt.call(this);var t=e.__sm__;if(t){e:{for(var n in t){e=n;break e}e=void 0}(this.c=e)?(e=this.c,this.data=null!==t&&e in t?t[e]:void 0):this.data=t}else this.data=e}function pr(){At.call(this),this.status=1}function yr(e){this.a=e}(C=xn.prototype).ba=function(e,t,n,r){if(this.a)throw Error("[goog.net.XhrIo] Object is active with another request="+this.B+"; newUri="+e);t=t?t.toUpperCase():"GET",this.B=e,this.f="",this.h=0,this.u=!1,this.b=!0,this.a=new XMLHttpRequest,this.s=this.H?Ct(this.H):Ct(_t),this.a.onreadystatechange=M(this.za,this);try{this.A=!0,this.a.open(t,String(e),!0),this.A=!1}catch(e){return void Mn(this,e)}e=n||"";var i,o=new Qt(this.headers);r&&zt(r,function(e,t){o.set(t,e)}),r=function(e){e:{for(var t=Pn,n=e.length,r="string"==typeof e?e.split(""):e,i=0;i<n;i++)if(i in r&&t.call(void 0,r[i],i,e)){t=i;break e}t=-1}return t<0?null:"string"==typeof e?e.charAt(t):e[t]}(o.L()),n=k.FormData&&e instanceof k.FormData,0<=U(Ln,t)&&!r&&!n&&o.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),o.forEach(function(e,t){this.a.setRequestHeader(t,e)},this),this.I&&(this.a.responseType=this.I),"withCredentials"in this.a&&this.a.withCredentials!==this.F&&(this.a.withCredentials=this.F);try{Vn(this),0<this.o&&((this.D=(i=this.a,ie&&de(9)&&"number"==typeof i.timeout&&void 0!==i.ontimeout))?(this.a.timeout=this.o,this.a.ontimeout=M(this.xa,this)):this.m=et(this.xa,this.o,this)),this.l=!0,this.a.send(e),this.l=!1}catch(e){Mn(this,e)}},C.xa=function(){void 0!==_&&this.a&&(this.f="Timed out after "+this.o+"ms, aborting",this.h=8,Ve(this,"timeout"),this.abort(8))},C.abort=function(e){this.a&&this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1,this.h=e||7,Ve(this,"complete"),Ve(this,"abort"),Bn(this))},C.G=function(){this.a&&(this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1),Bn(this,!0)),xn.X.G.call(this)},C.za=function(){this.j||(this.A||this.l||this.g?Fn(this):this.Ua())},C.Ua=function(){Fn(this)},C.W=function(){try{return 2<Un(this)?this.a.status:-1}catch(e){return-1}},C.$=function(){try{return this.a?this.a.responseText:""}catch(e){return""}},C.Pa=function(e){if(this.a){var t=this.a.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),Nn(t)}},C.ua=function(){return this.h},C.Qa=function(){return"string"==typeof this.f?this.f:String(this.f)},(C=zn.prototype).ha=8,C.v=1,C.Ba=function(e){if(this.h)if(this.h=null,1==this.v){if(!e){this.R=Math.floor(1e5*Math.random()),e=this.R++;var t,n=new xt(this,this.c,e,void 0),r=this.l;if(this.O&&(r?ee(r=$(r),this.O):r=this.O),null===this.i&&(n.B=r),this.da)e:{for(var i=t=0;i<this.g.length;i++){var o=this.g[i];if("__data__"in o.a&&"string"==typeof(o=o.a.__data__)?o=o.length:o=void 0,void 0===o)break;if(4096<(t+=o)){t=i;break e}if(4096===t||i===this.g.length-1){t=i+1;break e}}t=1e3}else t=1e3;t=$n(this,n,t),tn(i=Xt(this.B),"RID",e),tn(i,"CVER",22),this.A&&tn(i,"X-HTTP-Session-Id",this.A),Jn(this,i),this.i&&r&&Kn(i,this.i,r),En(this.b,n),this.Ia&&tn(i,"TYPE","init"),this.da?(tn(i,"$req",t),tn(i,"SID","null"),n.U=!0,Pt(n,i,null)):Pt(n,i,t),this.v=2}}else 3==this.v&&(e?Xn(this,e):0==this.g.length||Tn(this.b)||Xn(this))},C.Aa=function(){var e;this.j=null,nr(this),this.U&&!(this.F||null==this.a||this.N<=0)&&(e=2*this.N,this.c.info("BP detection timer enabled: "+e),this.s=Tt(M(this.Ta,this),e))},C.Ta=function(){this.s&&(this.s=null,this.c.info("BP detection timeout reached."),this.c.info("Buffering proxy detected and switch to long-polling!"),this.H=!1,this.F=!0,bt(10),Gn(this),nr(this))},C.Sa=function(){null!=this.m&&(this.m=null,Gn(this),er(this),bt(19))},C.Ya=function(e){e?(this.c.info("Successfully pinged google.com"),bt(2)):(this.c.info("Failed to ping google.com"),bt(1))},(C=lr.prototype).ta=function(){},C.sa=function(){},C.ra=function(){},C.qa=function(){},C.Ja=function(){},hr.prototype.a=function(e,t){return new fr(e,t)},B(fr,Be),fr.prototype.g=function(){this.a.f=this.f,this.m&&(this.a.C=!0);var e=this.a,t=this.o,n=this.b||void 0;bt(0),e.fa=t,e.V=n||{},e.H=e.S,e.B=ur(e,null,e.fa),Yn(e)},fr.prototype.close=function(){Qn(this.a)},fr.prototype.h=function(e){var t;"string"==typeof e?((t={}).__data__=e,Hn(this.a,t)):this.l?((t={}).__data__=Ke(e),Hn(this.a,t)):Hn(this.a,e)},fr.prototype.G=function(){this.a.f=null,delete this.f,Qn(this.a),delete this.a,fr.X.G.call(this)},B(dr,kt),B(pr,At),B(yr,lr),yr.prototype.ta=function(){Ve(this.a,"a")},yr.prototype.sa=function(e){Ve(this.a,new dr(e))},yr.prototype.ra=function(e){Ve(this.a,new pr)},yr.prototype.qa=function(){Ve(this.a,"b")},hr.prototype.createWebChannel=hr.prototype.a,fr.prototype.send=fr.prototype.h,fr.prototype.open=fr.prototype.g,St.NO_ERROR=0,St.TIMEOUT=8,St.HTTP_ERROR=6,It.COMPLETE="complete",(Dt.EventType=D).OPEN="a",D.CLOSE="b",D.ERROR="c",D.MESSAGE="d",Be.prototype.listen=Be.prototype.va,xn.prototype.listenOnce=xn.prototype.wa,xn.prototype.getLastError=xn.prototype.Qa,xn.prototype.getLastErrorCode=xn.prototype.ua,xn.prototype.getStatus=xn.prototype.W,xn.prototype.getResponseJson=xn.prototype.Pa,xn.prototype.getResponseText=xn.prototype.$,xn.prototype.send=xn.prototype.ba;var mr=yt,gr=St,vr=It,br=dt,wr=10,Tr=11,Sr=Dt,Ir=xn,Er=(Cr.prototype.setInstantiationMode=function(e){return this.instantiationMode=e,this},Cr.prototype.setMultipleInstances=function(e){return this.multipleInstances=e,this},Cr.prototype.setServiceProps=function(e){return this.serviceProps=e,this},Cr);function Cr(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY"}var Dr=function(e,t,n,r,i,o){this.databaseId=e,this.persistenceKey=t,this.host=n,this.ssl=r,this.forceLongPolling=i,this.autoDetectLongPolling=o},_r="(default)",kr=(Object.defineProperty(Ar.prototype,"isDefaultDatabase",{get:function(){return this.database===_r},enumerable:!1,configurable:!0}),Ar.prototype.isEqual=function(e){return e instanceof Ar&&e.projectId===this.projectId&&e.database===this.database},Ar);function Ar(e,t){this.projectId=e,this.database=t||_r}var Nr=(xr.prototype.isAuthenticated=function(){return null!=this.uid},xr.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"},xr.prototype.isEqual=function(e){return e.uid===this.uid},xr);function xr(e){this.uid=e}Nr.UNAUTHENTICATED=new Nr(null),Nr.GOOGLE_CREDENTIALS=new Nr("google-credentials-uid"),Nr.FIRST_PARTY=new Nr("first-party-uid");var Or,Rr={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},Lr=(n(Pr,Or=Error),Pr);function Pr(e,t){var n=Or.call(this,t)||this;return n.code=e,n.message=t,n.name="FirebaseError",n.toString=function(){return n.name+": [code="+n.code+"]: "+n.message},n}var Mr="8.1.1-1.0.0-eap-firestore-debug.9c6096f43";var qr=new l("@firebase/firestore");function Fr(){return qr.logLevel}function Br(e){for(var t,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];qr.logLevel<=f.DEBUG&&(t=n.map(Kr),qr.debug.apply(qr,a(["Firestore ("+Mr+"): "+e],t)))}function Vr(e){for(var t,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];qr.logLevel<=f.ERROR&&(t=n.map(Kr),qr.error.apply(qr,a(["Firestore ("+Mr+"): "+e],t)))}function Ur(e){for(var t,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];qr.logLevel<=f.WARN&&(t=n.map(Kr),qr.warn.apply(qr,a(["Firestore ("+Mr+"): "+e],t)))}function Kr(t){if("string"==typeof t)return t;try{return e=t,JSON.stringify(e)}catch(e){return t}var e}function jr(e){void 0===e&&(e="Unexpected state");e="FIRESTORE ("+Mr+") INTERNAL ASSERTION FAILED: "+e;throw Vr(e),new Error(e)}function zr(e,t){e||jr(t)}function Qr(e,t){e||jr(t)}function Gr(e,t){return Qr(e instanceof t,"Expected type '"+t.name+"', but was '"+e.constructor.name+"'"),e}var Wr=(Hr.newId=function(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length;Qr(0<t&&t<256,"Expect maxMultiple to be (0, 256), but got "+t);for(var n="";n.length<20;)for(var r=function(e){Qr(0<=e,"Expecting non-negative nBytes, got: "+e);var t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(var r=0;r<e;r++)n[r]=Math.floor(256*Math.random());return n}(40),i=0;i<r.length;++i)n.length<20&&r[i]<t&&(n+=e.charAt(r[i]%e.length));return Qr(20===n.length,"Invalid auto ID: "+n),n},Hr);function Hr(){}function Yr(e,t){return e<t?-1:t<e?1:0}function Xr(e,n,r){return e.length===n.length&&e.every(function(e,t){return r(e,n[t])})}function Jr(e){return e+"\0"}var $r=-62135596800,Zr=(ei.now=function(){return ei.fromMillis(Date.now())},ei.fromDate=function(e){return ei.fromMillis(e.getTime())},ei.fromMillis=function(e){var t=Math.floor(e/1e3);return new ei(t,1e6*(e-1e3*t))},ei.prototype.toDate=function(){return new Date(this.toMillis())},ei.prototype.toMillis=function(){return 1e3*this.seconds+this.nanoseconds/1e6},ei.prototype._compareTo=function(e){return this.seconds===e.seconds?Yr(this.nanoseconds,e.nanoseconds):Yr(this.seconds,e.seconds)},ei.prototype.isEqual=function(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds},ei.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"},ei.prototype.toJSON=function(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}},ei.prototype.valueOf=function(){var e=this.seconds-$r;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")},ei);function ei(e,t){if(this.seconds=e,(this.nanoseconds=t)<0)throw new Lr(Rr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new Lr(Rr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<$r)throw new Lr(Rr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(253402300800<=e)throw new Lr(Rr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}function ti(e){var t,n=0;for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&n++;return n}function ni(e,t){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function ri(e){for(var t in Qr(null!=e&&"object"==typeof e,"isEmpty() expects object parameter."),e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}var ii=(oi.fromBase64String=function(e){return new oi(atob(e))},oi.fromUint8Array=function(e){return new oi(function(e){for(var t="",n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e))},oi.prototype.toBase64=function(){return e=this.binaryString,btoa(e);var e},oi.prototype.toUint8Array=function(){return function(e){for(var t=new Uint8Array(e.length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)},oi.prototype.approximateByteSize=function(){return 2*this.binaryString.length},oi.prototype.compareTo=function(e){return Yr(this.binaryString,e.binaryString)},oi.prototype.isEqual=function(e){return this.binaryString===e.binaryString},oi);function oi(e){this.binaryString=e}function ai(e){return null==e}function si(e){return 0===e&&1/e==-1/0}function ui(e){return"number"==typeof e&&Number.isInteger(e)&&!si(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}ii.EMPTY_BYTE_STRING=new ii("");var ci="__name__",St=(Object.defineProperty(li.prototype,"length",{get:function(){return this.len},enumerable:!1,configurable:!0}),li.prototype.isEqual=function(e){return 0===li.comparator(this,e)},li.prototype.child=function(e){var t=this.segments.slice(this.offset,this.limit());return e instanceof li?e.forEach(function(e){t.push(e)}):t.push(e),this.construct(t)},li.prototype.limit=function(){return this.offset+this.length},li.prototype.popFirst=function(e){return e=void 0===e?1:e,Qr(this.length>=e,"Can't call popFirst() with less segments"),this.construct(this.segments,this.offset+e,this.length-e)},li.prototype.popLast=function(){return Qr(!this.isEmpty(),"Can't call popLast() on empty path"),this.construct(this.segments,this.offset,this.length-1)},li.prototype.firstSegment=function(){return Qr(!this.isEmpty(),"Can't call firstSegment() on empty path"),this.segments[this.offset]},li.prototype.lastSegment=function(){return this.get(this.length-1)},li.prototype.get=function(e){return Qr(e<this.length,"Index out of range"),this.segments[this.offset+e]},li.prototype.isEmpty=function(){return 0===this.length},li.prototype.isPrefixOf=function(e){if(e.length<this.length)return!1;for(var t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0},li.prototype.isImmediateParentOf=function(e){if(this.length+1!==e.length)return!1;for(var t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0},li.prototype.forEach=function(e){for(var t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])},li.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())},li.comparator=function(e,t){for(var n=Math.min(e.length,t.length),r=0;r<n;r++){var i=e.get(r),o=t.get(r);if(i<o)return-1;if(o<i)return 1}return e.length<t.length?-1:e.length>t.length?1:0},li);function li(e,t,n){void 0===t?t=0:t>e.length&&jr("offset "+t+" out of range "+e.length),void 0===n?n=e.length-t:n>e.length-t&&jr("length "+n+" out of range "+(e.length-t)),this.segments=e,this.offset=t,this.len=n}var hi,fi=(n(di,hi=St),di.prototype.construct=function(e,t,n){return new di(e,t,n)},di.prototype.canonicalString=function(){return this.toArray().join("/")},di.prototype.toString=function(){return this.canonicalString()},di.fromString=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var n=[],r=0,i=e;r<i.length;r++){var o=i[r];if(0<=o.indexOf("//"))throw new Lr(Rr.INVALID_ARGUMENT,"Invalid segment ("+o+"). Paths must not contain // in them.");n.push.apply(n,o.split("/").filter(function(e){return 0<e.length}))}return new di(n)},di.emptyPath=function(){return new di([])},di);function di(){return null!==hi&&hi.apply(this,arguments)||this}var pi,yi=/^[_a-zA-Z][_a-zA-Z0-9]*$/,mi=(n(gi,pi=St),gi.prototype.construct=function(e,t,n){return new gi(e,t,n)},gi.isValidIdentifier=function(e){return yi.test(e)},gi.prototype.canonicalString=function(){return this.toArray().map(function(e){return e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),gi.isValidIdentifier(e)||(e="`"+e+"`"),e}).join(".")},gi.prototype.toString=function(){return this.canonicalString()},gi.prototype.isKeyField=function(){return 1===this.length&&this.get(0)===ci},gi.keyField=function(){return new gi([ci])},gi.fromServerFormat=function(e){for(var t=[],n="",r=0,i=function(){if(0===n.length)throw new Lr(Rr.INVALID_ARGUMENT,"Invalid field path ("+e+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");t.push(n),n=""},o=!1;r<e.length;){var a=e[r];if("\\"===a){if(r+1===e.length)throw new Lr(Rr.INVALID_ARGUMENT,"Path has trailing escape character: "+e);var s=e[r+1];if("\\"!==s&&"."!==s&&"`"!==s)throw new Lr(Rr.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=s,r+=2}else"`"===a?o=!o:"."!==a||o?n+=a:i(),r++}if(i(),o)throw new Lr(Rr.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new gi(t)},gi.emptyPath=function(){return new gi([])},gi);function gi(){return null!==pi&&pi.apply(this,arguments)||this}var vi=(bi.fromPath=function(e){return new bi(fi.fromString(e))},bi.fromName=function(e){return new bi(fi.fromString(e).popFirst(5))},bi.prototype.hasCollectionId=function(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e},bi.prototype.isEqual=function(e){return null!==e&&0===fi.comparator(this.path,e.path)},bi.prototype.toString=function(){return this.path.toString()},bi.comparator=function(e,t){return fi.comparator(e.path,t.path)},bi.isDocumentKey=function(e){return e.length%2==0},bi.fromSegments=function(e){return new bi(new fi(e.slice()))},bi);function bi(e){this.path=e,Qr(bi.isDocumentKey(e),"Invalid DocumentKey with an odd number of segments: "+e.toArray().join("/"))}var wi="server_timestamp",Ti="__type__",Si="__previous_value__",Ii="__local_write_time__";function Ei(e){return(null===(e=((null===(e=null==e?void 0:e.mapValue)||void 0===e?void 0:e.fields)||{})[Ti])||void 0===e?void 0:e.stringValue)===wi}function Ci(e){e=Li(e.mapValue.fields[Ii].timestampValue);return new Zr(e.seconds,e.nanos)}var Di=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function _i(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Ei(e)?4:10:jr("Invalid value type: "+JSON.stringify(e))}function ki(e,t){var n,r=_i(e);if(r!==_i(t))return!1;switch(r){case 0:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Ci(e).isEqual(Ci(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;e=Li(e.timestampValue),t=Li(t.timestampValue);return e.seconds===t.seconds&&e.nanos===t.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return n=t,Mi(e.bytesValue).isEqual(Mi(n.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return r=t,Pi((n=e).geoPointValue.latitude)===Pi(r.geoPointValue.latitude)&&Pi(n.geoPointValue.longitude)===Pi(r.geoPointValue.longitude);case 2:return function(e,t){{if("integerValue"in e&&"integerValue"in t)return Pi(e.integerValue)===Pi(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){e=Pi(e.doubleValue),t=Pi(t.doubleValue);return e===t?si(e)===si(t):isNaN(e)&&isNaN(t)}}return!1}(e,t);case 9:return Xr(e.arrayValue.values||[],t.arrayValue.values||[],ki);case 10:return function(e,t){var n,r=e.mapValue.fields||{},i=t.mapValue.fields||{};if(ti(r)!==ti(i))return!1;for(n in r)if(r.hasOwnProperty(n)&&(void 0===i[n]||!ki(r[n],i[n])))return!1;return!0}(e,t);default:return jr("Unexpected value type: "+JSON.stringify(e))}}function Ai(e,t){return void 0!==(e.values||[]).find(function(e){return ki(e,t)})}function Ni(e,t){var n,r,i=_i(e),o=_i(t);if(i!==o)return Yr(i,o);switch(i){case 0:return 0;case 1:return Yr(e.booleanValue,t.booleanValue);case 2:return function(e,t){e=Pi(e.integerValue||e.doubleValue),t=Pi(t.integerValue||t.doubleValue);return e<t?-1:t<e?1:e===t?0:isNaN(e)?isNaN(t)?0:-1:1}(e,t);case 3:return xi(e.timestampValue,t.timestampValue);case 4:return xi(Ci(e),Ci(t));case 5:return Yr(e.stringValue,t.stringValue);case 6:return function(e,t){e=Mi(e),t=Mi(t);return e.compareTo(t)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){for(var n=e.split("/"),r=t.split("/"),i=0;i<n.length&&i<r.length;i++){var o=Yr(n[i],r[i]);if(0!==o)return o}return Yr(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return n=e.geoPointValue,r=t.geoPointValue,0===(o=Yr(Pi(n.latitude),Pi(r.latitude)))?Yr(Pi(n.longitude),Pi(r.longitude)):o;case 9:return function(e,t){for(var n=e.values||[],r=t.values||[],i=0;i<n.length&&i<r.length;++i){var o=Ni(n[i],r[i]);if(o)return o}return Yr(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){var n=e.fields||{},r=Object.keys(n),i=t.fields||{},o=Object.keys(i);r.sort(),o.sort();for(var a=0;a<r.length&&a<o.length;++a){var s=Yr(r[a],o[a]);if(0!==s)return s;s=Ni(n[r[a]],i[o[a]]);if(0!==s)return s}return Yr(r.length,o.length)}(e.mapValue,t.mapValue);default:throw jr("Invalid value type: "+i)}}function xi(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return Yr(e,t);var n=Li(e),e=Li(t),t=Yr(n.seconds,e.seconds);return 0!==t?t:Yr(n.nanos,e.nanos)}function Oi(e){return Ri(e)}function Ri(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){e=Li(e);return"time("+e.seconds+","+e.nanos+")"}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?Mi(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,vi.fromName(t).toString()):"geoPointValue"in e?"geo("+(t=e.geoPointValue).latitude+","+t.longitude+")":"arrayValue"in e?function(e){for(var t="[",n=!0,r=0,i=e.values||[];r<i.length;r++){n?n=!1:t+=",",t+=Ri(i[r])}return t+"]"}(e.arrayValue):"mapValue"in e?function(e){for(var t=Object.keys(e.fields||{}).sort(),n="{",r=!0,i=0,o=t;i<o.length;i++){var a=o[i];r?r=!1:n+=",",n+=a+":"+Ri(e.fields[a])}return n+"}"}(e.mapValue):jr("Invalid value type: "+JSON.stringify(e));var t}function Li(e){if(zr(!!e,"Cannot normalize null or undefined timestamp."),"string"!=typeof e)return{seconds:Pi(e.seconds),nanos:t=Pi(e.nanos)};var t=0,n=Di.exec(e);zr(!!n,"invalid timestamp: "+e),n[1]&&(n=((n=n[1])+"000000000").substr(0,9),t=Number(n));e=new Date(e);return{seconds:Math.floor(e.getTime()/1e3),nanos:t}}function Pi(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function Mi(e){return"string"==typeof e?ii.fromBase64String(e):ii.fromUint8Array(e)}function qi(e,t){return{referenceValue:"projects/"+e.projectId+"/databases/"+e.database+"/documents/"+t.path.canonicalString()}}function Fi(e){return!!e&&"integerValue"in e}function Bi(e){return Fi(e)||!!(e=e)&&"doubleValue"in e}function Vi(e){return!!e&&"arrayValue"in e}function Ui(e){return!!e&&"referenceValue"in e}function Ki(e){return e&&"nullValue"in e}function ji(e){return e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function zi(e){return e&&"mapValue"in e}var Qi,It=function(e,t){this.key=e,this.version=t},Gi=(n(Wi,Qi=It),Wi.prototype.field=function(e){return this.objectValue.field(e)},Wi.prototype.data=function(){return this.objectValue},Wi.prototype.toProto=function(){return this.objectValue.proto},Wi.prototype.isEqual=function(e){return e instanceof Wi&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.hasLocalMutations===e.hasLocalMutations&&this.hasCommittedMutations===e.hasCommittedMutations&&this.objectValue.isEqual(e.objectValue)},Wi.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.objectValue.toString()+", {hasLocalMutations: "+this.hasLocalMutations+"}), {hasCommittedMutations: "+this.hasCommittedMutations+"})"},Object.defineProperty(Wi.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:!1,configurable:!0}),Wi);function Wi(e,t,n,r){t=Qi.call(this,e,t)||this;return t.objectValue=n,t.hasLocalMutations=!!r.hasLocalMutations,t.hasCommittedMutations=!!r.hasCommittedMutations,t}var Hi,Yi=(n(Xi,Hi=It),Xi.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"},Object.defineProperty(Xi.prototype,"hasPendingWrites",{get:function(){return this.hasCommittedMutations},enumerable:!1,configurable:!0}),Xi.prototype.isEqual=function(e){return e instanceof Xi&&e.hasCommittedMutations===this.hasCommittedMutations&&e.version.isEqual(this.version)&&e.key.isEqual(this.key)},Xi);function Xi(e,t,n){t=Hi.call(this,e,t)||this;return t.hasCommittedMutations=!(!n||!n.hasCommittedMutations),t}var Ji,$i=(n(Zi,Ji=It),Zi.prototype.toString=function(){return"UnknownDocument("+this.key+", "+this.version+")"},Object.defineProperty(Zi.prototype,"hasPendingWrites",{get:function(){return!0},enumerable:!1,configurable:!0}),Zi.prototype.isEqual=function(e){return e instanceof Zi&&e.version.isEqual(this.version)&&e.key.isEqual(this.key)},Zi);function Zi(){return null!==Ji&&Ji.apply(this,arguments)||this}var eo=function(e,t,n,r,i,o,a){void 0===t&&(t=null),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=null),void 0===o&&(o=null),void 0===a&&(a=null),this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=o,this.endAt=a,this.memoizedCanonicalId=null};function to(e,t,n,r,i,o,a){return void 0===t&&(t=null),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=null),void 0===o&&(o=null),void 0===a&&(a=null),new eo(e,t,n,r,i,o,a)}function no(e){var t=Gr(e,eo);return null===t.memoizedCanonicalId&&(e=t.path.canonicalString(),null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(function(e){return Qr((e=e)instanceof Co,"canonifyFilter() only supports FieldFilters"),e.field.canonicalString()+e.op.toString()+Oi(e.value)}).join(","),e+="|ob:",e+=t.orderBy.map(function(e){return(e=e).field.canonicalString()+e.dir}).join(","),ai(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=Xo(t.startAt)),t.endAt&&(e+="|ub:",e+=Xo(t.endAt)),t.memoizedCanonicalId=e),t.memoizedCanonicalId}function ro(e){var t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),0<e.filters.length&&(t+=", filters: ["+e.filters.map(function(e){return Qr((e=e)instanceof Co,"stringifyFilter() only supports FieldFilters"),e.field.canonicalString()+" "+e.op+" "+Oi(e.value)}).join(", ")+"]"),ai(e.limit)||(t+=", limit: "+e.limit),0<e.orderBy.length&&(t+=", orderBy: ["+e.orderBy.map(function(e){return(e=e).field.canonicalString()+" ("+e.dir+")"}).join(", ")+"]"),e.startAt&&(t+=", startAt: "+Xo(e.startAt)),e.endAt&&(t+=", endAt: "+Xo(e.endAt)),"Target("+t+")"}function io(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(var n,r,i=0;i<e.orderBy.length;i++)if(n=e.orderBy[i],r=t.orderBy[i],n.dir!==r.dir||!n.field.isEqual(r.field))return!1;if(e.filters.length!==t.filters.length)return!1;for(var o,a,i=0;i<e.filters.length;i++)if(o=e.filters[i],a=t.filters[i],Qr(o instanceof Co&&a instanceof Co,"Only FieldFilters can be compared"),o.op!==a.op||!o.field.isEqual(a.field)||!ki(o.value,a.value))return!1;return e.collectionGroup===t.collectionGroup&&(!!e.path.isEqual(t.path)&&(!!$o(e.startAt,t.startAt)&&$o(e.endAt,t.endAt)))}function oo(e){return vi.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}var ao=function(e,t,n,r,i,o,a,s){void 0===t&&(t=null),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=null),void 0===o&&(o="F"),void 0===a&&(a=null),void 0===s&&(s=null),this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=o,this.startAt=a,this.endAt=s,this.memoizedOrderBy=null,this.memoizedTarget=null,this.startAt&&Qr(this.startAt.position.length<=mo(this).length,"Bound is longer than orderBy"),this.endAt&&Qr(this.endAt.position.length<=mo(this).length,"Bound is longer than orderBy")};function so(e,t,n,r,i,o,a,s){return new ao(e,t,n,r,i,o,a,s)}function uo(e){return new ao(e)}function co(e){return!ai(e.limit)&&"F"===e.limitType}function lo(e){return!ai(e.limit)&&"L"===e.limitType}function ho(e){return 0<e.explicitOrderBy.length?e.explicitOrderBy[0].field:null}function fo(e){for(var t=0,n=e.filters;t<n.length;t++){var r=n[t];if(Qr(r instanceof Co,"Only FieldFilters are supported"),r.isInequality())return r.field}return null}function po(e){return vi.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function yo(e){return null!==e.collectionGroup}function mo(e){var t=Gr(e,ao);if(null===t.memoizedOrderBy){t.memoizedOrderBy=[];var n=fo(t),e=ho(t);if(null!==n&&null===e)n.isKeyField()||t.memoizedOrderBy.push(new Zo(n)),t.memoizedOrderBy.push(new Zo(mi.keyField(),"asc"));else{Qr(null===n||null!==e&&n.isEqual(e),"First orderBy should match inequality field.");for(var r=!1,i=0,o=t.explicitOrderBy;i<o.length;i++){var a=o[i];t.memoizedOrderBy.push(a),a.field.isKeyField()&&(r=!0)}r||(e=0<t.explicitOrderBy.length?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc",t.memoizedOrderBy.push(new Zo(mi.keyField(),e)))}}return t.memoizedOrderBy}function go(e){var t=Gr(e,ao);if(!t.memoizedTarget)if("F"===t.limitType)t.memoizedTarget=to(t.path,t.collectionGroup,mo(t),t.filters,t.limit,t.startAt,t.endAt);else{for(var n=[],r=0,i=mo(t);r<i.length;r++){var o=i[r],a="desc"===o.dir?"asc":"desc";n.push(new Zo(o.field,a))}var s=t.endAt?new Yo(t.endAt.position,!t.endAt.before):null,e=t.startAt?new Yo(t.startAt.position,!t.startAt.before):null;t.memoizedTarget=to(t.path,t.collectionGroup,n,t.filters,t.limit,s,e)}return t.memoizedTarget}function vo(e,t,n){return new ao(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function bo(e,t){return io(go(e),go(t))&&e.limitType===t.limitType}function wo(e){return no(go(e))+"|lt:"+e.limitType}function To(e){return"Query(target="+ro(go(e))+"; limitType="+e.limitType+")"}function So(e,t){return n=e,i=(r=t).key.path,(null!==n.collectionGroup?r.key.hasCollectionId(n.collectionGroup)&&n.path.isPrefixOf(i):vi.isDocumentKey(n.path)?n.path.isEqual(i):n.path.isImmediateParentOf(i))&&function(e,t){for(var n=0,r=e.explicitOrderBy;n<r.length;n++){var i=r[n];if(!i.field.isKeyField()&&null===t.field(i.field))return}return 1}(e,t)&&function(e,t){for(var n=0,r=e.filters;n<r.length;n++){if(!r[n].matches(t))return}return 1}(e,t)&&function(e,t){if(e.startAt&&!Jo(e.startAt,mo(e),t))return;if(e.endAt&&Jo(e.endAt,mo(e),t))return;return 1}(e,t);var n,r,i}function Io(s){return function(e,t){for(var n=!1,r=0,i=mo(s);r<i.length;r++){var o=i[r],a=function(e,t,n){n=e.field.isKeyField()?vi.comparator(t.key,n.key):function(e,t,n){return t=t.field(e),e=n.field(e),null!==t&&null!==e?Ni(t,e):jr("Trying to compare documents on fields that don't exist")}(e.field,t,n);switch(e.dir){case"asc":return n;case"desc":return-1*n;default:return jr("Unknown direction: "+e.dir)}}(o,e,t);if(0!==a)return a;n=n||o.field.isKeyField()}return Qr(n,"orderBy used that doesn't compare on key field"),0}}var Eo,Co=(n(Do,Eo=function(){}),Do.create=function(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):(Qr(Ui(n),"Comparing on key, but filter value not a RefValue"),Qr("array-contains"!==t&&"array-contains-any"!==t,"'"+t.toString()+"' queries don't make sense on document keys."),new ko(e,t,n)):"array-contains"===t?new Fo(e,n):"in"===t?(Qr(Vi(n),"IN filter has invalid value: "+n.toString()),new Uo(e,n)):"not-in"===t?(Qr(Vi(n),"NOT_IN filter has invalid value: "+n.toString()),new zo(e,n)):"array-contains-any"===t?(Qr(Vi(n),"ARRAY_CONTAINS_ANY filter has invalid value: "+n.toString()),new Wo(e,n)):new Do(e,t,n)},Do.createKeyFieldInFilter=function(e,t,n){return Qr(Vi(n),"Comparing on key with "+t.toString()+", but filter value not an ArrayValue"),Qr((n.arrayValue.values||[]).every(Ui),"Comparing on key with "+t.toString()+", but an array value was not a RefValue"),new("in"===t?xo:Lo)(e,n)},Do.prototype.matches=function(e){e=e.field(this.field);return"!="===this.op?null!==e&&this.matchesComparison(Ni(e,this.value)):null!==e&&_i(this.value)===_i(e)&&this.matchesComparison(Ni(e,this.value))},Do.prototype.matchesComparison=function(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return 0<e;case">=":return 0<=e;default:return jr("Unknown FieldFilter operator: "+this.op)}},Do.prototype.isInequality=function(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)},Do);function Do(e,t,n){var r=Eo.call(this)||this;return r.field=e,r.op=t,r.value=n,r}var _o,ko=(n(Ao,_o=Co),Ao.prototype.matches=function(e){e=vi.comparator(e.key,this.key);return this.matchesComparison(e)},Ao);function Ao(e,t,n){t=_o.call(this,e,t,n)||this;return Qr(Ui(n),"KeyFieldFilter expects a ReferenceValue"),t.key=vi.fromName(n.referenceValue),t}var No,xo=(n(Oo,No=Co),Oo.prototype.matches=function(t){return this.keys.some(function(e){return e.isEqual(t.key)})},Oo);function Oo(e,t){e=No.call(this,e,"in",t)||this;return e.keys=Mo("in",t),e}var Ro,Lo=(n(Po,Ro=Co),Po.prototype.matches=function(t){return!this.keys.some(function(e){return e.isEqual(t.key)})},Po);function Po(e,t){e=Ro.call(this,e,"not-in",t)||this;return e.keys=Mo("not-in",t),e}function Mo(t,e){return Qr(Vi(e),"KeyFieldInFilter/KeyFieldNotInFilter expects an ArrayValue"),((null===(e=e.arrayValue)||void 0===e?void 0:e.values)||[]).map(function(e){return Qr(Ui(e),"Comparing on key with "+t.toString()+", but an array value was not a ReferenceValue"),vi.fromName(e.referenceValue)})}var qo,Fo=(n(Bo,qo=Co),Bo.prototype.matches=function(e){e=e.field(this.field);return Vi(e)&&Ai(e.arrayValue,this.value)},Bo);function Bo(e,t){return qo.call(this,e,"array-contains",t)||this}var Vo,Uo=(n(Ko,Vo=Co),Ko.prototype.matches=function(e){e=e.field(this.field);return null!==e&&Ai(this.value.arrayValue,e)},Ko);function Ko(e,t){e=Vo.call(this,e,"in",t)||this;return Qr(Vi(t),"InFilter expects an ArrayValue"),e}var jo,zo=(n(Qo,jo=Co),Qo.prototype.matches=function(e){if(Ai(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;e=e.field(this.field);return null!==e&&!Ai(this.value.arrayValue,e)},Qo);function Qo(e,t){e=jo.call(this,e,"not-in",t)||this;return Qr(Vi(t),"NotInFilter expects an ArrayValue"),e}var Go,Wo=(n(Ho,Go=Co),Ho.prototype.matches=function(e){var t=this,e=e.field(this.field);return!(!Vi(e)||!e.arrayValue.values)&&e.arrayValue.values.some(function(e){return Ai(t.value.arrayValue,e)})},Ho);function Ho(e,t){e=Go.call(this,e,"array-contains-any",t)||this;return Qr(Vi(t),"ArrayContainsAnyFilter expects an ArrayValue"),e}var Yo=function(e,t){this.position=e,this.before=t};function Xo(e){return(e.before?"b":"a")+":"+e.position.map(Oi).join(",")}function Jo(e,t,n){Qr(e.position.length<=t.length,"Bound has more components than query's orderBy");for(var r=0,i=0;i<e.position.length;i++){var o,a=t[i],s=e.position[i],r=a.field.isKeyField()?(Qr(Ui(s),"Bound has a non-key value where the key path is being used."),vi.comparator(vi.fromName(s.referenceValue),n.key)):(Qr(null!==(o=n.field(a.field)),"Field should exist since document matched the orderBy already."),Ni(s,o));if("desc"===a.dir&&(r*=-1),0!==r)break}return e.before?r<=0:r<0}function $o(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.before!==t.before||e.position.length!==t.position.length)return!1;for(var n=0;n<e.position.length;n++){if(!ki(e.position[n],t.position[n]))return!1}return!0}var Zo=function(e,t){void 0===t&&(t="asc"),this.field=e,this.dir=t};var ea=(ta.fromTimestamp=function(e){return new ta(e)},ta.min=function(){return new ta(new Zr(0,0))},ta.prototype.compareTo=function(e){return this.timestamp._compareTo(e.timestamp)},ta.prototype.isEqual=function(e){return this.timestamp.isEqual(e.timestamp)},ta.prototype.toMicroseconds=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3},ta.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},ta.prototype.toTimestamp=function(){return this.timestamp},ta);function ta(e){this.timestamp=e}var na=(ra.prototype.insert=function(e,t){return new ra(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,aa.BLACK,null,null))},ra.prototype.remove=function(e){return new ra(this.comparator,this.root.remove(e,this.comparator).copy(null,null,aa.BLACK,null,null))},ra.prototype.get=function(e){for(var t=this.root;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:0<n&&(t=t.right)}return null},ra.prototype.indexOf=function(e){for(var t=0,n=this.root;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;n=r<0?n.left:(t+=n.left.size+1,n.right)}return-1},ra.prototype.isEmpty=function(){return this.root.isEmpty()},Object.defineProperty(ra.prototype,"size",{get:function(){return this.root.size},enumerable:!1,configurable:!0}),ra.prototype.minKey=function(){return this.root.minKey()},ra.prototype.maxKey=function(){return this.root.maxKey()},ra.prototype.inorderTraversal=function(e){return this.root.inorderTraversal(e)},ra.prototype.forEach=function(n){this.inorderTraversal(function(e,t){return n(e,t),!1})},ra.prototype.toString=function(){var n=[];return this.inorderTraversal(function(e,t){return n.push(e+":"+t),!1}),"{"+n.join(", ")+"}"},ra.prototype.reverseTraversal=function(e){return this.root.reverseTraversal(e)},ra.prototype.getIterator=function(){return new ia(this.root,null,this.comparator,!1)},ra.prototype.getIteratorFrom=function(e){return new ia(this.root,e,this.comparator,!1)},ra.prototype.getReverseIterator=function(){return new ia(this.root,null,this.comparator,!0)},ra.prototype.getReverseIteratorFrom=function(e){return new ia(this.root,e,this.comparator,!0)},ra);function ra(e,t){this.comparator=e,this.root=t||aa.EMPTY}var ia=(oa.prototype.getNext=function(){Qr(0<this.nodeStack.length,"getNext() called on iterator when hasNext() is false.");var e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t},oa.prototype.hasNext=function(){return 0<this.nodeStack.length},oa.prototype.peek=function(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}},oa);function oa(e,t,n,r){this.isReverse=r,this.nodeStack=[];for(var i=1;!e.isEmpty();)if(i=t?n(e.key,t):1,r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}var aa=(sa.prototype.copy=function(e,t,n,r,i){return new sa(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)},sa.prototype.isEmpty=function(){return!1},sa.prototype.inorderTraversal=function(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)},sa.prototype.reverseTraversal=function(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)},sa.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()},sa.prototype.minKey=function(){return this.min().key},sa.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},sa.prototype.insert=function(e,t,n){var r=this,i=n(e,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()},sa.prototype.removeMin=function(){if(this.left.isEmpty())return sa.EMPTY;var e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()},sa.prototype.remove=function(e,t){var n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return sa.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()},sa.prototype.isRed=function(){return this.color},sa.prototype.fixUp=function(){var e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e},sa.prototype.moveRedLeft=function(){var e=this.colorFlip();return e.right.left.isRed()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip()),e},sa.prototype.moveRedRight=function(){var e=this.colorFlip();return e.left.left.isRed()&&(e=(e=e.rotateRight()).colorFlip()),e},sa.prototype.rotateLeft=function(){var e=this.copy(null,null,sa.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)},sa.prototype.rotateRight=function(){var e=this.copy(null,null,sa.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)},sa.prototype.colorFlip=function(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)},sa.prototype.checkMaxDepth=function(){var e=this.check();return Math.pow(2,e)<=this.size+1},sa.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw jr("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed())throw jr("Right child of ("+this.key+","+this.value+") is red");var e=this.left.check();if(e!==this.right.check())throw jr("Black depths differ");return e+(this.isRed()?0:1)},sa);function sa(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:sa.RED,this.left=null!=r?r:sa.EMPTY,this.right=null!=i?i:sa.EMPTY,this.size=this.left.size+1+this.right.size}aa.EMPTY=null,aa.RED=!0,aa.BLACK=!1;Object.defineProperty(ua.prototype,"key",{get:function(){throw jr("LLRBEmptyNode has no key.")},enumerable:!1,configurable:!0}),Object.defineProperty(ua.prototype,"value",{get:function(){throw jr("LLRBEmptyNode has no value.")},enumerable:!1,configurable:!0}),Object.defineProperty(ua.prototype,"color",{get:function(){throw jr("LLRBEmptyNode has no color.")},enumerable:!1,configurable:!0}),Object.defineProperty(ua.prototype,"left",{get:function(){throw jr("LLRBEmptyNode has no left child.")},enumerable:!1,configurable:!0}),Object.defineProperty(ua.prototype,"right",{get:function(){throw jr("LLRBEmptyNode has no right child.")},enumerable:!1,configurable:!0}),ua.prototype.copy=function(e,t,n,r,i){return this},ua.prototype.insert=function(e,t,n){return new aa(e,t)},ua.prototype.remove=function(e,t){return this},ua.prototype.isEmpty=function(){return!0},ua.prototype.inorderTraversal=function(e){return!1},ua.prototype.reverseTraversal=function(e){return!1},ua.prototype.minKey=function(){return null},ua.prototype.maxKey=function(){return null},ua.prototype.isRed=function(){return!1},ua.prototype.checkMaxDepth=function(){return!0},ua.prototype.check=function(){return 0},l=ua;function ua(){this.size=0}aa.EMPTY=new l;var ca=(la.prototype.has=function(e){return null!==this.data.get(e)},la.prototype.first=function(){return this.data.minKey()},la.prototype.last=function(){return this.data.maxKey()},Object.defineProperty(la.prototype,"size",{get:function(){return this.data.size},enumerable:!1,configurable:!0}),la.prototype.indexOf=function(e){return this.data.indexOf(e)},la.prototype.forEach=function(n){this.data.inorderTraversal(function(e,t){return n(e),!1})},la.prototype.forEachInRange=function(e,t){for(var n=this.data.getIteratorFrom(e[0]);n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,e[1]))return;t(r.key)}},la.prototype.forEachWhile=function(e,t){for(var n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();){if(!e(n.getNext().key))return}},la.prototype.firstAfterOrEqual=function(e){e=this.data.getIteratorFrom(e);return e.hasNext()?e.getNext().key:null},la.prototype.getIterator=function(){return new ha(this.data.getIterator())},la.prototype.getIteratorFrom=function(e){return new ha(this.data.getIteratorFrom(e))},la.prototype.add=function(e){return this.copy(this.data.remove(e).insert(e,!0))},la.prototype.delete=function(e){return this.has(e)?this.copy(this.data.remove(e)):this},la.prototype.isEmpty=function(){return this.data.isEmpty()},la.prototype.unionWith=function(e){var t=this;return t.size<e.size&&(t=e,e=this),e.forEach(function(e){t=t.add(e)}),t},la.prototype.isEqual=function(e){if(!(e instanceof la))return!1;if(this.size!==e.size)return!1;for(var t=this.data.getIterator(),n=e.data.getIterator();t.hasNext();){var r=t.getNext().key,i=n.getNext().key;if(0!==this.comparator(r,i))return!1}return!0},la.prototype.toArray=function(){var t=[];return this.forEach(function(e){t.push(e)}),t},la.prototype.toString=function(){var t=[];return this.forEach(function(e){return t.push(e)}),"SortedSet("+t.toString()+")"},la.prototype.copy=function(e){var t=new la(this.comparator);return t.data=e,t},la);function la(e){this.comparator=e,this.data=new na(this.comparator)}var ha=(fa.prototype.getNext=function(){return this.iter.getNext().key},fa.prototype.hasNext=function(){return this.iter.hasNext()},fa);function fa(e){this.iter=e}var da=new na(vi.comparator);var pa=new na(vi.comparator);var ya=new na(vi.comparator);var ma=new ca(vi.comparator);function ga(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var n=ma,r=0,i=e;r<i.length;r++)var o=i[r],n=n.add(o);return n}var va=new ca(Yr);var ba=(wa.empty=function(){return new wa({mapValue:{}})},wa.prototype.field=function(e){if(e.isEmpty())return this.proto;for(var t=this.proto,n=0;n<e.length-1;++n){if(!t.mapValue.fields)return null;if(!zi(t=t.mapValue.fields[e.get(n)]))return null}return(t=(t.mapValue.fields||{})[e.lastSegment()])||null},wa.prototype.isEqual=function(e){return ki(this.proto,e.proto)},wa);function wa(e){Qr(!Ei(this.proto=e),"ServerTimestamps should be converted to ServerTimestampValue")}var Ta=(Sa.prototype.set=function(e,t){return Qr(!e.isEmpty(),"Cannot set field for empty path on ObjectValue"),this.setOverlay(e,t),this},Sa.prototype.delete=function(e){return Qr(!e.isEmpty(),"Cannot delete field for empty path on ObjectValue"),this.setOverlay(e,null),this},Sa.prototype.setOverlay=function(e,t){for(var n=this.overlayMap,r=0;r<e.length-1;++r)var i=e.get(r),o=n.get(i),n=(o instanceof Map||(o=o&&10===_i(o)?new Map(Object.entries(o.mapValue.fields||{})):new Map,n.set(i,o)),o);n.set(e.lastSegment(),t)},Sa.prototype.build=function(){var e=this.applyOverlay(mi.emptyPath(),this.overlayMap);return null!=e?new ba(e):this.baseObject},Sa.prototype.applyOverlay=function(r,e){var i=this,o=!1,t=this.baseObject.field(r),a=zi(t)?Object.assign({},t.mapValue.fields):{};return e.forEach(function(e,t){var n;e instanceof Map?null!=(n=i.applyOverlay(r.child(t),e))&&(a[t]=n,o=!0):null!==e?(a[t]=e,o=!0):a.hasOwnProperty(t)&&(delete a[t],o=!0)}),o?{mapValue:{fields:a}}:null},Sa);function Sa(e){void 0===e&&(e=ba.empty()),this.baseObject=e,this.overlayMap=new Map}var Ia,Ea=function(e){this.count=e};function Ca(e){switch(e){case Rr.OK:return jr("Treated status OK as error");case Rr.CANCELLED:case Rr.UNKNOWN:case Rr.DEADLINE_EXCEEDED:case Rr.RESOURCE_EXHAUSTED:case Rr.INTERNAL:case Rr.UNAVAILABLE:case Rr.UNAUTHENTICATED:return!1;case Rr.INVALID_ARGUMENT:case Rr.NOT_FOUND:case Rr.ALREADY_EXISTS:case Rr.PERMISSION_DENIED:case Rr.FAILED_PRECONDITION:case Rr.ABORTED:case Rr.OUT_OF_RANGE:case Rr.UNIMPLEMENTED:case Rr.DATA_LOSS:return!0;default:return jr("Unknown status code: "+e)}}function Da(e){if(void 0===e)return Vr("GRPC error has no .code"),Rr.UNKNOWN;switch(e){case Ia.OK:return Rr.OK;case Ia.CANCELLED:return Rr.CANCELLED;case Ia.UNKNOWN:return Rr.UNKNOWN;case Ia.DEADLINE_EXCEEDED:return Rr.DEADLINE_EXCEEDED;case Ia.RESOURCE_EXHAUSTED:return Rr.RESOURCE_EXHAUSTED;case Ia.INTERNAL:return Rr.INTERNAL;case Ia.UNAVAILABLE:return Rr.UNAVAILABLE;case Ia.UNAUTHENTICATED:return Rr.UNAUTHENTICATED;case Ia.INVALID_ARGUMENT:return Rr.INVALID_ARGUMENT;case Ia.NOT_FOUND:return Rr.NOT_FOUND;case Ia.ALREADY_EXISTS:return Rr.ALREADY_EXISTS;case Ia.PERMISSION_DENIED:return Rr.PERMISSION_DENIED;case Ia.FAILED_PRECONDITION:return Rr.FAILED_PRECONDITION;case Ia.ABORTED:return Rr.ABORTED;case Ia.OUT_OF_RANGE:return Rr.OUT_OF_RANGE;case Ia.UNIMPLEMENTED:return Rr.UNIMPLEMENTED;case Ia.DATA_LOSS:return Rr.DATA_LOSS;default:return jr("Unknown status code: "+e)}}(St=Ia=Ia||{})[St.OK=0]="OK",St[St.CANCELLED=1]="CANCELLED",St[St.UNKNOWN=2]="UNKNOWN",St[St.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",St[St.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",St[St.NOT_FOUND=5]="NOT_FOUND",St[St.ALREADY_EXISTS=6]="ALREADY_EXISTS",St[St.PERMISSION_DENIED=7]="PERMISSION_DENIED",St[St.UNAUTHENTICATED=16]="UNAUTHENTICATED",St[St.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",St[St.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",St[St.ABORTED=10]="ABORTED",St[St.OUT_OF_RANGE=11]="OUT_OF_RANGE",St[St.UNIMPLEMENTED=12]="UNIMPLEMENTED",St[St.INTERNAL=13]="INTERNAL",St[St.UNAVAILABLE=14]="UNAVAILABLE",St[St.DATA_LOSS=15]="DATA_LOSS";var _a=(ka.createSynthesizedRemoteEventForCurrentChange=function(e,t){var n=new Map;return n.set(e,Aa.createSynthesizedTargetChangeForCurrentChange(e,t)),new ka(ea.min(),n,va,da,ga())},ka);function ka(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}var Aa=(Na.createSynthesizedTargetChangeForCurrentChange=function(e,t){return new Na(ii.EMPTY_BYTE_STRING,t,ga(),ga(),ga())},Na);function Na(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}var xa=function(e,t,n,r){this.updatedTargetIds=e,this.removedTargetIds=t,this.key=n,this.newDoc=r},Oa=function(e,t){this.targetId=e,this.existenceFilter=t},Ra=function(e,t,n,r){void 0===n&&(n=ii.EMPTY_BYTE_STRING),void 0===r&&(r=null),this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r},La=(Object.defineProperty(Pa.prototype,"current",{get:function(){return this._current},enumerable:!1,configurable:!0}),Object.defineProperty(Pa.prototype,"resumeToken",{get:function(){return this._resumeToken},enumerable:!1,configurable:!0}),Object.defineProperty(Pa.prototype,"isPending",{get:function(){return 0!==this.pendingResponses},enumerable:!1,configurable:!0}),Object.defineProperty(Pa.prototype,"hasPendingChanges",{get:function(){return this._hasPendingChanges},enumerable:!1,configurable:!0}),Pa.prototype.updateResumeToken=function(e){0<e.approximateByteSize()&&(this._hasPendingChanges=!0,this._resumeToken=e)},Pa.prototype.toTargetChange=function(){var n=ga(),r=ga(),i=ga();return this.documentChanges.forEach(function(e,t){switch(t){case 0:n=n.add(e);break;case 2:r=r.add(e);break;case 1:i=i.add(e);break;default:jr("Encountered invalid change type: "+t)}}),new Aa(this._resumeToken,this._current,n,r,i)},Pa.prototype.clearPendingChanges=function(){this._hasPendingChanges=!1,this.documentChanges=Ba()},Pa.prototype.addDocumentChange=function(e,t){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.insert(e,t)},Pa.prototype.removeDocumentChange=function(e){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.remove(e)},Pa.prototype.recordPendingTargetRequest=function(){this.pendingResponses+=1},Pa.prototype.recordTargetResponse=function(){--this.pendingResponses},Pa.prototype.markCurrent=function(){this._hasPendingChanges=!0,this._current=!0},Pa);function Pa(){this.pendingResponses=0,this.documentChanges=Ba(),this._resumeToken=ii.EMPTY_BYTE_STRING,this._current=!1,this._hasPendingChanges=!0}var Ma=(qa.prototype.handleDocumentChange=function(e){for(var t=0,n=e.updatedTargetIds;t<n.length;t++){var r=n[t];e.newDoc instanceof Gi?this.addDocumentToTarget(r,e.newDoc):e.newDoc instanceof Yi&&this.removeDocumentFromTarget(r,e.key,e.newDoc)}for(var i=0,o=e.removedTargetIds;i<o.length;i++){r=o[i];this.removeDocumentFromTarget(r,e.key,e.newDoc)}},qa.prototype.handleTargetChange=function(n){var r=this;this.forEachTarget(n,function(e){var t=r.ensureTargetState(e);switch(n.state){case 0:r.isActiveTarget(e)&&t.updateResumeToken(n.resumeToken);break;case 1:t.recordTargetResponse(),t.isPending||t.clearPendingChanges(),t.updateResumeToken(n.resumeToken);break;case 2:t.recordTargetResponse(),t.isPending||r.removeTarget(e),Qr(!n.cause,"WatchChangeAggregator does not handle errored targets");break;case 3:r.isActiveTarget(e)&&(t.markCurrent(),t.updateResumeToken(n.resumeToken));break;case 4:r.isActiveTarget(e)&&(r.resetTarget(e),t.updateResumeToken(n.resumeToken));break;default:jr("Unknown target watch change state: "+n.state)}})},qa.prototype.forEachTarget=function(e,n){var r=this;0<e.targetIds.length?e.targetIds.forEach(n):this.targetStates.forEach(function(e,t){r.isActiveTarget(t)&&n(t)})},qa.prototype.handleExistenceFilter=function(e){var t=e.targetId,n=e.existenceFilter.count,e=this.targetDataForActiveTarget(t);e&&(oo(e=e.target)?0===n?(e=new vi(e.path),this.removeDocumentFromTarget(t,e,new Yi(e,ea.min()))):zr(1===n,"Single document existence filter with count: "+n):this.getCurrentDocumentCountForTarget(t)!==n&&(this.resetTarget(t),this.pendingTargetResets=this.pendingTargetResets.add(t)))},qa.prototype.createRemoteEvent=function(r){var i=this,o=new Map;this.targetStates.forEach(function(e,t){var n=i.targetDataForActiveTarget(t);n&&(e.current&&oo(n.target)&&(n=new vi(n.target.path),null!==i.pendingDocumentUpdates.get(n)||i.targetContainsDocument(t,n)||i.removeDocumentFromTarget(t,n,new Yi(n,r))),e.hasPendingChanges&&(o.set(t,e.toTargetChange()),e.clearPendingChanges()))});var a=ga();this.pendingDocumentTargetMapping.forEach(function(e,t){var n=!0;t.forEachWhile(function(e){e=i.targetDataForActiveTarget(e);return!e||2===e.purpose||(n=!1)}),n&&(a=a.add(e))});var e=new _a(r,o,this.pendingTargetResets,this.pendingDocumentUpdates,a);return this.pendingDocumentUpdates=da,this.pendingDocumentTargetMapping=Fa(),this.pendingTargetResets=new ca(Yr),e},qa.prototype.addDocumentToTarget=function(e,t){var n;this.isActiveTarget(e)&&(n=this.targetContainsDocument(e,t.key)?2:0,this.ensureTargetState(e).addDocumentChange(t.key,n),this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(t.key,t),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(t.key,this.ensureDocumentTargetMapping(t.key).add(e)))},qa.prototype.removeDocumentFromTarget=function(e,t,n){var r;this.isActiveTarget(e)&&(r=this.ensureTargetState(e),this.targetContainsDocument(e,t)?r.addDocumentChange(t,1):r.removeDocumentChange(t),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(t,this.ensureDocumentTargetMapping(t).delete(e)),n&&(this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(t,n)))},qa.prototype.removeTarget=function(e){this.targetStates.delete(e)},qa.prototype.getCurrentDocumentCountForTarget=function(e){var t=this.ensureTargetState(e).toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size},qa.prototype.recordPendingTargetRequest=function(e){this.ensureTargetState(e).recordPendingTargetRequest()},qa.prototype.ensureTargetState=function(e){var t=this.targetStates.get(e);return t||(t=new La,this.targetStates.set(e,t)),t},qa.prototype.ensureDocumentTargetMapping=function(e){var t=this.pendingDocumentTargetMapping.get(e);return t||(t=new ca(Yr),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(e,t)),t},qa.prototype.isActiveTarget=function(e){var t=null!==this.targetDataForActiveTarget(e);return t||Br("WatchChangeAggregator","Detected inactive target",e),t},qa.prototype.targetDataForActiveTarget=function(e){var t=this.targetStates.get(e);return t&&t.isPending?null:this.metadataProvider.getTargetDataForTarget(e)},qa.prototype.resetTarget=function(t){var n=this;Qr(!this.targetStates.get(t).isPending,"Should only reset active targets"),this.targetStates.set(t,new La),this.metadataProvider.getRemoteKeysForTarget(t).forEach(function(e){n.removeDocumentFromTarget(t,e,null)})},qa.prototype.targetContainsDocument=function(e,t){return this.metadataProvider.getRemoteKeysForTarget(e).has(t)},qa);function qa(e){this.metadataProvider=e,this.targetStates=new Map,this.pendingDocumentUpdates=da,this.pendingDocumentTargetMapping=Fa(),this.pendingTargetResets=new ca(Yr)}function Fa(){return new na(vi.comparator)}function Ba(){return new na(vi.comparator)}var Va={asc:"ASCENDING",desc:"DESCENDING"},Ua={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};function Ka(e,t){Qr(!ai(e),t+" is missing")}var ja=function(e,t){this.databaseId=e,this.useProto3Json=t};function za(e){return{integerValue:""+e}}function Qa(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:si(t)?"-0":t}}function Ga(e,t){return ui(t)?za(t):Qa(e,t)}function Wa(e,t){return e.useProto3Json?new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")+"."+("000000000"+t.nanoseconds).slice(-9)+"Z":{seconds:""+t.seconds,nanos:t.nanoseconds}}function Ha(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function Ya(e){return zr(!!e,"Trying to deserialize version that isn't set"),ea.fromTimestamp((e=Li(e=e),new Zr(e.seconds,e.nanos)))}function Xa(e,t){return new fi(["projects",(e=e).projectId,"databases",e.database]).child("documents").child(t).canonicalString()}function Ja(e){e=fi.fromString(e);return zr(bs(e),"Tried to deserialize invalid key "+e.toString()),e}function $a(e,t){return Xa(e.databaseId,t.path)}function Za(e,t){t=Ja(t);if(t.get(1)!==e.databaseId.projectId)throw new Lr(Rr.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+t.get(1)+" vs "+e.databaseId.projectId);if(t.get(3)!==e.databaseId.database)throw new Lr(Rr.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+t.get(3)+" vs "+e.databaseId.database);return new vi(rs(t))}function es(e,t){return Xa(e.databaseId,t)}function ts(e){e=Ja(e);return 4===e.length?fi.emptyPath():rs(e)}function ns(e){return new fi(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function rs(e){return zr(4<e.length&&"documents"===e.get(4),"tried to deserialize invalid key "+e.toString()),e.popFirst(5)}function is(e,t,n){return{name:$a(e,t),fields:n.proto.mapValue.fields}}function os(e,t){return"found"in t?function(e,t){zr(!!t.found,"Tried to deserialize a found document from a missing document."),Ka(t.found.name,"doc.found.name"),Ka(t.found.updateTime,"doc.found.updateTime");var n=Za(e,t.found.name),e=Ya(t.found.updateTime),t=new ba({mapValue:{fields:t.found.fields}});return new Gi(n,e,t,{})}(e,t):"missing"in t?(n=e,zr(!!(e=t).missing,"Tried to deserialize a missing document from a found document."),zr(!!e.readTime,"Tried to deserialize a missing document without a read time."),n=Za(n,e.missing),e=Ya(e.readTime),new Yi(n,e)):jr("invalid batch get response: "+JSON.stringify(t));var n}function as(e,t){if("targetChange"in t){Ka(t.targetChange,"targetChange");var n="NO_CHANGE"===(o=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===o?1:"REMOVE"===o?2:"CURRENT"===o?3:"RESET"===o?4:jr("Got unexpected TargetChange.state: "+o),r=t.targetChange.targetIds||[],i=(i=e,o=t.targetChange.resumeToken,i.useProto3Json?(zr(void 0===o||"string"==typeof o,"value must be undefined or a string when using proto3 Json"),ii.fromBase64String(o||"")):(zr(void 0===o||o instanceof Uint8Array,"value must be undefined or Uint8Array"),ii.fromUint8Array(o||new Uint8Array))),o=t.targetChange.cause,a=o&&(o=void 0===(a=o).code?Rr.UNKNOWN:Da(a.code),new Lr(o,a.message||"")),i=new Ra(n,r,i,a||null)}else if("documentChange"in t){Ka(t.documentChange,"documentChange");var s=t.documentChange;Ka(s.document,"documentChange.name"),Ka(s.document.name,"documentChange.document.name"),Ka(s.document.updateTime,"documentChange.document.updateTime");var u=Za(e,s.document.name),c=Ya(s.document.updateTime),a=new ba({mapValue:{fields:s.document.fields}}),c=new Gi(u,c,a,{}),a=s.targetIds||[],s=s.removedTargetIds||[];i=new xa(a,s,c.key,c)}else if("documentDelete"in t){Ka(t.documentDelete,"documentDelete");c=t.documentDelete;Ka(c.document,"documentDelete.document");var u=Za(e,c.document),l=c.readTime?Ya(c.readTime):ea.min(),l=new Yi(u,l),s=c.removedTargetIds||[];i=new xa([],s,l.key,l)}else if("documentRemove"in t){Ka(t.documentRemove,"documentRemove");l=t.documentRemove;Ka(l.document,"documentRemove");u=Za(e,l.document),s=l.removedTargetIds||[];i=new xa([],s,u,null)}else{if(!("filter"in t))return jr("Unknown change type "+JSON.stringify(t));Ka(t.filter,"filter");u=t.filter;Ka(u.targetId,"filter.targetId");t=u.count||0,t=new Ea(t),u=u.targetId;i=new Oa(u,t)}return i}function ss(e,t){var n,r,i;if(t instanceof Zs)n={update:is(e,t.key,t.value)};else if(t instanceof hu)n={delete:$a(e,t.key)};else if(t instanceof nu)n={update:is(e,t.key,t.data),updateMask:(r=t.fieldMask,i=[],r.fields.forEach(function(e){return i.push(e.canonicalString())}),{fieldPaths:i})};else if(t instanceof au)n={transform:{document:$a(e,t.key),fieldTransforms:t.fieldTransforms.map(function(e){var t=e.transform;{if(t instanceof Is)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(t instanceof Ds)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:t.elements}};if(t instanceof Ns)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:t.elements}};if(t instanceof Ls)return{fieldPath:e.field.canonicalString(),increment:t.operand};throw jr("Unknown transform: "+e.transform)}})}};else{if(!(t instanceof pu))return jr("Unknown mutation type "+t.type);n={verify:$a(e,t.key)}}return t.precondition.isNone||(n.currentDocument=(e=e,Qr(!(t=t.precondition).isNone,"Can't serialize an empty precondition"),void 0!==t.updateTime?{updateTime:function(e,t){return Wa(e,t.toTimestamp())}(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:jr("Unknown precondition"))),n}function us(t,e){var n=e.currentDocument?void 0!==(o=e.currentDocument).updateTime?js.updateTime(Ya(o.updateTime)):void 0!==o.exists?js.exists(o.exists):js.none():js.none();if(e.update){Ka(e.update.name,"name");var r=Za(t,e.update.name),i=new ba({mapValue:{fields:e.update.fields}});if(e.updateMask){var o=function(e){e=e.fieldPaths||[];return new Fs(e.map(function(e){return mi.fromServerFormat(e)}))}(e.updateMask);return new nu(r,i,o,n)}return new Zs(r,i,n)}if(e.delete){r=Za(t,e.delete);return new hu(r,n)}if(e.transform){r=Za(t,e.transform.document),i=e.transform.fieldTransforms.map(function(e){return function(e,t){var n=null;{var r;"setToServerValue"in t?(zr("REQUEST_TIME"===t.setToServerValue,"Unknown server value transform proto: "+JSON.stringify(t)),n=new Is):"appendMissingElements"in t?(r=t.appendMissingElements.values||[],n=new Ds(r)):"removeAllFromArray"in t?(r=t.removeAllFromArray.values||[],n=new Ns(r)):"increment"in t?n=new Ls(e,t.increment):jr("Unknown transform proto: "+JSON.stringify(t))}t=mi.fromServerFormat(t.fieldPath);return new Vs(t,n)}(t,e)});return zr(!0===n.exists,'Transforms only support precondition "exists == true"'),new au(r,i)}if(e.verify){r=Za(t,e.verify);return new pu(r,n)}return jr("unknown mutation proto: "+JSON.stringify(e))}function cs(e,r){return e&&0<e.length?(zr(void 0!==r,"Received a write result without a commit time"),e.map(function(e){return n=r,(e=(t=e).updateTime?Ya(t.updateTime):Ya(n)).isEqual(ea.min())&&(e=Ya(n)),n=null,t.transformResults&&0<t.transformResults.length&&(n=t.transformResults),new Ks(e,n);var t,n})):[]}function ls(e,t){return{documents:[es(e,t.path)]}}function hs(e,t){var n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(Qr(r.length%2==0,"Collection Group queries should be within a document path or root."),n.parent=es(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(Qr(r.length%2!=0,"Document queries with filters are not supported."),n.parent=es(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);r=function(e){if(0===e.length)return;e=e.map(function(e){return Qr(e instanceof Co,"Only FieldFilters are supported"),function(e){if("=="===e.op){if(ji(e.value))return{unaryFilter:{field:ms(e.field),op:"IS_NAN"}};if(Ki(e.value))return{unaryFilter:{field:ms(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(ji(e.value))return{unaryFilter:{field:ms(e.field),op:"IS_NOT_NAN"}};if(Ki(e.value))return{unaryFilter:{field:ms(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:ms(e.field),op:function(e){return Ua[e]}(e.op),value:e.value}}}(e)});return 1!==e.length?{compositeFilter:{op:"AND",filters:e}}:e[0]}(t.filters);r&&(n.structuredQuery.where=r);r=0!==(r=t.orderBy).length?r.map(function(e){return{field:ms((e=e).field),direction:function(e){return Va[e]}(e.dir)}}):void 0;r&&(n.structuredQuery.orderBy=r);r=e,e=t.limit,e=r.useProto3Json||ai(e)?e:{value:e};return null!==e&&(n.structuredQuery.limit=e),t.startAt&&(n.structuredQuery.startAt=ps(t.startAt)),t.endAt&&(n.structuredQuery.endAt=ps(t.endAt)),n}function fs(e){var t=ts(e.parent),n=e.structuredQuery,r=n.from?n.from.length:0,i=null;0<r&&(zr(1===r,"StructuredQuery.from with more than one collection is not supported."),(a=n.from[0]).allDescendants?i=a.collectionId:t=t.child(a.collectionId));var o=[];n.where&&(o=function t(e){return e?void 0!==e.unaryFilter?[vs(e)]:void 0!==e.fieldFilter?[(n=e,Co.create(gs(n.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":return jr("Unspecified operator");default:return jr("Unknown operator")}}(n.fieldFilter.op),n.fieldFilter.value))]:void 0!==e.compositeFilter?e.compositeFilter.filters.map(function(e){return t(e)}).reduce(function(e,t){return e.concat(t)}):jr("Unknown filter: "+JSON.stringify(e)):[];var n}(n.where));e=[];n.orderBy&&(e=n.orderBy.map(function(e){return new Zo(gs((e=e).field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}));r=null;n.limit&&(r=ai(s="object"==typeof(s=n.limit)?s.value:s)?null:s);var a=null;n.startAt&&(a=ys(n.startAt));var s=null;return n.endAt&&(s=ys(n.endAt)),so(t,i,e,o,r,"F",a,s)}function ds(e,t){t=function(e){switch(e){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return jr("Unrecognized query purpose: "+e)}}(t.purpose);return null==t?null:{"goog-listen-tags":t}}function ps(e){return{before:e.before,values:e.position}}function ys(e){var t=!!e.before,e=e.values||[];return new Yo(e,t)}function ms(e){return{fieldPath:e.canonicalString()}}function gs(e){return mi.fromServerFormat(e.fieldPath)}function vs(e){switch(e.unaryFilter.op){case"IS_NAN":var t=gs(e.unaryFilter.field);return Co.create(t,"==",{doubleValue:NaN});case"IS_NULL":var n=gs(e.unaryFilter.field);return Co.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":n=gs(e.unaryFilter.field);return Co.create(n,"!=",{doubleValue:NaN});case"IS_NOT_NULL":e=gs(e.unaryFilter.field);return Co.create(e,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":return jr("Unspecified filter");default:return jr("Unknown filter")}}function bs(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)}It=function(){this._=void 0};function ws(e,t,n){return e instanceof Is?(r=n,n=t,i={fields:((i={})[Ti]={stringValue:wi},i[Ii]={timestampValue:{seconds:r.seconds,nanos:r.nanoseconds}},i)},n&&(i.fields[Si]=n),{mapValue:i}):e instanceof Ds?ks(e,t):e instanceof Ns?Os(e,t):(Qr(e instanceof Ls,"Expected NumericIncrementTransformOperation but was: "+e),e=Ms(t=Ts(i=e,e=t))+Ms(i.operand),Fi(t)&&Fi(i.operand)?za(e):Qa(i.serializer,e));var r,i}function Ts(e,t){return e instanceof Ls?Bi(t)?t:{integerValue:0}:null}var Ss,Is=(n(Es,Ss=It),Es);function Es(){return null!==Ss&&Ss.apply(this,arguments)||this}var Cs,Ds=(n(_s,Cs=It),_s);function _s(e){var t=Cs.call(this)||this;return t.elements=e,t}function ks(e,t){for(var n=qs(t),r=0,i=e.elements;r<i.length;r++){!function(t){n.some(function(e){return ki(e,t)})||n.push(t)}(i[r])}return{arrayValue:{values:n}}}var As,Ns=(n(xs,As=It),xs);function xs(e){var t=As.call(this)||this;return t.elements=e,t}function Os(e,t){for(var n=qs(t),r=0,i=e.elements;r<i.length;r++){!function(t){n=n.filter(function(e){return!ki(e,t)})}(i[r])}return{arrayValue:{values:n}}}var Rs,Ls=(n(Ps,Rs=It),Ps);function Ps(e,t){var n=Rs.call(this)||this;return n.serializer=e,Qr(Bi(n.operand=t),"NumericIncrementTransform transform requires a NumberValue"),n}function Ms(e){return Pi(e.integerValue||e.doubleValue)}function qs(e){return Vi(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}var Fs=(Bs.prototype.covers=function(e){for(var t=0,n=this.fields;t<n.length;t++){if(n[t].isPrefixOf(e))return!0}return!1},Bs.prototype.isEqual=function(e){return Xr(this.fields,e.fields,function(e,t){return e.isEqual(t)})},Bs);function Bs(n){(this.fields=n).sort(mi.comparator),Qr(!n.some(function(e,t){return 0!==t&&e.isEqual(n[t-1])}),"FieldMask contains field that is not unique: "+n.find(function(e,t){return 0!==t&&e.isEqual(n[t-1])}))}var Vs=function(e,t){this.field=e,this.transform=t};function Us(e,t){return e.field.isEqual(t.field)&&(e=e.transform,t=t.transform,e instanceof Ds&&t instanceof Ds||e instanceof Ns&&t instanceof Ns?Xr(e.elements,t.elements,ki):e instanceof Ls&&t instanceof Ls?ki(e.operand,t.operand):e instanceof Is&&t instanceof Is)}var Ks=function(e,t){this.version=e,this.transformResults=t},js=(zs.none=function(){return new zs},zs.exists=function(e){return new zs(void 0,e)},zs.updateTime=function(e){return new zs(e)},Object.defineProperty(zs.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!1,configurable:!0}),zs.prototype.isEqual=function(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)},zs);function zs(e,t){this.updateTime=e,this.exists=t,Qr(void 0===e||void 0===t,'Precondition can specify "exists" or "updateTime" but not both')}function Qs(e,t){return void 0!==e.updateTime?t instanceof Gi&&t.version.isEqual(e.updateTime):void 0!==e.exists?e.exists===t instanceof Gi:(Qr(e.isNone,"Precondition should be empty"),1)}l=function(){};function Gs(e,t,n){return Xs(e,t),e instanceof Zs?(r=e,Qr(null==(i=n).transformResults,"Transform results received by SetMutation."),new Gi(r.key,i.version,r.value,{hasCommittedMutations:!0})):e instanceof nu?function(e,t,n){if(Qr(null==n.transformResults,"Transform results received by PatchMutation."),!Qs(e.precondition,t))return new $i(e.key,n.version);t=iu(e,t);return new Gi(e.key,n.version,t,{hasCommittedMutations:!0})}(e,t,n):e instanceof au?function(e,t,n){if(zr(null!=n.transformResults,"Transform results missing for TransformMutation."),!Qs(e.precondition,t))return new $i(e.key,n.version);var r=uu(e,t),t=function(e,t,n){var r=[];zr(e.length===n.length,"server transform result count ("+n.length+") should match field transform count ("+e.length+")");for(var i=0;i<n.length;i++){var o=e[i],a=o.transform,s=null;t instanceof Gi&&(s=t.field(o.field)),r.push(function(e,t,n){return e instanceof Ds?ks(e,t):e instanceof Ns?Os(e,t):(Qr(null!==n,"Didn't receive transformResult for non-array transform"),n)}(a,s,n[i]))}return r}(e.fieldTransforms,t,n.transformResults),n=n.version,t=cu(e,r.data(),t);return new Gi(e.key,n,t,{hasCommittedMutations:!0})}(e,t,n):(Qr(e instanceof hu,"Unexpected mutation type: "+e),e=e,Qr(null==(n=n).transformResults,"Transform results received by DeleteMutation."),new Yi(e.key,n.version,{hasCommittedMutations:!0}));var r,i}function Ws(e,t,n,r){return Xs(e,t),e instanceof Zs?function(e,t){if(!Qs(e.precondition,t))return t;t=Js(t);return new Gi(e.key,t,e.value,{hasLocalMutations:!0})}(e,t):e instanceof nu?function(e,t){if(!Qs(e.precondition,t))return t;var n=Js(t),t=iu(e,t);return new Gi(e.key,n,t,{hasLocalMutations:!0})}(e,t):e instanceof au?function(e,t,n,r){if(!Qs(e.precondition,t))return t;var i=uu(e,t),r=function(e,t,n,r){for(var i=[],o=0,a=e;o<a.length;o++){var s=a[o],u=s.transform,c=null;n instanceof Gi&&(c=n.field(s.field)),null===c&&r instanceof Gi&&(c=r.field(s.field)),i.push(ws(u,c,t))}return i}(e.fieldTransforms,n,t,r),r=cu(e,i.data(),r);return new Gi(e.key,i.version,r,{hasLocalMutations:!0})}(e,t,r,n):(Qr(e instanceof hu,"Unexpected mutation type: "+e),function(e,t){if(!Qs(e.precondition,t))return t;t&&Qr(t.key.isEqual(e.key),"Can only apply mutation to document with same key");return new Yi(e.key,ea.min())}(e,t))}function Hs(e,t){return e instanceof au?function(e,t){for(var n=null,r=0,i=e.fieldTransforms;r<i.length;r++){var o=i[r],a=t instanceof Gi?t.field(o.field):void 0,a=Ts(o.transform,a||null);null!=a&&(n=(null==n?new Ta:n).set(o.field,a))}return n?n.build():null}(e,t):null}function Ys(e,t){return e.type===t.type&&(!!e.key.isEqual(t.key)&&(!!e.precondition.isEqual(t.precondition)&&(0===e.type?e.value.isEqual(t.value):1===e.type?e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask):2!==e.type||Xr(e.fieldTransforms,e.fieldTransforms,Us))))}function Xs(e,t){null!=t&&Qr(t.key.isEqual(e.key),"Can only apply a mutation to a document with the same key")}function Js(e){return e instanceof Gi?e.version:ea.min()}var $s,Zs=(n(eu,$s=l),eu);function eu(e,t,n){var r=$s.call(this)||this;return r.key=e,r.value=t,r.precondition=n,r.type=0,r}var tu,nu=(n(ru,tu=l),ru);function ru(e,t,n,r){var i=tu.call(this)||this;return i.key=e,i.data=t,i.fieldMask=n,i.precondition=r,i.type=1,i}function iu(e,t){var n,r,t=t instanceof Gi?t.data():ba.empty();return n=e,r=new Ta(t),n.fieldMask.fields.forEach(function(e){var t;e.isEmpty()||(null!==(t=n.data.field(e))?r.set(e,t):r.delete(e))}),r.build()}var ou,au=(n(su,ou=l),su);function su(e,t){var n=ou.call(this)||this;return n.key=e,n.fieldTransforms=t,n.type=2,n.precondition=js.exists(!0),n}function uu(e,t){return Qr(t instanceof Gi,"Unknown MaybeDocument type "+t),Qr(t.key.isEqual(e.key),"Can only transform a document with the same key"),t}function cu(e,t,n){Qr(n.length===e.fieldTransforms.length,"TransformResults length mismatch.");for(var r=new Ta(t),i=0;i<e.fieldTransforms.length;i++){var o=e.fieldTransforms[i];r.set(o.field,n[i])}return r.build()}var lu,hu=(n(fu,lu=l),fu);function fu(e,t){var n=lu.call(this)||this;return n.key=e,n.precondition=t,n.type=3,n}var du,pu=(n(yu,du=l),yu);function yu(e,t){var n=du.call(this)||this;return n.key=e,n.precondition=t,n.type=4,n}var mu=-1,gu=(vu.prototype.applyToRemoteDocument=function(e,t,n){t&&Qr(t.key.isEqual(e),"applyToRemoteDocument: key "+e+" should match maybeDoc key\n        "+t.key);var r=n.mutationResults;Qr(r.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+r.length+").");for(var i=0;i<this.mutations.length;i++){var o=this.mutations[i];o.key.isEqual(e)&&(t=Gs(o,t,r[i]))}return t},vu.prototype.applyToLocalView=function(e,t){t&&Qr(t.key.isEqual(e),"applyToLocalDocument: key "+e+" should match maybeDoc key\n        "+t.key);for(var n=0,r=this.baseMutations;n<r.length;n++){(i=r[n]).key.isEqual(e)&&(t=Ws(i,t,t,this.localWriteTime))}for(var i,o=t,a=0,s=this.mutations;a<s.length;a++){(i=s[a]).key.isEqual(e)&&(t=Ws(i,t,o,this.localWriteTime))}return t},vu.prototype.applyToLocalDocumentSet=function(n){var r=this,i=n;return this.mutations.forEach(function(e){var t=r.applyToLocalView(e.key,n.get(e.key));t&&(i=i.insert(e.key,t))}),i},vu.prototype.keys=function(){return this.mutations.reduce(function(e,t){return e.add(t.key)},ga())},vu.prototype.isEqual=function(e){return this.batchId===e.batchId&&Xr(this.mutations,e.mutations,Ys)&&Xr(this.baseMutations,e.baseMutations,Ys)},vu);function vu(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,Qr(0<(this.mutations=r).length,"Cannot create an empty mutation batch")}var bu=(wu.from=function(e,t,n){zr(e.mutations.length===n.length,"Mutations sent "+e.mutations.length+" must equal results received "+n.length);for(var r=ya,i=e.mutations,o=0;o<i.length;o++)r=r.insert(i[o].key,n[o].version);return new wu(e,t,n,r)},wu);function wu(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}var Tu=(Su.prototype.get=function(e){var t=this.mapKeyFn(e),t=this.inner[t];if(void 0!==t)for(var n=0,r=t;n<r.length;n++){var i=r[n],o=i[0],i=i[1];if(this.equalsFn(o,e))return i}},Su.prototype.has=function(e){return void 0!==this.get(e)},Su.prototype.set=function(e,t){var n=this.mapKeyFn(e),r=this.inner[n];if(void 0!==r){for(var i=0;i<r.length;i++)if(this.equalsFn(r[i][0],e))return void(r[i]=[e,t]);r.push([e,t])}else this.inner[n]=[[e,t]]},Su.prototype.delete=function(e){var t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(var r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),!0;return!1},Su.prototype.forEach=function(a){ni(this.inner,function(e,t){for(var n=0,r=t;n<r.length;n++){var i=r[n],o=i[0],i=i[1];a(o,i)}})},Su.prototype.isEmpty=function(){return ri(this.inner)},Su);function Su(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={}}var Iu=(Eu.prototype.catch=function(e){return this.next(void 0,e)},Eu.prototype.next=function(r,i){var o=this;return this.callbackAttached&&jr("Called next() or catch() twice for PersistencePromise"),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(i,this.error):this.wrapSuccess(r,this.result):new Eu(function(t,n){o.nextCallback=function(e){o.wrapSuccess(r,e).next(t,n)},o.catchCallback=function(e){o.wrapFailure(i,e).next(t,n)}})},Eu.prototype.toPromise=function(){var n=this;return new Promise(function(e,t){n.next(e,t)})},Eu.prototype.wrapUserFunction=function(e){try{var t=e();return t instanceof Eu?t:Eu.resolve(t)}catch(e){return Eu.reject(e)}},Eu.prototype.wrapSuccess=function(e,t){return e?this.wrapUserFunction(function(){return e(t)}):Eu.resolve(t)},Eu.prototype.wrapFailure=function(e,t){return e?this.wrapUserFunction(function(){return e(t)}):Eu.reject(t)},Eu.resolve=function(n){return new Eu(function(e,t){e(n)})},Eu.reject=function(n){return new Eu(function(e,t){t(n)})},Eu.waitFor=function(e){return new Eu(function(t,n){var r=0,i=0,o=!1;e.forEach(function(e){++r,e.next(function(){++i,o&&i===r&&t()},function(e){return n(e)})}),o=!0,i===r&&t()})},Eu.or=function(e){for(var n=Eu.resolve(!1),t=0,r=e;t<r.length;t++){!function(t){n=n.next(function(e){return e?Eu.resolve(e):t()})}(r[t])}return n},Eu.forEach=function(e,n){var r=this,i=[];return e.forEach(function(e,t){i.push(n.call(r,e,t))}),this.waitFor(i)},Eu);function Eu(e){var t=this;this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(function(e){t.isDone=!0,t.result=e,t.nextCallback&&t.nextCallback(e)},function(e){t.isDone=!0,t.error=e,t.catchCallback&&t.catchCallback(e)})}var Cu=(Du.prototype.getDocument=function(t,n){var r=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(t,n).next(function(e){return r.getDocumentInternal(t,n,e)})},Du.prototype.getDocumentInternal=function(e,r,i){return this.remoteDocumentCache.getEntry(e,r).next(function(e){for(var t=0,n=i;t<n.length;t++){e=n[t].applyToLocalView(r,e)}return e})},Du.prototype.applyLocalMutationsToDocuments=function(e,t,i){var o=da;return t.forEach(function(e,t){for(var n=0,r=i;n<r.length;n++){t=r[n].applyToLocalView(e,t)}o=o.insert(e,t)}),o},Du.prototype.getDocuments=function(t,e){var n=this;return this.remoteDocumentCache.getEntries(t,e).next(function(e){return n.getLocalViewOfDocuments(t,e)})},Du.prototype.getLocalViewOfDocuments=function(t,r){var i=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,r).next(function(e){var e=i.applyLocalMutationsToDocuments(t,r,e),n=da;return e.forEach(function(e,t){t=t||new Yi(e,ea.min()),n=n.insert(e,t)}),n})},Du.prototype.getDocumentsMatchingQuery=function(e,t,n){return po(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):yo(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n)},Du.prototype.getDocumentsMatchingDocumentQuery=function(e,t){return this.getDocument(e,new vi(t)).next(function(e){var t=pa;return e instanceof Gi&&(t=t.insert(e.key,e)),t})},Du.prototype.getDocumentsMatchingCollectionGroupQuery=function(n,r,i){var o=this;Qr(r.path.isEmpty(),"Currently we only support collection group queries at the root.");var a=r.collectionGroup,s=pa;return this.indexManager.getCollectionParents(n,a).next(function(e){return Iu.forEach(e,function(e){var t,t=(t=r,e=e.child(a),new ao(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt));return o.getDocumentsMatchingCollectionQuery(n,t,i).next(function(e){e.forEach(function(e,t){s=s.insert(e,t)})})}).next(function(){return s})})},Du.prototype.getDocumentsMatchingCollectionQuery=function(t,n,e){var c,l,r=this;return this.remoteDocumentCache.getDocumentsMatchingQuery(t,n,e).next(function(e){return c=e,r.mutationQueue.getAllMutationBatchesAffectingQuery(t,n)}).next(function(e){return l=e,r.addMissingBaseDocuments(t,l,c).next(function(e){c=e;for(var t=0,n=l;t<n.length;t++)for(var r=n[t],i=0,o=r.mutations;i<o.length;i++){var a=o[i],s=a.key,u=c.get(s),u=Ws(a,u,u,r.localWriteTime);c=u instanceof Gi?c.insert(s,u):c.remove(s)}})}).next(function(){return c.forEach(function(e,t){So(n,t)||(c=c.remove(e))}),c})},Du.prototype.addMissingBaseDocuments=function(e,t,n){for(var r=ga(),i=0,o=t;i<o.length;i++)for(var a=0,s=o[i].mutations;a<s.length;a++){var u=s[a];u instanceof nu&&null===n.get(u.key)&&(r=r.add(u.key))}var c=n;return this.remoteDocumentCache.getEntries(e,r).next(function(e){return e.forEach(function(e,t){null!==t&&t instanceof Gi&&(c=c.insert(e,t))}),c})},Du);function Du(e,t,n){this.remoteDocumentCache=e,this.mutationQueue=t,this.indexManager=n}var _u="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",St=(ku.prototype.addOnCommittedListener=function(e){this.onCommittedListeners.push(e)},ku.prototype.raiseOnCommittedEvent=function(){this.onCommittedListeners.forEach(function(e){return e()})},ku);function ku(){this.onCommittedListeners=[]}var Au=(Nu.prototype.withSequenceNumber=function(e){return new Nu(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)},Nu.prototype.withResumeToken=function(e,t){return new Nu(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e)},Nu.prototype.withLastLimboFreeSnapshotVersion=function(e){return new Nu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken)},Nu);function Nu(e,t,n,r,i,o,a){void 0===i&&(i=ea.min()),void 0===o&&(o=ea.min()),void 0===a&&(a=ii.EMPTY_BYTE_STRING),this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=a}var xu=(Ou.prototype.setPreviousValue=function(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue},Ou.prototype.next=function(){var e=++this.previousValue;return this.writeNewSequenceNumber&&this.writeNewSequenceNumber(e),e},Ou);function Ou(e,t){var n=this;this.previousValue=e,t&&(t.sequenceNumberHandler=function(e){return n.setPreviousValue(e)},this.writeNewSequenceNumber=function(e){return t.writeSequenceNumber(e)})}xu.INVALID=-1;var Ru="\x01",Lu="\x01",Pu="\x10",Mu="\x11";function qu(e){for(var t="",n=0;n<e.length;n++)0<t.length&&(t=Fu(t)),t=function(e,t){for(var n=t,r=e.length,i=0;i<r;i++){var o=e.charAt(i);switch(o){case"\0":n+=Ru+Pu;break;case Ru:n+=Ru+Mu;break;default:n+=o}}return n}(e.get(n),t);return Fu(t)}function Fu(e){return e+Ru+Lu}function Bu(e){var t=e.length;if(zr(2<=t,"Invalid path "+e),2===t)return zr(e.charAt(0)===Ru&&e.charAt(1)===Lu,"Non-empty path "+e+" had length 2"),fi.emptyPath();for(var n=t-2,r=[],i="",o=0;o<t;){var a=e.indexOf(Ru,o);switch((a<0||n<a)&&jr('Invalid encoded resource path: "'+e+'"'),e.charAt(a+1)){case Lu:var s=e.substring(o,a),u=void 0;0===i.length?u=s:(u=i+=s,i=""),r.push(u);break;case Pu:i+=e.substring(o,a),i+="\0";break;case Mu:i+=e.substring(o,a+1);break;default:jr('Invalid encoded resource path: "'+e+'"')}o=a+2}return new fi(r)}var Vu=function(e){this.remoteSerializer=e};function Uu(e,t){if(t.document)return i=e.remoteSerializer,o=t.document,r=!!t.hasCommittedMutations,e=Za(i,o.name),i=Ya(o.updateTime),o=new ba({mapValue:{fields:o.fields}}),new Gi(e,i,o,{hasCommittedMutations:!!r});if(t.noDocument){var n=vi.fromSegments(t.noDocument.path),r=Gu(t.noDocument.readTime);return new Yi(n,r,{hasCommittedMutations:!!t.hasCommittedMutations})}if(t.unknownDocument){n=vi.fromSegments(t.unknownDocument.path),t=Gu(t.unknownDocument.version);return new $i(n,t)}return jr("Unexpected DbRemoteDocument");var i,o,r}function Ku(e,t,n){var r=ju(n),n=t.key.path.popLast().toArray();if(t instanceof Gi){var i=(i=e.remoteSerializer,Qr(!(o=t).hasLocalMutations,"Can't serialize documents with mutations."),{name:$a(i,o.key),fields:o.toProto().mapValue.fields,updateTime:Wa(i,o.version.toTimestamp())}),o=t.hasCommittedMutations;return new Gc(null,null,i,o,r,n)}if(t instanceof Yi){var a=t.key.path.toArray(),i=Qu(t.version),o=t.hasCommittedMutations;return new Gc(null,new zc(a,i),null,o,r,n)}if(t instanceof $i){a=t.key.path.toArray(),t=Qu(t.version);return new Gc(new Qc(a,t),null,null,!0,r,n)}return jr("Unexpected MaybeDocument")}function ju(e){e=e.toTimestamp();return[e.seconds,e.nanoseconds]}function zu(e){e=new Zr(e[0],e[1]);return ea.fromTimestamp(e)}function Qu(e){e=e.toTimestamp();return new Fc(e.seconds,e.nanoseconds)}function Gu(e){e=new Zr(e.seconds,e.nanoseconds);return ea.fromTimestamp(e)}function Wu(t,e){var n=(e.baseMutations||[]).map(function(e){return us(t.remoteSerializer,e)}),r=e.mutations.map(function(e){return us(t.remoteSerializer,e)}),i=Zr.fromMillis(e.localWriteTimeMs);return new gu(e.batchId,i,n,r)}function Hu(e){var t,n=Gu(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?Gu(e.lastLimboFreeSnapshotVersion):ea.min(),i=void 0!==e.query.documents?(i=e.query,zr(1===(t=i.documents.length),"DocumentsTarget contained other than 1 document: "+t),go(uo(ts(i.documents[0])))):go(fs(e.query));return new Au(i,e.targetId,0,e.lastListenSequenceNumber,n,r,ii.fromBase64String(e.resumeToken))}function Yu(e,t){Qr(0===t.purpose,"Only queries with purpose 0 may be stored, got "+t.purpose);var n=Qu(t.snapshotVersion),r=Qu(t.lastLimboFreeSnapshotVersion),i=(oo(t.target)?ls:hs)(e.remoteSerializer,t.target),e=t.resumeToken.toBase64();return new Hc(t.targetId,no(t.target),n,e,t.sequenceNumber,r,i)}function Xu(e){var t=fs({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?(Qr(!!t.limit,"Bundled query has limitType LAST, but limit is null"),vo(t,t.limit,"L")):t}var Ju=($u.forUser=function(e,t,n,r){return zr(""!==e.uid,"UserID must not be an empty string."),new $u(e.isAuthenticated()?e.uid:"",t,n,r)},$u.prototype.checkEmpty=function(e){var r=!0,t=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return tc(e).iterate({index:Uc.userMutationsIndex,range:t},function(e,t,n){r=!1,n.done()}).next(function(){return r})},$u.prototype.addMutationBatch=function(p,y,m,g){var v=this,b=nc(p),w=tc(p);return w.add({}).next(function(e){zr("number"==typeof e,"Auto-generated key is not a number");for(var t,n,r,i,o,a=new gu(e,y,m,g),s=(t=v.serializer,n=v.userId,i=(r=a).baseMutations.map(function(e){return ss(t.remoteSerializer,e)}),o=r.mutations.map(function(e){return ss(t.remoteSerializer,e)}),new Uc(n,r.batchId,r.localWriteTime.toMillis(),i,o)),u=[],c=new ca(function(e,t){return Yr(e.canonicalString(),t.canonicalString())}),l=0,h=g;l<h.length;l++){var f=h[l],d=Kc.key(v.userId,f.key.path,e),c=c.add(f.key.path.popLast());u.push(w.put(s)),u.push(b.put(d,Kc.PLACEHOLDER))}return c.forEach(function(e){u.push(v.indexManager.addToCollectionParentIndex(p,e))}),p.addOnCommittedListener(function(){v.documentKeysByBatchId[e]=a.keys()}),Iu.waitFor(u).next(function(){return a})})},$u.prototype.lookupMutationBatch=function(e,t){var n=this;return tc(e).get(t).next(function(e){return e?(zr(e.userId===n.userId,"Unexpected user '"+e.userId+"' for mutation batch "+t),Wu(n.serializer,e)):null})},$u.prototype.lookupMutationKeys=function(e,t){var n=this;return this.documentKeysByBatchId[t]?Iu.resolve(this.documentKeysByBatchId[t]):this.lookupMutationBatch(e,t).next(function(e){if(e){e=e.keys();return n.documentKeysByBatchId[t]=e}return null})},$u.prototype.getNextMutationBatchAfterBatchId=function(e,t){var r=this,i=t+1,t=IDBKeyRange.lowerBound([this.userId,i]),o=null;return tc(e).iterate({index:Uc.userMutationsIndex,range:t},function(e,t,n){t.userId===r.userId&&(zr(t.batchId>=i,"Should have found mutation after "+i),o=Wu(r.serializer,t)),n.done()}).next(function(){return o})},$u.prototype.getHighestUnacknowledgedBatchId=function(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),r=mu;return tc(e).iterate({index:Uc.userMutationsIndex,range:t,reverse:!0},function(e,t,n){r=t.batchId,n.done()}).next(function(){return r})},$u.prototype.getAllMutationBatches=function(e){var t=this,n=IDBKeyRange.bound([this.userId,mu],[this.userId,Number.POSITIVE_INFINITY]);return tc(e).loadAll(Uc.userMutationsIndex,n).next(function(e){return e.map(function(e){return Wu(t.serializer,e)})})},$u.prototype.getAllMutationBatchesAffectingDocumentKey=function(a,s){var u=this,e=Kc.prefixForPath(this.userId,s.path),e=IDBKeyRange.lowerBound(e),c=[];return nc(a).iterate({range:e},function(t,e,n){var r=t[0],i=t[1],o=t[2],i=Bu(i);if(r===u.userId&&s.path.isEqual(i))return tc(a).get(o).next(function(e){if(!e)throw jr("Dangling document-mutation reference found: "+t+" which points to "+o);zr(e.userId===u.userId,"Unexpected user '"+e.userId+"' for mutation batch "+o),c.push(Wu(u.serializer,e))});n.done()}).next(function(){return c})},$u.prototype.getAllMutationBatchesAffectingDocumentKeys=function(t,e){var a=this,s=new ca(Yr),n=[];return e.forEach(function(o){var e=Kc.prefixForPath(a.userId,o.path),e=IDBKeyRange.lowerBound(e),e=nc(t).iterate({range:e},function(e,t,n){var r=e[0],i=e[1],e=e[2],i=Bu(i);r===a.userId&&o.path.isEqual(i)?s=s.add(e):n.done()});n.push(e)}),Iu.waitFor(n).next(function(){return a.lookupMutationBatches(t,s)})},$u.prototype.getAllMutationBatchesAffectingQuery=function(e,t){var o=this;Qr(!po(t),"Document queries shouldn't go down this path"),Qr(!yo(t),"CollectionGroup queries should be handled in LocalDocumentsView");var a=t.path,s=a.length+1,t=Kc.prefixForPath(this.userId,a),t=IDBKeyRange.lowerBound(t),u=new ca(Yr);return nc(e).iterate({range:t},function(e,t,n){var r=e[0],i=e[1],e=e[2],i=Bu(i);r===o.userId&&a.isPrefixOf(i)?i.length===s&&(u=u.add(e)):n.done()}).next(function(){return o.lookupMutationBatches(e,u)})},$u.prototype.lookupMutationBatches=function(e,t){var n=this,r=[],i=[];return t.forEach(function(t){i.push(tc(e).get(t).next(function(e){if(null===e)throw jr("Dangling document-mutation reference found, which points to "+t);zr(e.userId===n.userId,"Unexpected user '"+e.userId+"' for mutation batch "+t),r.push(Wu(n.serializer,e))}))}),Iu.waitFor(i).next(function(){return r})},$u.prototype.removeMutationBatch=function(t,n){var r=this;return ec(t.simpleDbTransaction,this.userId,n).next(function(e){return t.addOnCommittedListener(function(){r.removeCachedMutationKeys(n.batchId)}),Iu.forEach(e,function(e){return r.referenceDelegate.markPotentiallyOrphaned(t,e)})})},$u.prototype.removeCachedMutationKeys=function(e){delete this.documentKeysByBatchId[e]},$u.prototype.performConsistencyCheck=function(t){var i=this;return this.checkEmpty(t).next(function(e){if(!e)return Iu.resolve();var e=IDBKeyRange.lowerBound(Kc.prefixForUser(i.userId)),r=[];return nc(t).iterate({range:e},function(e,t,n){e[0]===i.userId?(e=Bu(e[1]),r.push(e)):n.done()}).next(function(){zr(0===r.length,"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+r.map(function(e){return e.canonicalString()}))})})},$u.prototype.containsKey=function(e,t){return Zu(e,this.userId,t)},$u.prototype.getMutationQueueMetadata=function(e){var t=this;return rc(e).get(this.userId).next(function(e){return e||new Vc(t.userId,mu,"")})},$u);function $u(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.documentKeysByBatchId={}}function Zu(e,o,t){var t=Kc.prefixForPath(o,t.path),a=t[1],t=IDBKeyRange.lowerBound(t),s=!1;return nc(e).iterate({range:t,keysOnly:!0},function(e,t,n){var r=e[0],i=e[1];e[2];r===o&&i===a&&(s=!0),n.done()}).next(function(){return s})}function ec(e,t,n){var r=e.store(Uc.store),i=e.store(Kc.store),o=[],e=IDBKeyRange.only(n.batchId),a=0,e=r.iterate({range:e},function(e,t,n){return a++,n.delete()});o.push(e.next(function(){zr(1===a,"Dangling document-mutation reference found: Missing batch "+n.batchId)}));for(var s=[],u=0,c=n.mutations;u<c.length;u++){var l=c[u],h=Kc.key(t,l.key.path,n.batchId);o.push(i.delete(h)),s.push(l.key)}return Iu.waitFor(o).next(function(){return s})}function tc(e){return Ll.getStore(e,Uc.store)}function nc(e){return Ll.getStore(e,Kc.store)}function rc(e){return Ll.getStore(e,Vc.store)}ic.prototype.getReadTime=function(e){var t=this.changes.get(e);return t?(Qr(!!t.readTime,"Read time is not set for "+e+". All removeEntry() calls must include a readTime if 'trackRemovals' is used."),t.readTime):ea.min()},ic.prototype.addEntry=function(e,t){this.assertNotApplied(),this.changes.set(e.key,{maybeDocument:e,readTime:t})},ic.prototype.removeEntry=function(e,t){void 0===t&&(t=null),this.assertNotApplied(),this.changes.set(e,{maybeDocument:null,readTime:t})},ic.prototype.getEntry=function(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?Iu.resolve(n.maybeDocument):this.getFromCache(e,t)},ic.prototype.getEntries=function(e,t){return this.getAllFromCache(e,t)},ic.prototype.apply=function(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)},ic.prototype.assertNotApplied=function(){Qr(!this.changesApplied,"Changes have already been applied.")},It=ic;function ic(){this.changes=new Tu(function(e){return e.toString()},function(e,t){return e.isEqual(t)}),this.changesApplied=!1}var oc=(ac.prototype.addEntry=function(e,t,n){return hc(e).put(fc(t),n)},ac.prototype.removeEntry=function(e,t){e=hc(e),t=fc(t);return e.delete(t)},ac.prototype.updateMetadata=function(t,n){var r=this;return this.getMetadata(t).next(function(e){return e.byteSize+=n,r.setMetadata(t,e)})},ac.prototype.getEntry=function(e,t){var n=this;return hc(e).get(fc(t)).next(function(e){return n.maybeDecodeDocument(e)})},ac.prototype.getSizedEntry=function(e,t){var n=this;return hc(e).get(fc(t)).next(function(e){var t=n.maybeDecodeDocument(e);return t?{maybeDocument:t,size:dc(e)}:null})},ac.prototype.getEntries=function(e,t){var n=this,r=da;return this.forEachDbEntry(e,t,function(e,t){t=n.maybeDecodeDocument(t);r=r.insert(e,t)}).next(function(){return r})},ac.prototype.getSizedEntries=function(e,t){var r=this,i=da,o=new na(vi.comparator);return this.forEachDbEntry(e,t,function(e,t){var n=r.maybeDecodeDocument(t);o=n?(i=i.insert(e,n),o.insert(e,dc(t))):(i=i.insert(e,null),o.insert(e,0))}).next(function(){return{maybeDocuments:i,sizeMap:o}})},ac.prototype.forEachDbEntry=function(e,t,i){if(t.isEmpty())return Iu.resolve();var n=IDBKeyRange.bound(t.first().path.toArray(),t.last().path.toArray()),o=t.getIterator(),a=o.getNext();return hc(e).iterate({range:n},function(e,t,n){for(var r=vi.fromSegments(e);a&&vi.comparator(a,r)<0;)i(a,null),a=o.getNext();a&&a.isEqual(r)&&(i(a,t),a=o.hasNext()?o.getNext():null),a?n.skip(a.path.toArray()):n.done()}).next(function(){for(;a;)i(a,null),a=o.hasNext()?o.getNext():null})},ac.prototype.getDocumentsMatchingQuery=function(e,r,t){var i=this;Qr(!yo(r),"CollectionGroup queries should be handled in LocalDocumentsView");var n,o=pa,a=r.path.length+1,s={};return t.isEqual(ea.min())?(n=r.path.toArray(),s.range=IDBKeyRange.lowerBound(n)):(n=r.path.toArray(),t=ju(t),s.range=IDBKeyRange.lowerBound([n,t],!0),s.index=Gc.collectionReadTimeIndex),hc(e).iterate(s,function(e,t,n){e.length===a&&(t=Uu(i.serializer,t),r.path.isPrefixOf(t.key.path)?t instanceof Gi&&So(r,t)&&(o=o.insert(t.key,t)):n.done())}).next(function(){return o})},ac.prototype.newChangeBuffer=function(e){return new uc(this,!!e&&e.trackRemovals)},ac.prototype.getSize=function(e){return this.getMetadata(e).next(function(e){return e.byteSize})},ac.prototype.getMetadata=function(e){return lc(e).get(Wc.key).next(function(e){return zr(!!e,"Missing document cache metadata"),e})},ac.prototype.setMetadata=function(e,t){return lc(e).put(Wc.key,t)},ac.prototype.maybeDecodeDocument=function(e){if(e){e=Uu(this.serializer,e);return e instanceof Yi&&e.version.isEqual(ea.min())?null:e}return null},ac);function ac(e,t){this.serializer=e,this.indexManager=t}var sc,uc=(n(cc,sc=It),cc.prototype.applyChanges=function(i){var o=this,a=[],s=0,u=new ca(function(e,t){return Yr(e.canonicalString(),t.canonicalString())});return this.changes.forEach(function(e,t){var n,r=o.documentSizes.get(e);Qr(void 0!==r,"Cannot modify a document that wasn't read (for "+e+")"),t.maybeDocument?(Qr(!o.getReadTime(e).isEqual(ea.min()),"Cannot add a document with a read time of zero"),n=Ku(o.documentCache.serializer,t.maybeDocument,o.getReadTime(e)),u=u.add(e.path.popLast()),t=dc(n),s+=t-r,a.push(o.documentCache.addEntry(i,e,n))):(s-=r,o.trackRemovals?(r=Ku(o.documentCache.serializer,new Yi(e,ea.min()),o.getReadTime(e)),a.push(o.documentCache.addEntry(i,e,r))):a.push(o.documentCache.removeEntry(i,e)))}),u.forEach(function(e){a.push(o.documentCache.indexManager.addToCollectionParentIndex(i,e))}),a.push(this.documentCache.updateMetadata(i,s)),Iu.waitFor(a)},cc.prototype.getFromCache=function(e,t){var n=this;return this.documentCache.getSizedEntry(e,t).next(function(e){return null===e?(n.documentSizes.set(t,0),null):(n.documentSizes.set(t,e.size),e.maybeDocument)})},cc.prototype.getAllFromCache=function(e,t){var n=this;return this.documentCache.getSizedEntries(e,t).next(function(e){var t=e.maybeDocuments;return e.sizeMap.forEach(function(e,t){n.documentSizes.set(e,t)}),t})},cc);function cc(e,t){var n=sc.call(this)||this;return n.documentCache=e,n.trackRemovals=t,n.documentSizes=new Tu(function(e){return e.toString()},function(e,t){return e.isEqual(t)}),n}function lc(e){return Ll.getStore(e,Wc.store)}function hc(e){return Ll.getStore(e,Gc.store)}function fc(e){return e.path.toArray()}function dc(e){var t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw jr("Unknown remote document type");t=e.noDocument}return JSON.stringify(t).length}var pc=(yc.prototype.addToCollectionParentIndex=function(e,t){return this.collectionParentIndex.add(t),Iu.resolve()},yc.prototype.getCollectionParents=function(e,t){return Iu.resolve(this.collectionParentIndex.getEntries(t))},yc);function yc(){this.collectionParentIndex=new mc}var mc=(gc.prototype.add=function(e){Qr(e.length%2==1,"Expected a collection path.");var t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new ca(fi.comparator),e=!r.has(n);return this.index[t]=r.add(n),e},gc.prototype.has=function(e){var t=e.lastSegment(),e=e.popLast(),t=this.index[t];return t&&t.has(e)},gc.prototype.getEntries=function(e){return(this.index[e]||new ca(fi.comparator)).toArray()},gc);function gc(){this.index={}}var vc=function(){var n=this;this.promise=new Promise(function(e,t){n.resolve=e,n.reject=t})},bc="SimpleDb",wc=(Tc.delete=function(e){return Br(bc,"Removing database:",e),Oc(window.indexedDB.deleteDatabase(e)).toPromise()},Tc.isAvailable=function(){if("undefined"==typeof indexedDB)return!1;if(Tc.isMockPersistence())return!0;var e=d(),t=Tc.getIOSVersion(e),n=0<t&&t<10,t=Tc.getAndroidVersion(e),t=0<t&&t<4.5;return!(0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")||n||t)},Tc.isMockPersistence=function(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.env)||void 0===e?void 0:e.USE_MOCK_PERSISTENCE)},Tc.getStore=function(e,t){return e.store(t)},Tc.getIOSVersion=function(e){e=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),e=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(e)},Tc.getAndroidVersion=function(e){e=e.match(/Android ([\d.]+)/i),e=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(e)},Tc.prototype.ensureDb=function(o){return m(this,void 0,void 0,function(){var t,i=this;return g(this,function(e){switch(e.label){case 0:return this.db?[3,2]:(Br(bc,"Opening database:",this.name),t=this,[4,new Promise(function(t,n){var r=indexedDB.open(i.name,i.version);r.onsuccess=function(e){e=e.target.result;t(e)},r.onblocked=function(){n(new Cc(o,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=function(e){e=e.target.error;"VersionError"===e.name?n(new Lr(Rr.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):n(new Cc(o,e))},r.onupgradeneeded=function(e){Br(bc,'Database "'+i.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;i.schemaConverter.createOrUpgrade(t,r.transaction,e.oldVersion,i.version).next(function(){Br(bc,"Database upgrade to version "+i.version+" complete")})}})]);case 1:t.db=e.sent(),e.label=2;case 2:return this.versionchangelistener&&(this.db.onversionchange=function(e){return i.versionchangelistener(e)}),[2,this.db]}})})},Tc.prototype.setVersionChangeListener=function(t){this.versionchangelistener=t,this.db&&(this.db.onversionchange=function(e){return t(e)})},Tc.prototype.runTransaction=function(s,n,u,c){return m(this,void 0,void 0,function(){var i,o,a,t;return g(this,function(e){switch(e.label){case 0:i="readonly"===n,o=0,t=function(){var t,n,r;return g(this,function(e){switch(e.label){case 0:++o,e.label=1;case 1:return e.trys.push([1,4,,5]),[4,a.ensureDb(s)];case 2:return a.db=e.sent(),t=kc.open(a.db,s,i?"readonly":"readwrite",u),(r=c(t).catch(function(e){return t.abort(e),Iu.reject(e)}).toPromise()).catch(function(){}),[4,t.completionPromise];case 3:return e.sent(),[2,{value:r}];case 4:return n=e.sent(),r="FirebaseError"!==n.name&&o<3,Br(bc,"Transaction failed with error:",n.message,"Retrying:",r),a.close(),r?[3,5]:[2,{value:Promise.reject(n)}];case 5:return[2]}})},a=this,e.label=1;case 1:return[5,t()];case 2:return"object"==typeof(t=e.sent())?[2,t.value]:[3,1];case 3:return[2]}})})},Tc.prototype.close=function(){this.db&&this.db.close(),this.db=void 0},Tc);function Tc(e,t,n){this.name=e,this.version=t,this.schemaConverter=n,Qr(Tc.isAvailable(),"IndexedDB not supported in current environment."),12.2===Tc.getIOSVersion(d())&&Vr("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}var Sc=(Object.defineProperty(Ic.prototype,"isDone",{get:function(){return this.shouldStop},enumerable:!1,configurable:!0}),Object.defineProperty(Ic.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:!1,configurable:!0}),Object.defineProperty(Ic.prototype,"cursor",{set:function(e){this.dbCursor=e},enumerable:!1,configurable:!0}),Ic.prototype.done=function(){this.shouldStop=!0},Ic.prototype.skip=function(e){this.nextKey=e},Ic.prototype.delete=function(){return Oc(this.dbCursor.delete())},Ic);function Ic(e){this.dbCursor=e,this.shouldStop=!1,this.nextKey=null}var Ec,Cc=(n(Dc,Ec=Lr),Dc);function Dc(e,t){t=Ec.call(this,Rr.UNAVAILABLE,"IndexedDB transaction '"+e+"' failed: "+t)||this;return t.name="IndexedDbTransactionError",t}function _c(e){return"IndexedDbTransactionError"===e.name}var kc=(Ac.open=function(e,t,n,r){try{return new Ac(t,e.transaction(r,n))}catch(e){throw new Cc(t,e)}},Object.defineProperty(Ac.prototype,"completionPromise",{get:function(){return this.completionDeferred.promise},enumerable:!1,configurable:!0}),Ac.prototype.abort=function(e){e&&this.completionDeferred.reject(e),this.aborted||(Br(bc,"Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())},Ac.prototype.store=function(e){var t=this.transaction.objectStore(e);return Qr(!!t,"Object store not part of transaction: "+e),new Nc(t)},Ac);function Ac(t,e){var n=this;this.action=t,this.transaction=e,this.aborted=!1,this.completionDeferred=new vc,this.transaction.oncomplete=function(){n.completionDeferred.resolve()},this.transaction.onabort=function(){e.error?n.completionDeferred.reject(new Cc(t,e.error)):n.completionDeferred.resolve()},this.transaction.onerror=function(e){e=Lc(e.target.error);n.completionDeferred.reject(new Cc(t,e))}}var Nc=(xc.prototype.put=function(e,t){e=void 0!==t?(Br(bc,"PUT",this.store.name,e,t),this.store.put(t,e)):(Br(bc,"PUT",this.store.name,"<auto-key>",e),this.store.put(e));return Oc(e)},xc.prototype.add=function(e){return Br(bc,"ADD",this.store.name,e,e),Oc(this.store.add(e))},xc.prototype.get=function(t){var n=this;return Oc(this.store.get(t)).next(function(e){return void 0===e&&(e=null),Br(bc,"GET",n.store.name,t,e),e})},xc.prototype.delete=function(e){return Br(bc,"DELETE",this.store.name,e),Oc(this.store.delete(e))},xc.prototype.count=function(){return Br(bc,"COUNT",this.store.name),Oc(this.store.count())},xc.prototype.loadAll=function(e,t){var t=this.cursor(this.options(e,t)),n=[];return this.iterateCursor(t,function(e,t){n.push(t)}).next(function(){return n})},xc.prototype.deleteAll=function(e,t){Br(bc,"DELETE ALL",this.store.name);t=this.options(e,t);t.keysOnly=!1;t=this.cursor(t);return this.iterateCursor(t,function(e,t,n){return n.delete()})},xc.prototype.iterate=function(e,t){t?n=e:(n={},t=e);var n=this.cursor(n);return this.iterateCursor(n,t)},xc.prototype.iterateSerial=function(r){var e=this.cursor({});return new Iu(function(n,t){e.onerror=function(e){e=Lc(e.target.error);t(e)},e.onsuccess=function(e){var t=e.target.result;t?r(t.primaryKey,t.value).next(function(e){e?t.continue():n()}):n()}})},xc.prototype.iterateCursor=function(e,i){var o=[];return new Iu(function(r,t){e.onerror=function(e){t(e.target.error)},e.onsuccess=function(e){var t,n=e.target.result;n?(t=new Sc(n),(e=i(n.primaryKey,n.value,t))instanceof Iu&&(e=e.catch(function(e){return t.done(),Iu.reject(e)}),o.push(e)),t.isDone?r():null===t.skipToKey?n.continue():n.continue(t.skipToKey)):r()}}).next(function(){return Iu.waitFor(o)})},xc.prototype.options=function(e,t){var n=void 0;return void 0!==e&&("string"==typeof e?n=e:(Qr(void 0===t,"3rd argument must not be defined if 2nd is a range."),t=e)),{index:n,range:t}},xc.prototype.cursor=function(e){var t="next";if(e.reverse&&(t="prev"),e.index){var n=this.store.index(e.index);return e.keysOnly?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)},xc);function xc(e){this.store=e}function Oc(e){return new Iu(function(t,n){e.onsuccess=function(e){e=e.target.result;t(e)},e.onerror=function(e){e=Lc(e.target.error);n(e)}})}var Rc=!1;function Lc(e){var t=wc.getIOSVersion(d());if(12.2<=t&&t<13){t="An internal error was encountered in the Indexed Database server";if(0<=e.message.indexOf(t)){var n=new Lr("internal","IOS_INDEXEDDB_BUG1: IndexedDb has thrown '"+t+"'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.");return Rc||(Rc=!0,setTimeout(function(){throw n},0)),n}}return e}var Pc=11,Mc=(qc.prototype.createOrUpgrade=function(t,n,e,r){var i=this;zr(e<r&&0<=e&&r<=Pc,"Unexpected schema upgrade from v"+e+" to v"+r+".");var o=new kc("createOrUpgrade",n);e<1&&1<=r&&(t.createObjectStore(Bc.store),(a=t).createObjectStore(Vc.store,{keyPath:Vc.keyPath}),a.createObjectStore(Uc.store,{keyPath:Uc.keyPath,autoIncrement:!0}).createIndex(Uc.userMutationsIndex,Uc.userMutationsKeyPath,{unique:!0}),a.createObjectStore(Kc.store),$c(t),t.createObjectStore(Gc.store));var a,s=Iu.resolve();return e<3&&3<=r&&(0!==e&&((a=t).deleteObjectStore(Yc.store),a.deleteObjectStore(Hc.store),a.deleteObjectStore(Xc.store),$c(t)),s=s.next(function(){return t=(e=o).store(Xc.store),e=new Xc(0,0,ea.min().toTimestamp(),0),t.put(Xc.key,e);var e,t})),e<4&&4<=r&&(0!==e&&(s=s.next(function(){return n=t,(r=o).store(Uc.store).loadAll().next(function(e){n.deleteObjectStore(Uc.store),n.createObjectStore(Uc.store,{keyPath:Uc.keyPath,autoIncrement:!0}).createIndex(Uc.userMutationsIndex,Uc.userMutationsKeyPath,{unique:!0});var t=r.store(Uc.store),e=e.map(function(e){return t.put(e)});return Iu.waitFor(e)});var n,r})),s=s.next(function(){t.createObjectStore(Zc.store,{keyPath:Zc.keyPath})})),e<5&&5<=r&&(s=s.next(function(){return i.removeAcknowledgedMutations(o)})),e<6&&6<=r&&(s=s.next(function(){return t.createObjectStore(Wc.store),i.addDocumentGlobal(o)})),e<7&&7<=r&&(s=s.next(function(){return i.ensureSequenceNumbers(o)})),e<8&&8<=r&&(s=s.next(function(){return i.createCollectionParentIndex(t,o)})),e<9&&9<=r&&(s=s.next(function(){var e;(e=t).objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges"),function(e){e=e.objectStore(Gc.store);e.createIndex(Gc.readTimeIndex,Gc.readTimeIndexPath,{unique:!1}),e.createIndex(Gc.collectionReadTimeIndex,Gc.collectionReadTimeIndexPath,{unique:!1})}(n)})),e<10&&10<=r&&(s=s.next(function(){return i.rewriteCanonicalIds(o)})),e<11&&11<=r&&(s=s.next(function(){t.createObjectStore(el.store,{keyPath:el.keyPath}),t.createObjectStore(tl.store,{keyPath:tl.keyPath})})),s},qc.prototype.addDocumentGlobal=function(t){var n=0;return t.store(Gc.store).iterate(function(e,t){n+=dc(t)}).next(function(){var e=new Wc(n);return t.store(Wc.store).put(Wc.key,e)})},qc.prototype.removeAcknowledgedMutations=function(n){var r=this,e=n.store(Vc.store),i=n.store(Uc.store);return e.loadAll().next(function(e){return Iu.forEach(e,function(t){var e=IDBKeyRange.bound([t.userId,mu],[t.userId,t.lastAcknowledgedBatchId]);return i.loadAll(Uc.userMutationsIndex,e).next(function(e){return Iu.forEach(e,function(e){zr(e.userId===t.userId,"Cannot process batch "+e.batchId+" from unexpected user");e=Wu(r.serializer,e);return ec(n,t.userId,e).next(function(){})})})})})},qc.prototype.ensureSequenceNumbers=function(e){var o=e.store(Yc.store),t=e.store(Gc.store);return e.store(Xc.store).get(Xc.key).next(function(r){Qr(!!r,"Metadata should have been written during the version 3 migration");var i=[];return t.iterate(function(e,t){var n=new fi(e),e=[0,qu(n)];i.push(o.get(e).next(function(e){return e?Iu.resolve():(e=n,o.put(new Yc(0,qu(e),r.highestListenSequenceNumber)))}))}).next(function(){return Iu.waitFor(i)})})},qc.prototype.createCollectionParentIndex=function(e,t){e.createObjectStore(Jc.store,{keyPath:Jc.keyPath});function r(e){if(i.add(e)){var t=e.lastSegment(),e=e.popLast();return n.put({collectionId:t,parent:qu(e)})}}var n=t.store(Jc.store),i=new mc;return t.store(Gc.store).iterate({keysOnly:!0},function(e,t){e=new fi(e);return r(e.popLast())}).next(function(){return t.store(Kc.store).iterate({keysOnly:!0},function(e,t){e[0];var n=e[1],n=(e[2],Bu(n));return r(n.popLast())})})},qc.prototype.rewriteCanonicalIds=function(e){var n=this,r=e.store(Hc.store);return r.iterate(function(e,t){t=Hu(t),t=Yu(n.serializer,t);return r.put(t)})},qc);function qc(e){this.serializer=e}var Fc=function(e,t){this.seconds=e,this.nanoseconds=t},Bc=function(e,t,n){this.ownerId=e,this.allowTabSynchronization=t,this.leaseTimestampMs=n};Bc.store="owner",Bc.key="owner";var Vc=function(e,t,n){this.userId=e,this.lastAcknowledgedBatchId=t,this.lastStreamToken=n};Vc.store="mutationQueues",Vc.keyPath="userId";var Uc=function(e,t,n,r,i){this.userId=e,this.batchId=t,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=i};Uc.store="mutations",Uc.keyPath="batchId",Uc.userMutationsIndex="userMutationsIndex",Uc.userMutationsKeyPath=["userId","batchId"];var Kc=(jc.prefixForUser=function(e){return[e]},jc.prefixForPath=function(e,t){return[e,qu(t)]},jc.key=function(e,t,n){return[e,qu(t),n]},jc);function jc(){}Kc.store="documentMutations",Kc.PLACEHOLDER=new Kc;var zc=function(e,t){this.path=e,this.readTime=t},Qc=function(e,t){this.path=e,this.version=t},Gc=function(e,t,n,r,i,o){this.unknownDocument=e,this.noDocument=t,this.document=n,this.hasCommittedMutations=r,this.readTime=i,this.parentPath=o};Gc.store="remoteDocuments",Gc.readTimeIndex="readTimeIndex",Gc.readTimeIndexPath="readTime",Gc.collectionReadTimeIndex="collectionReadTimeIndex",Gc.collectionReadTimeIndexPath=["parentPath","readTime"];var Wc=function(e){this.byteSize=e};Wc.store="remoteDocumentGlobal",Wc.key="remoteDocumentGlobalKey";var Hc=function(e,t,n,r,i,o,a){this.targetId=e,this.canonicalId=t,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=i,this.lastLimboFreeSnapshotVersion=o,this.query=a};Hc.store="targets",Hc.keyPath="targetId",Hc.queryTargetsIndexName="queryTargetsIndex",Hc.queryTargetsKeyPath=["canonicalId","targetId"];var Yc=function(e,t,n){this.targetId=e,this.path=t,Qr(0===e==(void 0!==(this.sequenceNumber=n)),"A target-document row must either have targetId == 0 and a defined sequence number, or a non-zero targetId and no sequence number")};Yc.store="targetDocuments",Yc.keyPath=["targetId","path"],Yc.documentTargetsIndex="documentTargetsIndex",Yc.documentTargetsKeyPath=["path","targetId"];var Xc=function(e,t,n,r){this.highestTargetId=e,this.highestListenSequenceNumber=t,this.lastRemoteSnapshotVersion=n,this.targetCount=r};Xc.key="targetGlobalKey",Xc.store="targetGlobal";var Jc=function(e,t){this.collectionId=e,this.parent=t};function $c(e){e.createObjectStore(Yc.store,{keyPath:Yc.keyPath}).createIndex(Yc.documentTargetsIndex,Yc.documentTargetsKeyPath,{unique:!0}),e.createObjectStore(Hc.store,{keyPath:Hc.keyPath}).createIndex(Hc.queryTargetsIndexName,Hc.queryTargetsKeyPath,{unique:!0}),e.createObjectStore(Xc.store)}Jc.store="collectionParents",Jc.keyPath=["collectionId","parent"];var Zc=function(e,t,n,r){this.clientId=e,this.updateTimeMs=t,this.networkEnabled=n,this.inForeground=r};Zc.store="clientMetadata",Zc.keyPath="clientId";var el=function(e,t,n){this.bundleId=e,this.createTime=t,this.version=n};el.store="bundles",el.keyPath="bundleId";var tl=function(e,t,n){this.name=e,this.readTime=t,this.bundledQuery=n};tl.store="namedQueries",tl.keyPath="name";var l=a([Vc.store,Uc.store,Kc.store,Gc.store,Hc.store,Bc.store,Xc.store,Yc.store],[Zc.store]),l=a(l,[Wc.store]),l=a(l,[Jc.store]),nl=a(l,[el.store,tl.store]),rl=(il.prototype.getBundleMetadata=function(e,t){return ol(e).get(t).next(function(e){if(e)return{id:(e=e).bundleId,createTime:Gu(e.createTime),version:e.version}})},il.prototype.saveBundleMetadata=function(e,t){return ol(e).put({bundleId:(t=t).id,createTime:Qu(Ya(t.createTime)),version:t.version})},il.prototype.getNamedQuery=function(e,t){return al(e).get(t).next(function(e){if(e)return{name:(e=e).name,query:Xu(e.bundledQuery),readTime:Gu(e.readTime)}})},il.prototype.saveNamedQuery=function(e,t){return al(e).put({name:(t=t).name,readTime:Qu(Ya(t.readTime)),bundledQuery:t.bundledQuery})},il);function il(e){this.serializer=e}function ol(e){return Ll.getStore(e,el.store)}function al(e){return Ll.getStore(e,tl.store)}var sl=(ul.prototype.addToCollectionParentIndex=function(e,t){var n=this;if(Qr(t.length%2==1,"Expected a collection path."),this.collectionParentsCache.has(t))return Iu.resolve();var r=t.lastSegment(),i=t.popLast();e.addOnCommittedListener(function(){n.collectionParentsCache.add(t)});i={collectionId:r,parent:qu(i)};return cl(e).put(i)},ul.prototype.getCollectionParents=function(e,i){var o=[],t=IDBKeyRange.bound([i,""],[Jr(i),""],!1,!0);return cl(e).loadAll(t).next(function(e){for(var t=0,n=e;t<n.length;t++){var r=n[t];if(r.collectionId!==i)break;o.push(Bu(r.parent))}return o})},ul);function ul(){this.collectionParentsCache=new mc}function cl(e){return Ll.getStore(e,Jc.store)}var ll=(hl.prototype.next=function(){return this.lastId+=2,this.lastId},hl.forTargetCache=function(){return new hl(0)},hl.forSyncEngine=function(){return new hl(-1)},hl);function hl(e){this.lastId=e}var fl=(dl.prototype.allocateTargetId=function(n){var r=this;return this.retrieveMetadata(n).next(function(e){var t=new ll(e.highestTargetId);return e.highestTargetId=t.next(),r.saveMetadata(n,e).next(function(){return e.highestTargetId})})},dl.prototype.getLastRemoteSnapshotVersion=function(e){return this.retrieveMetadata(e).next(function(e){return ea.fromTimestamp(new Zr(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))})},dl.prototype.getHighestSequenceNumber=function(e){return this.retrieveMetadata(e).next(function(e){return e.highestListenSequenceNumber})},dl.prototype.setTargetsMetadata=function(t,n,r){var i=this;return this.retrieveMetadata(t).next(function(e){return e.highestListenSequenceNumber=n,r&&(e.lastRemoteSnapshotVersion=r.toTimestamp()),n>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=n),i.saveMetadata(t,e)})},dl.prototype.addTargetData=function(t,n){var r=this;return this.saveTargetData(t,n).next(function(){return r.retrieveMetadata(t).next(function(e){return e.targetCount+=1,r.updateMetadataFromTargetData(n,e),r.saveMetadata(t,e)})})},dl.prototype.updateTargetData=function(e,t){return this.saveTargetData(e,t)},dl.prototype.removeTargetData=function(t,e){var n=this;return this.removeMatchingKeysForTargetId(t,e.targetId).next(function(){return pl(t).delete(e.targetId)}).next(function(){return n.retrieveMetadata(t)}).next(function(e){return zr(0<e.targetCount,"Removing from an empty target cache"),--e.targetCount,n.saveMetadata(t,e)})},dl.prototype.removeTargets=function(n,r,i){var o=this,a=0,s=[];return pl(n).iterate(function(e,t){t=Hu(t);t.sequenceNumber<=r&&null===i.get(t.targetId)&&(a++,s.push(o.removeTargetData(n,t)))}).next(function(){return Iu.waitFor(s)}).next(function(){return a})},dl.prototype.forEachTarget=function(e,n){return pl(e).iterate(function(e,t){t=Hu(t);n(t)})},dl.prototype.retrieveMetadata=function(e){return yl(e).get(Xc.key).next(function(e){return zr(null!==e,"Missing metadata row."),e})},dl.prototype.saveMetadata=function(e,t){return yl(e).put(Xc.key,t)},dl.prototype.saveTargetData=function(e,t){return pl(e).put(Yu(this.serializer,t))},dl.prototype.updateMetadataFromTargetData=function(e,t){var n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n},dl.prototype.getTargetCount=function(e){return this.retrieveMetadata(e).next(function(e){return e.targetCount})},dl.prototype.getTargetData=function(e,r){var t=no(r),t=IDBKeyRange.bound([t,Number.NEGATIVE_INFINITY],[t,Number.POSITIVE_INFINITY]),i=null;return pl(e).iterate({range:t,index:Hc.queryTargetsIndexName},function(e,t,n){t=Hu(t);io(r,t.target)&&(i=t,n.done())}).next(function(){return i})},dl.prototype.addMatchingKeys=function(n,e,r){var i=this,o=[],a=ml(n);return e.forEach(function(e){var t=qu(e.path);o.push(a.put(new Yc(r,t))),o.push(i.referenceDelegate.addReference(n,r,e))}),Iu.waitFor(o)},dl.prototype.removeMatchingKeys=function(n,e,r){var i=this,o=ml(n);return Iu.forEach(e,function(e){var t=qu(e.path);return Iu.waitFor([o.delete([r,t]),i.referenceDelegate.removeReference(n,r,e)])})},dl.prototype.removeMatchingKeysForTargetId=function(e,t){e=ml(e),t=IDBKeyRange.bound([t],[t+1],!1,!0);return e.delete(t)},dl.prototype.getMatchingKeysForTargetId=function(e,t){var t=IDBKeyRange.bound([t],[t+1],!1,!0),e=ml(e),r=ga();return e.iterate({range:t,keysOnly:!0},function(e,t,n){e=Bu(e[1]),e=new vi(e);r=r.add(e)}).next(function(){return r})},dl.prototype.containsKey=function(e,t){var t=qu(t.path),t=IDBKeyRange.bound([t],[Jr(t)],!1,!0),i=0;return ml(e).iterate({index:Yc.documentTargetsIndex,keysOnly:!0,range:t},function(e,t,n){var r=e[0];e[1];0!==r&&(i++,n.done())}).next(function(){return 0<i})},dl.prototype.getTargetDataForTarget=function(e,t){return pl(e).get(t).next(function(e){return e?Hu(e):null})},dl);function dl(e,t){this.referenceDelegate=e,this.serializer=t}function pl(e){return Ll.getStore(e,Hc.store)}function yl(e){return Ll.getStore(e,Xc.store)}function ml(e){return Ll.getStore(e,Yc.store)}function gl(e,t){var n=e[0],r=e[1],e=t[0],t=t[1],e=Yr(n,e);return 0===e?Yr(r,t):e}var vl=(bl.prototype.nextIndex=function(){return++this.previousIndex},bl.prototype.addElement=function(e){var t=[e,this.nextIndex()];this.buffer.size<this.maxElements?this.buffer=this.buffer.add(t):gl(t,e=this.buffer.last())<0&&(this.buffer=this.buffer.delete(e).add(t))},Object.defineProperty(bl.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!1,configurable:!0}),bl);function bl(e){this.maxElements=e,this.buffer=new ca(gl),this.previousIndex=0}var wl={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Tl=(Sl.withCacheSize=function(e){return new Sl(e,Sl.DEFAULT_COLLECTION_PERCENTILE,Sl.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)},Sl);function Sl(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}Tl.DEFAULT_COLLECTION_PERCENTILE=10,Tl.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Tl.DEFAULT=new Tl(41943040,Tl.DEFAULT_COLLECTION_PERCENTILE,Tl.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Tl.DISABLED=new Tl(-1,0,0);var Il=(El.prototype.start=function(e){Qr(null===this.gcTask,"Cannot start an already started LruScheduler"),-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.scheduleGC(e)},El.prototype.stop=function(){this.gcTask&&(this.gcTask.cancel(),this.gcTask=null)},Object.defineProperty(El.prototype,"started",{get:function(){return null!==this.gcTask},enumerable:!1,configurable:!0}),El.prototype.scheduleGC=function(n){var e=this;Qr(null===this.gcTask,"Cannot schedule GC while a task is pending");var t=this.hasRun?3e5:6e4;Br("LruGarbageCollector","Garbage collection scheduled in "+t+"ms"),this.gcTask=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,function(){return m(e,void 0,void 0,function(){var t;return g(this,function(e){switch(e.label){case 0:this.gcTask=null,this.hasRun=!0,e.label=1;case 1:return e.trys.push([1,3,,7]),[4,n.collectGarbage(this.garbageCollector)];case 2:return e.sent(),[3,7];case 3:return _c(t=e.sent())?(Br("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t),[3,6]):[3,4];case 4:return[4,ih(t)];case 5:e.sent(),e.label=6;case 6:return[3,7];case 7:return[4,this.scheduleGC(n)];case 8:return e.sent(),[2]}})})})},El);function El(e,t){this.garbageCollector=e,this.asyncQueue=t,this.hasRun=!1,this.gcTask=null}var Cl=(Dl.prototype.calculateTargetCount=function(e,t){return this.delegate.getSequenceNumberCount(e).next(function(e){return Math.floor(t/100*e)})},Dl.prototype.nthSequenceNumber=function(e,t){var n=this;if(0===t)return Iu.resolve(xu.INVALID);var r=new vl(t);return this.delegate.forEachTarget(e,function(e){return r.addElement(e.sequenceNumber)}).next(function(){return n.delegate.forEachOrphanedDocumentSequenceNumber(e,function(e){return r.addElement(e)})}).next(function(){return r.maxValue})},Dl.prototype.removeTargets=function(e,t,n){return this.delegate.removeTargets(e,t,n)},Dl.prototype.removeOrphanedDocuments=function(e,t){return this.delegate.removeOrphanedDocuments(e,t)},Dl.prototype.collect=function(t,n){var r=this;return-1===this.params.cacheSizeCollectionThreshold?(Br("LruGarbageCollector","Garbage collection skipped; disabled"),Iu.resolve(wl)):this.getCacheSize(t).next(function(e){return e<r.params.cacheSizeCollectionThreshold?(Br("LruGarbageCollector","Garbage collection skipped; Cache size "+e+" is lower than threshold "+r.params.cacheSizeCollectionThreshold),wl):r.runGarbageCollection(t,n)})},Dl.prototype.getCacheSize=function(e){return this.delegate.getCacheSize(e)},Dl.prototype.runGarbageCollection=function(t,n){var r,i,o,a,s,u,c,l=this,h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(function(e){return i=e>l.params.maximumSequenceNumbersToCollect?(Br("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of "+l.params.maximumSequenceNumbersToCollect+" from "+e),l.params.maximumSequenceNumbersToCollect):e,a=Date.now(),l.nthSequenceNumber(t,i)}).next(function(e){return r=e,s=Date.now(),l.removeTargets(t,r,n)}).next(function(e){return o=e,u=Date.now(),l.removeOrphanedDocuments(t,r)}).next(function(e){return c=Date.now(),Fr()<=f.DEBUG&&Br("LruGarbageCollector","LRU Garbage Collection\n\tCounted targets in "+(a-h)+"ms\n\tDetermined least recently used "+i+" in "+(s-a)+"ms\n\tRemoved "+o+" targets in "+(u-s)+"ms\n\tRemoved "+e+" documents in "+(c-u)+"ms\nTotal Duration: "+(c-h)+"ms"),Iu.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:o,documentsRemoved:e})})},Dl);function Dl(e,t){this.delegate=e,this.params=t}var _l,kl="IndexedDbPersistence",Al="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",Nl="This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.",xl="main",Ol=(n(Rl,_l=St),Rl);function Rl(e,t){var n=_l.call(this)||this;return n.simpleDbTransaction=e,n.currentSequenceNumber=t,n}var Ll=(Pl.getStore=function(e,t){if(e instanceof Ol)return wc.getStore(e.simpleDbTransaction,t);throw jr("IndexedDbPersistence must use instances of IndexedDbTransaction")},Pl.prototype.start=function(){var t=this;return Qr(!this.started,"IndexedDbPersistence double-started!"),Qr(null!==this.window,"Expected 'window' to be defined"),this.updateClientMetadataAndTryBecomePrimary().then(function(){if(!t.isPrimary&&!t.allowTabSynchronization)throw new Lr(Rr.FAILED_PRECONDITION,Al);return t.attachVisibilityHandler(),t.attachWindowUnloadHook(),t.scheduleClientMetadataAndPrimaryLeaseRefreshes(),t.runTransaction("getHighestListenSequenceNumber","readonly",function(e){return t.targetCache.getHighestSequenceNumber(e)})}).then(function(e){t.listenSequence=new xu(e,t.sequenceNumberSyncer)}).then(function(){t._started=!0}).catch(function(e){return t.simpleDb&&t.simpleDb.close(),Promise.reject(e)})},Pl.prototype.setPrimaryStateListener=function(n){var e=this;return this.primaryStateListener=function(t){return m(e,void 0,void 0,function(){return g(this,function(e){return this.started?[2,n(t)]:[2]})})},n(this.isPrimary)},Pl.prototype.setDatabaseDeletedListener=function(n){var e=this;this.simpleDb.setVersionChangeListener(function(t){return m(e,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return null!==t.newVersion?[3,2]:[4,n()];case 1:e.sent(),e.label=2;case 2:return[2]}})})})},Pl.prototype.setNetworkEnabled=function(e){var t=this;this.networkEnabled!==e&&(this.networkEnabled=e,this.queue.enqueueAndForget(function(){return m(t,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return this.started?[4,this.updateClientMetadataAndTryBecomePrimary()]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}})})}))},Pl.prototype.updateClientMetadataAndTryBecomePrimary=function(){var n=this;return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",function(t){return ql(t).put(new Zc(n.clientId,Date.now(),n.networkEnabled,n.inForeground)).next(function(){if(n.isPrimary)return n.verifyPrimaryLease(t).next(function(e){e||(n.isPrimary=!1,n.queue.enqueueRetryable(function(){return n.primaryStateListener(!1)}))})}).next(function(){return n.canActAsPrimary(t)}).next(function(e){return n.isPrimary&&!e?n.releasePrimaryLeaseIfHeld(t).next(function(){return!1}):!!e&&n.acquireOrExtendPrimaryLease(t).next(function(){return!0})})}).catch(function(e){if(_c(e))return Br(kl,"Failed to extend owner lease: ",e),n.isPrimary;if(!n.allowTabSynchronization)throw e;return Br(kl,"Releasing owner lease after error during lease refresh",e),!1}).then(function(e){n.isPrimary!==e&&n.queue.enqueueRetryable(function(){return n.primaryStateListener(e)}),n.isPrimary=e})},Pl.prototype.verifyPrimaryLease=function(e){var t=this;return Ml(e).get(Bc.key).next(function(e){return Iu.resolve(t.isLocalClient(e))})},Pl.prototype.removeClientMetadata=function(e){return ql(e).delete(this.clientId)},Pl.prototype.maybeGarbageCollectMultiClientState=function(){return m(this,void 0,void 0,function(){var t,n,r,i,o=this;return g(this,function(e){switch(e.label){case 0:return!this.isPrimary||this.isWithinAge(this.lastGarbageCollectionTime,18e5)?[3,2]:(this.lastGarbageCollectionTime=Date.now(),[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",function(e){var r=Pl.getStore(e,Zc.store);return r.loadAll().next(function(e){var t=o.filterActiveClients(e,18e5),n=e.filter(function(e){return-1===t.indexOf(e)});return Iu.forEach(n,function(e){return r.delete(e.clientId)}).next(function(){return n})})}).catch(function(){return[]})]);case 1:if(t=e.sent(),this.webStorage)for(n=0,r=t;n<r.length;n++)i=r[n],this.webStorage.removeItem(this.zombiedClientLocalStorageKey(i.clientId));e.label=2;case 2:return[2]}})})},Pl.prototype.scheduleClientMetadataAndPrimaryLeaseRefreshes=function(){var e=this;this.clientMetadataRefresher=this.queue.enqueueAfterDelay("client_metadata_refresh",4e3,function(){return e.updateClientMetadataAndTryBecomePrimary().then(function(){return e.maybeGarbageCollectMultiClientState()}).then(function(){return e.scheduleClientMetadataAndPrimaryLeaseRefreshes()})})},Pl.prototype.isLocalClient=function(e){return!!e&&e.ownerId===this.clientId},Pl.prototype.canActAsPrimary=function(t){var r=this;return this.forceOwningTab?Iu.resolve(!0):Ml(t).get(Bc.key).next(function(e){if(null!==e&&r.isWithinAge(e.leaseTimestampMs,5e3)&&!r.isClientZombied(e.ownerId)){if(r.isLocalClient(e)&&r.networkEnabled)return!0;if(!r.isLocalClient(e)){if(!e.allowTabSynchronization)throw new Lr(Rr.FAILED_PRECONDITION,Al);return!1}}return!(!r.networkEnabled||!r.inForeground)||ql(t).loadAll().next(function(e){return void 0===r.filterActiveClients(e,5e3).find(function(e){if(r.clientId!==e.clientId){var t=!r.networkEnabled&&e.networkEnabled,n=!r.inForeground&&e.inForeground,e=r.networkEnabled===e.networkEnabled;if(t||n&&e)return!0}return!1})})}).next(function(e){return r.isPrimary!==e&&Br(kl,"Client "+(e?"is":"is not")+" eligible for a primary lease."),e})},Pl.prototype.shutdown=function(){return m(this,void 0,void 0,function(){var n=this;return g(this,function(e){switch(e.label){case 0:return this._started=!1,this.markClientZombied(),this.clientMetadataRefresher&&(this.clientMetadataRefresher.cancel(),this.clientMetadataRefresher=null),this.detachVisibilityHandler(),this.detachWindowUnloadHook(),[4,this.simpleDb.runTransaction("shutdown","readwrite",[Bc.store,Zc.store],function(e){var t=new Ol(e,xu.INVALID);return n.releasePrimaryLeaseIfHeld(t).next(function(){return n.removeClientMetadata(t)})})];case 1:return e.sent(),this.simpleDb.close(),this.removeClientZombiedEntry(),[2]}})})},Pl.prototype.filterActiveClients=function(e,t){var n=this;return e.filter(function(e){return n.isWithinAge(e.updateTimeMs,t)&&!n.isClientZombied(e.clientId)})},Pl.prototype.getActiveClients=function(){var t=this;return this.runTransaction("getActiveClients","readonly",function(e){return ql(e).loadAll().next(function(e){return t.filterActiveClients(e,18e5).map(function(e){return e.clientId})})})},Object.defineProperty(Pl.prototype,"started",{get:function(){return this._started},enumerable:!1,configurable:!0}),Pl.prototype.getMutationQueue=function(e){return Qr(this.started,"Cannot initialize MutationQueue before persistence is started."),Ju.forUser(e,this.serializer,this.indexManager,this.referenceDelegate)},Pl.prototype.getTargetCache=function(){return Qr(this.started,"Cannot initialize TargetCache before persistence is started."),this.targetCache},Pl.prototype.getRemoteDocumentCache=function(){return Qr(this.started,"Cannot initialize RemoteDocumentCache before persistence is started."),this.remoteDocumentCache},Pl.prototype.getIndexManager=function(){return Qr(this.started,"Cannot initialize IndexManager before persistence is started."),this.indexManager},Pl.prototype.getBundleCache=function(){return Qr(this.started,"Cannot initialize BundleCache before persistence is started."),this.bundleCache},Pl.prototype.runTransaction=function(t,n,r){var i=this;Br(kl,"Starting transaction:",t);var o,e="readonly"===n?"readonly":"readwrite";return this.simpleDb.runTransaction(t,e,nl,function(e){return o=new Ol(e,i.listenSequence?i.listenSequence.next():xu.INVALID),"readwrite-primary"===n?i.verifyPrimaryLease(o).next(function(e){return!!e||i.canActAsPrimary(o)}).next(function(e){if(!e)throw Vr("Failed to obtain primary lease for action '"+t+"'."),i.isPrimary=!1,i.queue.enqueueRetryable(function(){return i.primaryStateListener(!1)}),new Lr(Rr.FAILED_PRECONDITION,_u);return r(o)}).next(function(e){return i.acquireOrExtendPrimaryLease(o).next(function(){return e})}):i.verifyAllowTabSynchronization(o).next(function(){return r(o)})}).then(function(e){return o.raiseOnCommittedEvent(),e})},Pl.prototype.verifyAllowTabSynchronization=function(e){var t=this;return Ml(e).get(Bc.key).next(function(e){if(null!==e&&t.isWithinAge(e.leaseTimestampMs,5e3)&&!t.isClientZombied(e.ownerId)&&!t.isLocalClient(e)&&!(t.forceOwningTab||t.allowTabSynchronization&&e.allowTabSynchronization))throw new Lr(Rr.FAILED_PRECONDITION,Al)})},Pl.prototype.acquireOrExtendPrimaryLease=function(e){var t=new Bc(this.clientId,this.allowTabSynchronization,Date.now());return Ml(e).put(Bc.key,t)},Pl.isAvailable=function(){return wc.isAvailable()},Pl.prototype.releasePrimaryLeaseIfHeld=function(e){var t=this,n=Ml(e);return n.get(Bc.key).next(function(e){return t.isLocalClient(e)?(Br(kl,"Releasing primary lease."),n.delete(Bc.key)):Iu.resolve()})},Pl.prototype.isWithinAge=function(e,t){var n=Date.now();return!(e<n-t)&&(!(n<e)||(Vr("Detected an update time that is in the future: "+e+" > "+n),!1))},Pl.prototype.attachVisibilityHandler=function(){var e=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.documentVisibilityHandler=function(){e.queue.enqueueAndForget(function(){return e.inForeground="visible"===e.document.visibilityState,e.updateClientMetadataAndTryBecomePrimary()})},this.document.addEventListener("visibilitychange",this.documentVisibilityHandler),this.inForeground="visible"===this.document.visibilityState)},Pl.prototype.detachVisibilityHandler=function(){this.documentVisibilityHandler&&(Qr(null!==this.document&&"function"==typeof this.document.addEventListener,"Expected 'document.addEventListener' to be a function"),this.document.removeEventListener("visibilitychange",this.documentVisibilityHandler),this.documentVisibilityHandler=null)},Pl.prototype.attachWindowUnloadHook=function(){var e,t=this;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.windowUnloadHandler=function(){t.markClientZombied(),t.queue.enqueueAndForget(function(){return t.shutdown()})},this.window.addEventListener("unload",this.windowUnloadHandler))},Pl.prototype.detachWindowUnloadHook=function(){var e;this.windowUnloadHandler&&(Qr("function"==typeof(null===(e=this.window)||void 0===e?void 0:e.removeEventListener),"Expected 'window.removeEventListener' to be a function"),this.window.removeEventListener("unload",this.windowUnloadHandler),this.windowUnloadHandler=null)},Pl.prototype.isClientZombied=function(e){try{var t=null!==(null===(t=this.webStorage)||void 0===t?void 0:t.getItem(this.zombiedClientLocalStorageKey(e)));return Br(kl,"Client '"+e+"' "+(t?"is":"is not")+" zombied in LocalStorage"),t}catch(e){return Vr(kl,"Failed to get zombied client id.",e),!1}},Pl.prototype.markClientZombied=function(){if(this.webStorage)try{this.webStorage.setItem(this.zombiedClientLocalStorageKey(this.clientId),String(Date.now()))}catch(e){Vr("Failed to set zombie client id.",e)}},Pl.prototype.removeClientZombiedEntry=function(){if(this.webStorage)try{this.webStorage.removeItem(this.zombiedClientLocalStorageKey(this.clientId))}catch(e){}},Pl.prototype.zombiedClientLocalStorageKey=function(e){return"firestore_zombie_"+this.persistenceKey+"_"+e},Pl);function Pl(e,t,n,r,i,o,a,s,u,c){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.queue=i,this.window=o,this.document=a,this.sequenceNumberSyncer=u,this.forceOwningTab=c,this.listenSequence=null,this._started=!1,this.isPrimary=!1,this.networkEnabled=!0,this.windowUnloadHandler=null,this.inForeground=!1,this.documentVisibilityHandler=null,this.clientMetadataRefresher=null,this.lastGarbageCollectionTime=Number.NEGATIVE_INFINITY,this.primaryStateListener=function(e){return Promise.resolve()},!Pl.isAvailable())throw new Lr(Rr.UNIMPLEMENTED,Nl);this.referenceDelegate=new Fl(this,r),this.dbName=t+xl,this.serializer=new Vu(s),this.simpleDb=new wc(this.dbName,Pc,new Mc(this.serializer)),this.targetCache=new fl(this.referenceDelegate,this.serializer),this.indexManager=new sl,this.remoteDocumentCache=(t=this.serializer,s=this.indexManager,new oc(t,s)),this.bundleCache=new rl(this.serializer),this.window&&this.window.localStorage?this.webStorage=this.window.localStorage:(this.webStorage=null,!1===c&&Vr(kl,"LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}function Ml(e){return Ll.getStore(e,Bc.store)}function ql(e){return Ll.getStore(e,Zc.store)}var Fl=(Bl.prototype.getSequenceNumberCount=function(e){var n=this.orphanedDocumentCount(e);return this.db.getTargetCache().getTargetCount(e).next(function(t){return n.next(function(e){return t+e})})},Bl.prototype.orphanedDocumentCount=function(e){var t=0;return this.forEachOrphanedDocumentSequenceNumber(e,function(e){t++}).next(function(){return t})},Bl.prototype.forEachTarget=function(e,t){return this.db.getTargetCache().forEachTarget(e,t)},Bl.prototype.forEachOrphanedDocumentSequenceNumber=function(e,n){return this.forEachOrphanedDocument(e,function(e,t){return n(t)})},Bl.prototype.addReference=function(e,t,n){return Vl(e,n)},Bl.prototype.removeReference=function(e,t,n){return Vl(e,n)},Bl.prototype.removeTargets=function(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)},Bl.prototype.markPotentiallyOrphaned=Vl,Bl.prototype.isPinned=function(e,t){return r=t,i=!1,rc(n=e).iterateSerial(function(e){return Zu(n,e,r).next(function(e){return e&&(i=!0),Iu.resolve(!e)})}).next(function(){return i});var n,r,i},Bl.prototype.removeOrphanedDocuments=function(n,r){var i=this,o=this.db.getRemoteDocumentCache().newChangeBuffer(),a=[],s=0;return this.forEachOrphanedDocument(n,function(t,e){e<=r&&(e=i.isPinned(n,t).next(function(e){if(!e)return s++,o.getEntry(n,t).next(function(){return o.removeEntry(t),ml(n).delete([0,qu(t.path)])})}),a.push(e))}).next(function(){return Iu.waitFor(a)}).next(function(){return o.apply(n)}).next(function(){return s})},Bl.prototype.removeTarget=function(e,t){t=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,t)},Bl.prototype.updateLimboDocument=Vl,Bl.prototype.forEachOrphanedDocument=function(e,r){var i,e=ml(e),o=xu.INVALID;return e.iterate({index:Yc.documentTargetsIndex},function(e,t){var n=e[0],e=(e[1],t.path),t=t.sequenceNumber;0===n?(o!==xu.INVALID&&r(new vi(Bu(i)),o),o=t,i=e):o=xu.INVALID}).next(function(){o!==xu.INVALID&&r(new vi(Bu(i)),o)})},Bl.prototype.getCacheSize=function(e){return this.db.getRemoteDocumentCache().getSize(e)},Bl);function Bl(e,t){this.db=e,this.garbageCollector=new Cl(this,t)}function Vl(e,t){return ml(e).put((t=t,e=e.currentSequenceNumber,new Yc(0,qu(t.path),e)))}function Ul(e,t){var n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}var Kl="LocalStore",jl=3e8,zl=(Ql.prototype.collectGarbage=function(t){var n=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary",function(e){return t.collect(e,n.targetDataByTarget)})},Ql);function Ql(e,t,n,r){this.persistence=e,this.queryEngine=t,this.serializer=r,this.targetDataByTarget=new na(Yr),this.targetIdByTarget=new Tu(no,io),this.lastDocumentChangeReadTime=ea.min(),Qr(e.started,"LocalStore was passed an unstarted persistence implementation"),this.mutationQueue=e.getMutationQueue(n),this.remoteDocuments=e.getRemoteDocumentCache(),this.targetCache=e.getTargetCache(),this.localDocuments=new Cu(this.remoteDocuments,this.mutationQueue,this.persistence.getIndexManager()),this.bundleCache=e.getBundleCache(),this.queryEngine.setLocalDocumentsView(this.localDocuments)}function Gl(e,t,n,r){return new zl(e,t,n,r)}function Wl(i,o){return m(this,void 0,void 0,function(){var t,n,m,r;return g(this,function(e){switch(e.label){case 0:return t=Gr(i,zl),n=t.mutationQueue,m=t.localDocuments,[4,t.persistence.runTransaction("Handle user change","readonly",function(p){var y;return t.mutationQueue.getAllMutationBatches(p).next(function(e){return y=e,n=t.persistence.getMutationQueue(o),m=new Cu(t.remoteDocuments,n,t.persistence.getIndexManager()),n.getAllMutationBatches(p)}).next(function(e){for(var t=[],n=[],r=ga(),i=0,o=y;i<o.length;i++){var a=o[i];t.push(a.batchId);for(var s=0,u=a.mutations;s<u.length;s++)var c=u[s],r=r.add(c.key)}for(var l=0,h=e;l<h.length;l++){a=h[l];n.push(a.batchId);for(var f=0,d=a.mutations;f<d.length;f++){c=d[f];r=r.add(c.key)}}return m.getDocuments(p,r).next(function(e){return{affectedDocuments:e,removedBatchIds:t,addedBatchIds:n}})})})];case 1:return r=e.sent(),t.mutationQueue=n,t.localDocuments=m,t.queryEngine.setLocalDocumentsView(t.localDocuments),[2,r]}})})}function Hl(e,s){var u,c=Gr(e,zl),l=Zr.now(),t=s.reduce(function(e,t){return e.add(t.key)},ga());return c.persistence.runTransaction("Locally write mutations","readwrite",function(a){return c.localDocuments.getDocuments(a,t).next(function(e){u=e;for(var t=[],n=0,r=s;n<r.length;n++){var i=r[n],o=Hs(i,u.get(i.key));null!=o&&t.push(new nu(i.key,o,function a(e){var s=[];return ni(e.fields||{},function(e,t){var n=new mi([e]);if(zi(t))if(0===(t=a(t.mapValue).fields).length)s.push(n);else for(var r=0,i=t;r<i.length;r++){var o=i[r];s.push(n.child(o))}else s.push(n)}),new Fs(s)}(o.proto.mapValue),js.exists(!0)))}return c.mutationQueue.addMutationBatch(a,l,t,s)})}).then(function(e){var t=e.applyToLocalDocumentSet(u);return{batchId:e.batchId,changes:t}})}function Yl(e,l){var h=Gr(e,zl);return h.persistence.runTransaction("Acknowledge batch","readwrite-primary",function(e){var t,n,i,o,a,r,s,u=l.batch.keys(),c=h.remoteDocuments.newChangeBuffer({trackRemovals:!0});return t=h,n=e,o=c,a=(i=l).batch,r=a.keys(),s=Iu.resolve(),r.forEach(function(r){s=s.next(function(){return o.getEntry(n,r)}).next(function(e){var t=e,n=i.docVersions.get(r);zr(null!==n,"ackVersions should contain every doc in the write."),(!t||t.version.compareTo(n)<0)&&((t=a.applyToRemoteDocument(r,t,i))?o.addEntry(t,i.commitVersion):Qr(!e,"Mutation batch "+a+" applied to document "+e+" resulted in null"))})}),s.next(function(){return t.mutationQueue.removeMutationBatch(n,a)}).next(function(){return c.apply(e)}).next(function(){return h.mutationQueue.performConsistencyCheck(e)}).next(function(){return h.localDocuments.getDocuments(e,u)})})}function Xl(e){var t=Gr(e,zl);return t.persistence.runTransaction("Get last remote snapshot version","readonly",function(e){return t.targetCache.getLastRemoteSnapshotVersion(e)})}function Jl(e,l){var h=Gr(e,zl),f=l.snapshotVersion,d=h.targetDataByTarget;return h.persistence.runTransaction("Apply remote event","readwrite-primary",function(i){var e=h.remoteDocuments.newChangeBuffer({trackRemovals:!0});d=h.targetDataByTarget;var o=[];l.targetChanges.forEach(function(e,t){var n,r=d.get(t);r&&(o.push(h.targetCache.removeMatchingKeys(i,e.removedDocuments,t).next(function(){return h.targetCache.addMatchingKeys(i,e.addedDocuments,t)})),0<(n=e.resumeToken).approximateByteSize()&&(n=r.withResumeToken(n,f).withSequenceNumber(i.currentSequenceNumber),d=d.insert(t,n),function(e,t,n){if(zr(0<t.resumeToken.approximateByteSize(),"Attempted to persist target data with no resume token"),0===e.resumeToken.approximateByteSize())return!0;if(t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=jl)return!0;return 0<n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size}(r,n,e)&&o.push(h.targetCache.updateTargetData(i,n))))});var a,t,s,u,n,r,c=da;return l.documentUpdates.forEach(function(e,t){l.resolvedLimboDocuments.has(e)&&o.push(h.persistence.referenceDelegate.updateLimboDocument(i,e))}),o.push((r=i,a=e,t=l.documentUpdates,s=f,u=void 0,n=ga(),t.forEach(function(e){return n=n.add(e)}),a.getEntries(r,n).next(function(i){var o=da;return t.forEach(function(e,t){var n=i.get(e),r=(null==u?void 0:u.get(e))||s;t instanceof Yi&&t.version.isEqual(ea.min())?(a.removeEntry(e,r),o=o.insert(e,t)):null==n||0<t.version.compareTo(n.version)||0===t.version.compareTo(n.version)&&n.hasPendingWrites?(Qr(!ea.min().isEqual(r),"Cannot add a document when the remote version is zero"),a.addEntry(t,r),o=o.insert(e,t)):Br(Kl,"Ignoring outdated watch update for ",e,". Current version:",n.version," Watch version:",t.version)}),o}).next(function(e){c=e}))),f.isEqual(ea.min())||(r=h.targetCache.getLastRemoteSnapshotVersion(i).next(function(e){return Qr(0<=f.compareTo(e),"Watch stream reverted to previous snapshot?? "+f+" < "+e),h.targetCache.setTargetsMetadata(i,i.currentSequenceNumber,f)}),o.push(r)),Iu.waitFor(o).next(function(){return e.apply(i)}).next(function(){return h.localDocuments.getLocalViewOfDocuments(i,c)})}).then(function(e){return h.targetDataByTarget=d,e})}function $l(e,r){var i=Gr(e,zl);return i.persistence.runTransaction("Allocate target","readwrite",function(t){var n;return i.targetCache.getTargetData(t,r).next(function(e){return e?(n=e,Iu.resolve(n)):i.targetCache.allocateTargetId(t).next(function(e){return n=new Au(r,e,0,t.currentSequenceNumber),i.targetCache.addTargetData(t,n).next(function(){return n})})})}).then(function(e){var t=i.targetDataByTarget.get(e.targetId);return(null===t||0<e.snapshotVersion.compareTo(t.snapshotVersion))&&(i.targetDataByTarget=i.targetDataByTarget.insert(e.targetId,e),i.targetIdByTarget.set(r,e.targetId)),e})}function Zl(i,o,a){return m(this,void 0,void 0,function(){var t,n,r;return g(this,function(e){switch(e.label){case 0:t=Gr(i,zl),Qr(null!==(n=t.targetDataByTarget.get(o)),"Tried to release nonexistent target: "+o),r=a?"readwrite":"readwrite-primary",e.label=1;case 1:return e.trys.push([1,4,,5]),a?[3,3]:[4,t.persistence.runTransaction("Release target",r,function(e){return t.persistence.referenceDelegate.removeTarget(e,n)})];case 2:e.sent(),e.label=3;case 3:return[3,5];case 4:if(!_c(r=e.sent()))throw r;return Br(Kl,"Failed to update sequence numbers for target "+o+": "+r),[3,5];case 5:return t.targetDataByTarget=t.targetDataByTarget.remove(o),t.targetIdByTarget.delete(n.target),[2]}})})}function eh(e,o,a){var s=Gr(e,zl),u=ea.min(),c=ga();return s.persistence.runTransaction("Execute query","readonly",function(t){return e=s,n=t,r=go(o),i=Gr(e,zl),(void 0!==(e=i.targetIdByTarget.get(r))?Iu.resolve(i.targetDataByTarget.get(e)):i.targetCache.getTargetData(n,r)).next(function(e){if(e)return u=e.lastLimboFreeSnapshotVersion,s.targetCache.getMatchingKeysForTargetId(t,e.targetId).next(function(e){c=e})}).next(function(){return s.queryEngine.getDocumentsMatchingQuery(t,o,a?u:ea.min(),a?c:ga())}).next(function(e){return{documents:e,remoteKeys:c}});var e,n,r,i})}function th(e,t){var n=Gr(e,zl),r=Gr(n.targetCache,fl),e=n.targetDataByTarget.get(t);return e?Promise.resolve(e.target):n.persistence.runTransaction("Get target data","readonly",function(e){return r.getTargetDataForTarget(e,t).next(function(e){return e?e.target:null})})}function nh(e){var a=Gr(e,zl);return a.persistence.runTransaction("Get new document changes","readonly",function(e){return t=a.remoteDocuments,n=e,e=a.lastDocumentChangeReadTime,r=Gr(t,oc),i=da,o=ju(e),e=hc(n),n=IDBKeyRange.lowerBound(o,!0),e.iterate({index:Gc.readTimeIndex,range:n},function(e,t){var n=Uu(r.serializer,t);i=i.insert(n.key,n),o=t.readTime}).next(function(){return{changedDocs:i,readTime:zu(o)}});var t,n,r,i,o}).then(function(e){var t=e.changedDocs,e=e.readTime;return a.lastDocumentChangeReadTime=e,t})}function rh(n){return m(this,void 0,void 0,function(){var t;return g(this,function(e){return[2,(t=Gr(n,zl)).persistence.runTransaction("Synchronize last document change read time","readonly",function(e){return e=hc(e=e),r=ea.min(),e.iterate({index:Gc.readTimeIndex,reverse:!0},function(e,t,n){t.readTime&&(r=zu(t.readTime)),n.done()}).next(function(){return r});var r}).then(function(e){t.lastDocumentChangeReadTime=e})]})})}function ih(t){return m(this,void 0,void 0,function(){return g(this,function(e){if(t.code!==Rr.FAILED_PRECONDITION||t.message!==_u)throw t;return Br(Kl,"Unexpectedly lost primary lease"),[2]})})}var oh=(ah.prototype.reset=function(){this.currentBaseMs=0},ah.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs},ah.prototype.backoffAndRun=function(e){var t=this;this.cancel();var n=Math.floor(this.currentBaseMs+this.jitterDelayMs()),r=Math.max(0,Date.now()-this.lastAttemptTime),i=Math.max(0,n-r);0<i&&Br("ExponentialBackoff","Backing off for "+i+" ms (base delay: "+this.currentBaseMs+" ms, delay with jitter: "+n+" ms, last attempt: "+r+" ms ago)"),this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,i,function(){return t.lastAttemptTime=Date.now(),e()}),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<this.initialDelayMs&&(this.currentBaseMs=this.initialDelayMs),this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs)},ah.prototype.skipBackoff=function(){null!==this.timerPromise&&(this.timerPromise.skipDelay(),this.timerPromise=null)},ah.prototype.cancel=function(){null!==this.timerPromise&&(this.timerPromise.cancel(),this.timerPromise=null)},ah.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs},ah);function ah(e,t,n,r,i){void 0===n&&(n=1e3),void 0===r&&(r=1.5),void 0===i&&(i=6e4),this.queue=e,this.timerId=t,this.initialDelayMs=n,this.backoffFactor=r,this.maxDelayMs=i,this.currentBaseMs=0,this.timerPromise=null,this.lastAttemptTime=Date.now(),this.reset()}var sh="PersistentStream",l=(uh.prototype.isStarted=function(){return 1===this.state||2===this.state||4===this.state},uh.prototype.isOpen=function(){return 2===this.state},uh.prototype.start=function(){3!==this.state?(Qr(0===this.state,"Already started"),this.auth()):this.performBackoff()},uh.prototype.stop=function(){return m(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return this.isStarted()?[4,this.close(0)]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}})})},uh.prototype.inhibitBackoff=function(){Qr(!this.isStarted(),"Can only inhibit backoff in a stopped state"),this.state=0,this.backoff.reset()},uh.prototype.markIdle=function(){var e=this;this.isOpen()&&null===this.idleTimer&&(this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,6e4,function(){return e.handleIdleCloseTimer()}))},uh.prototype.sendRequest=function(e){this.cancelIdleCheck(),this.stream.send(e)},uh.prototype.handleIdleCloseTimer=function(){return m(this,void 0,void 0,function(){return g(this,function(e){return this.isOpen()?[2,this.close(0)]:[2]})})},uh.prototype.cancelIdleCheck=function(){this.idleTimer&&(this.idleTimer.cancel(),this.idleTimer=null)},uh.prototype.close=function(t,n){return m(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return Qr(this.isStarted(),"Only started streams should be closed."),Qr(3===t||ai(n),"Can't provide an error when not in an error state."),this.cancelIdleCheck(),this.backoff.cancel(),this.closeCount++,3!==t?this.backoff.reset():n&&n.code===Rr.RESOURCE_EXHAUSTED?(Vr(n.toString()),Vr("Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()):n&&n.code===Rr.UNAUTHENTICATED&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=t,[4,this.listener.onClose(n)];case 1:return e.sent(),[2]}})})},uh.prototype.tearDown=function(){},uh.prototype.auth=function(){var n=this;Qr(0===this.state,"Must be in initial state to auth"),this.state=1;var e=this.getCloseGuardedDispatcher(this.closeCount),t=this.closeCount;this.credentialsProvider.getToken().then(function(e){n.closeCount===t&&n.startStream(e)},function(t){e(function(){var e=new Lr(Rr.UNKNOWN,"Fetching auth token failed: "+t.message);return n.handleStreamClose(e)})})},uh.prototype.startStream=function(e){var t=this;Qr(1===this.state,"Trying to start stream in a non-starting state");var n=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(e),this.stream.onOpen(function(){n(function(){return Qr(1===t.state,"Expected stream to be in state Starting, but was "+t.state),t.state=2,t.listener.onOpen()})}),this.stream.onClose(function(e){n(function(){return t.handleStreamClose(e)})}),this.stream.onMessage(function(e){n(function(){return t.onMessage(e)})})},uh.prototype.performBackoff=function(){var e=this;Qr(3===this.state,"Should only perform backoff when in Error state"),this.state=4,this.backoff.backoffAndRun(function(){return m(e,void 0,void 0,function(){return g(this,function(e){return Qr(4===this.state,"Backoff elapsed but state is now: "+this.state),this.state=0,this.start(),Qr(this.isStarted(),"PersistentStream should have started"),[2]})})})},uh.prototype.handleStreamClose=function(e){return Qr(this.isStarted(),"Can't handle server close on non-started stream"),Br(sh,"close with error: "+e),this.stream=null,this.close(3,e)},uh.prototype.getCloseGuardedDispatcher=function(t){var n=this;return function(e){n.queue.enqueueAndForget(function(){return n.closeCount===t?e():(Br(sh,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())})}},uh);function uh(e,t,n,r,i,o){this.queue=e,this.idleTimerId=n,this.connection=r,this.credentialsProvider=i,this.listener=o,this.state=0,this.closeCount=0,this.idleTimer=null,this.stream=null,this.backoff=new oh(e,t)}var ch,lh=(n(hh,ch=l),hh.prototype.startRpc=function(e){return this.connection.openStream("Listen",e)},hh.prototype.onMessage=function(e){this.backoff.reset();var t=as(this.serializer,e),e="targetChange"in(e=e)&&(!(e=e.targetChange).targetIds||!e.targetIds.length)&&e.readTime?Ya(e.readTime):ea.min();return this.listener.onWatchChange(t,e)},hh.prototype.watch=function(e){var t,n,r,i={};i.database=ns(this.serializer),i.addTarget=(t=this.serializer,(r=oo(r=(n=e).target)?{documents:ls(t,r)}:{query:hs(t,r)}).targetId=n.targetId,0<n.resumeToken.approximateByteSize()?r.resumeToken=Ha(t,n.resumeToken):0<n.snapshotVersion.compareTo(ea.min())&&(r.readTime=Wa(t,n.snapshotVersion.toTimestamp())),r);e=ds(this.serializer,e);e&&(i.labels=e),this.sendRequest(i)},hh.prototype.unwatch=function(e){var t={};t.database=ns(this.serializer),t.removeTarget=e,this.sendRequest(t)},hh);function hh(e,t,n,r,i){i=ch.call(this,e,"listen_stream_connection_backoff","listen_stream_idle",t,n,i)||this;return i.serializer=r,i}var fh,dh=(n(ph,fh=l),Object.defineProperty(ph.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:!1,configurable:!0}),ph.prototype.start=function(){this.handshakeComplete_=!1,this.lastStreamToken=void 0,fh.prototype.start.call(this)},ph.prototype.tearDown=function(){this.handshakeComplete_&&this.writeMutations([])},ph.prototype.startRpc=function(e){return this.connection.openStream("Write",e)},ph.prototype.onMessage=function(e){if(zr(!!e.streamToken,"Got a write response without a stream token"),this.lastStreamToken=e.streamToken,this.handshakeComplete_){this.backoff.reset();var t=cs(e.writeResults,e.commitTime),n=Ya(e.commitTime);return this.listener.onMutationResult(n,t)}return zr(!e.writeResults||0===e.writeResults.length,"Got mutation results for handshake"),this.handshakeComplete_=!0,this.listener.onHandshakeComplete()},ph.prototype.writeHandshake=function(){Qr(this.isOpen(),"Writing handshake requires an opened stream"),Qr(!this.handshakeComplete_,"Handshake already completed"),Qr(!this.lastStreamToken,"Stream token should be empty during handshake");var e={};e.database=ns(this.serializer),this.sendRequest(e)},ph.prototype.writeMutations=function(e){var t=this;Qr(this.isOpen(),"Writing mutations requires an opened stream"),Qr(this.handshakeComplete_,"Handshake must be complete before writing mutations"),Qr(!!this.lastStreamToken,"Trying to write mutation without a token");e={streamToken:this.lastStreamToken,writes:e.map(function(e){return ss(t.serializer,e)})};this.sendRequest(e)},ph);function ph(e,t,n,r,i){i=fh.call(this,e,"write_stream_connection_backoff","write_stream_idle",t,n,i)||this;return i.serializer=r,i.handshakeComplete_=!1,i}var yh,mh=(n(gh,yh=function(){}),gh.prototype.verifyInitialized=function(){if(Qr(!!this.connection,"Datastore.start() not called"),this.terminated)throw new Lr(Rr.FAILED_PRECONDITION,"The client has already been terminated.")},gh.prototype.invokeRPC=function(t,n,r){var i=this;return this.verifyInitialized(),this.credentials.getToken().then(function(e){return i.connection.invokeRPC(t,n,r,e)}).catch(function(e){throw e.code===Rr.UNAUTHENTICATED&&i.credentials.invalidateToken(),e})},gh.prototype.invokeStreamingRPC=function(t,n,r){var i=this;return this.verifyInitialized(),this.credentials.getToken().then(function(e){return i.connection.invokeStreamingRPC(t,n,r,e)}).catch(function(e){throw e.code===Rr.UNAUTHENTICATED&&i.credentials.invalidateToken(),e})},gh.prototype.terminate=function(){this.terminated=!1},gh);function gh(e,t,n){var r=yh.call(this)||this;return r.credentials=e,r.connection=t,r.serializer=n,r.terminated=!1,r}var vh=(bh.prototype.handleWatchStreamStart=function(){var e=this;0===this.watchStreamFailures&&(this.setAndBroadcast("Unknown"),Qr(null===this.onlineStateTimer,"onlineStateTimer shouldn't be started yet"),this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,function(){return e.onlineStateTimer=null,Qr("Unknown"===e.state,"Timer should be canceled if we transitioned to a different state."),e.logClientOfflineWarningIfNecessary("Backend didn't respond within 10 seconds."),e.setAndBroadcast("Offline"),Promise.resolve()}))},bh.prototype.handleWatchStreamFailure=function(e){"Online"===this.state?(this.setAndBroadcast("Unknown"),Qr(0===this.watchStreamFailures,"watchStreamFailures must be 0"),Qr(null===this.onlineStateTimer,"onlineStateTimer must be null")):(this.watchStreamFailures++,1<=this.watchStreamFailures&&(this.clearOnlineStateTimer(),this.logClientOfflineWarningIfNecessary("Connection failed 1 times. Most recent error: "+e.toString()),this.setAndBroadcast("Offline")))},bh.prototype.set=function(e){this.clearOnlineStateTimer(),this.watchStreamFailures=0,"Online"===e&&(this.shouldWarnClientIsOffline=!1),this.setAndBroadcast(e)},bh.prototype.setAndBroadcast=function(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))},bh.prototype.logClientOfflineWarningIfNecessary=function(e){e="Could not reach Cloud Firestore backend. "+e+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.shouldWarnClientIsOffline?(Vr(e),this.shouldWarnClientIsOffline=!1):Br("OnlineStateTracker",e)},bh.prototype.clearOnlineStateTimer=function(){null!==this.onlineStateTimer&&(this.onlineStateTimer.cancel(),this.onlineStateTimer=null)},bh);function bh(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.watchStreamFailures=0,this.onlineStateTimer=null,this.shouldWarnClientIsOffline=!0}var wh="RemoteStore",Th=10,Sh=function(e,t,n,r,i){var o=this;this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.writePipeline=[],this.listenTargets=new Map,this.offlineCauses=new Set,this.onNetworkStatusChange=[],this.connectivityMonitor=i,this.connectivityMonitor.addCallback(function(e){n.enqueueAndForget(function(){return m(o,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return xh(this)?(Br(wh,"Restarting streams for network reachability change."),[4,function(n){return m(this,void 0,void 0,function(){var t;return g(this,function(e){switch(e.label){case 0:return(t=Gr(n,Sh)).offlineCauses.add(4),[4,Eh(t)];case 1:return e.sent(),t.onlineStateTracker.set("Unknown"),t.offlineCauses.delete(4),[4,Ih(t)];case 2:return e.sent(),[2]}})})}(this)]):[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}})})})}),this.onlineStateTracker=new vh(n,r)};function Ih(r){return m(this,void 0,void 0,function(){var t,n;return g(this,function(e){switch(e.label){case 0:if(!xh(r))return[3,4];t=0,n=r.onNetworkStatusChange,e.label=1;case 1:return t<n.length?[4,(0,n[t])(!0)]:[3,4];case 2:e.sent(),e.label=3;case 3:return t++,[3,1];case 4:return[2]}})})}function Eh(r){return m(this,void 0,void 0,function(){var t,n;return g(this,function(e){switch(e.label){case 0:t=0,n=r.onNetworkStatusChange,e.label=1;case 1:return t<n.length?[4,(0,n[t])(!1)]:[3,4];case 2:e.sent(),e.label=3;case 3:return t++,[3,1];case 4:return[2]}})})}function Ch(e,t){e=Gr(e,Sh);e.listenTargets.has(t.targetId)||(e.listenTargets.set(t.targetId,t),Nh(e)?Ah(e):Kh(e).isOpen()&&_h(e,t))}function Dh(e,t){var n=Gr(e,Sh),e=Kh(n);Qr(n.listenTargets.has(t),"unlisten called on target no currently watched: "+t),n.listenTargets.delete(t),e.isOpen()&&kh(n,t),0===n.listenTargets.size&&(e.isOpen()?e.markIdle():xh(n)&&n.onlineStateTracker.set("Unknown"))}function _h(e,t){e.watchChangeAggregator.recordPendingTargetRequest(t.targetId),Kh(e).watch(t)}function kh(e,t){e.watchChangeAggregator.recordPendingTargetRequest(t),Kh(e).unwatch(t)}function Ah(t){Qr(Nh(t),"startWatchStream() called when shouldStartWatchStream() is false."),Qr(!!t.remoteSyncer.getRemoteKeysForTarget,"getRemoteKeysForTarget() not set"),t.watchChangeAggregator=new Ma({getRemoteKeysForTarget:function(e){return t.remoteSyncer.getRemoteKeysForTarget(e)},getTargetDataForTarget:function(e){return t.listenTargets.get(e)||null}}),Kh(t).start(),t.onlineStateTracker.handleWatchStreamStart()}function Nh(e){return xh(e)&&!Kh(e).isStarted()&&0<e.listenTargets.size}function xh(e){return 0===Gr(e,Sh).offlineCauses.size}function Oh(e){e.watchChangeAggregator=void 0}function Rh(r,i,o){return m(this,void 0,void 0,function(){var t,n;return g(this,function(e){switch(e.label){case 0:if(r.onlineStateTracker.set("Online"),!(i instanceof Ra&&2===i.state&&i.cause))return[3,6];e.label=1;case 1:return e.trys.push([1,3,,5]),[4,function(o,a){return m(this,void 0,void 0,function(){var t,n,r,i;return g(this,function(e){switch(e.label){case 0:Qr(!!o.remoteSyncer.rejectListen,"rejectListen() not set"),Qr(!!a.cause,"Handling target error without a cause"),t=a.cause,n=0,r=a.targetIds,e.label=1;case 1:return n<r.length?(i=r[n],o.listenTargets.has(i)?[4,o.remoteSyncer.rejectListen(i,t)]:[3,3]):[3,4];case 2:e.sent(),o.listenTargets.delete(i),o.watchChangeAggregator.removeTarget(i),e.label=3;case 3:return n++,[3,1];case 4:return[2]}})})}(r,i)];case 2:return e.sent(),[3,5];case 3:return t=e.sent(),Br(wh,"Failed to remove targets %s: %s ",i.targetIds.join(","),t),[4,Lh(r,t)];case 4:return e.sent(),[3,5];case 5:return[2];case 6:if(i instanceof xa?r.watchChangeAggregator.handleDocumentChange(i):i instanceof Oa?r.watchChangeAggregator.handleExistenceFilter(i):(Qr(i instanceof Ra,"Expected watchChange to be an instance of WatchTargetChange"),r.watchChangeAggregator.handleTargetChange(i)),o.isEqual(ea.min()))return[3,13];e.label=7;case 7:return e.trys.push([7,11,,13]),[4,Xl(r.localStore)];case 8:return n=e.sent(),0<=o.compareTo(n)?[4,function(r,i){Qr(!i.isEqual(ea.min()),"Can't raise event for unknown SnapshotVersion");var e=r.watchChangeAggregator.createRemoteEvent(i);return e.targetChanges.forEach(function(e,t){var n;0<e.resumeToken.approximateByteSize()&&((n=r.listenTargets.get(t))&&r.listenTargets.set(t,n.withResumeToken(e.resumeToken,i)))}),e.targetMismatches.forEach(function(e){var t=r.listenTargets.get(e);t&&(r.listenTargets.set(e,t.withResumeToken(ii.EMPTY_BYTE_STRING,t.snapshotVersion)),kh(r,e),t=new Au(t.target,e,1,t.sequenceNumber),_h(r,t))}),Qr(!!r.remoteSyncer.applyRemoteEvent,"applyRemoteEvent() not set"),r.remoteSyncer.applyRemoteEvent(e)}(r,o)]:[3,10];case 9:e.sent(),e.label=10;case 10:return[3,13];case 11:return n=e.sent(),Br(wh,"Failed to raise snapshot:",n),[4,Lh(r,n)];case 12:return e.sent(),[3,13];case 13:return[2]}})})}function Lh(n,r,i){return m(this,void 0,void 0,function(){var t=this;return g(this,function(e){switch(e.label){case 0:return _c(r)?(Qr(!n.offlineCauses.has(1),"Unexpected network event when IndexedDB was marked failed."),n.offlineCauses.add(1),[4,Eh(n)]):[3,2];case 1:return e.sent(),n.onlineStateTracker.set("Offline"),i=i||function(){return Xl(n.localStore)},n.asyncQueue.enqueueRetryable(function(){return m(t,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return Br(wh,"Retrying IndexedDB access"),[4,i()];case 1:return e.sent(),n.offlineCauses.delete(1),[4,Ih(n)];case 2:return e.sent(),[2]}})})}),[3,3];case 2:throw r;case 3:return[2]}})})}function Ph(t,n){return n().catch(function(e){return Lh(t,e,n)})}function Mh(u){return m(this,void 0,void 0,function(){var i,o,a,s;return g(this,function(e){switch(e.label){case 0:i=Gr(u,Sh),o=jh(i),a=0<i.writePipeline.length?i.writePipeline[i.writePipeline.length-1].batchId:mu,e.label=1;case 1:if(!qh(i))return[3,7];e.label=2;case 2:return e.trys.push([2,4,,6]),[4,(t=i.localStore,n=a,(r=Gr(t,zl)).persistence.runTransaction("Get next mutation batch","readonly",function(e){return void 0===n&&(n=mu),r.mutationQueue.getNextMutationBatchAfterBatchId(e,n)}))];case 3:return null===(s=e.sent())?(0===i.writePipeline.length&&o.markIdle(),[3,7]):(a=s.batchId,function(e,t){Qr(qh(e),"addToWritePipeline called when pipeline is full"),e.writePipeline.push(t);e=jh(e);e.isOpen()&&e.handshakeComplete&&e.writeMutations(t.mutations)}(i,s),[3,6]);case 4:return s=e.sent(),[4,Lh(i,s)];case 5:return e.sent(),[3,6];case 6:return[3,1];case 7:return Fh(i)&&Bh(i),[2]}var t,n,r})})}function qh(e){return xh(e)&&e.writePipeline.length<Th}function Fh(e){return xh(e)&&!jh(e).isStarted()&&0<e.writePipeline.length}function Bh(e){Qr(Fh(e),"startWriteStream() called when shouldStartWriteStream() is false."),jh(e).start()}function Vh(t,n){return m(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return void 0===n&&Qr(!Fh(t),"Write stream was stopped gracefully while still needed."),n&&jh(t).handshakeComplete?[4,function(r,i){return m(this,void 0,void 0,function(){var n;return g(this,function(e){switch(e.label){case 0:return Ca(t=i.code)&&t!==Rr.ABORTED?(n=r.writePipeline.shift(),jh(r).inhibitBackoff(),Qr(!!r.remoteSyncer.rejectFailedWrite,"rejectFailedWrite() not set"),[4,Ph(r,function(){return r.remoteSyncer.rejectFailedWrite(n.batchId,i)})]):[3,3];case 1:return e.sent(),[4,Mh(r)];case 2:e.sent(),e.label=3;case 3:return[2]}var t})})}(t,n)]:[3,2];case 1:e.sent(),e.label=2;case 2:return Fh(t)&&Bh(t),[2]}})})}function Uh(n,r){return m(this,void 0,void 0,function(){var t;return g(this,function(e){switch(e.label){case 0:return(t=Gr(n,Sh),r)?(t.offlineCauses.delete(2),[4,Ih(t)]):[3,2];case 1:return e.sent(),[3,4];case 2:return r?[3,4]:(t.offlineCauses.add(2),[4,Eh(t)]);case 3:e.sent(),t.onlineStateTracker.set("Unknown"),e.label=4;case 4:return[2]}})})}function Kh(n){var e,t,r,i=this;return n.watchStream||(n.watchStream=(e=n.datastore,t=n.asyncQueue,r={onOpen:function(n){return m(this,void 0,void 0,function(){return g(this,function(e){return n.listenTargets.forEach(function(e,t){_h(n,e)}),[2]})})}.bind(null,n),onClose:function(t,n){return m(this,void 0,void 0,function(){return g(this,function(e){return void 0===n&&Qr(!Nh(t),"Watch stream was stopped gracefully while still needed."),Oh(t),Nh(t)?(t.onlineStateTracker.handleWatchStreamFailure(n),Ah(t)):t.onlineStateTracker.set("Unknown"),[2]})})}.bind(null,n),onWatchChange:Rh.bind(null,n)},(e=Gr(e,mh)).verifyInitialized(),new lh(t,e.connection,e.credentials,e.serializer,r)),n.onNetworkStatusChange.push(function(t){return m(i,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return t?(n.watchStream.inhibitBackoff(),Nh(n)?Ah(n):n.onlineStateTracker.set("Unknown"),[3,3]):[3,1];case 1:return[4,n.watchStream.stop()];case 2:e.sent(),Oh(n),e.label=3;case 3:return[2]}})})})),n.watchStream}function jh(n){var e,t,r,i=this;return n.writeStream||(Qr(0===n.writePipeline.length,"Should not issue writes before WriteStream is enabled"),n.writeStream=(e=n.datastore,t=n.asyncQueue,r={onOpen:function(t){return m(this,void 0,void 0,function(){return g(this,function(e){return jh(t).writeHandshake(),[2]})})}.bind(null,n),onClose:Vh.bind(null,n),onHandshakeComplete:function(o){return m(this,void 0,void 0,function(){var t,n,r,i;return g(this,function(e){for(t=jh(o),n=0,r=o.writePipeline;n<r.length;n++)i=r[n],t.writeMutations(i.mutations);return[2]})})}.bind(null,n),onMutationResult:function(r,i,o){return m(this,void 0,void 0,function(){var t,n;return g(this,function(e){switch(e.label){case 0:return Qr(0<r.writePipeline.length,"Got result for empty write pipeline"),t=r.writePipeline.shift(),n=bu.from(t,i,o),Qr(!!r.remoteSyncer.applySuccessfulWrite,"applySuccessfulWrite() not set"),[4,Ph(r,function(){return r.remoteSyncer.applySuccessfulWrite(n)})];case 1:return e.sent(),[4,Mh(r)];case 2:return e.sent(),[2]}})})}.bind(null,n)},(e=Gr(e,mh)).verifyInitialized(),new dh(t,e.connection,e.credentials,e.serializer,r)),n.onNetworkStatusChange.push(function(t){return m(i,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return t?(n.writeStream.inhibitBackoff(),[4,Mh(n)]):[3,2];case 1:return e.sent(),[3,4];case 2:return[4,n.writeStream.stop()];case 3:e.sent(),0<n.writePipeline.length&&(Br(wh,"Stopping write stream with "+n.writePipeline.length+" pending writes"),n.writePipeline=[]),e.label=4;case 4:return[2]}})})})),n.writeStream}function zh(){return"undefined"!=typeof window?window:null}function Qh(){return"undefined"!=typeof document?document:null}var Gh="AsyncQueue",Wh=(Hh.createAndSchedule=function(e,t,n,r,i){i=new Hh(e,t,Date.now()+n,r,i);return i.start(n),i},Hh.prototype.start=function(e){var t=this;this.timerHandle=setTimeout(function(){return t.handleDelayElapsed()},e)},Hh.prototype.skipDelay=function(){return this.handleDelayElapsed()},Hh.prototype.cancel=function(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Lr(Rr.CANCELLED,"Operation cancelled"+(e?": "+e:""))))},Hh.prototype.handleDelayElapsed=function(){var t=this;this.asyncQueue.enqueueAndForget(function(){return null!==t.timerHandle?(t.clearTimeout(),t.op().then(function(e){return t.deferred.resolve(e)})):Promise.resolve()})},Hh.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)},Hh);function Hh(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new vc,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(function(e){})}var Yh=(Object.defineProperty(Xh.prototype,"isShuttingDown",{get:function(){return this._isShuttingDown},enumerable:!1,configurable:!0}),Xh.prototype.enqueueAndForget=function(e){this.enqueue(e)},Xh.prototype.enqueueAndForgetEvenWhileRestricted=function(e){this.verifyNotFailed(),this.enqueueInternal(e)},Xh.prototype.enterRestrictedMode=function(){var e;this._isShuttingDown||(this._isShuttingDown=!0,(e=Qh())&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.visibilityHandler))},Xh.prototype.enqueue=function(e){return this.verifyNotFailed(),this._isShuttingDown?new Promise(function(e){}):this.enqueueInternal(e)},Xh.prototype.enqueueRetryable=function(e){var t=this;this.enqueueAndForget(function(){return t.retryableOps.push(e),t.retryNextOp()})},Xh.prototype.retryNextOp=function(){return m(this,void 0,void 0,function(){var t,n=this;return g(this,function(e){switch(e.label){case 0:if(0===this.retryableOps.length)return[2];e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.retryableOps[0]()];case 2:return e.sent(),this.retryableOps.shift(),this.backoff.reset(),[3,4];case 3:if(!_c(t=e.sent()))throw t;return Br(Gh,"Operation failed with retryable error: "+t),[3,4];case 4:return 0<this.retryableOps.length&&this.backoff.backoffAndRun(function(){return n.retryNextOp()}),[2]}})})},Xh.prototype.enqueueInternal=function(e){var t=this,n=this.tail.then(function(){return t.operationInProgress=!0,e().catch(function(e){throw t.failure=e,t.operationInProgress=!1,Vr("INTERNAL UNHANDLED ERROR: ",$h(e)),e}).then(function(e){return t.operationInProgress=!1,e})});return this.tail=n},Xh.prototype.enqueueAfterDelay=function(e,t,n){var r=this;this.verifyNotFailed(),Qr(0<=t,"Attempted to schedule an operation with a negative delay of "+t),-1<this.timerIdsToSkip.indexOf(e)&&(t=0);n=Wh.createAndSchedule(this,e,t,n,function(e){return r.removeDelayedOperation(e)});return this.delayedOperations.push(n),n},Xh.prototype.verifyNotFailed=function(){this.failure&&jr("AsyncQueue is already failed: "+$h(this.failure))},Xh.prototype.verifyOperationInProgress=function(){Qr(this.operationInProgress,"verifyOpInProgress() called when no op in progress on this queue.")},Xh.prototype.drain=function(){return m(this,void 0,void 0,function(){var t;return g(this,function(e){switch(e.label){case 0:return[4,t=this.tail];case 1:e.sent(),e.label=2;case 2:if(t!==this.tail)return[3,0];e.label=3;case 3:return[2]}})})},Xh.prototype.containsDelayedOperation=function(e){for(var t=0,n=this.delayedOperations;t<n.length;t++){if(n[t].timerId===e)return!0}return!1},Xh.prototype.runAllDelayedOperationsUntil=function(r){var i=this;return this.drain().then(function(){i.delayedOperations.sort(function(e,t){return e.targetTimeMs-t.targetTimeMs});for(var e=0,t=i.delayedOperations;e<t.length;e++){var n=t[e];if(n.skipDelay(),"all"!==r&&n.timerId===r)break}return i.drain()})},Xh.prototype.skipDelaysForTimerId=function(e){this.timerIdsToSkip.push(e)},Xh.prototype.removeDelayedOperation=function(e){e=this.delayedOperations.indexOf(e);Qr(0<=e,"Delayed operation not found."),this.delayedOperations.splice(e,1)},Xh);function Xh(){var t=this;this.tail=Promise.resolve(),this.retryableOps=[],this._isShuttingDown=!1,this.delayedOperations=[],this.failure=null,this.operationInProgress=!1,this.timerIdsToSkip=[],this.backoff=new oh(this,"async_queue_retry"),this.visibilityHandler=function(){var e=Qh();e&&Br(Gh,"Visibility state changed to "+e.visibilityState),t.backoff.skipBackoff()};var e=Qh();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.visibilityHandler)}function Jh(e,t){if(Vr(Gh,t+": "+e),_c(e))return new Lr(Rr.UNAVAILABLE,t+": "+e);throw e}function $h(e){var t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}var Zh=(ef.emptySet=function(e){return new ef(e.comparator)},ef.prototype.has=function(e){return null!=this.keyedMap.get(e)},ef.prototype.get=function(e){return this.keyedMap.get(e)},ef.prototype.first=function(){return this.sortedSet.minKey()},ef.prototype.last=function(){return this.sortedSet.maxKey()},ef.prototype.isEmpty=function(){return this.sortedSet.isEmpty()},ef.prototype.indexOf=function(e){e=this.keyedMap.get(e);return e?this.sortedSet.indexOf(e):-1},Object.defineProperty(ef.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!1,configurable:!0}),ef.prototype.forEach=function(n){this.sortedSet.inorderTraversal(function(e,t){return n(e),!1})},ef.prototype.add=function(e){var t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))},ef.prototype.delete=function(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this},ef.prototype.isEqual=function(e){if(!(e instanceof ef))return!1;if(this.size!==e.size)return!1;for(var t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();t.hasNext();){var r=t.getNext().key,i=n.getNext().key;if(!r.isEqual(i))return!1}return!0},ef.prototype.toString=function(){var t=[];return this.forEach(function(e){t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"},ef.prototype.copy=function(e,t){var n=new ef;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n},ef);function ef(n){this.comparator=n?function(e,t){return n(e,t)||vi.comparator(e.key,t.key)}:function(e,t){return vi.comparator(e.key,t.key)},this.keyedMap=pa,this.sortedSet=new na(this.comparator)}var tf=(nf.prototype.track=function(e){var t=e.doc.key,n=this.changeMap.get(t);!n||0!==e.type&&3===n.type?this.changeMap=this.changeMap.insert(t,e):3===e.type&&1!==n.type?this.changeMap=this.changeMap.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.changeMap=this.changeMap.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.changeMap=this.changeMap.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.changeMap=this.changeMap.remove(t):1===e.type&&2===n.type?this.changeMap=this.changeMap.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.changeMap=this.changeMap.insert(t,{type:2,doc:e.doc}):jr("unsupported combination of changes: "+JSON.stringify(e)+" after "+JSON.stringify(n))},nf.prototype.getChanges=function(){var n=[];return this.changeMap.inorderTraversal(function(e,t){n.push(t)}),n},nf);function nf(){this.changeMap=new na(vi.comparator)}var rf=(of.fromInitialDocuments=function(e,t,n,r){var i=[];return t.forEach(function(e){i.push({type:0,doc:e})}),new of(e,t,Zh.emptySet(t),i,n,r,!0,!1)},Object.defineProperty(of.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:!1,configurable:!0}),of.prototype.isEqual=function(e){if(!(this.fromCache===e.fromCache&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&bo(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;var t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(var r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0},of);function of(e,t,n,r,i,o,a,s){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=s}var af=function(){this.viewSnap=void 0,this.listeners=[]};var sf=function(){this.queries=new Tu(wo,bo),this.onlineState="Unknown",this.snapshotsInSyncListeners=new Set};function uf(a,s){return m(this,void 0,void 0,function(){var t,n,r,i,o;return g(this,function(e){switch(e.label){case 0:if(Qr(!!(t=Gr(a,sf)).onListen,"onListen not set"),n=s.query,r=!1,(i=t.queries.get(n))||(r=!0,i=new af),!r)return[3,4];e.label=1;case 1:return e.trys.push([1,3,,4]),o=i,[4,t.onListen(n)];case 2:return o.viewSnap=e.sent(),[3,4];case 3:return o=e.sent(),o=Jh(o,"Initialization of query '"+To(s.query)+"' failed"),s.onError(o),[2];case 4:return t.queries.set(n,i),i.listeners.push(s),Qr(!s.applyOnlineStateChange(t.onlineState),"applyOnlineStateChange() shouldn't raise an event for brand-new listeners."),i.viewSnap&&s.onViewSnapshot(i.viewSnap)&&lf(t),[2]}})})}function cf(a,s){return m(this,void 0,void 0,function(){var t,n,r,i,o;return g(this,function(e){return Qr(!!(t=Gr(a,sf)).onUnlisten,"onUnlisten not set"),n=s.query,r=!1,(i=t.queries.get(n))&&0<=(o=i.listeners.indexOf(s))&&(i.listeners.splice(o,1),r=0===i.listeners.length),r?(t.queries.delete(n),[2,t.onUnlisten(n)]):[2]})})}function lf(e){e.snapshotsInSyncListeners.forEach(function(e){e.next()})}var hf=(ff.prototype.onViewSnapshot=function(e){if(Qr(0<e.docChanges.length||e.syncStateChanged,"We got a new snapshot with no changes?"),!this.options.includeMetadataChanges){for(var t=[],n=0,r=e.docChanges;n<r.length;n++){var i=r[n];3!==i.type&&t.push(i)}e=new rf(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0)}var o=!1;return this.raisedInitialEvent?this.shouldRaiseEvent(e)&&(this.queryObserver.next(e),o=!0):this.shouldRaiseInitialEvent(e,this.onlineState)&&(this.raiseInitialEvent(e),o=!0),this.snap=e,o},ff.prototype.onError=function(e){this.queryObserver.error(e)},ff.prototype.applyOnlineStateChange=function(e){this.onlineState=e;var t=!1;return this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,e)&&(this.raiseInitialEvent(this.snap),t=!0),t},ff.prototype.shouldRaiseInitialEvent=function(e,t){if(Qr(!this.raisedInitialEvent,"Determining whether to raise first event but already had first event"),!e.fromCache)return!0;var n="Offline"!==t;return this.options.waitForSyncWhenOnline&&n?(Qr(e.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!e.docs.isEmpty()||"Offline"===t},ff.prototype.shouldRaiseEvent=function(e){if(0<e.docChanges.length)return!0;var t=this.snap&&this.snap.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges},ff.prototype.raiseInitialEvent=function(e){Qr(!this.raisedInitialEvent,"Trying to raise initial events for second time"),e=rf.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache),this.raisedInitialEvent=!0,this.queryObserver.next(e)},ff);function ff(e,t,n){this.query=e,this.queryObserver=t,this.raisedInitialEvent=!1,this.snap=null,this.onlineState="Unknown",this.options=n||{}}var df=(pf.fromSnapshot=function(e,t){for(var n=ga(),r=ga(),i=0,o=t.docChanges;i<o.length;i++){var a=o[i];switch(a.type){case 0:n=n.add(a.doc.key);break;case 1:r=r.add(a.doc.key)}}return new pf(e,t.fromCache,n,r)},pf);function pf(e,t,n,r){this.targetId=e,this.fromCache=t,this.addedKeys=n,this.removedKeys=r}var yf=(mf.prototype.isEmpty=function(){return this.refsByKey.isEmpty()},mf.prototype.addReference=function(e,t){t=new gf(e,t);this.refsByKey=this.refsByKey.add(t),this.refsByTarget=this.refsByTarget.add(t)},mf.prototype.addReferences=function(e,t){var n=this;e.forEach(function(e){return n.addReference(e,t)})},mf.prototype.removeReference=function(e,t){this.removeRef(new gf(e,t))},mf.prototype.removeReferences=function(e,t){var n=this;e.forEach(function(e){return n.removeReference(e,t)})},mf.prototype.removeReferencesForId=function(e){var t=this,n=new vi(new fi([])),r=new gf(n,e),e=new gf(n,e+1),i=[];return this.refsByTarget.forEachInRange([r,e],function(e){t.removeRef(e),i.push(e.key)}),i},mf.prototype.removeAllReferences=function(){var t=this;this.refsByKey.forEach(function(e){return t.removeRef(e)})},mf.prototype.removeRef=function(e){this.refsByKey=this.refsByKey.delete(e),this.refsByTarget=this.refsByTarget.delete(e)},mf.prototype.referencesForId=function(e){var t=new vi(new fi([])),n=new gf(t,e),e=new gf(t,e+1),r=ga();return this.refsByTarget.forEachInRange([n,e],function(e){r=r.add(e.key)}),r},mf.prototype.containsKey=function(e){var t=new gf(e,0),t=this.refsByKey.firstAfterOrEqual(t);return null!==t&&e.isEqual(t.key)},mf);function mf(){this.refsByKey=new ca(gf.compareByKey),this.refsByTarget=new ca(gf.compareByTargetId)}var gf=(vf.compareByKey=function(e,t){return vi.comparator(e.key,t.key)||Yr(e.targetOrBatchId,t.targetOrBatchId)},vf.compareByTargetId=function(e,t){return Yr(e.targetOrBatchId,t.targetOrBatchId)||vi.comparator(e.key,t.key)},vf);function vf(e,t){this.key=e,this.targetOrBatchId=t}var bf=function(e){this.key=e},wf=function(e){this.key=e},Tf=(Object.defineProperty(Sf.prototype,"syncedDocuments",{get:function(){return this._syncedDocuments},enumerable:!1,configurable:!0}),Sf.prototype.computeDocChanges=function(e,t){var a=this,s=t?t.changeSet:new tf,u=(t||this).documentSet,c=(t||this).mutatedKeys,l=u,h=!1,f=co(this.query)&&u.size===this.query.limit?u.last():null,d=lo(this.query)&&u.size===this.query.limit?u.first():null;if(e.inorderTraversal(function(e,t){var n=u.get(e),r=t instanceof Gi?t:null;r&&(Qr(e.isEqual(r.key),"Mismatching keys found in document changes: "+e+" != "+r.key),r=So(a.query,r)?r:null);var i=!!n&&a.mutatedKeys.has(n.key),o=!!r&&(r.hasLocalMutations||a.mutatedKeys.has(r.key)&&r.hasCommittedMutations),t=!1;n&&r?n.data().isEqual(r.data())?i!==o&&(s.track({type:3,doc:r}),t=!0):a.shouldWaitForSyncedDocument(n,r)||(s.track({type:2,doc:r}),t=!0,(f&&0<a.docComparator(r,f)||d&&a.docComparator(r,d)<0)&&(h=!0)):!n&&r?(s.track({type:0,doc:r}),t=!0):n&&!r&&(s.track({type:1,doc:n}),t=!0,(f||d)&&(h=!0)),t&&(c=r?(l=l.add(r),o?c.add(e):c.delete(e)):(l=l.delete(e),c.delete(e)))}),co(this.query)||lo(this.query))for(;l.size>this.query.limit;){var n=co(this.query)?l.last():l.first(),l=l.delete(n.key),c=c.delete(n.key);s.track({type:1,doc:n})}return Qr(!h||!t,"View was refilled using docs that themselves needed refilling."),{documentSet:l,changeSet:s,needsRefill:h,mutatedKeys:c}},Sf.prototype.shouldWaitForSyncedDocument=function(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations},Sf.prototype.applyChanges=function(e,t,n){var o=this;Qr(!e.needsRefill,"Cannot apply changes that need a refill");var r=this.documentSet;this.documentSet=e.documentSet,this.mutatedKeys=e.mutatedKeys;var i=e.changeSet.getChanges();i.sort(function(e,t){return r=e.type,i=t.type,n(r)-n(i)||o.docComparator(e.doc,t.doc);function n(e){switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return jr("Unknown ChangeType: "+e)}}var r,i}),this.applyTargetChange(n);var a=t?this.updateLimboDocuments():[],n=0===this.limboDocuments.size&&this.current?1:0,t=n!==this.syncState;return this.syncState=n,0!==i.length||t?{snapshot:new rf(this.query,e.documentSet,r,i,e.mutatedKeys,0==n,t,!1),limboChanges:a}:{limboChanges:a}},Sf.prototype.applyOnlineStateChange=function(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({documentSet:this.documentSet,changeSet:new tf,mutatedKeys:this.mutatedKeys,needsRefill:!1},!1)):{limboChanges:[]}},Sf.prototype.shouldBeInLimbo=function(e){return!this._syncedDocuments.has(e)&&(!!this.documentSet.has(e)&&!this.documentSet.get(e).hasLocalMutations)},Sf.prototype.applyTargetChange=function(e){var t=this;e&&(e.addedDocuments.forEach(function(e){return t._syncedDocuments=t._syncedDocuments.add(e)}),e.modifiedDocuments.forEach(function(e){Qr(t._syncedDocuments.has(e),"Modified document "+e+" not found in view.")}),e.removedDocuments.forEach(function(e){return t._syncedDocuments=t._syncedDocuments.delete(e)}),this.current=e.current)},Sf.prototype.updateLimboDocuments=function(){var t=this;if(!this.current)return[];var n=this.limboDocuments;this.limboDocuments=ga(),this.documentSet.forEach(function(e){t.shouldBeInLimbo(e.key)&&(t.limboDocuments=t.limboDocuments.add(e.key))});var r=[];return n.forEach(function(e){t.limboDocuments.has(e)||r.push(new wf(e))}),this.limboDocuments.forEach(function(e){n.has(e)||r.push(new bf(e))}),r},Sf.prototype.synchronizeWithPersistedState=function(e){this._syncedDocuments=e.remoteKeys,this.limboDocuments=ga();e=this.computeDocChanges(e.documents);return this.applyChanges(e,!0)},Sf.prototype.computeInitialSnapshot=function(){return rf.fromInitialDocuments(this.query,this.documentSet,this.mutatedKeys,0===this.syncState)},Sf);function Sf(e,t){this.query=e,this._syncedDocuments=t,this.syncState=null,this.current=!1,this.limboDocuments=ga(),this.mutatedKeys=ga(),this.docComparator=Io(e),this.documentSet=new Zh(this.docComparator)}var If="SyncEngine",Ef=function(e,t,n){this.query=e,this.targetId=t,this.view=n},Cf=function(e){this.key=e,this.receivedDocument=!1},Df=(Object.defineProperty(_f.prototype,"isPrimaryClient",{get:function(){return!0===this._isPrimaryClient},enumerable:!1,configurable:!0}),_f);function _f(e,t,n,r,i,o){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=o,this.syncEngineListener={},this.queryViewsByQuery=new Tu(wo,bo),this.queriesByTarget=new Map,this.enqueuedLimboResolutions=[],this.activeLimboTargetsByKey=new na(vi.comparator),this.activeLimboResolutionsByTarget=new Map,this.limboDocumentRefs=new yf,this.mutationUserCallbacks={},this.pendingWritesCallbacks=new Map,this.limboTargetIdGenerator=ll.forSyncEngine(),this.onlineState="Unknown",this._isPrimaryClient=void 0}function kf(i,o,a,s){return m(this,void 0,void 0,function(){var t,n,r;return g(this,function(e){switch(e.label){case 0:return i.applyDocChanges=function(e,t,n){return function(r,i,o,a){return m(this,void 0,void 0,function(){var t,n;return g(this,function(e){switch(e.label){case 0:return(t=i.view.computeDocChanges(o)).needsRefill?[4,eh(r.localStore,i.query,!1).then(function(e){e=e.documents;return i.view.computeDocChanges(e,t)})]:[3,2];case 1:t=e.sent(),e.label=2;case 2:return n=a&&a.targetChanges.get(i.targetId),n=i.view.applyChanges(t,r.isPrimaryClient,n),Ff(r,i.targetId,n.limboChanges),[2,n.snapshot]}})})}(i,e,t,n)},[4,eh(i.localStore,o,!0)];case 1:return n=e.sent(),r=new Tf(o,n.remoteKeys),t=r.computeDocChanges(n.documents),n=Aa.createSynthesizedTargetChangeForCurrentChange(a,s&&"Offline"!==i.onlineState),n=r.applyChanges(t,i.isPrimaryClient,n),Ff(i,a,n.limboChanges),Qr(!!n.snapshot,"applyChanges for new view should always return a snapshot"),r=new Ef(o,a,r),i.queryViewsByQuery.set(o,r),i.queriesByTarget.has(a)?i.queriesByTarget.get(a).push(o):i.queriesByTarget.set(a,[o]),[2,n.snapshot]}})})}function Af(r,i,o){return m(this,void 0,void 0,function(){var t,n;return g(this,function(e){switch(e.label){case 0:n=Hf(r),e.label=1;case 1:return e.trys.push([1,5,,6]),[4,Hl(n.localStore,i)];case 2:return t=e.sent(),n.sharedClientState.addPendingMutation(t.batchId),function(e,t,n){var r=e.mutationUserCallbacks[e.currentUser.toKey()];r=r||new na(Yr);r=r.insert(t,n),e.mutationUserCallbacks[e.currentUser.toKey()]=r}(n,t.batchId,o),[4,Vf(n,t.changes)];case 3:return e.sent(),[4,Mh(n.remoteStore)];case 4:return e.sent(),[3,6];case 5:return n=e.sent(),n=Jh(n,"Failed to persist write"),o.reject(n),[3,6];case 6:return[2]}})})}function Nf(r,i){return m(this,void 0,void 0,function(){var n,t;return g(this,function(e){switch(e.label){case 0:n=Gr(r,Df),e.label=1;case 1:return e.trys.push([1,4,,6]),[4,Jl(n.localStore,i)];case 2:return t=e.sent(),i.targetChanges.forEach(function(e,t){t=n.activeLimboResolutionsByTarget.get(t);t&&(zr(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1,"Limbo resolution for single document contains multiple changes."),0<e.addedDocuments.size?t.receivedDocument=!0:0<e.modifiedDocuments.size?zr(t.receivedDocument,"Received change for limbo target document without add."):0<e.removedDocuments.size&&(zr(t.receivedDocument,"Received remove for limbo target document without add."),t.receivedDocument=!1))}),[4,Vf(n,t,i)];case 3:return e.sent(),[3,6];case 4:return[4,ih(e.sent())];case 5:return e.sent(),[3,6];case 6:return[2]}})})}function xf(e,n,t){var r,e=Gr(e,Df);(e.isPrimaryClient&&0===t||!e.isPrimaryClient&&1===t)&&(r=[],e.queryViewsByQuery.forEach(function(e,t){t=t.view.applyOnlineStateChange(n);Qr(0===t.limboChanges.length,"OnlineState should not affect limbo documents."),t.snapshot&&r.push(t.snapshot)}),function(e,i){(e=Gr(e,sf)).onlineState=i;var o=!1;e.queries.forEach(function(e,t){for(var n=0,r=t.listeners;n<r.length;n++){r[n].applyOnlineStateChange(i)&&(o=!0)}}),o&&lf(e)}(e.eventManager,n),r.length&&(Qr(!!e.syncEngineListener.onWatchChange,"Active views but EventManager callbacks are not assigned"),e.syncEngineListener.onWatchChange(r)),e.onlineState=n,e.isPrimaryClient&&e.sharedClientState.setOnlineState(n))}function Of(a,s,u){return m(this,void 0,void 0,function(){var n,o;return g(this,function(e){switch(e.label){case 0:n=Gr(a,Df),e.label=1;case 1:return e.trys.push([1,4,,6]),[4,(t=n.localStore,r=s,(i=Gr(t,zl)).persistence.runTransaction("Reject batch","readwrite-primary",function(t){var n;return i.mutationQueue.lookupMutationBatch(t,r).next(function(e){return zr(null!==e,"Attempt to reject nonexistent batch!"),n=e.keys(),i.mutationQueue.removeMutationBatch(t,e)}).next(function(){return i.mutationQueue.performConsistencyCheck(t)}).next(function(){return i.localDocuments.getDocuments(t,n)})}))];case 2:return o=e.sent(),Pf(n,s,u),Lf(n,s),n.sharedClientState.updateMutationState(s,"rejected",u),[4,Vf(n,o)];case 3:return e.sent(),[3,6];case 4:return[4,ih(e.sent())];case 5:return e.sent(),[3,6];case 6:return[2]}var t,r,i})})}function Rf(a,s){return m(this,void 0,void 0,function(){var r,i,o;return g(this,function(e){switch(e.label){case 0:xh((r=Gr(a,Df)).remoteStore)||Br(If,"The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled."),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,(t=r.localStore,(n=Gr(t,zl)).persistence.runTransaction("Get highest unacknowledged batch id","readonly",function(e){return n.mutationQueue.getHighestUnacknowledgedBatchId(e)}))];case 2:return(i=e.sent())===mu?(s.resolve(),[2]):((o=r.pendingWritesCallbacks.get(i)||[]).push(s),r.pendingWritesCallbacks.set(i,o),[3,4]);case 3:return o=e.sent(),o=Jh(o,"Initialization of waitForPendingWrites() operation failed"),s.reject(o),[3,4];case 4:return[2]}var t,n})})}function Lf(e,t){(e.pendingWritesCallbacks.get(t)||[]).forEach(function(e){e.resolve()}),e.pendingWritesCallbacks.delete(t)}function Pf(e,t,n){var r=Gr(e,Df),i=r.mutationUserCallbacks[r.currentUser.toKey()];i&&((e=i.get(t))&&(Qr(t===i.minKey(),"Mutation callbacks processed out-of-order?"),n?e.reject(n):e.resolve(),i=i.remove(t)),r.mutationUserCallbacks[r.currentUser.toKey()]=i)}function Mf(t,e,n){void 0===n&&(n=null),t.sharedClientState.removeLocalQueryTarget(e),Qr(t.queriesByTarget.has(e)&&0!==t.queriesByTarget.get(e).length,"There are no queries mapped to target id "+e);for(var r=0,i=t.queriesByTarget.get(e);r<i.length;r++){var o=i[r];t.queryViewsByQuery.delete(o),n&&t.syncEngineListener.onWatchError(o,n)}t.queriesByTarget.delete(e),t.isPrimaryClient&&t.limboDocumentRefs.removeReferencesForId(e).forEach(function(e){t.limboDocumentRefs.containsKey(e)||qf(t,e)})}function qf(e,t){var n=e.activeLimboTargetsByKey.get(t);null!==n&&(Dh(e.remoteStore,n),e.activeLimboTargetsByKey=e.activeLimboTargetsByKey.remove(t),e.activeLimboResolutionsByTarget.delete(n),Bf(e))}function Ff(e,t,n){for(var r=0,i=n;r<i.length;r++){var o=i[r];o instanceof bf?(e.limboDocumentRefs.addReference(o.key,t),function(e,t){t=t.key;e.activeLimboTargetsByKey.get(t)||(Br(If,"New document in limbo: "+t),e.enqueuedLimboResolutions.push(t),Bf(e))}(e,o)):o instanceof wf?(Br(If,"Document no longer in limbo: "+o.key),e.limboDocumentRefs.removeReference(o.key,t),e.limboDocumentRefs.containsKey(o.key)||qf(e,o.key)):jr("Unknown limbo change: "+JSON.stringify(o))}}function Bf(e){for(;0<e.enqueuedLimboResolutions.length&&e.activeLimboTargetsByKey.size<e.maxConcurrentLimboResolutions;){var t=e.enqueuedLimboResolutions.shift(),n=e.limboTargetIdGenerator.next();e.activeLimboResolutionsByTarget.set(n,new Cf(t)),e.activeLimboTargetsByKey=e.activeLimboTargetsByKey.insert(t,n),Ch(e.remoteStore,new Au(go(uo(t.path)),n,2,xu.INVALID))}}function Vf(t,a,s){return m(this,void 0,void 0,function(){var n,r,i,o;return g(this,function(e){switch(e.label){case 0:return(n=Gr(t,Df),r=[],i=[],o=[],n.queryViewsByQuery.isEmpty())?[2]:(n.queryViewsByQuery.forEach(function(e,t){Qr(!!n.applyDocChanges,"ApplyDocChangesHandler not set"),o.push(n.applyDocChanges(t,a,s).then(function(e){e&&(n.isPrimaryClient&&n.sharedClientState.updateQueryState(t.targetId,e.fromCache?"not-current":"current"),r.push(e),e=df.fromSnapshot(t.targetId,e),i.push(e))}))}),[4,Promise.all(o)]);case 1:return e.sent(),n.syncEngineListener.onWatchChange(r),[4,function(u,c){return m(this,void 0,void 0,function(){var r,t,n,i,o,a,s;return g(this,function(e){switch(e.label){case 0:r=Gr(u,zl),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,r.persistence.runTransaction("notifyLocalViewChanges","readwrite",function(n){return Iu.forEach(c,function(t){return Iu.forEach(t.addedKeys,function(e){return r.persistence.referenceDelegate.addReference(n,t.targetId,e)}).next(function(){return Iu.forEach(t.removedKeys,function(e){return r.persistence.referenceDelegate.removeReference(n,t.targetId,e)})})})})];case 2:return e.sent(),[3,4];case 3:if(!_c(t=e.sent()))throw t;return Br(Kl,"Failed to update sequence numbers: "+t),[3,4];case 4:for(n=0,i=c;n<i.length;n++)s=i[n],o=s.targetId,s.fromCache||(Qr(null!==(a=r.targetDataByTarget.get(o)),"Can't set limbo-free snapshot version for unknown target: "+o),s=a.snapshotVersion,s=a.withLastLimboFreeSnapshotVersion(s),r.targetDataByTarget=r.targetDataByTarget.insert(o,s));return[2]}})})}(n.localStore,i)];case 2:return e.sent(),[2]}})})}function Uf(o,a){return m(this,void 0,void 0,function(){var r,i;return g(this,function(e){switch(e.label){case 0:return(r=Gr(o,Df),!r.currentUser.isEqual(a))?(Br(If,"User change. New user:",a.toKey()),[4,Wl(r.localStore,a)]):[3,3];case 1:return i=e.sent(),r.currentUser=a,n="'waitForPendingWrites' promise is rejected due to a user change.",(t=r).pendingWritesCallbacks.forEach(function(e){e.forEach(function(e){e.reject(new Lr(Rr.CANCELLED,n))})}),t.pendingWritesCallbacks.clear(),r.sharedClientState.handleUserChange(a,i.removedBatchIds,i.addedBatchIds),[4,Vf(r,i.affectedDocuments)];case 2:e.sent(),e.label=3;case 3:return[2]}var t,n})})}function Kf(u,c,l,h){return m(this,void 0,void 0,function(){var a,s;return g(this,function(e){switch(e.label){case 0:return a=Gr(u,Df),[4,(n=a.localStore,r=c,i=Gr(n,zl),o=Gr(i.mutationQueue,Ju),i.persistence.runTransaction("Lookup mutation documents","readonly",function(t){return o.lookupMutationKeys(t,r).next(function(e){return e?i.localDocuments.getDocuments(t,e):Iu.resolve(null)})}))];case 1:return null===(s=e.sent())?(Br(If,"Cannot apply mutation batch with id: "+c),[2]):"pending"!==l?[3,3]:[4,Mh(a.remoteStore)];case 2:return e.sent(),[3,4];case 3:"acknowledged"===l||"rejected"===l?(Pf(a,c,h||null),Lf(a,c),t=a.localStore,n=c,Gr(Gr(t,zl).mutationQueue,Ju).removeCachedMutationKeys(n)):jr("Unknown batchState: "+l),e.label=4;case 4:return[4,Vf(a,s)];case 5:return e.sent(),[2]}var t,n,r,i,o})})}function jf(l,h){return m(this,void 0,void 0,function(){var r,t,i,o,a,s,u,c;return g(this,function(e){switch(e.label){case 0:return(Wf(r=Gr(l,Df)),Hf(r),!0!==h||!0===r._isPrimaryClient)?[3,3]:(t=r.sharedClientState.getAllActiveQueryTargets(),[4,zf(r,t.toArray(),!0)]);case 1:return i=e.sent(),r._isPrimaryClient=!0,[4,Uh(r.remoteStore,!0)];case 2:for(e.sent(),o=0,a=i;o<a.length;o++)s=a[o],Ch(r.remoteStore,s);return[3,7];case 3:return!1!==h||!1===r._isPrimaryClient?[3,7]:(u=[],c=Promise.resolve(),r.queriesByTarget.forEach(function(e,t){r.sharedClientState.isLocalQueryTarget(t)?u.push(t):c=c.then(function(){return Mf(r,t),Zl(r.localStore,t,!0)}),Dh(r.remoteStore,t)}),[4,c]);case 4:return e.sent(),[4,zf(r,u,!1)];case 5:return e.sent(),(n=Gr(r,Df)).activeLimboResolutionsByTarget.forEach(function(e,t){Dh(n.remoteStore,t)}),n.limboDocumentRefs.removeAllReferences(),n.activeLimboResolutionsByTarget=new Map,n.activeLimboTargetsByKey=new na(vi.comparator),r._isPrimaryClient=!1,[4,Uh(r.remoteStore,!1)];case 6:e.sent(),e.label=7;case 7:return[2]}var n})})}function zf(d,p,y){return m(this,void 0,void 0,function(){var t,n,r,i,o,a,s,u,c,l,h,f;return g(this,function(e){switch(e.label){case 0:t=Gr(d,Df),n=[],r=[],i=0,o=p,e.label=1;case 1:return i<o.length?(a=o[i],s=void 0,(u=t.queriesByTarget.get(a))&&0!==u.length?[4,$l(t.localStore,go(u[0]))]:[3,7]):[3,13];case 2:s=e.sent(),c=0,l=u,e.label=3;case 3:return c<l.length?(l=l[c],Qr(!!(h=t.queryViewsByQuery.get(l)),"No query view found for "+To(l)),[4,function(r,i){return m(this,void 0,void 0,function(){var t,n;return g(this,function(e){switch(e.label){case 0:return[4,eh((t=Gr(r,Df)).localStore,i.query,!0)];case 1:return n=e.sent(),n=i.view.synchronizeWithPersistedState(n),t.isPrimaryClient&&Ff(t,i.targetId,n.limboChanges),[2,n]}})})}(t,h)]):[3,6];case 4:(h=e.sent()).snapshot&&r.push(h.snapshot),e.label=5;case 5:return c++,[3,3];case 6:return[3,11];case 7:return Qr(y,"A secondary tab should never have an active view without an active target."),[4,th(t.localStore,a)];case 8:return Qr(!!(f=e.sent()),"Target for id "+a+" not found"),[4,$l(t.localStore,f)];case 9:return s=e.sent(),[4,kf(t,Qf(f),a,!1)];case 10:e.sent(),e.label=11;case 11:n.push(s),e.label=12;case 12:return i++,[3,1];case 13:return t.syncEngineListener.onWatchChange(r),[2,n]}})})}function Qf(e){return so(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Gf(e){e=Gr(e,Df);return Gr(Gr(e.localStore,zl).persistence,Ll).getActiveClients()}function Wf(e){e=Gr(e,Df);return e.remoteStore.remoteSyncer.applyRemoteEvent=Nf.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=function(e,t){var n=Gr(e,Df);if((e=n.activeLimboResolutionsByTarget.get(t))&&e.receivedDocument)return ga().add(e.key);var r=ga();if(!(t=n.queriesByTarget.get(t)))return r;for(var i=0,o=t;i<o.length;i++){var a=o[i],s=n.queryViewsByQuery.get(a);Qr(!!s,"No query view found for "+To(a)),r=r.unionWith(s.view.syncedDocuments)}return r}.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=function(o,a,s){return m(this,void 0,void 0,function(){var t,n,r,i;return g(this,function(e){switch(e.label){case 0:return((t=Gr(o,Df)).sharedClientState.updateQueryState(a,"rejected",s),i=t.activeLimboResolutionsByTarget.get(a),n=i&&i.key)?(r=(r=new na(vi.comparator)).insert(n,new Yi(n,ea.min())),i=ga().add(n),i=new _a(ea.min(),new Map,new ca(Yr),r,i),[4,Nf(t,i)]):[3,2];case 1:return e.sent(),t.activeLimboTargetsByKey=t.activeLimboTargetsByKey.remove(n),t.activeLimboResolutionsByTarget.delete(a),Bf(t),[3,4];case 2:return[4,Zl(t.localStore,a,!1).then(function(){return Mf(t,a,s)}).catch(ih)];case 3:e.sent(),e.label=4;case 4:return[2]}})})}.bind(null,e),e.syncEngineListener.onWatchChange=function(e,t){for(var n=Gr(e,sf),r=!1,i=0,o=t;i<o.length;i++){var a=o[i],s=a.query,s=n.queries.get(s);if(s){for(var u=0,c=s.listeners;u<c.length;u++){c[u].onViewSnapshot(a)&&(r=!0)}s.viewSnap=a}}r&&lf(n)}.bind(null,e.eventManager),e.syncEngineListener.onWatchError=function(e,t,n){var r=Gr(e,sf);if(e=r.queries.get(t))for(var i=0,o=e.listeners;i<o.length;i++){o[i].onError(n)}r.queries.delete(t)}.bind(null,e.eventManager),e}function Hf(e){e=Gr(e,Df);return e.remoteStore.remoteSyncer.applySuccessfulWrite=function(i,o){return m(this,void 0,void 0,function(){var t,n,r;return g(this,function(e){switch(e.label){case 0:t=Gr(i,Df),n=o.batch.batchId,e.label=1;case 1:return e.trys.push([1,4,,6]),[4,Yl(t.localStore,o)];case 2:return r=e.sent(),Pf(t,n,null),Lf(t,n),t.sharedClientState.updateMutationState(n,"acknowledged"),[4,Vf(t,r)];case 3:return e.sent(),[3,6];case 4:return[4,ih(e.sent())];case 5:return e.sent(),[3,6];case 6:return[2]}})})}.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=Of.bind(null,e),e}var Yf="firestore_clients";function Xf(e,t){return Qr(-1===t.indexOf("_"),"Client key cannot contain '_', but was '"+t+"'"),Yf+"_"+e+"_"+t}var Jf="firestore_mutations";function $f(e,t,n){n=Jf+"_"+e+"_"+n;return t.isAuthenticated()&&(n+="_"+t.uid),n}var Zf="firestore_targets";function ed(e,t){return Zf+"_"+e+"_"+t}var td="firestore_online_state";var nd="firestore_bundle_loaded";var rd="firestore_sequence_number";var id="SharedClientState",od=(ad.fromWebStorageEntry=function(e,t,n){var r=JSON.parse(n),i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error),o=void 0;return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(o=new Lr(r.error.code,r.error.message)),i?new ad(e,t,r.state,o):(Vr(id,"Failed to parse mutation state for ID '"+t+"': "+n),null)},ad.prototype.toWebStorageJSON=function(){var e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)},ad);function ad(e,t,n,r){this.user=e,this.batchId=t,this.state=n,Qr(void 0!==(this.error=r)==("rejected"===n),"MutationMetadata must contain an error iff state is 'rejected'")}var sd=(ud.fromWebStorageEntry=function(e,t){var n=JSON.parse(t),r="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error),i=void 0;return r&&n.error&&(r="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(i=new Lr(n.error.code,n.error.message)),r?new ud(e,n.state,i):(Vr(id,"Failed to parse target state for ID '"+e+"': "+t),null)},ud.prototype.toWebStorageJSON=function(){var e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)},ud);function ud(e,t,n){this.targetId=e,this.state=t,Qr(void 0!==(this.error=n)==("rejected"===t),"QueryTargetMetadata must contain an error iff state is 'rejected'")}var cd=(ld.fromWebStorageEntry=function(e,t){for(var n=JSON.parse(t),r="object"==typeof n&&n.activeTargetIds instanceof Array,i=va,o=0;r&&o<n.activeTargetIds.length;++o)r=ui(n.activeTargetIds[o]),i=i.add(n.activeTargetIds[o]);return r?new ld(e,i):(Vr(id,"Failed to parse client data for instance '"+e+"': "+t),null)},ld);function ld(e,t){this.clientId=e,this.activeTargetIds=t}var hd=(fd.fromWebStorageEntry=function(e){var t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new fd(t.clientId,t.onlineState):(Vr(id,"Failed to parse online state: "+e),null)},fd);function fd(e,t){this.clientId=e,this.onlineState=t}var dd=(pd.prototype.addQueryTarget=function(e){this.activeTargetIds=this.activeTargetIds.add(e)},pd.prototype.removeQueryTarget=function(e){this.activeTargetIds=this.activeTargetIds.delete(e)},pd.prototype.toWebStorageJSON=function(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)},pd);function pd(){this.activeTargetIds=va}var yd=(md.isAvailable=function(e){return!(!e||!e.localStorage)},md.prototype.start=function(){return m(this,void 0,void 0,function(){var t,n,r,i,o,a,s,u,c,l,h=this;return g(this,function(e){switch(e.label){case 0:return Qr(!this.started,"WebStorageSharedClientState already started"),Qr(null!==this.syncEngine,"syncEngine property must be set before calling start()"),Qr(null!==this.onlineStateHandler,"onlineStateHandler property must be set before calling start()"),[4,this.syncEngine.getActiveClients()];case 1:for(a=e.sent(),t=0,n=a;t<n.length;t++)(r=n[t])!==this.localClientId&&(i=this.getItem(Xf(this.persistenceKey,r)))&&(o=cd.fromWebStorageEntry(r,i))&&(this.activeClients=this.activeClients.insert(o.clientId,o));for(this.persistClientState(),(a=this.storage.getItem(this.onlineStateKey))&&(s=this.fromWebStorageOnlineState(a))&&this.handleOnlineStateEvent(s),u=0,c=this.earlyEvents;u<c.length;u++)l=c[u],this.handleWebStorageEvent(l);return this.earlyEvents=[],this.window.addEventListener("unload",function(){return h.shutdown()}),this.started=!0,[2]}})})},md.prototype.writeSequenceNumber=function(e){this.setItem(this.sequenceNumberKey,JSON.stringify(e))},md.prototype.getAllActiveQueryTargets=function(){return this.extractActiveQueryTargets(this.activeClients)},md.prototype.isActiveQueryTarget=function(n){var r=!1;return this.activeClients.forEach(function(e,t){t.activeTargetIds.has(n)&&(r=!0)}),r},md.prototype.addPendingMutation=function(e){this.persistMutationState(e,"pending")},md.prototype.updateMutationState=function(e,t,n){this.persistMutationState(e,t,n),this.removeMutationState(e)},md.prototype.addLocalQueryTarget=function(e){var t,n="not-current";return this.isActiveQueryTarget(e)&&(!(t=this.storage.getItem(ed(this.persistenceKey,e)))||(t=sd.fromWebStorageEntry(e,t))&&(n=t.state)),this.localClientState.addQueryTarget(e),this.persistClientState(),n},md.prototype.removeLocalQueryTarget=function(e){this.localClientState.removeQueryTarget(e),this.persistClientState()},md.prototype.isLocalQueryTarget=function(e){return this.localClientState.activeTargetIds.has(e)},md.prototype.clearQueryState=function(e){this.removeItem(ed(this.persistenceKey,e))},md.prototype.updateQueryState=function(e,t,n){this.persistQueryTargetState(e,t,n)},md.prototype.handleUserChange=function(e,t,n){var r=this;t.forEach(function(e){r.removeMutationState(e)}),this.currentUser=e,n.forEach(function(e){r.addPendingMutation(e)})},md.prototype.setOnlineState=function(e){this.persistOnlineState(e)},md.prototype.notifyBundleLoaded=function(){this.persistBundleLoadedState()},md.prototype.shutdown=function(){this.started&&(this.window.removeEventListener("storage",this.storageListener),this.removeItem(this.localClientStorageKey),this.started=!1)},md.prototype.getItem=function(e){var t=this.storage.getItem(e);return Br(id,"READ",e,t),t},md.prototype.setItem=function(e,t){Br(id,"SET",e,t),this.storage.setItem(e,t)},md.prototype.removeItem=function(e){Br(id,"REMOVE",e),this.storage.removeItem(e)},md.prototype.handleWebStorageEvent=function(e){var t=this,o=e;if(o.storageArea===this.storage){if(Br(id,"EVENT",o.key,o.newValue),o.key===this.localClientStorageKey)return void Vr("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.queue.enqueueRetryable(function(){return m(t,void 0,void 0,function(){var t,n,r,i;return g(this,function(e){if(!this.started)return this.earlyEvents.push(o),[2];if(null===o.key)return[2];if(this.clientStateKeyRe.test(o.key)){if(null==o.newValue)return t=this.fromWebStorageClientStateKey(o.key),[2,this.handleClientStateEvent(t,null)];if(t=this.fromWebStorageClientState(o.key,o.newValue))return[2,this.handleClientStateEvent(t.clientId,t)]}else if(this.mutationBatchKeyRe.test(o.key)){if(null!==o.newValue&&(n=this.fromWebStorageMutationMetadata(o.key,o.newValue)))return[2,this.handleMutationBatchEvent(n)]}else if(this.queryTargetKeyRe.test(o.key)){if(null!==o.newValue&&(r=this.fromWebStorageQueryTargetMetadata(o.key,o.newValue)))return[2,this.handleQueryTargetEvent(r)]}else if(o.key===this.onlineStateKey){if(null!==o.newValue&&(i=this.fromWebStorageOnlineState(o.newValue)))return[2,this.handleOnlineStateEvent(i)]}else if(o.key===this.sequenceNumberKey)Qr(!!this.sequenceNumberHandler,"Missing sequenceNumberHandler"),(i=function(e){var t=xu.INVALID;if(null!=e)try{var n=JSON.parse(e);zr("number"==typeof n,"Found non-numeric sequence number"),t=n}catch(e){Vr(id,"Failed to read sequence number from WebStorage",e)}return t}(o.newValue))!==xu.INVALID&&this.sequenceNumberHandler(i);else if(o.key===this.bundleLoadedKey)return[2,this.syncEngine.synchronizeWithChangedDocuments()];return[2]})})})}},Object.defineProperty(md.prototype,"localClientState",{get:function(){return this.activeClients.get(this.localClientId)},enumerable:!1,configurable:!0}),md.prototype.persistClientState=function(){this.setItem(this.localClientStorageKey,this.localClientState.toWebStorageJSON())},md.prototype.persistMutationState=function(e,t,n){n=new od(this.currentUser,e,t,n),e=$f(this.persistenceKey,this.currentUser,e);this.setItem(e,n.toWebStorageJSON())},md.prototype.removeMutationState=function(e){e=$f(this.persistenceKey,this.currentUser,e);this.removeItem(e)},md.prototype.persistOnlineState=function(e){e={clientId:this.localClientId,onlineState:e};this.storage.setItem(this.onlineStateKey,JSON.stringify(e))},md.prototype.persistQueryTargetState=function(e,t,n){var r=ed(this.persistenceKey,e),n=new sd(e,t,n);this.setItem(r,n.toWebStorageJSON())},md.prototype.persistBundleLoadedState=function(){this.setItem(this.bundleLoadedKey,"value-not-used")},md.prototype.fromWebStorageClientStateKey=function(e){e=this.clientStateKeyRe.exec(e);return e?e[1]:null},md.prototype.fromWebStorageClientState=function(e,t){var n=this.fromWebStorageClientStateKey(e);return Qr(null!==n,"Cannot parse client state key '"+e+"'"),cd.fromWebStorageEntry(n,t)},md.prototype.fromWebStorageMutationMetadata=function(e,t){var n=this.mutationBatchKeyRe.exec(e);Qr(null!==n,"Cannot parse mutation batch key '"+e+"'");e=Number(n[1]),n=void 0!==n[2]?n[2]:null;return od.fromWebStorageEntry(new Nr(n),e,t)},md.prototype.fromWebStorageQueryTargetMetadata=function(e,t){var n=this.queryTargetKeyRe.exec(e);Qr(null!==n,"Cannot parse query target key '"+e+"'");n=Number(n[1]);return sd.fromWebStorageEntry(n,t)},md.prototype.fromWebStorageOnlineState=function(e){return hd.fromWebStorageEntry(e)},md.prototype.handleMutationBatchEvent=function(t){return m(this,void 0,void 0,function(){return g(this,function(e){return t.user.uid!==this.currentUser.uid?(Br(id,"Ignoring mutation for non-active user "+t.user.uid),[2]):[2,this.syncEngine.applyBatchState(t.batchId,t.state,t.error)]})})},md.prototype.handleQueryTargetEvent=function(e){return this.syncEngine.applyTargetState(e.targetId,e.state,e.error)},md.prototype.handleClientStateEvent=function(e,t){var n=this,r=t?this.activeClients.insert(e,t):this.activeClients.remove(e),i=this.extractActiveQueryTargets(this.activeClients),o=this.extractActiveQueryTargets(r),a=[],s=[];return o.forEach(function(e){i.has(e)||a.push(e)}),i.forEach(function(e){o.has(e)||s.push(e)}),this.syncEngine.applyActiveTargetsChange(a,s).then(function(){n.activeClients=r})},md.prototype.handleOnlineStateEvent=function(e){this.activeClients.get(e.clientId)&&this.onlineStateHandler(e.onlineState)},md.prototype.extractActiveQueryTargets=function(e){var n=va;return e.forEach(function(e,t){n=n.unionWith(t.activeTargetIds)}),n},md);function md(e,t,n,r,i){this.window=e,this.queue=t,this.persistenceKey=n,this.localClientId=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.storageListener=this.handleWebStorageEvent.bind(this),this.activeClients=new na(Yr),this.started=!1,this.earlyEvents=[];n=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.localClientStorageKey=Xf(this.persistenceKey,this.localClientId),this.sequenceNumberKey=(i=this.persistenceKey,rd+"_"+i),this.activeClients=this.activeClients.insert(this.localClientId,new dd),this.clientStateKeyRe=new RegExp("^"+Yf+"_"+n+"_([^_]*)$"),this.mutationBatchKeyRe=new RegExp("^"+Jf+"_"+n+"_(\\d+)(?:_(.*))?$"),this.queryTargetKeyRe=new RegExp("^"+Zf+"_"+n+"_(\\d+)$"),this.onlineStateKey=(n=this.persistenceKey,td+"_"+n),this.bundleLoadedKey=(n=this.persistenceKey,nd+"_"+n),this.window.addEventListener("storage",this.storageListener)}var gd=(vd.prototype.addPendingMutation=function(e){},vd.prototype.updateMutationState=function(e,t,n){},vd.prototype.addLocalQueryTarget=function(e){return this.localState.addQueryTarget(e),this.queryState[e]||"not-current"},vd.prototype.updateQueryState=function(e,t,n){this.queryState[e]=t},vd.prototype.removeLocalQueryTarget=function(e){this.localState.removeQueryTarget(e)},vd.prototype.isLocalQueryTarget=function(e){return this.localState.activeTargetIds.has(e)},vd.prototype.clearQueryState=function(e){delete this.queryState[e]},vd.prototype.getAllActiveQueryTargets=function(){return this.localState.activeTargetIds},vd.prototype.isActiveQueryTarget=function(e){return this.localState.activeTargetIds.has(e)},vd.prototype.start=function(){return this.localState=new dd,Promise.resolve()},vd.prototype.handleUserChange=function(e,t,n){},vd.prototype.setOnlineState=function(e){},vd.prototype.shutdown=function(){},vd.prototype.writeSequenceNumber=function(e){},vd.prototype.notifyBundleLoaded=function(){},vd);function vd(){this.localState=new dd,this.queryState={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}var bd=(wd.prototype.setLocalDocumentsView=function(e){this.localDocumentsView=e},wd.prototype.getDocumentsMatchingQuery=function(t,r,i,o){var e,a=this;return Qr(void 0!==this.localDocumentsView,"setLocalDocumentsView() not called"),0===(e=r).filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())||i.isEqual(ea.min())?this.executeFullCollectionScan(t,r):this.localDocumentsView.getDocuments(t,o).next(function(e){var n=a.applyQuery(r,e);return(co(r)||lo(r))&&a.needsRefill(r.limitType,n,o,i)?a.executeFullCollectionScan(t,r):(Fr()<=f.DEBUG&&Br("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),To(r)),a.localDocumentsView.getDocumentsMatchingQuery(t,r,i).next(function(t){return n.forEach(function(e){t=t.insert(e.key,e)}),t}))})},wd.prototype.applyQuery=function(n,e){var r=new ca(Io(n));return e.forEach(function(e,t){t instanceof Gi&&So(n,t)&&(r=r.add(t))}),r},wd.prototype.needsRefill=function(e,t,n,r){if(n.size!==t.size)return!0;t="F"===e?t.last():t.first();return!!t&&(t.hasPendingWrites||0<t.version.compareTo(r))},wd.prototype.executeFullCollectionScan=function(e,t){return Fr()<=f.DEBUG&&Br("QueryEngine","Using full collection scan to execute query:",To(t)),this.localDocumentsView.getDocumentsMatchingQuery(e,t,ea.min())},wd);function wd(){}var Td=(Sd.prototype.checkEmpty=function(e){return Iu.resolve(0===this.mutationQueue.length)},Sd.prototype.addMutationBatch=function(e,t,n,r){Qr(0!==r.length,"Mutation batches should not be empty");var i=this.nextBatchId;this.nextBatchId++,0<this.mutationQueue.length&&Qr(this.mutationQueue[this.mutationQueue.length-1].batchId<i,"Mutation batchIDs must be monotonically increasing order");n=new gu(i,t,n,r);this.mutationQueue.push(n);for(var o=0,a=r;o<a.length;o++){var s=a[o];this.batchesByDocumentKey=this.batchesByDocumentKey.add(new gf(s.key,i)),this.indexManager.addToCollectionParentIndex(e,s.key.path.popLast())}return Iu.resolve(n)},Sd.prototype.lookupMutationBatch=function(e,t){return Iu.resolve(this.findMutationBatch(t))},Sd.prototype.getNextMutationBatchAfterBatchId=function(e,t){t+=1,t=this.indexOfBatchId(t),t=t<0?0:t;return Iu.resolve(this.mutationQueue.length>t?this.mutationQueue[t]:null)},Sd.prototype.getHighestUnacknowledgedBatchId=function(){return Iu.resolve(0===this.mutationQueue.length?mu:this.nextBatchId-1)},Sd.prototype.getAllMutationBatches=function(e){return Iu.resolve(this.mutationQueue.slice())},Sd.prototype.getAllMutationBatchesAffectingDocumentKey=function(e,t){var n=this,r=new gf(t,0),i=new gf(t,Number.POSITIVE_INFINITY),o=[];return this.batchesByDocumentKey.forEachInRange([r,i],function(e){Qr(t.isEqual(e.key),"Should only iterate over a single key's batches");e=n.findMutationBatch(e.targetOrBatchId);Qr(null!==e,"Batches in the index must exist in the main table"),o.push(e)}),Iu.resolve(o)},Sd.prototype.getAllMutationBatchesAffectingDocumentKeys=function(e,t){var r=this,i=new ca(Yr);return t.forEach(function(t){var e=new gf(t,0),n=new gf(t,Number.POSITIVE_INFINITY);r.batchesByDocumentKey.forEachInRange([e,n],function(e){Qr(t.isEqual(e.key),"For each key, should only iterate over a single key's batches"),i=i.add(e.targetOrBatchId)})}),Iu.resolve(this.findMutationBatches(i))},Sd.prototype.getAllMutationBatchesAffectingQuery=function(e,t){Qr(!yo(t),"CollectionGroup queries should be handled in LocalDocumentsView");var n=t.path,r=n.length+1,t=n;vi.isDocumentKey(t)||(t=t.child(""));var t=new gf(new vi(t),0),i=new ca(Yr);return this.batchesByDocumentKey.forEachWhile(function(e){var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(i=i.add(e.targetOrBatchId)),!0)},t),Iu.resolve(this.findMutationBatches(i))},Sd.prototype.findMutationBatches=function(e){var t=this,n=[];return e.forEach(function(e){e=t.findMutationBatch(e);null!==e&&n.push(e)}),n},Sd.prototype.removeMutationBatch=function(n,r){var i=this;zr(0===this.indexOfExistingBatchId(r.batchId,"removed"),"Can only remove the first entry of the mutation queue"),this.mutationQueue.shift();var o=this.batchesByDocumentKey;return Iu.forEach(r.mutations,function(e){var t=new gf(e.key,r.batchId);return o=o.delete(t),i.referenceDelegate.markPotentiallyOrphaned(n,e.key)}).next(function(){i.batchesByDocumentKey=o})},Sd.prototype.removeCachedMutationKeys=function(e){},Sd.prototype.containsKey=function(e,t){var n=new gf(t,0),n=this.batchesByDocumentKey.firstAfterOrEqual(n);return Iu.resolve(t.isEqual(n&&n.key))},Sd.prototype.performConsistencyCheck=function(e){return 0===this.mutationQueue.length&&Qr(this.batchesByDocumentKey.isEmpty(),"Document leak -- detected dangling mutation references when queue is empty."),Iu.resolve()},Sd.prototype.indexOfExistingBatchId=function(e,t){e=this.indexOfBatchId(e);return Qr(0<=e&&e<this.mutationQueue.length,"Batches must exist to be "+t),e},Sd.prototype.indexOfBatchId=function(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId},Sd.prototype.findMutationBatch=function(e){var t=this.indexOfBatchId(e);if(t<0||t>=this.mutationQueue.length)return null;t=this.mutationQueue[t];return Qr(t.batchId===e,"If found batch must match"),t},Sd);function Sd(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.nextBatchId=1,this.batchesByDocumentKey=new ca(gf.compareByKey)}var Id=(Ed.prototype.addEntry=function(e,t,n){Qr(!n.isEqual(ea.min()),"Cannot add a document with a read time of zero");var r=t.key,i=this.docs.get(r),o=i?i.size:0,i=this.sizer(t);return this.docs=this.docs.insert(r,{maybeDocument:t,size:i,readTime:n}),this.size+=i-o,this.indexManager.addToCollectionParentIndex(e,r.path.popLast())},Ed.prototype.removeEntry=function(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)},Ed.prototype.getEntry=function(e,t){t=this.docs.get(t);return Iu.resolve(t?t.maybeDocument:null)},Ed.prototype.getEntries=function(e,t){var n=this,r=da;return t.forEach(function(e){var t=n.docs.get(e);r=r.insert(e,t?t.maybeDocument:null)}),Iu.resolve(r)},Ed.prototype.getDocumentsMatchingQuery=function(e,t,n){Qr(!yo(t),"CollectionGroup queries should be handled in LocalDocumentsView");for(var r=pa,i=new vi(t.path.child("")),o=this.docs.getIteratorFrom(i);o.hasNext();){var a=o.getNext(),s=a.key,u=a.value,a=u.maybeDocument,u=u.readTime;if(!t.path.isPrefixOf(s.path))break;u.compareTo(n)<=0||a instanceof Gi&&So(t,a)&&(r=r.insert(a.key,a))}return Iu.resolve(r)},Ed.prototype.forEachDocumentKey=function(e,t){return Iu.forEach(this.docs,function(e){return t(e)})},Ed.prototype.newChangeBuffer=function(e){return new Dd(this)},Ed.prototype.getSize=function(e){return Iu.resolve(this.size)},Ed);function Ed(e,t){this.indexManager=e,this.sizer=t,this.docs=new na(vi.comparator),this.size=0}var Cd,Dd=(n(_d,Cd=It),_d.prototype.applyChanges=function(n){var r=this,i=[];return this.changes.forEach(function(e,t){t&&t.maybeDocument?i.push(r.documentCache.addEntry(n,t.maybeDocument,r.getReadTime(e))):r.documentCache.removeEntry(e)}),Iu.waitFor(i)},_d.prototype.getFromCache=function(e,t){return this.documentCache.getEntry(e,t)},_d.prototype.getAllFromCache=function(e,t){return this.documentCache.getEntries(e,t)},_d);function _d(e){var t=Cd.call(this)||this;return t.documentCache=e,t}var kd=(Ad.prototype.forEachTarget=function(e,n){return this.targets.forEach(function(e,t){return n(t)}),Iu.resolve()},Ad.prototype.getLastRemoteSnapshotVersion=function(e){return Iu.resolve(this.lastRemoteSnapshotVersion)},Ad.prototype.getHighestSequenceNumber=function(e){return Iu.resolve(this.highestSequenceNumber)},Ad.prototype.allocateTargetId=function(e){return this.highestTargetId=this.targetIdGenerator.next(),Iu.resolve(this.highestTargetId)},Ad.prototype.setTargetsMetadata=function(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.highestSequenceNumber&&(this.highestSequenceNumber=t),Iu.resolve()},Ad.prototype.saveTargetData=function(e){this.targets.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.targetIdGenerator=new ll(t),this.highestTargetId=t),e.sequenceNumber>this.highestSequenceNumber&&(this.highestSequenceNumber=e.sequenceNumber)},Ad.prototype.addTargetData=function(e,t){return Qr(!this.targets.has(t.target),"Adding a target that already exists"),this.saveTargetData(t),this.targetCount+=1,Iu.resolve()},Ad.prototype.updateTargetData=function(e,t){return Qr(this.targets.has(t.target),"Updating a non-existent target"),this.saveTargetData(t),Iu.resolve()},Ad.prototype.removeTargetData=function(e,t){return Qr(0<this.targetCount,"Removing a target from an empty cache"),Qr(this.targets.has(t.target),"Removing a non-existent target from the cache"),this.targets.delete(t.target),this.references.removeReferencesForId(t.targetId),--this.targetCount,Iu.resolve()},Ad.prototype.removeTargets=function(n,r,i){var o=this,a=0,s=[];return this.targets.forEach(function(e,t){t.sequenceNumber<=r&&null===i.get(t.targetId)&&(o.targets.delete(e),s.push(o.removeMatchingKeysForTargetId(n,t.targetId)),a++)}),Iu.waitFor(s).next(function(){return a})},Ad.prototype.getTargetCount=function(e){return Iu.resolve(this.targetCount)},Ad.prototype.getTargetData=function(e,t){t=this.targets.get(t)||null;return Iu.resolve(t)},Ad.prototype.addMatchingKeys=function(e,t,n){return this.references.addReferences(t,n),Iu.resolve()},Ad.prototype.removeMatchingKeys=function(t,e,n){this.references.removeReferences(e,n);var r=this.persistence.referenceDelegate,i=[];return r&&e.forEach(function(e){i.push(r.markPotentiallyOrphaned(t,e))}),Iu.waitFor(i)},Ad.prototype.removeMatchingKeysForTargetId=function(e,t){return this.references.removeReferencesForId(t),Iu.resolve()},Ad.prototype.getMatchingKeysForTargetId=function(e,t){t=this.references.referencesForId(t);return Iu.resolve(t)},Ad.prototype.containsKey=function(e,t){return Iu.resolve(this.references.containsKey(t))},Ad);function Ad(e){this.persistence=e,this.targets=new Tu(no,io),this.lastRemoteSnapshotVersion=ea.min(),this.highestTargetId=0,this.highestSequenceNumber=0,this.references=new yf,this.targetCount=0,this.targetIdGenerator=ll.forTargetCache()}var Nd=(xd.prototype.getBundleMetadata=function(e,t){return Iu.resolve(this.bundles.get(t))},xd.prototype.saveBundleMetadata=function(e,t){return this.bundles.set(t.id,{id:(t=t).id,version:t.version,createTime:Ya(t.createTime)}),Iu.resolve()},xd.prototype.getNamedQuery=function(e,t){return Iu.resolve(this.namedQueries.get(t))},xd.prototype.saveNamedQuery=function(e,t){return this.namedQueries.set(t.name,{name:(t=t).name,query:Xu(t.bundledQuery),readTime:Ya(t.readTime)}),Iu.resolve()},xd);function xd(e){this.serializer=e,this.bundles=new Map,this.namedQueries=new Map}var Od=(Rd.prototype.start=function(){return Promise.resolve()},Rd.prototype.shutdown=function(){return this._started=!1,Promise.resolve()},Object.defineProperty(Rd.prototype,"started",{get:function(){return this._started},enumerable:!1,configurable:!0}),Rd.prototype.setDatabaseDeletedListener=function(){},Rd.prototype.setNetworkEnabled=function(){},Rd.prototype.getIndexManager=function(){return this.indexManager},Rd.prototype.getMutationQueue=function(e){var t=this.mutationQueues[e.toKey()];return t||(t=new Td(this.indexManager,this.referenceDelegate),this.mutationQueues[e.toKey()]=t),t},Rd.prototype.getTargetCache=function(){return this.targetCache},Rd.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache},Rd.prototype.getBundleCache=function(){return this.bundleCache},Rd.prototype.runTransaction=function(e,t,n){var r=this;Br("MemoryPersistence","Starting transaction:",e);var i=new Pd(this.listenSequence.next());return this.referenceDelegate.onTransactionStarted(),n(i).next(function(e){return r.referenceDelegate.onTransactionCommitted(i).next(function(){return e})}).toPromise().then(function(e){return i.raiseOnCommittedEvent(),e})},Rd.prototype.mutationQueuesContainKey=function(t,n){return Iu.or(Object.values(this.mutationQueues).map(function(e){return function(){return e.containsKey(t,n)}}))},Rd);function Rd(e,t){var n=this;this.mutationQueues={},this.listenSequence=new xu(0),this._started=!1,this._started=!0,this.referenceDelegate=e(this),this.targetCache=new kd(this);this.indexManager=new pc,this.remoteDocumentCache=(e=this.indexManager,new Id(e,function(e){return n.referenceDelegate.documentSize(e)})),this.serializer=new Vu(t),this.bundleCache=new Nd(this.serializer)}var Ld,Pd=(n(Md,Ld=St),Md);function Md(e){var t=Ld.call(this)||this;return t.currentSequenceNumber=e,t}var qd=(Fd.factory=function(e){return new Fd(e)},Object.defineProperty(Fd.prototype,"orphanedDocuments",{get:function(){if(this._orphanedDocuments)return this._orphanedDocuments;throw jr("orphanedDocuments is only valid during a transaction.")},enumerable:!1,configurable:!0}),Fd.prototype.addReference=function(e,t,n){return this.localViewReferences.addReference(n,t),this.orphanedDocuments.delete(n.toString()),Iu.resolve()},Fd.prototype.removeReference=function(e,t,n){return this.localViewReferences.removeReference(n,t),this.orphanedDocuments.add(n.toString()),Iu.resolve()},Fd.prototype.markPotentiallyOrphaned=function(e,t){return this.orphanedDocuments.add(t.toString()),Iu.resolve()},Fd.prototype.removeTarget=function(e,t){var n=this;this.localViewReferences.removeReferencesForId(t.targetId).forEach(function(e){return n.orphanedDocuments.add(e.toString())});var r=this.persistence.getTargetCache();return r.getMatchingKeysForTargetId(e,t.targetId).next(function(e){e.forEach(function(e){return n.orphanedDocuments.add(e.toString())})}).next(function(){return r.removeTargetData(e,t)})},Fd.prototype.onTransactionStarted=function(){this._orphanedDocuments=new Set},Fd.prototype.onTransactionCommitted=function(n){var r=this,i=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Iu.forEach(this.orphanedDocuments,function(e){var t=vi.fromPath(e);return r.isReferenced(n,t).next(function(e){e||i.removeEntry(t)})}).next(function(){return r._orphanedDocuments=null,i.apply(n)})},Fd.prototype.updateLimboDocument=function(e,t){var n=this;return this.isReferenced(e,t).next(function(e){e?n.orphanedDocuments.delete(t.toString()):n.orphanedDocuments.add(t.toString())})},Fd.prototype.documentSize=function(e){return 0},Fd.prototype.isReferenced=function(e,t){var n=this;return Iu.or([function(){return Iu.resolve(n.localViewReferences.containsKey(t))},function(){return n.persistence.getTargetCache().containsKey(e,t)},function(){return n.persistence.mutationQueuesContainKey(e,t)}])},Fd);function Fd(e){this.persistence=e,this.localViewReferences=new yf,this._orphanedDocuments=null}var Bd=(Vd.prototype.onOpen=function(e){Qr(!this.wrappedOnOpen,"Called onOpen on stream twice!"),this.wrappedOnOpen=e},Vd.prototype.onClose=function(e){Qr(!this.wrappedOnClose,"Called onClose on stream twice!"),this.wrappedOnClose=e},Vd.prototype.onMessage=function(e){Qr(!this.wrappedOnMessage,"Called onMessage on stream twice!"),this.wrappedOnMessage=e},Vd.prototype.close=function(){this.closeFn()},Vd.prototype.send=function(e){this.sendFn(e)},Vd.prototype.callOnOpen=function(){Qr(void 0!==this.wrappedOnOpen,"Cannot call onOpen because no callback was set"),this.wrappedOnOpen()},Vd.prototype.callOnClose=function(e){Qr(void 0!==this.wrappedOnClose,"Cannot call onClose because no callback was set"),this.wrappedOnClose(e)},Vd.prototype.callOnMessage=function(e){Qr(void 0!==this.wrappedOnMessage,"Cannot call onMessage because no callback was set"),this.wrappedOnMessage(e)},Vd);function Vd(e){this.sendFn=e.sendFn,this.closeFn=e.closeFn}var Ud="RestConnection",Kd={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"},jd="gl-js/ fire/"+Mr,It=(zd.prototype.invokeRPC=function(t,e,n,r){var i=this.makeUrl(t,e);Br(Ud,"Sending: ",i,n);e={};return this.modifyHeadersForRequest(e,r),this.performRPCRequest(t,i,e,n).then(function(e){return Br(Ud,"Received: ",e),e},function(e){throw Ur(Ud,t+" failed with error: ",e,"url: ",i,"request:",n),e})},zd.prototype.invokeStreamingRPC=function(e,t,n,r){return this.invokeRPC(e,t,n,r)},zd.prototype.modifyHeadersForRequest=function(e,t){if(e["X-Goog-Api-Client"]=jd,e["Content-Type"]="text/plain",t)for(var n in t.authHeaders)t.authHeaders.hasOwnProperty(n)&&(e[n]=t.authHeaders[n])},zd.prototype.makeUrl=function(e,t){var n=Kd[e];return Qr(void 0!==n,"Unknown REST mapping for: "+e),this.baseUrl+"/v1/"+t+":"+n},zd);function zd(e){this.databaseInfo=e,this.databaseId=e.databaseId;var t=e.ssl?"https":"http";this.baseUrl=t+"://"+e.host,this.databaseRoot="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}var Qd,Gd="Connection",Wd=(n(Hd,Qd=It),Hd.prototype.performRPCRequest=function(o,t,a,s){return new Promise(function(n,r){var i=new Ir;i.listenOnce(vr.COMPLETE,function(){try{switch(i.getLastErrorCode()){case gr.NO_ERROR:var e=i.getResponseJson();Br(Gd,"XHR received:",JSON.stringify(e)),n(e);break;case gr.TIMEOUT:Br(Gd,'RPC "'+o+'" timed out'),r(new Lr(Rr.DEADLINE_EXCEEDED,"Request time out"));break;case gr.HTTP_ERROR:var t=i.getStatus();Br(Gd,'RPC "'+o+'" failed with status:',t,"response text:",i.getResponseText()),0<t?(e=i.getResponseJson().error)&&e.status&&e.message?(t=(t=e.status).toLowerCase().replace(/_/g,"-"),t=0<=Object.values(Rr).indexOf(t)?t:Rr.UNKNOWN,r(new Lr(t,e.message))):r(new Lr(Rr.UNKNOWN,"Server responded with status "+i.getStatus())):r(new Lr(Rr.UNAVAILABLE,"Connection failed."));break;default:jr('RPC "'+o+'" failed with unanticipated webchannel error '+i.getLastErrorCode()+": "+i.getLastError()+", giving up.")}}finally{Br(Gd,'RPC "'+o+'" completed.')}});var e=JSON.stringify(s);i.send(t,"POST",e,a,15)})},Hd.prototype.openStream=function(e,t){var n,r=[this.baseUrl,"/","google.firestore.v1.Firestore","/",e,"/channel"],i=new hr,o=mr(),e={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.modifyHeadersForRequest(e.initMessageHeaders,t),"undefined"!=typeof window&&(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(d())||"object"==typeof navigator&&"ReactNative"===navigator.product||0<=d().indexOf("Electron/")||(0<=(n=d()).indexOf("MSIE ")||0<=n.indexOf("Trident/"))||0<=d().indexOf("MSAppHost/")||"object"==typeof(n="object"==typeof chrome?chrome.runtime:"object"==typeof browser?browser.runtime:void 0)&&void 0!==n.id||(e.httpHeadersOverwriteParam="$httpHeaders");r=r.join("");Br(Gd,"Creating WebChannel: "+r,e);var a=i.createWebChannel(r,e),s=!1,u=!1,c=new Bd({sendFn:function(e){u?Br(Gd,"Not sending because WebChannel is closed:",e):(s||(Br(Gd,"Opening WebChannel transport."),a.open(),s=!0),Br(Gd,"WebChannel sending:",e),a.send(e))},closeFn:function(){return a.close()}}),e=function(e,t,n){e.listen(t,function(e){try{n(e)}catch(e){setTimeout(function(){throw e},0)}})};return e(a,Sr.EventType.OPEN,function(){u||Br(Gd,"WebChannel transport opened.")}),e(a,Sr.EventType.CLOSE,function(){u||(u=!0,Br(Gd,"WebChannel transport closed"),c.callOnClose())}),e(a,Sr.EventType.ERROR,function(e){u||(u=!0,Ur(Gd,"WebChannel transport errored:",e),c.callOnClose(new Lr(Rr.UNAVAILABLE,"The operation could not be completed")))}),e(a,Sr.EventType.MESSAGE,function(e){var t,n,r,i;u||(zr(!!(t=e.data[0]),"Got a webchannel message without data."),(n=t.error||(null===(i=t[0])||void 0===i?void 0:i.error))?(Br(Gd,"WebChannel received error:",n),e=function(e){if(void 0!==(e=Ia[e]))return Da(e)}(r=n.status),i=n.message,void 0===e&&(e=Rr.INTERNAL,i="Unknown error status: "+r+" with message "+n.message),u=!0,c.callOnClose(new Lr(e,i)),a.close()):(Br(Gd,"WebChannel received:",t),c.callOnMessage(t)))}),e(o,br.STAT_EVENT,function(e){e.stat===wr?Br(Gd,"Detected buffering proxy"):e.stat===Tr&&Br(Gd,"Detected no buffering proxy")}),setTimeout(function(){c.callOnOpen()},0),c},Hd);function Hd(e){var t=Qd.call(this,e)||this;return t.forceLongPolling=e.forceLongPolling,t.autoDetectLongPolling=e.autoDetectLongPolling,t}var Yd="ConnectivityMonitor",Xd=(Jd.prototype.addCallback=function(e){this.callbacks.push(e)},Jd.prototype.shutdown=function(){window.removeEventListener("online",this.networkAvailableListener),window.removeEventListener("offline",this.networkUnavailableListener)},Jd.prototype.configureNetworkMonitoring=function(){window.addEventListener("online",this.networkAvailableListener),window.addEventListener("offline",this.networkUnavailableListener)},Jd.prototype.onNetworkAvailable=function(){Br(Yd,"Network connectivity changed: AVAILABLE");for(var e=0,t=this.callbacks;e<t.length;e++){(0,t[e])(0)}},Jd.prototype.onNetworkUnavailable=function(){Br(Yd,"Network connectivity changed: UNAVAILABLE");for(var e=0,t=this.callbacks;e<t.length;e++){(0,t[e])(1)}},Jd.isAvailable=function(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener},Jd);function Jd(){var e=this;this.networkAvailableListener=function(){return e.onNetworkAvailable()},this.networkUnavailableListener=function(){return e.onNetworkUnavailable()},this.callbacks=[],this.configureNetworkMonitoring()}var $d=(Zd.prototype.addCallback=function(e){},Zd.prototype.shutdown=function(){},Zd);function Zd(){}function ep(e){return new ja(e,!0)}var tp=(np.prototype.initialize=function(t){return m(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return this.serializer=ep(t.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(t),this.persistence=this.createPersistence(t),[4,this.persistence.start()];case 1:return e.sent(),this.gcScheduler=this.createGarbageCollectionScheduler(t),this.localStore=this.createLocalStore(t),[2]}})})},np.prototype.createGarbageCollectionScheduler=function(e){return null},np.prototype.createLocalStore=function(e){return Gl(this.persistence,new bd,e.initialUser,this.serializer)},np.prototype.createPersistence=function(e){return new Od(qd.factory,this.serializer)},np.prototype.createSharedClientState=function(e){return new gd},np.prototype.terminate=function(){return m(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return this.gcScheduler&&this.gcScheduler.stop(),[4,this.sharedClientState.shutdown()];case 1:return e.sent(),[4,this.persistence.shutdown()];case 2:return e.sent(),[2]}})})},np);function np(){this.synchronizeTabs=!1}var rp,ip=(n(op,rp=tp),op.prototype.initialize=function(t){return m(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return[4,rp.prototype.initialize.call(this,t)];case 1:return e.sent(),[4,rh(this.localStore)];case 2:return e.sent(),[4,this.onlineComponentProvider.initialize(this,t)];case 3:return e.sent(),[4,Hf(this.onlineComponentProvider.syncEngine)];case 4:return e.sent(),[4,Mh(this.onlineComponentProvider.remoteStore)];case 5:return e.sent(),[2]}})})},op.prototype.createLocalStore=function(e){return Gl(this.persistence,new bd,e.initialUser,this.serializer)},op.prototype.createGarbageCollectionScheduler=function(e){var t=this.persistence.referenceDelegate.garbageCollector;return new Il(t,e.asyncQueue)},op.prototype.createPersistence=function(e){var t=Ul(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Tl.withCacheSize(this.cacheSizeBytes):Tl.DEFAULT;return new Ll(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,zh(),Qh(),this.serializer,this.sharedClientState,!!this.forceOwnership)},op.prototype.createSharedClientState=function(e){return new gd},op);function op(e,t,n){var r=rp.call(this)||this;return r.onlineComponentProvider=e,r.cacheSizeBytes=t,r.forceOwnership=n,r.synchronizeTabs=!1,r}var ap,sp=(n(up,ap=ip),up.prototype.initialize=function(r){return m(this,void 0,void 0,function(){var t,n=this;return g(this,function(e){switch(e.label){case 0:return[4,ap.prototype.initialize.call(this,r)];case 1:return(e.sent(),t=this.onlineComponentProvider.syncEngine,this.sharedClientState instanceof yd)?(this.sharedClientState.syncEngine={applyBatchState:Kf.bind(null,t),applyTargetState:function(i,o,a,s){return m(this,void 0,void 0,function(){var t,n,r;return g(this,function(e){switch(e.label){case 0:if((t=Gr(i,Df))._isPrimaryClient)return Br(If,"Ignoring unexpected query state notification."),[2];if(!t.queriesByTarget.has(o))return[3,7];switch(a){case"current":case"not-current":return[3,1];case"rejected":return[3,4]}return[3,6];case 1:return[4,nh(t.localStore)];case 2:return n=e.sent(),r=_a.createSynthesizedRemoteEventForCurrentChange(o,"current"===a),[4,Vf(t,n,r)];case 3:return e.sent(),[3,7];case 4:return[4,Zl(t.localStore,o,!0)];case 5:return e.sent(),Mf(t,o,s),[3,7];case 6:jr("Unexpected target state: "+a),e.label=7;case 7:return[2]}})})}.bind(null,t),applyActiveTargetsChange:function(l,h,f){return m(this,void 0,void 0,function(){var n,t,r,i,o,a,s,u,c;return g(this,function(e){switch(e.label){case 0:if(!(n=Wf(l))._isPrimaryClient)return[2];t=0,r=h,e.label=1;case 1:return t<r.length?(c=r[t],n.queriesByTarget.has(c)?(Br(If,"Adding an already active target "+c),[3,5]):[4,th(n.localStore,c)]):[3,6];case 2:return Qr(!!(i=e.sent()),"Query data for active target "+c+" not found"),[4,$l(n.localStore,i)];case 3:return o=e.sent(),[4,kf(n,Qf(i),o.targetId,!1)];case 4:e.sent(),Ch(n.remoteStore,o),e.label=5;case 5:return t++,[3,1];case 6:a=function(t){return g(this,function(e){switch(e.label){case 0:return n.queriesByTarget.has(t)?[4,Zl(n.localStore,t,!1).then(function(){Dh(n.remoteStore,t),Mf(n,t)}).catch(ih)]:[2,"continue"];case 1:return e.sent(),[2]}})},s=0,u=f,e.label=7;case 7:return s<u.length?(c=u[s],[5,a(c)]):[3,10];case 8:e.sent(),e.label=9;case 9:return s++,[3,7];case 10:return[2]}})})}.bind(null,t),getActiveClients:Gf.bind(null,t),synchronizeWithChangedDocuments:function(n){return m(this,void 0,void 0,function(){var t;return g(this,function(e){return[2,nh((t=Gr(n,Df)).localStore).then(function(e){return Vf(t,e)})]})})}.bind(null,t)},[4,this.sharedClientState.start()]):[3,3];case 2:e.sent(),e.label=3;case 3:return[4,this.persistence.setPrimaryStateListener(function(t){return m(n,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return[4,jf(this.onlineComponentProvider.syncEngine,t)];case 1:return e.sent(),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):t||this.gcScheduler.stop()),[2]}})})})];case 4:return e.sent(),[2]}})})},up.prototype.createSharedClientState=function(e){var t=zh();if(!yd.isAvailable(t))throw new Lr(Rr.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=Ul(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new yd(t,e.asyncQueue,n,e.clientId,e.initialUser)},up);function up(e,t){var n=ap.call(this,e,t,!1)||this;return n.onlineComponentProvider=e,n.cacheSizeBytes=t,n.synchronizeTabs=!0,n}var cp=(lp.prototype.initialize=function(n,r){return m(this,void 0,void 0,function(){var t=this;return g(this,function(e){switch(e.label){case 0:return this.localStore?[2]:(this.localStore=n.localStore,this.sharedClientState=n.sharedClientState,this.datastore=this.createDatastore(r),this.remoteStore=this.createRemoteStore(r),this.eventManager=this.createEventManager(r),this.syncEngine=this.createSyncEngine(r,!n.synchronizeTabs),this.sharedClientState.onlineStateHandler=function(e){return xf(t.syncEngine,e,1)},this.remoteStore.remoteSyncer.handleCredentialChange=Uf.bind(null,this.syncEngine),[4,Uh(this.remoteStore,this.syncEngine.isPrimaryClient)]);case 1:return e.sent(),[2]}})})},lp.prototype.createEventManager=function(e){return new sf},lp.prototype.createDatastore=function(e){var t,n=ep(e.databaseInfo.databaseId),t=(t=e.databaseInfo,new Wd(t));return e=e.credentials,new mh(e,t,n)},lp.prototype.createRemoteStore=function(e){var t,n,r,i,o=this;return t=this.localStore,n=this.datastore,r=e.asyncQueue,i=function(e){return xf(o.syncEngine,e,0)},e=new(Xd.isAvailable()?Xd:$d),new Sh(t,n,r,i,e)},lp.prototype.createSyncEngine=function(e,t){return n=this.localStore,r=this.remoteStore,i=this.eventManager,o=this.sharedClientState,a=e.initialUser,e=e.maxConcurrentLimboResolutions,t=t,e=new Df(n,r,i,o,a,e),t&&(e._isPrimaryClient=!0),e;var n,r,i,o,a},lp.prototype.terminate=function(){return function(n){return m(this,void 0,void 0,function(){var t;return g(this,function(e){switch(e.label){case 0:return t=Gr(n,Sh),Br(wh,"RemoteStore shutting down."),t.offlineCauses.add(5),[4,Eh(t)];case 1:return e.sent(),t.connectivityMonitor.shutdown(),t.onlineStateTracker.set("Unknown"),[2]}})})}(this.remoteStore)},lp);function lp(){}var hp=(fp.prototype.next=function(e){this.observer.next&&this.scheduleEvent(this.observer.next,e)},fp.prototype.error=function(e){this.observer.error?this.scheduleEvent(this.observer.error,e):console.error("Uncaught Error in snapshot listener:",e)},fp.prototype.mute=function(){this.muted=!0},fp.prototype.scheduleEvent=function(e,t){var n=this;this.muted||setTimeout(function(){n.muted||e(t)},0)},fp);function fp(e){this.observer=e,this.muted=!1}var dp=(pp.prototype.lookup=function(r){return m(this,void 0,void 0,function(){var t,n=this;return g(this,function(e){switch(e.label){case 0:if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new Lr(Rr.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");return[4,function(a,s){return m(this,void 0,void 0,function(){var t,n,r,i,o;return g(this,function(e){switch(e.label){case 0:return t=Gr(a,mh),n=ns(t.serializer)+"/documents",r={documents:s.map(function(e){return $a(t.serializer,e)})},[4,t.invokeStreamingRPC("BatchGetDocuments",n,r)];case 1:return r=e.sent(),i=new Map,r.forEach(function(e){e=os(t.serializer,e);i.set(e.key.toString(),e)}),o=[],s.forEach(function(e){var t=i.get(e.toString());zr(!!t,"Missing entity in write response for "+e),o.push(t)}),[2,o]}})})}(this.datastore,r)];case 1:return(t=e.sent()).forEach(function(e){e instanceof Yi||e instanceof Gi?n.recordVersion(e):jr("Document in a transaction was a "+e.constructor.name)}),[2,t]}})})},pp.prototype.set=function(e,t){this.write(t.toMutations(e,this.precondition(e))),this.writtenDocs.add(e.toString())},pp.prototype.update=function(e,t){try{this.write(t.toMutations(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())},pp.prototype.delete=function(e){this.write([new hu(e,this.precondition(e))]),this.writtenDocs.add(e.toString())},pp.prototype.commit=function(){return m(this,void 0,void 0,function(){var t,n=this;return g(this,function(e){switch(e.label){case 0:if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;return t=this.readVersions,this.mutations.forEach(function(e){t.delete(e.key.toString())}),t.forEach(function(e,t){t=vi.fromPath(t);n.mutations.push(new pu(t,n.precondition(t)))}),[4,function(i,o){return m(this,void 0,void 0,function(){var t,n,r;return g(this,function(e){switch(e.label){case 0:return t=Gr(i,mh),n=ns(t.serializer)+"/documents",r={writes:o.map(function(e){return ss(t.serializer,e)})},[4,t.invokeRPC("Commit",n,r)];case 1:return e.sent(),[2]}})})}(this.datastore,this.mutations)];case 1:return e.sent(),this.committed=!0,[2]}})})},pp.prototype.recordVersion=function(e){var t;if(e instanceof Gi)t=e.version;else{if(!(e instanceof Yi))throw jr("Document in a transaction was a "+e.constructor.name);t=ea.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new Lr(Rr.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)},pp.prototype.precondition=function(e){var t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?js.updateTime(t):js.none()},pp.prototype.preconditionForUpdate=function(e){var t=this.readVersions.get(e.toString());if(this.writtenDocs.has(e.toString())||!t)return js.exists(!0);if(t.isEqual(ea.min()))throw new Lr(Rr.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return js.updateTime(t)},pp.prototype.write=function(e){this.ensureCommitNotCalled(),this.mutations=this.mutations.concat(e)},pp.prototype.ensureCommitNotCalled=function(){Qr(!this.committed,"A transaction object cannot be used after its update callback has been invoked.")},pp);function pp(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}var yp=(mp.prototype.run=function(){this.runWithBackOff()},mp.prototype.runWithBackOff=function(){var e=this;this.backoff.backoffAndRun(function(){return m(e,void 0,void 0,function(){var t,n,r=this;return g(this,function(e){return t=new dp(this.datastore),(n=this.tryRunUpdateFunction(t))&&n.then(function(e){r.asyncQueue.enqueueAndForget(function(){return t.commit().then(function(){r.deferred.resolve(e)}).catch(function(e){r.handleTransactionError(e)})})}).catch(function(e){r.handleTransactionError(e)}),[2]})})})},mp.prototype.tryRunUpdateFunction=function(e){try{var t=this.updateFunction(e);return!ai(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}},mp.prototype.handleTransactionError=function(e){var t=this;0<this.retries&&this.isRetryableTransactionError(e)?(--this.retries,this.asyncQueue.enqueueAndForget(function(){return t.runWithBackOff(),Promise.resolve()})):this.deferred.reject(e)},mp.prototype.isRetryableTransactionError=function(e){if("FirebaseError"!==e.name)return!1;e=e.code;return"aborted"===e||"failed-precondition"===e||!Ca(e)},mp);function mp(e,t,n,r){this.asyncQueue=e,this.datastore=t,this.updateFunction=n,this.deferred=r,this.retries=5,this.backoff=new oh(this.asyncQueue,"transaction_retry")}var gp="FirestoreClient",vp=(bp.prototype.getConfiguration=function(){return m(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return[4,this.receivedInitialUser.promise];case 1:return e.sent(),[2,{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,credentials:this.credentials,initialUser:this.user,maxConcurrentLimboResolutions:100}]}})})},bp.prototype.setCredentialChangeListener=function(e){var t=this;this.credentialListener=e,this.receivedInitialUser.promise.then(function(){return t.credentialListener(t.user)})},bp.prototype.verifyNotTerminated=function(){if(this.asyncQueue.isShuttingDown)throw new Lr(Rr.FAILED_PRECONDITION,"The client has already been terminated.")},bp.prototype.terminate=function(){var e=this;this.asyncQueue.enterRestrictedMode();var n=new vc;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(function(){return m(e,void 0,void 0,function(){var t;return g(this,function(e){switch(e.label){case 0:return e.trys.push([0,5,,6]),this.onlineComponents?[4,this.onlineComponents.terminate()]:[3,2];case 1:e.sent(),e.label=2;case 2:return this.offlineComponents?[4,this.offlineComponents.terminate()]:[3,4];case 3:e.sent(),e.label=4;case 4:return this.credentials.removeChangeListener(),n.resolve(),[3,6];case 5:return t=e.sent(),t=Jh(t,"Failed to shutdown persistence"),n.reject(t),[3,6];case 6:return[2]}})})}),n.promise},bp);function bp(e,t,n){var r=this;this.credentials=e,this.asyncQueue=t,this.databaseInfo=n,this.user=Nr.UNAUTHENTICATED,this.clientId=Wr.newId(),this.credentialListener=function(){},this.receivedInitialUser=new vc,this.credentials.setChangeListener(function(e){Br(gp,"Received user=",e.uid),r.user.isEqual(e)||(r.user=e,r.credentialListener(e)),r.receivedInitialUser.resolve()})}function wp(r,i){return m(this,void 0,void 0,function(){var t,n=this;return g(this,function(e){switch(e.label){case 0:return r.asyncQueue.verifyOperationInProgress(),Br(gp,"Initializing OfflineComponentProvider"),[4,r.getConfiguration()];case 1:return t=e.sent(),[4,i.initialize(t)];case 2:return e.sent(),r.setCredentialChangeListener(function(t){return r.asyncQueue.enqueueRetryable(function(){return m(n,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return[4,Wl(i.localStore,t)];case 1:return e.sent(),[2]}})})})}),i.persistence.setDatabaseDeletedListener(function(){return r.terminate()}),r.offlineComponents=i,[2]}})})}function Tp(r,i){return m(this,void 0,void 0,function(){var t,n;return g(this,function(e){switch(e.label){case 0:return r.asyncQueue.verifyOperationInProgress(),[4,Sp(r)];case 1:return t=e.sent(),Br(gp,"Initializing OnlineComponentProvider"),[4,r.getConfiguration()];case 2:return n=e.sent(),[4,i.initialize(t,n)];case 3:return e.sent(),r.setCredentialChangeListener(function(e){return r.asyncQueue.enqueueRetryable(function(){return function(r,i){return m(this,void 0,void 0,function(){var t,n;return g(this,function(e){switch(e.label){case 0:return(t=Gr(r,Sh)).asyncQueue.verifyOperationInProgress(),Qr(!!t.remoteSyncer.handleCredentialChange,"handleCredentialChange() not set"),Br(wh,"RemoteStore received new credentials"),n=xh(t),t.offlineCauses.add(3),[4,Eh(t)];case 1:return e.sent(),n&&t.onlineStateTracker.set("Unknown"),[4,t.remoteSyncer.handleCredentialChange(i)];case 2:return e.sent(),t.offlineCauses.delete(3),[4,Ih(t)];case 3:return e.sent(),[2]}})})}(i.remoteStore,e)})}),r.onlineComponents=i,[2]}})})}function Sp(t){return m(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return t.offlineComponents?[3,2]:(Br(gp,"Using default OfflineComponentProvider"),[4,wp(t,new tp)]);case 1:e.sent(),e.label=2;case 2:return[2,t.offlineComponents]}})})}function Ip(t){return m(this,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return t.onlineComponents?[3,2]:(Br(gp,"Using default OnlineComponentProvider"),[4,Tp(t,new cp)]);case 1:e.sent(),e.label=2;case 2:return[2,t.onlineComponents]}})})}function Ep(e){return Sp(e).then(function(e){return e.persistence})}function Cp(e){return Sp(e).then(function(e){return e.localStore})}function Dp(e){return Ip(e).then(function(e){return e.remoteStore})}function _p(e){return Ip(e).then(function(e){return e.syncEngine})}function kp(r){return m(this,void 0,void 0,function(){var t,n;return g(this,function(e){switch(e.label){case 0:return[4,Ip(r)];case 1:return t=e.sent(),(n=t.eventManager).onListen=function(a,s){return m(this,void 0,void 0,function(){var t,n,r,i,o;return g(this,function(e){switch(e.label){case 0:return(t=Wf(a),o=t.queryViewsByQuery.get(s))?(n=o.targetId,t.sharedClientState.addLocalQueryTarget(n),r=o.view.computeInitialSnapshot(),[3,4]):[3,1];case 1:return[4,$l(t.localStore,go(s))];case 2:return i=e.sent(),o=t.sharedClientState.addLocalQueryTarget(i.targetId),n=i.targetId,[4,kf(t,s,n,"current"===o)];case 3:r=e.sent(),t.isPrimaryClient&&Ch(t.remoteStore,i),e.label=4;case 4:return[2,r]}})})}.bind(null,t.syncEngine),n.onUnlisten=function(i,o){return m(this,void 0,void 0,function(){var t,n,r;return g(this,function(e){switch(e.label){case 0:return(t=Gr(i,Df),Qr(!!(n=t.queryViewsByQuery.get(o)),"Trying to unlisten on query not found:"+To(o)),1<(r=t.queriesByTarget.get(n.targetId)).length)?(t.queriesByTarget.set(n.targetId,r.filter(function(e){return!bo(e,o)})),t.queryViewsByQuery.delete(o),[2]):t.isPrimaryClient?(t.sharedClientState.removeLocalQueryTarget(n.targetId),t.sharedClientState.isActiveQueryTarget(n.targetId)?[3,2]:[4,Zl(t.localStore,n.targetId,!1).then(function(){t.sharedClientState.clearQueryState(n.targetId),Dh(t.remoteStore,n.targetId),Mf(t,n.targetId)}).catch(ih)]):[3,3];case 1:e.sent(),e.label=2;case 2:return[3,5];case 3:return Mf(t,n.targetId),[4,Zl(t.localStore,n.targetId,!0)];case 4:e.sent(),e.label=5;case 5:return[2]}})})}.bind(null,t.syncEngine),[2,n]}})})}function Ap(r){var e=this;return r.asyncQueue.enqueue(function(){return m(e,void 0,void 0,function(){var t,n;return g(this,function(e){switch(e.label){case 0:return[4,Ep(r)];case 1:return t=e.sent(),[4,Dp(r)];case 2:return n=e.sent(),t.setNetworkEnabled(!0),[2,((e=Gr(e=n,Sh)).offlineCauses.delete(0),Ih(e))]}})})})}function Np(r){var e=this;return r.asyncQueue.enqueue(function(){return m(e,void 0,void 0,function(){var t,n;return g(this,function(e){switch(e.label){case 0:return[4,Ep(r)];case 1:return t=e.sent(),[4,Dp(r)];case 2:return n=e.sent(),t.setNetworkEnabled(!1),[2,function(n){return m(this,void 0,void 0,function(){var t;return g(this,function(e){switch(e.label){case 0:return(t=Gr(n,Sh)).offlineCauses.add(0),[4,Eh(t)];case 1:return e.sent(),t.onlineStateTracker.set("Offline"),[2]}})})}(n)]}})})})}function xp(t,n){var e=this,r=new vc;return t.asyncQueue.enqueueAndForget(function(){return m(e,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return[4,Cp(t)];case 1:return[2,function(i,o,a){return m(this,void 0,void 0,function(){var r;return g(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,(t=o,(n=Gr(i,zl)).persistence.runTransaction("read document","readonly",function(e){return n.localDocuments.getDocument(e,t)}))];case 1:return(r=e.sent())instanceof Gi?a.resolve(r):r instanceof Yi?a.resolve(null):a.reject(new Lr(Rr.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")),[3,3];case 2:return r=e.sent(),r=Jh(r,"Failed to get document '"+o+" from cache"),a.reject(r),[3,3];case 3:return[2]}var t,n})})}(e.sent(),n,r)]}})})}),r.promise}function Op(u,c,l){var e=this;void 0===l&&(l={});var h=new vc;return u.asyncQueue.enqueueAndForget(function(){return m(e,void 0,void 0,function(){var t;return g(this,function(e){switch(e.label){case 0:return[4,kp(u)];case 1:return t=e.sent(),[2,(n=t,r=u.asyncQueue,i=c,o=l,a=h,e=new hp({next:function(e){r.enqueueAndForget(function(){return cf(n,s)});var t=e.docs.has(i);!t&&e.fromCache?a.reject(new Lr(Rr.UNAVAILABLE,"Failed to get document because the client is offline.")):t&&e.fromCache&&o&&"server"===o.source?a.reject(new Lr(Rr.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):(Qr(e.docs.size<=1,"Expected zero or a single result on a document-only query"),a.resolve(e))},error:function(e){return a.reject(e)}}),s=new hf(uo(i.path),e,{includeMetadataChanges:!0,waitForSyncWhenOnline:!0}),uf(n,s))]}var n,r,i,o,a,s})})}),h.promise}function Rp(t,n){var e=this,r=new vc;return t.asyncQueue.enqueueAndForget(function(){return m(e,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return[4,Cp(t)];case 1:return[2,function(r,i,o){return m(this,void 0,void 0,function(){var t,n;return g(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,eh(r,i,!0)];case 1:return n=e.sent(),t=new Tf(i,n.remoteKeys),n=t.computeDocChanges(n.documents),n=t.applyChanges(n,!1),o.resolve(n.snapshot),[3,3];case 2:return n=e.sent(),n=Jh(n,"Failed to execute query '"+i+" against cache"),o.reject(n),[3,3];case 3:return[2]}})})}(e.sent(),n,r)]}})})}),r.promise}function Lp(u,c,l){var e=this;void 0===l&&(l={});var h=new vc;return u.asyncQueue.enqueueAndForget(function(){return m(e,void 0,void 0,function(){var s;return g(this,function(e){switch(e.label){case 0:return[4,kp(u)];case 1:return s=e.sent(),[2,(t=s,n=u.asyncQueue,r=c,i=l,o=h,e=new hp({next:function(e){n.enqueueAndForget(function(){return cf(t,a)}),e.fromCache&&"server"===i.source?o.reject(new Lr(Rr.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):o.resolve(e)},error:function(e){return o.reject(e)}}),a=new hf(r,e,{includeMetadataChanges:!0,waitForSyncWhenOnline:!0}),uf(t,a))]}var t,n,r,i,o,a})})}),h.promise}function Pp(n,e){var t=this,r=new hp(e);return n.asyncQueue.enqueueAndForget(function(){return m(t,void 0,void 0,function(){var t;return g(this,function(e){switch(e.label){case 0:return[4,kp(n)];case 1:return t=e.sent(),[2,(e=r,Gr(t,sf).snapshotsInSyncListeners.add(e),void e.next())]}})})}),function(){r.mute(),n.asyncQueue.enqueueAndForget(function(){return m(t,void 0,void 0,function(){var t;return g(this,function(e){switch(e.label){case 0:return[4,kp(n)];case 1:return t=e.sent(),[2,(e=r,void Gr(t,sf).snapshotsInSyncListeners.delete(e))]}})})})}}function Mp(n,r){var e=this,i=new vc;return n.asyncQueue.enqueueAndForget(function(){return m(e,void 0,void 0,function(){var t;return g(this,function(e){switch(e.label){case 0:return[4,Ip(n).then(function(e){return e.datastore})];case 1:return t=e.sent(),new yp(n.asyncQueue,t,r,i).run(),[2]}})})}),i.promise}function qp(e,t,n){if(!n)throw new Lr(Rr.INVALID_ARGUMENT,"Function "+e+"() cannot be called with an empty "+t+".")}function Fp(e,t){if(void 0===t)return{merge:!1};if(void 0!==t.mergeFields&&void 0!==t.merge)throw new Lr(Rr.INVALID_ARGUMENT,"Invalid options passed to function "+e+'(): You cannot specify both "merge" and "mergeFields".');return t}function Bp(e,t,n,r){if(!0===t&&!0===r)throw new Lr(Rr.INVALID_ARGUMENT,e+" and "+n+" cannot be used together.")}function Vp(e){if(!vi.isDocumentKey(e))throw new Lr(Rr.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+e+" has "+e.length+".")}function Up(e){if(vi.isDocumentKey(e))throw new Lr(Rr.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+e+" has "+e.length+".")}function Kp(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return 20<e.length&&(e=e.substring(0,20)+"..."),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"!=typeof e)return"function"==typeof e?"a function":jr("Unknown wrong type: "+typeof e);if(e instanceof Array)return"an array";e=function(e){if(e.constructor){e=/function\s+([^\s(]+)\s*\(/.exec(e.constructor.toString());if(e&&1<e.length)return e[1]}return null}(e);return e?"a custom "+e+" object":"an object"}function jp(e,t){if("_delegate"in e&&(e=e._delegate),e instanceof t)return e;if(t.name===e.constructor.name)throw new Lr(Rr.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");e=Kp(e);throw new Lr(Rr.INVALID_ARGUMENT,"Expected type '"+t.name+"', but it was: "+e)}function zp(e,t){if(t<=0)throw new Lr(Rr.INVALID_ARGUMENT,"Function "+e+"() requires a positive number, but it was: "+t+".")}function Qp(e){return function(e,t){if("object"!=typeof e||null===e)return;for(var n=e,r=0,i=t;r<i.length;r++){var o=i[r];if(o in n&&"function"==typeof n[o])return 1}return}(e,["next","error","complete"])}var Gp=(Object.defineProperty(Wp.prototype,"latitude",{get:function(){return this._lat},enumerable:!1,configurable:!0}),Object.defineProperty(Wp.prototype,"longitude",{get:function(){return this._long},enumerable:!1,configurable:!0}),Wp.prototype.isEqual=function(e){return this._lat===e._lat&&this._long===e._long},Wp.prototype.toJSON=function(){return{latitude:this._lat,longitude:this._long}},Wp.prototype._compareTo=function(e){return Yr(this._lat,e._lat)||Yr(this._long,e._long)},Wp);function Wp(e,t){if(!isFinite(e)||e<-90||90<e)throw new Lr(Rr.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||180<t)throw new Lr(Rr.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}var Hp=(Yp.fromBase64String=function(e){try{return new Yp(ii.fromBase64String(e))}catch(e){throw new Lr(Rr.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}},Yp.fromUint8Array=function(e){return new Yp(ii.fromUint8Array(e))},Yp.prototype.toBase64=function(){return this._byteString.toBase64()},Yp.prototype.toUint8Array=function(){return this._byteString.toUint8Array()},Yp.prototype.toString=function(){return"Bytes(base64: "+this.toBase64()+")"},Yp.prototype.isEqual=function(e){return this._byteString.isEqual(e._byteString)},Yp);function Yp(e){this._byteString=e}var Xp=function(e){this._delegate=e};function Jp(){if("undefined"==typeof Uint8Array)throw new Lr(Rr.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}function $p(){if("undefined"==typeof atob)throw new Lr(Rr.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}var Zp,ey=(n(ty,Zp=Xp),ty.fromBase64String=function(e){return $p(),new ty(Hp.fromBase64String(e))},ty.fromUint8Array=function(e){return Jp(),new ty(Hp.fromUint8Array(e))},ty.prototype.toBase64=function(){return $p(),this._delegate.toBase64()},ty.prototype.toUint8Array=function(){return Jp(),this._delegate.toUint8Array()},ty.prototype.isEqual=function(e){return this._delegate.isEqual(e._delegate)},ty.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},ty);function ty(){return null!==Zp&&Zp.apply(this,arguments)||this}ny.prototype.convertValue=function(e,t){switch(void 0===t&&(t="none"),_i(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Pi(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Mi(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw jr("Invalid value type: "+JSON.stringify(e))}},ny.prototype.convertObject=function(e,n){var r=this,i={};return ni(e.fields||{},function(e,t){i[e]=r.convertValue(t,n)}),i},ny.prototype.convertGeoPoint=function(e){return new Gp(Pi(e.latitude),Pi(e.longitude))},ny.prototype.convertArray=function(e,t){var n=this;return(e.values||[]).map(function(e){return n.convertValue(e,t)})},ny.prototype.convertServerTimestamp=function(e,t){switch(t){case"previous":var n=function e(t){t=t.mapValue.fields[Si];return Ei(t)?e(t):t}(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Ci(e));default:return null}},ny.prototype.convertTimestamp=function(e){e=Li(e);return new Zr(e.seconds,e.nanos)},ny.prototype.convertDocumentKey=function(e,t){var n=fi.fromString(e);zr(bs(n),"ReferenceValue is not valid "+e);e=new kr(n.get(1),n.get(3)),n=new vi(n.popFirst(5));return e.isEqual(t)||Vr("Document "+n+" contains a document reference within a different database ("+e.projectId+"/"+e.database+") which is not supported. It will be treated as a reference in the current database ("+t.projectId+"/"+t.database+") instead."),n},St=ny;function ny(){}var ry,iy=(n(oy,ry=St),oy.prototype.convertBytes=function(e){return new ey(new Hp(e))},oy.prototype.convertReference=function(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return zg.forKey(e,this.firestore,null)},oy);function oy(e){var t=ry.call(this)||this;return t.firestore=e,t}var ay=function(e,t){this.user=t,this.type="OAuth",this.authHeaders={},this.authHeaders.Authorization="Bearer "+e},sy=(uy.prototype.getToken=function(){return Promise.resolve(null)},uy.prototype.invalidateToken=function(){},uy.prototype.setChangeListener=function(e){Qr(!this.changeListener,"Can only call setChangeListener() once."),(this.changeListener=e)(Nr.UNAUTHENTICATED)},uy.prototype.removeChangeListener=function(){this.changeListener=null},uy);function uy(){this.changeListener=null}var cy=(ly.prototype.getToken=function(){var t=this;Qr(null!=this.tokenListener,"getToken cannot be called after listener removed.");var n=this.tokenCounter,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(function(e){return t.tokenCounter!==n?(Br("FirebaseCredentialsProvider","getToken aborted due to token change."),t.getToken()):e?(zr("string"==typeof e.accessToken,"Invalid tokenData returned from getToken():"+e),new ay(e.accessToken,t.currentUser)):null}):Promise.resolve(null)},ly.prototype.invalidateToken=function(){this.forceRefresh=!0},ly.prototype.setChangeListener=function(e){Qr(!this.changeListener,"Can only call setChangeListener() once."),this.changeListener=e,this.receivedInitialUser&&e(this.currentUser)},ly.prototype.removeChangeListener=function(){this.auth&&this.auth.removeAuthTokenListener(this.tokenListener),this.tokenListener=null,this.changeListener=null},ly.prototype.getUser=function(){var e=this.auth&&this.auth.getUid();return zr(null===e||"string"==typeof e,"Received invalid UID: "+e),new Nr(e)},ly);function ly(e){var t=this;this.tokenListener=null,this.currentUser=Nr.UNAUTHENTICATED,this.receivedInitialUser=!1,this.tokenCounter=0,this.changeListener=null,this.forceRefresh=!1,this.tokenListener=function(){t.tokenCounter++,t.currentUser=t.getUser(),t.receivedInitialUser=!0,t.changeListener&&t.changeListener(t.currentUser)},this.tokenCounter=0,this.auth=e.getImmediate({optional:!0}),this.auth?this.auth.addAuthTokenListener(this.tokenListener):(this.tokenListener(null),e.get().then(function(e){t.auth=e,t.tokenListener&&t.auth.addAuthTokenListener(t.tokenListener)},function(){}))}var hy=(Object.defineProperty(fy.prototype,"authHeaders",{get:function(){var e={"X-Goog-AuthUser":this.sessionIndex},t=this.gapi.auth.getAuthHeaderValueForFirstParty([]);return t&&(e.Authorization=t),e},enumerable:!1,configurable:!0}),fy);function fy(e,t){this.gapi=e,this.sessionIndex=t,this.type="FirstParty",this.user=Nr.FIRST_PARTY}var dy=(py.prototype.getToken=function(){return Promise.resolve(new hy(this.gapi,this.sessionIndex))},py.prototype.setChangeListener=function(e){e(Nr.FIRST_PARTY)},py.prototype.removeChangeListener=function(){},py.prototype.invalidateToken=function(){},py);function py(e,t){this.gapi=e,this.sessionIndex=t}var yy=new Map;var my=(gy.prototype.isEqual=function(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties},gy);function gy(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new Lr(Rr.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Lr(Rr.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,Bp("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling)}var vy=(Object.defineProperty(by.prototype,"app",{get:function(){if(!this._app)throw new Lr(Rr.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app},enumerable:!1,configurable:!0}),Object.defineProperty(by.prototype,"_initialized",{get:function(){return this._settingsFrozen},enumerable:!1,configurable:!0}),Object.defineProperty(by.prototype,"_terminated",{get:function(){return void 0!==this._terminateTask},enumerable:!1,configurable:!0}),by.prototype._setSettings=function(e){if(this._settingsFrozen)throw new Lr(Rr.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new my(e),void 0!==e.credentials&&(this._credentials=function(e){if(!e)return new sy;switch(e.type){case"gapi":var t=e.client;return zr(!("object"!=typeof t||null===t||!t.auth||!t.auth.getAuthHeaderValueForFirstParty),"unexpected gapi interface"),new dy(t,e.sessionIndex||"0");case"provider":return e.client;default:throw new Lr(Rr.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}(e.credentials))},by.prototype._getSettings=function(){return this._settings},by.prototype._freezeSettings=function(){return this._settingsFrozen=!0,this._settings},by.prototype._delete=function(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask},by.prototype._terminate=function(){var e,t;return e=this,(t=yy.get(e))&&(Br("ComponentProvider","Removing Datastore"),yy.delete(e),t.terminate()),Promise.resolve()},by);function by(e,t){this._persistenceKey="(lite)",this._settings=new my({}),this._settingsFrozen=!1,e instanceof kr?(this._databaseId=e,this._credentials=new sy):(this._app=e,this._databaseId=function(e){if(Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))return new kr(e.options.projectId);throw new Lr(Rr.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.')}(e),this._credentials=new cy(t))}var wy,Ty=11,Sy=20,Iy=22,Ey=(n(Cy,wy=vy),Cy.prototype._terminate=function(){return this._firestoreClient||Mg(this),this._firestoreClient.terminate()},Cy);function Cy(e,t){t=wy.call(this,e,t)||this;return t._queue=new Yh,t._persistenceKey="name"in e?e.name:"[DEFAULT]",t}function Dy(n,r,i){var e=this,o=new vc;return n.asyncQueue.enqueue(function(){return m(e,void 0,void 0,function(){var t;return g(this,function(e){switch(e.label){case 0:return e.trys.push([0,3,,4]),[4,wp(n,i)];case 1:return e.sent(),[4,Tp(n,r)];case 2:return e.sent(),o.resolve(),[3,4];case 3:if(!function(e){{if("FirebaseError"===e.name)return e.code===Rr.FAILED_PRECONDITION||e.code===Rr.UNIMPLEMENTED;if("undefined"!=typeof DOMException&&e instanceof DOMException)return e.code===Iy||e.code===Sy||e.code===Ty}return!0}(t=e.sent()))throw t;return console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),o.reject(t),[3,4];case 4:return[2]}})})}).then(function(){return o.promise})}function _y(n){var e=this;if(n._initialized&&!n._terminated)throw new Lr(Rr.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");var r=new vc;return n._queue.enqueueAndForgetEvenWhileRestricted(function(){return m(e,void 0,void 0,function(){var t;return g(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,function(n){return m(this,void 0,void 0,function(){var t;return g(this,function(e){switch(e.label){case 0:return wc.isAvailable()?(t=n+xl,[4,wc.delete(t)]):[2,Promise.resolve()];case 1:return e.sent(),[2]}})})}(Ul(n._databaseId,n._persistenceKey))];case 1:return e.sent(),r.resolve(),[3,3];case 2:return t=e.sent(),r.reject(t),[3,3];case 3:return[2]}})})}),r.promise}function ky(e){return function(t){var e=this,n=new vc;return t.asyncQueue.enqueueAndForget(function(){return m(e,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return[4,_p(t)];case 1:return[2,Rf(e.sent(),n)]}})})}),n.promise}(Pg(e=jp(e,Ey)))}function Ay(e){if(e._initialized||e._terminated)throw new Lr(Rr.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}var Ny=function(e){this._methodName=e};var xy,Oy=(n(Ry,xy=Ny),Ry.prototype._toFieldTransform=function(e){if(2!==e.dataSource)throw 1===e.dataSource?(Qr(0<e.path.length,this._methodName+"() at the top level should have already been handled."),e.createError(this._methodName+"() can only appear at the top level of your update data")):e.createError(this._methodName+"() cannot be used with set() unless you pass {merge:true}");return e.fieldMask.push(e.path),null},Ry.prototype.isEqual=function(e){return e instanceof Ry},Ry);function Ry(){return null!==xy&&xy.apply(this,arguments)||this}function Ly(e,t,n){return new tm({dataSource:3,targetDoc:t.settings.targetDoc,methodName:e._methodName,arrayElement:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}var Py,My=(n(qy,Py=Ny),qy.prototype._toFieldTransform=function(e){return new Vs(e.path,new Is)},qy.prototype.isEqual=function(e){return e instanceof qy},qy);function qy(){return null!==Py&&Py.apply(this,arguments)||this}var Fy,By=(n(Vy,Fy=Ny),Vy.prototype._toFieldTransform=function(e){var t=Ly(this,e,!0),n=this._elements.map(function(e){return cm(e,t)}),n=new Ds(n);return new Vs(e.path,n)},Vy.prototype.isEqual=function(e){return this===e},Vy);function Vy(e,t){e=Fy.call(this,e)||this;return e._elements=t,e}var Uy,Ky=(n(jy,Uy=Ny),jy.prototype._toFieldTransform=function(e){var t=Ly(this,e,!0),n=this._elements.map(function(e){return cm(e,t)}),n=new Ns(n);return new Vs(e.path,n)},jy.prototype.isEqual=function(e){return this===e},jy);function jy(e,t){e=Uy.call(this,e)||this;return e._elements=t,e}var zy,Qy=(n(Gy,zy=Ny),Gy.prototype._toFieldTransform=function(e){var t=new Ls(e.serializer,Ga(e.serializer,this._operand));return new Vs(e.path,t)},Gy.prototype.isEqual=function(e){return this===e},Gy);function Gy(e,t){e=zy.call(this,e)||this;return e._operand=t,e}var Wy=(Hy.prototype.isEqual=function(e){return this._internalPath.isEqual(e._internalPath)},Hy);function Hy(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var n=0;n<e.length;++n)if(0===e[n].length)throw new Lr(Rr.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new mi(e)}var Yy=/^__.*__$/,Xy=(Jy.prototype.toMutations=function(e,t){var n=[];return null!==this.fieldMask?n.push(new nu(e,this.data,this.fieldMask,t)):n.push(new Zs(e,this.data,t)),0<this.fieldTransforms.length&&n.push(new au(e,this.fieldTransforms)),n},Jy);function Jy(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}var $y=(Zy.prototype.toMutations=function(e,t){t=[new nu(e,this.data,this.fieldMask,t)];return 0<this.fieldTransforms.length&&t.push(new au(e,this.fieldTransforms)),t},Zy);function Zy(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}function em(e){switch(e){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw jr("Unexpected case for UserDataSource: "+e)}}var tm=(Object.defineProperty(nm.prototype,"path",{get:function(){return this.settings.path},enumerable:!1,configurable:!0}),Object.defineProperty(nm.prototype,"dataSource",{get:function(){return this.settings.dataSource},enumerable:!1,configurable:!0}),nm.prototype.contextWith=function(e){return new nm(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)},nm.prototype.childContextForField=function(e){var t=null===(t=this.path)||void 0===t?void 0:t.child(e),t=this.contextWith({path:t,arrayElement:!1});return t.validatePathSegment(e),t},nm.prototype.childContextForFieldPath=function(e){var t,e=null===(t=this.path)||void 0===t?void 0:t.child(e),e=this.contextWith({path:e,arrayElement:!1});return e.validatePath(),e},nm.prototype.childContextForArray=function(e){return this.contextWith({path:void 0,arrayElement:!0})},nm.prototype.createError=function(e){return mm(e,this.settings.methodName,this.settings.hasConverter||!1,this.path,this.settings.targetDoc)},nm.prototype.contains=function(t){return void 0!==this.fieldMask.find(function(e){return t.isPrefixOf(e)})||void 0!==this.fieldTransforms.find(function(e){return t.isPrefixOf(e.field)})},nm.prototype.validatePath=function(){if(this.path)for(var e=0;e<this.path.length;e++)this.validatePathSegment(this.path.get(e))},nm.prototype.validatePathSegment=function(e){if(0===e.length)throw this.createError("Document fields must not be empty");if(em(this.dataSource)&&Yy.test(e))throw this.createError('Document fields cannot begin and end with "__"')},nm);function nm(e,t,n,r,i,o){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.validatePath(),this.fieldTransforms=i||[],this.fieldMask=o||[]}var rm=(im.prototype.createContext=function(e,t,n,r){return void 0===r&&(r=!1),new tm({dataSource:e,methodName:t,targetDoc:n,path:mi.emptyPath(),arrayElement:!1,hasConverter:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)},im);function im(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||ep(e)}function om(e,t,n,r,i,o){void 0===o&&(o={});var a=e.createContext(o.merge||o.mergeFields?2:0,t,n,i);fm("Data must be an object, but it was:",a,r);var s,u,r=lm(r,a);if(o.merge)s=new Fs(a.fieldMask),u=a.fieldTransforms;else if(o.mergeFields){for(var c=[],l=0,h=o.mergeFields;l<h.length;l++){var f=dm(t,h[l],n);if(!a.contains(f))throw new Lr(Rr.INVALID_ARGUMENT,"Field '"+f+"' is specified in your field mask but missing from your input data.");gm(c,f)||c.push(f)}s=new Fs(c),u=a.fieldTransforms.filter(function(e){return s.covers(e.field)})}else s=null,u=a.fieldTransforms;return new Xy(new ba(r),s,u)}function am(e,r,i,t){var o=e.createContext(1,r,i);fm("Data must be an object, but it was:",o,t);var a=[],s=new Ta;ni(t,function(e,t){var n=ym(r,e,i);t instanceof Xp&&(t=t._delegate);e=o.childContextForFieldPath(n);t instanceof Oy?a.push(n):null!=(e=cm(t,e))&&(a.push(n),s.set(n,e))});t=new Fs(a);return new $y(s.build(),t,o.fieldTransforms)}function sm(e,t,n,r,i,o){var a=e.createContext(1,t,n),s=[dm(t,r,n)],u=[i];if(o.length%2!=0)throw new Lr(Rr.INVALID_ARGUMENT,"Function "+t+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var c=0;c<o.length;c+=2)s.push(dm(t,o[c])),u.push(o[c+1]);for(var l,h,f,d=[],p=new Ta,c=s.length-1;0<=c;--c){gm(d,s[c])||(l=s[c],(h=u[c])instanceof Xp&&(h=h._delegate),f=a.childContextForFieldPath(l),h instanceof Oy?d.push(l):null!=(f=cm(h,f))&&(d.push(l),p.set(l,f)))}i=new Fs(d);return new $y(p.build(),i,a.fieldTransforms)}function um(e,t,n,r){void 0===r&&(r=!1);t=e.createContext(r?4:3,t),n=cm(n,t);return Qr(null!=n,"Parsed data should not be null."),Qr(0===t.fieldTransforms.length,"Field transforms should have been disallowed."),n}function cm(e,t){if(e instanceof Xp&&(e=e._delegate),hm(e))return fm("Unsupported field value:",t,e),lm(e,t);if(e instanceof Ny)return function(e,t){if(!em(t.dataSource))throw t.createError(e._methodName+"() can only be used with update() and set()");if(!t.path)throw t.createError(e._methodName+"() is not currently supported inside arrays");e=e._toFieldTransform(t);e&&t.fieldTransforms.push(e)}(e,t),null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.arrayElement&&4!==t.dataSource)throw t.createError("Nested arrays are not supported");return function(e,t){for(var n=[],r=0,i=0,o=e;i<o.length;i++){var a=cm(o[i],t.childContextForArray(r));null==a&&(a={nullValue:"NULL_VALUE"}),n.push(a),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){e instanceof Xp&&(e=e._delegate);{if(null===e)return{nullValue:"NULL_VALUE"};if("number"==typeof e)return Ga(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){var n=Zr.fromDate(e);return{timestampValue:Wa(t.serializer,n)}}if(e instanceof Zr){n=new Zr(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:Wa(t.serializer,n)}}if(e instanceof Gp)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof Hp)return{bytesValue:Ha(t.serializer,e._byteString)};if(e instanceof Cm){var r=t.databaseId,n=e.firestore._databaseId;if(!n.isEqual(r))throw t.createError("Document reference is for database "+n.projectId+"/"+n.database+" but should be for database "+r.projectId+"/"+r.database);return{referenceValue:Xa(e.firestore._databaseId||t.databaseId,e._key.path)}}if(void 0===e&&t.ignoreUndefinedProperties)return null;throw t.createError("Unsupported field value: "+Kp(e))}}(e,t)}function lm(e,n){var r={};return ri(e)?n.path&&0<n.path.length&&n.fieldMask.push(n.path):ni(e,function(e,t){t=cm(t,n.childContextForField(e));null!=t&&(r[e]=t)}),{mapValue:{fields:r}}}function hm(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof Zr||e instanceof Gp||e instanceof Hp||e instanceof Cm||e instanceof Ny)}function fm(e,t,n){if(!hm(n)||("object"!=typeof(r=n)||null===r||Object.getPrototypeOf(r)!==Object.prototype&&null!==Object.getPrototypeOf(r))){n=Kp(n);throw"an object"===n?t.createError(e+" a custom object"):t.createError(e+" "+n)}var r}function dm(e,t,n){if(t instanceof Xp&&(t=t._delegate),t instanceof Wy)return t._internalPath;if("string"==typeof t)return ym(e,t);throw mm("Field path arguments must be of type string or FieldPath.",e,!1,void 0,n)}var pm=new RegExp("[~\\*/\\[\\]]");function ym(t,n,r){if(0<=n.search(pm))throw mm("Invalid field path ("+n+"). Paths must not contain '~', '*', '/', '[', or ']'",t,!1,void 0,r);try{return(new(Wy.bind.apply(Wy,a([void 0],n.split(".")))))._internalPath}catch(e){throw mm("Invalid field path ("+n+"). Paths must not be empty, begin with '.', end with '.', or contain '..'",t,!1,void 0,r)}}function mm(e,t,n,r,i){var o=r&&!r.isEmpty(),a=void 0!==i,t="Function "+t+"() called with invalid data";n&&(t+=" (via `toFirestore()`)"),t+=". ";n="";return(o||a)&&(n+=" (found",o&&(n+=" in field "+r),a&&(n+=" in document "+i),n+=")"),new Lr(Rr.INVALID_ARGUMENT,t+e+n)}function gm(e,t){return e.some(function(e){return e.isEqual(t)})}var vm,bm=(n(wm,vm=St),wm.prototype.convertBytes=function(e){return new Hp(e)},wm.prototype.convertReference=function(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return new Cm(this.firestore,null,e)},wm);function wm(e){var t=vm.call(this)||this;return t.firestore=e,t}function Tm(e,t,n){for(var r=[],i=3;i<arguments.length;i++)r[i-3]=arguments[i];e=jp(e,Cm);var o=jp(e.firestore,Ey),a=sg(o);return t instanceof Xp&&(t=t._delegate),Im(o,("string"==typeof t||t instanceof Wy?sm(a,"updateDoc",e._key,t,n,r):am(a,"updateDoc",e._key,t)).toMutations(e._key,js.exists(!0)))}function Sm(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t instanceof Xp&&(t=t._delegate);var r={includeMetadataChanges:!1},i=0;"object"!=typeof n[i]||Qp(n[i])||(r=n[i],i++);var o,a,s,u,c,l,h={includeMetadataChanges:r.includeMetadataChanges};return Qp(n[i])&&(o=n[i],n[i]=null===(r=o.next)||void 0===r?void 0:r.bind(o),n[i+1]=null===(r=o.error)||void 0===r?void 0:r.bind(o),n[i+2]=null===(r=o.complete)||void 0===r?void 0:r.bind(o)),t instanceof Cm?(s=jp(t.firestore,Ey),u=uo(t._key.path),l={next:function(e){n[i]&&n[i](Em(s,t,e))},error:n[i+1],complete:n[i+2]}):(a=jp(t,_m),s=jp(a.firestore,Ey),u=a._query,c=new bm(s),l={next:function(e){n[i]&&n[i](new wg(s,c,a,e))},error:n[i+1],complete:n[i+2]},Ym(t._query)),function(t,e,n,r){var i=this,o=new hp(r),a=new hf(e,o,n);return t.asyncQueue.enqueueAndForget(function(){return m(i,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return[4,kp(t)];case 1:return[2,uf(e.sent(),a)]}})})}),function(){o.mute(),t.asyncQueue.enqueueAndForget(function(){return m(i,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return[4,kp(t)];case 1:return[2,cf(e.sent(),a)]}})})})}}(Pg(s),u,h,l)}function Im(e,t){return function(t,n){var e=this,r=new vc;return t.asyncQueue.enqueueAndForget(function(){return m(e,void 0,void 0,function(){return g(this,function(e){switch(e.label){case 0:return[4,_p(t)];case 1:return[2,Af(e.sent(),n,r)]}})})}),r.promise}(Pg(e),t)}function Em(e,t,n){Qr(n.docs.size<=1,"Expected zero or a single result on a document-only query");var r=n.docs.get(t._key),i=new bm(e);return new yg(e,i,t._key,r,new Yg(n.hasPendingWrites,n.fromCache),t._converter)}var Cm=(Object.defineProperty(Dm.prototype,"_path",{get:function(){return this._key.path},enumerable:!1,configurable:!0}),Object.defineProperty(Dm.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!1,configurable:!0}),Object.defineProperty(Dm.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!1,configurable:!0}),Object.defineProperty(Dm.prototype,"parent",{get:function(){return new Jm(this.firestore,this._converter,this._key.path.popLast())},enumerable:!1,configurable:!0}),Dm.prototype.withConverter=function(e){return new Dm(this.firestore,e,this._key)},Dm);function Dm(e,t,n){this._converter=t,this._key=n,this.type="document",this.firestore=e}var _m=(km.prototype.withConverter=function(e){return new km(this.firestore,e,this._query)},km);function km(e,t,n){this._converter=t,this._query=n,this.type="query",this.firestore=e}It=function(){};function Am(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];for(var r=0,i=t;r<i.length;r++){e=i[r]._apply(e)}return e}var Nm,xm=(n(Om,Nm=It),Om.prototype._apply=function(e){var t=sg(e.firestore),t=function(e,t,n,r,i,o,a){if(i.isKeyField()){if("array-contains"===o||"array-contains-any"===o)throw new Lr(Rr.INVALID_ARGUMENT,"Invalid Query. You can't perform '"+o+"' queries on FieldPath.documentId().");if("in"===o||"not-in"===o){Wm(a,o);for(var s=[],u=0,c=a;u<c.length;u++){var l=c[u];s.push(Gm(r,e,l))}h={arrayValue:{values:s}}}else h=Gm(r,e,a)}else"in"!==o&&"not-in"!==o&&"array-contains-any"!==o||Wm(a,o),h=um(n,t,a,"in"===o||"not-in"===o);var h=Co.create(i,o,h);return function(e,t){if(Qr(t instanceof Co,"Only FieldFilters are supported"),t.isInequality()){var n=fo(e);if(null!==n&&!n.isEqual(t.field))throw new Lr(Rr.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, >, or >=) must be on the same field. But you have inequality filters on '"+n.toString()+"' and '"+t.field.toString()+"'");n=ho(e);null!==n&&Hm(0,t.field,n)}e=function(e,t){for(var n=0,r=e.filters;n<r.length;n++){var i=r[n];if(Qr(i instanceof Co,"Only FieldFilters are supported"),0<=t.indexOf(i.op))return i.op}return null}(e,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==e)throw e===t.op?new Lr(Rr.INVALID_ARGUMENT,"Invalid query. You cannot use more than one '"+t.op.toString()+"' filter."):new Lr(Rr.INVALID_ARGUMENT,"Invalid query. You cannot use '"+t.op.toString()+"' filters with '"+e.toString()+"' filters.")}(e,h),h}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value);return new _m(e.firestore,e._converter,(e=e._query,t=t,Qr(null==fo(e)||!(t instanceof Co)||!t.isInequality()||t.field.isEqual(fo(e)),"Query must only have one inequality field."),Qr(!po(e),"No filtering allowed for document query"),t=e.filters.concat([t]),new ao(e.path,e.collectionGroup,e.explicitOrderBy.slice(),t,e.limit,e.limitType,e.startAt,e.endAt)))},Om);function Om(e,t,n){var r=Nm.call(this)||this;return r._field=e,r._op=t,r._value=n,r.type="where",r}var Rm,Lm=(n(Pm,Rm=It),Pm.prototype._apply=function(e){var t=function(e,t,n){if(null!==e.startAt)throw new Lr(Rr.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new Lr(Rr.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");n=new Zo(t,n);return function(e,t){{var n;null!==ho(e)||null!==(n=fo(e))&&Hm(0,n,t.field)}}(e,n),n}(e._query,this._field,this._direction);return new _m(e.firestore,e._converter,(e=e._query,t=t,Qr(!e.startAt&&!e.endAt,"Bounds must be set after orderBy"),t=e.explicitOrderBy.concat([t]),new ao(e.path,e.collectionGroup,t,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)))},Pm);function Pm(e,t){var n=Rm.call(this)||this;return n._field=e,n._direction=t,n.type="orderBy",n}var Mm,qm=(n(Fm,Mm=It),Fm.prototype._apply=function(e){return new _m(e.firestore,e._converter,vo(e._query,this._limit,this._limitType))},Fm);function Fm(e,t,n){var r=Mm.call(this)||this;return r.type=e,r._limit=t,r._limitType=n,r}var Bm,Vm=(n(Um,Bm=It),Um.prototype._apply=function(e){var t=Qm(e,this.type,this._docOrFields,this._before);return new _m(e.firestore,e._converter,(e=e._query,t=t,new ao(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)))},Um);function Um(e,t,n){var r=Bm.call(this)||this;return r.type=e,r._docOrFields=t,r._before=n,r}var Km,jm=(n(zm,Km=It),zm.prototype._apply=function(e){var t=Qm(e,this.type,this._docOrFields,this._before);return new _m(e.firestore,e._converter,(e=e._query,t=t,new ao(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)))},zm);function zm(e,t,n){var r=Km.call(this)||this;return r.type=e,r._docOrFields=t,r._before=n,r}function Qm(e,t,n,r){if(n[0]instanceof Xp&&(n[0]=n[0]._delegate),n[0]instanceof ug)return function(e,t,n,r,i){if(!r)throw new Lr(Rr.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+n+"().");for(var o=[],a=0,s=mo(e);a<s.length;a++){var u=s[a];if(u.field.isKeyField())o.push(qi(t,r.key));else{var c=r.field(u.field);if(Ei(c))throw new Lr(Rr.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+u.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===c){u=u.field.canonicalString();throw new Lr(Rr.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+u+"' (used as the orderBy) does not exist.")}o.push(c)}}return new Yo(o,i)}(e._query,e.firestore._databaseId,t,n[0]._document,r);var i=sg(e.firestore);return function(e,t,n,r,i,o){var a=e.explicitOrderBy;if(i.length>a.length)throw new Lr(Rr.INVALID_ARGUMENT,"Too many arguments provided to "+r+"(). The number of arguments must be less than or equal to the number of orderBy() clauses");for(var s=[],u=0;u<i.length;u++){var c=i[u];if(a[u].field.isKeyField()){if("string"!=typeof c)throw new Lr(Rr.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+r+"(), but got a "+typeof c);if(!yo(e)&&-1!==c.indexOf("/"))throw new Lr(Rr.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to "+r+"() must be a plain document ID, but '"+c+"' contains a slash.");var l=e.path.child(fi.fromString(c));if(!vi.isDocumentKey(l))throw new Lr(Rr.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to "+r+"() must result in a valid document path, but '"+l+"' is not because it contains an odd number of segments.");l=new vi(l);s.push(qi(t,l))}else{c=um(n,r,c);s.push(c)}}return new Yo(s,o)}(e._query,e.firestore._databaseId,i,t,n,r)}function Gm(e,t,n){if(n instanceof Xp&&(n=n._delegate),"string"==typeof n){if(""===n)throw new Lr(Rr.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!yo(t)&&-1!==n.indexOf("/"))throw new Lr(Rr.INVALID_ARGUMENT,"Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '"+n+"' contains a '/' character.");t=t.path.child(fi.fromString(n));if(!vi.isDocumentKey(t))throw new Lr(Rr.INVALID_ARGUMENT,"Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '"+t+"' is not because it has an odd number of segments ("+t.length+").");return qi(e,new vi(t))}if(n instanceof Cm)return qi(e,n._key);throw new Lr(Rr.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: "+Kp(n)+".")}function Wm(e,t){if(!Array.isArray(e)||0===e.length)throw new Lr(Rr.INVALID_ARGUMENT,"Invalid Query. A non-empty array is required for '"+t.toString()+"' filters.");if(10<e.length)throw new Lr(Rr.INVALID_ARGUMENT,"Invalid Query. '"+t.toString()+"' filters support a maximum of 10 elements in the value array.")}function Hm(e,t,n){if(!n.isEqual(t))throw new Lr(Rr.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, >, or >=) on field '"+t.toString()+"' and so you must also use '"+t.toString()+"' as your first argument to orderBy(), but your first orderBy() is on field '"+n.toString()+"' instead.")}function Ym(e){if(lo(e)&&0===e.explicitOrderBy.length)throw new Lr(Rr.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}var Xm,Jm=(n($m,Xm=_m),Object.defineProperty($m.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!1,configurable:!0}),Object.defineProperty($m.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!1,configurable:!0}),Object.defineProperty($m.prototype,"parent",{get:function(){var e=this._path.popLast();return e.isEmpty()?null:new Cm(this.firestore,null,new vi(e))},enumerable:!1,configurable:!0}),$m.prototype.withConverter=function(e){return new $m(this.firestore,e,this._path)},$m);function $m(e,t,n){t=Xm.call(this,e,t,uo(n))||this;return t.firestore=e,t._path=n,t.type="collection",t}function Zm(e,t){for(var n,r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];if(e instanceof Xp&&(e=e._delegate),qp("collection","path",t),e instanceof vy)return Up(n=fi.fromString.apply(fi,a([t],r))),new Jm(e,null,n);if(!(e instanceof Cm||e instanceof Jm))throw new Lr(Rr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");return Up(n=fi.fromString.apply(fi,a([e.path],r)).child(fi.fromString(t))),new Jm(e.firestore,null,n)}function eg(e,t){if(e=jp(e,vy),qp("collectionGroup","collection id",t),0<=t.indexOf("/"))throw new Lr(Rr.INVALID_ARGUMENT,"Invalid collection ID '"+t+"' passed to function collectionGroup(). Collection IDs must not contain '/'.");return new _m(e,null,(t=t,new ao(fi.emptyPath(),t)))}function tg(e,t){for(var n,r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];if(e instanceof Xp&&(e=e._delegate),1===arguments.length&&(t=Wr.newId()),qp("doc","path",t),e instanceof vy)return Vp(n=fi.fromString.apply(fi,a([t],r))),new Cm(e,null,new vi(n));if(!(e instanceof Cm||e instanceof Jm))throw new Lr(Rr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");return Vp(n=e._path.child(fi.fromString.apply(fi,a([t],r)))),new Cm(e.firestore,e instanceof Jm?e._converter:null,new vi(n))}var ng,rg=(n(ig,ng=St),ig.prototype.convertBytes=function(e){return new Hp(e)},ig.prototype.convertReference=function(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return new Cm(this.firestore,null,e)},ig);function ig(e){var t=ng.call(this)||this;return t.firestore=e,t}function og(e,t){return e instanceof Xp&&(e=e._delegate),t instanceof Xp&&(t=t._delegate),(e instanceof Cm||e instanceof Jm)&&(t instanceof Cm||t instanceof Jm)&&(e.firestore===t.firestore&&e.path===t.path&&e._converter===t._converter)}function ag(e,t){return e instanceof Xp&&(e=e._delegate),t instanceof Xp&&(t=t._delegate),e instanceof _m&&t instanceof _m&&(e.firestore===t.firestore&&bo(e._query,t._query)&&e._converter===t._converter)}function sg(e){var t=e._freezeSettings(),n=ep(e._databaseId);return new rm(e._databaseId,!!t.ignoreUndefinedProperties,n)}var ug=(Object.defineProperty(cg.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!1,configurable:!0}),Object.defineProperty(cg.prototype,"ref",{get:function(){return new Cm(this._firestore,this._converter,this._key)},enumerable:!1,configurable:!0}),cg.prototype.exists=function(){return null!==this._document},cg.prototype.data=function(){if(this._document){if(this._converter){var e=new hg(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.toProto())}},cg.prototype.get=function(e){if(this._document){e=this._document.data().field(dg("DocumentSnapshot.get",e));if(null!==e)return this._userDataWriter.convertValue(e)}},cg);function cg(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}var lg,hg=(n(fg,lg=ug),fg.prototype.data=function(){return lg.prototype.data.call(this)},fg);function fg(){return null!==lg&&lg.apply(this,arguments)||this}function dg(e,t){return"string"==typeof t?ym(e,t):(t instanceof Xp?t._delegate:t)._internalPath}var pg,yg=(n(mg,pg=ug),mg.prototype.exists=function(){return pg.prototype.exists.call(this)},mg.prototype.data=function(e){if(void 0===e&&(e={}),this._document){if(this._converter){var t=new vg(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.toProto(),e.serverTimestamps)}},mg.prototype.get=function(e,t){if(void 0===t&&(t={}),this._document){e=this._document.data().field(dg("DocumentSnapshot.get",e));if(null!==e)return this._userDataWriter.convertValue(e,t.serverTimestamps)}},mg);function mg(e,t,n,r,i,o){o=pg.call(this,e,t,n,r,o)||this;return o._firestore=e,o._firestoreImpl=e,o.metadata=i,o}var gg,vg=(n(bg,gg=yg),bg.prototype.data=function(e){return void 0===e&&(e={}),gg.prototype.data.call(this,e)},bg);function bg(){return null!==gg&&gg.apply(this,arguments)||this}var wg=(Object.defineProperty(Tg.prototype,"docs",{get:function(){var t=[];return this.forEach(function(e){return t.push(e)}),t},enumerable:!1,configurable:!0}),Object.defineProperty(Tg.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!1,configurable:!0}),Object.defineProperty(Tg.prototype,"empty",{get:function(){return 0===this.size},enumerable:!1,configurable:!0}),Tg.prototype.forEach=function(t,n){var r=this;this._snapshot.docs.forEach(function(e){t.call(n,new vg(r._firestore,r._userDataWriter,e.key,e,new Yg(r._snapshot.mutatedKeys.has(e.key),r._snapshot.fromCache),r.query._converter))})},Tg.prototype.docChanges=function(e){void 0===e&&(e={});e=!!e.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new Lr(Rr.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(i,t){{if(i._snapshot.oldDocs.isEmpty()){var n,r=0;return i._snapshot.docChanges.map(function(e){Qr(0===e.type,"Invalid event type for first snapshot"),Qr(!n||Io(i._snapshot.query)(n,e.doc)<0,"Got added events in wrong order");var t=new vg(i._firestore,i._userDataWriter,e.doc.key,e.doc,new Yg(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query._converter);return n=e.doc,{type:"added",doc:t,oldIndex:-1,newIndex:r++}})}var o=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(function(e){return t||3!==e.type}).map(function(e){var t=new vg(i._firestore,i._userDataWriter,e.doc.key,e.doc,new Yg(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query._converter),n=-1,r=-1;return 0!==e.type&&(Qr(0<=(n=o.indexOf(e.doc.key)),"Index for document not found"),o=o.delete(e.doc.key)),1!==e.type&&(r=(o=o.add(e.doc)).indexOf(e.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return jr("Unknown change type: "+e)}}(e.type),doc:t,oldIndex:n,newIndex:r}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges},Tg);function Tg(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Yg(r.hasPendingWrites,r.fromCache),this.query=n}function Sg(e,t){return e instanceof yg&&t instanceof yg?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof wg&&t instanceof wg&&(e._firestore===t._firestore&&ag(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot))}var Ig=(Eg.prototype.set=function(e,t,n){this._verifyNotCommitted();e=Cg(e,this._firestore),t=mv(e._converter,t,n),n=om(this._dataReader,"WriteBatch.set",e._key,t,null!==e._converter,n);return this._mutations=this._mutations.concat(n.toMutations(e._key,js.none())),this},Eg.prototype.update=function(e,t,n){for(var r=[],i=3;i<arguments.length;i++)r[i-3]=arguments[i];this._verifyNotCommitted();e=Cg(e,this._firestore);return t instanceof Xp&&(t=t._delegate),t="string"==typeof t||t instanceof Wy?sm(this._dataReader,"WriteBatch.update",e._key,t,n,r):am(this._dataReader,"WriteBatch.update",e._key,t),this._mutations=this._mutations.concat(t.toMutations(e._key,js.exists(!0))),this},Eg.prototype.delete=function(e){this._verifyNotCommitted();e=Cg(e,this._firestore);return this._mutations=this._mutations.concat(new hu(e._key,js.none())),this},Eg.prototype.commit=function(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()},Eg.prototype._verifyNotCommitted=function(){if(this._committed)throw new Lr(Rr.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},Eg);function Eg(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=sg(e)}function Cg(e,t){if(e instanceof Xp&&(e=e._delegate),e.firestore!==t)throw new Lr(Rr.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}Dg.prototype.get=function(e){var t=this,n=Cg(e,this._firestore),r=new rg(this._firestore);return this._transaction.lookup([n._key]).then(function(e){if(!e||1!==e.length)return jr("Mismatch in docs returned from document lookup.");e=e[0];if(e instanceof Yi)return new ug(t._firestore,r,n._key,null,n._converter);if(e instanceof Gi)return new ug(t._firestore,r,e.key,e,n._converter);throw jr("BatchGetDocumentsRequest returned unexpected document type: "+e.constructor.name)})},Dg.prototype.set=function(e,t,n){e=Cg(e,this._firestore),t=mv(e._converter,t,n),n=om(this._dataReader,"Transaction.set",e._key,t,null!==e._converter,n);return this._transaction.set(e._key,n),this},Dg.prototype.update=function(e,t,n){for(var r=[],i=3;i<arguments.length;i++)r[i-3]=arguments[i];e=Cg(e,this._firestore);return t instanceof Xp&&(t=t._delegate),t="string"==typeof t||t instanceof Wy?sm(this._dataReader,"Transaction.update",e._key,t,n,r):am(this._dataReader,"Transaction.update",e._key,t),this._transaction.update(e._key,t),this},Dg.prototype.delete=function(e){e=Cg(e,this._firestore);return this._transaction.delete(e._key),this},It=Dg;function Dg(e,t){this._firestore=e,this._transaction=t,this._dataReader=sg(e)}var _g,kg=(n(Ag,_g=It),Ag.prototype.get=function(e){var t=this,n=Cg(e,this._firestore),r=new bm(this._firestore);return _g.prototype.get.call(this,e).then(function(e){return new yg(t._firestore,r,n._key,e._document,new Yg(!1,!1),n._converter)})},Ag);function Ag(e,t){t=_g.call(this,e,t)||this;return t._firestore=e,t}var Ng=(xg.prototype.enableIndexedDbPersistence=function(e,t){return function(e,t){Ay(e=jp(e,Ey));var n=Pg(e),r=e._freezeSettings(),e=new cp;return Dy(n,e,new ip(e,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}(e._delegate,{forceOwnership:t})},xg.prototype.enableMultiTabIndexedDbPersistence=function(e){return function(e){Ay(e=jp(e,Ey));var t=Pg(e),n=e._freezeSettings(),e=new cp;return Dy(t,e,new sp(e,n.cacheSizeBytes))}(e._delegate)},xg.prototype.clearIndexedDbPersistence=function(e){return _y(e._delegate)},xg);function xg(){}var Og,Rg=(n(Lg,Og=Xp),Object.defineProperty(Lg.prototype,"_databaseId",{get:function(){return this._delegate._databaseId},enumerable:!1,configurable:!0}),Lg.prototype.settings=function(e){e.merge&&delete(e=Object.assign(Object.assign({},this._delegate._getSettings()),e)).merge,this._delegate._setSettings(e)},Lg.prototype.useEmulator=function(e,t){"firestore.googleapis.com"!==this._delegate._getSettings().host&&Ur("Host has been set in both settings() and useEmulator(), emulator host will be used"),this.settings({host:e+":"+t,ssl:!1,merge:!0})},Lg.prototype.enableNetwork=function(){return Ap(Pg(jp(this._delegate,Ey)))},Lg.prototype.disableNetwork=function(){return Np(Pg(jp(this._delegate,Ey)))},Lg.prototype.enablePersistence=function(e){var t=!1,n=!1;return e&&Bp("synchronizeTabs",t=!!e.synchronizeTabs,"experimentalForceOwningTab",n=!!e.experimentalForceOwningTab),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)},Lg.prototype.clearPersistence=function(){return this._persistenceProvider.clearIndexedDbPersistence(this)},Lg.prototype.terminate=function(){return this.app._removeServiceInstance("firestore"),this.app._removeServiceInstance("firestore-exp"),this._delegate._delete()},Lg.prototype.waitForPendingWrites=function(){return ky(this._delegate)},Lg.prototype.onSnapshotsInSync=function(e){return t=this._delegate,e=e,Pp(Pg(t=jp(t,Ey)),Qp(e)?e:{next:e});var t},Object.defineProperty(Lg.prototype,"app",{get:function(){if(!this._appCompat)throw new Lr(Rr.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat},enumerable:!1,configurable:!0}),Lg.prototype.collection=function(e){try{return new dv(this,Zm(this._delegate,e))}catch(e){throw Gg(e,"collection()","Firestore.collection()")}},Lg.prototype.doc=function(e){try{return new zg(this,tg(this._delegate,e))}catch(e){throw Gg(e,"doc()","Firestore.doc()")}},Lg.prototype.collectionGroup=function(e){try{return new iv(this,eg(this._delegate,e))}catch(e){throw Gg(e,"collectionGroup()","Firestore.collectionGroup()")}},Lg.prototype.runTransaction=function(t){var n,r,i=this;return n=this._delegate,r=function(e){return t(new Fg(i,e))},Mp(Pg(n),function(e){return r(new kg(n,e))})},Lg.prototype.batch=function(){var t=this;return Pg(this._delegate),new Ug(new Ig(this._delegate,function(e){return Im(t._delegate,e)}))},Lg);function Lg(e,t,n){var r=Og.call(this,t)||this;return r._persistenceProvider=n,r.INTERNAL={delete:function(){return r.terminate()}},e instanceof kr||(r._appCompat=e),r}function Pg(e){return e._firestoreClient||Mg(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Mg(e){var t=e._freezeSettings();Qr(!!t.host,"FirestoreSettings.host is not set"),Qr(!e._firestoreClient,"configureFirestore() called multiple times");var n,r,t=(n=e._databaseId,r=e._persistenceKey,new Dr(n,r,(t=t).host,t.ssl,t.experimentalForceLongPolling,t.experimentalAutoDetectLongPolling));e._firestoreClient=new vp(e._credentials,e._queue,t)}var qg,Fg=(n(Bg,qg=Xp),Bg.prototype.get=function(e){var t=this,e=yv(e);return this._delegate.get(e).then(function(e){return new $g(t._firestore,e)})},Bg.prototype.set=function(e,t,n){e=yv(e);return n?(Fp("Transaction.set",n),this._delegate.set(e,t,n)):this._delegate.set(e,t),this},Bg.prototype.update=function(e,t,n){for(var r=[],i=3;i<arguments.length;i++)r[i-3]=arguments[i];var o=yv(e);return 2===arguments.length?this._delegate.update(o,t):(e=this._delegate).update.apply(e,a([o,t,n],r)),this},Bg.prototype.delete=function(e){e=yv(e);return this._delegate.delete(e),this},Bg);function Bg(e,t){t=qg.call(this,t)||this;return t._firestore=e,t}var Vg,Ug=(n(Kg,Vg=Xp),Kg.prototype.set=function(e,t,n){e=yv(e);return n?(Fp("WriteBatch.set",n),this._delegate.set(e,t,n)):this._delegate.set(e,t),this},Kg.prototype.update=function(e,t,n){for(var r=[],i=3;i<arguments.length;i++)r[i-3]=arguments[i];var o=yv(e);return 2===arguments.length?this._delegate.update(o,t):(e=this._delegate).update.apply(e,a([o,t,n],r)),this},Kg.prototype.delete=function(e){e=yv(e);return this._delegate.delete(e),this},Kg.prototype.commit=function(){return this._delegate.commit()},Kg);function Kg(){return null!==Vg&&Vg.apply(this,arguments)||this}var jg,zg=(n(Qg,jg=Xp),Qg.forPath=function(e,t,n){if(e.length%2!=0)throw new Lr(Rr.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+e.canonicalString()+" has "+e.length);return new Qg(t,new Cm(t._delegate,n,new vi(e)))},Qg.forKey=function(e,t,n){return new Qg(t,new Cm(t._delegate,n,e))},Object.defineProperty(Qg.prototype,"id",{get:function(){return this._delegate.id},enumerable:!1,configurable:!0}),Object.defineProperty(Qg.prototype,"parent",{get:function(){return new dv(this.firestore,this._delegate.parent)},enumerable:!1,configurable:!0}),Object.defineProperty(Qg.prototype,"path",{get:function(){return this._delegate.path},enumerable:!1,configurable:!0}),Qg.prototype.collection=function(e){try{return new dv(this.firestore,Zm(this._delegate,e))}catch(e){throw Gg(e,"collection()","DocumentReference.collection()")}},Qg.prototype.isEqual=function(e){return e instanceof Xp&&(e=e._delegate),e instanceof Cm&&og(this._delegate,e)},Qg.prototype.set=function(e,t){t=Fp("DocumentReference.set",t);try{return function(e,t,n){e=jp(e,Cm);var r=jp(e.firestore,Ey),t=mv(e._converter,t,n);return Im(r,om(sg(r),"setDoc",e._key,t,null!==e._converter,n).toMutations(e._key,js.none()))}(this._delegate,e,t)}catch(e){throw Gg(e,"setDoc()","DocumentReference.set()")}},Qg.prototype.update=function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];try{return 1===arguments.length?Tm(this._delegate,e):Tm.apply(void 0,a([this._delegate,e,t],n))}catch(e){throw Gg(e,"updateDoc()","DocumentReference.update()")}},Qg.prototype.delete=function(){return Im(jp((e=this._delegate).firestore,Ey),[new hu(e._key,js.none())]);var e},Qg.prototype.onSnapshot=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var r=Wg(e),i=Hg(e,function(e){return new $g(t.firestore,new yg(t.firestore._delegate,t._userDataWriter,e._key,e._document,e.metadata,t._delegate._converter))});return Sm(this._delegate,r,i)},Qg.prototype.get=function(e){var t=this,e=("cache"===(null==e?void 0:e.source)?function(t){t=jp(t,Cm);var n=jp(t.firestore,Ey),e=Pg(n),r=new bm(n);return xp(e,t._key).then(function(e){return new yg(n,r,t._key,e,new Yg(e instanceof Gi&&e.hasLocalMutations,!0),t._converter)})}:"server"===(null==e?void 0:e.source)?function(t){t=jp(t,Cm);var n=jp(t.firestore,Ey);return Op(Pg(n),t._key,{source:"server"}).then(function(e){return Em(n,t,e)})}:function(t){t=jp(t,Cm);var n=jp(t.firestore,Ey);return Op(Pg(n),t._key).then(function(e){return Em(n,t,e)})})(this._delegate);return e.then(function(e){return new $g(t.firestore,new yg(t.firestore._delegate,t._userDataWriter,e._key,e._document,e.metadata,t._delegate._converter))})},Qg.prototype.withConverter=function(e){return new Qg(this.firestore,this._delegate.withConverter(e))},Qg);function Qg(e,t){t=jg.call(this,t)||this;return t.firestore=e,t._userDataWriter=new iy(e),t}function Gg(e,t,n){return e.message=e.message.replace(t,n),e}function Wg(e){for(var t=0,n=e;t<n.length;t++){var r=n[t];if("object"==typeof r&&!Qp(r))return r}return{}}function Hg(e,t){var n=Qp(e[0])?e[0]:Qp(e[1])?e[1]:"function"==typeof e[0]?{next:e[0],error:e[1],complete:e[2]}:{next:e[1],error:e[2],complete:e[3]};return{next:function(e){n.next&&n.next(t(e))},error:null===(e=n.error)||void 0===e?void 0:e.bind(n),complete:null===(e=n.complete)||void 0===e?void 0:e.bind(n)}}var Yg=(Xg.prototype.isEqual=function(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache},Xg);function Xg(e,t){this.hasPendingWrites=e,this.fromCache=t}var Jg,$g=(n(Zg,Jg=Xp),Object.defineProperty(Zg.prototype,"ref",{get:function(){return new zg(this._firestore,this._delegate.ref)},enumerable:!1,configurable:!0}),Object.defineProperty(Zg.prototype,"id",{get:function(){return this._delegate.id},enumerable:!1,configurable:!0}),Object.defineProperty(Zg.prototype,"metadata",{get:function(){return this._delegate.metadata},enumerable:!1,configurable:!0}),Object.defineProperty(Zg.prototype,"exists",{get:function(){return this._delegate.exists()},enumerable:!1,configurable:!0}),Zg.prototype.data=function(e){return this._delegate.data(e)},Zg.prototype.get=function(e,t){return this._delegate.get(e,t)},Zg.prototype.isEqual=function(e){return Sg(this._delegate,e._delegate)},Zg);function Zg(e,t){t=Jg.call(this,t)||this;return t._firestore=e,t}var ev,tv=(n(nv,ev=$g),nv.prototype.data=function(e){e=this._delegate.data(e);return Qr(void 0!==e,"Document in a QueryDocumentSnapshot should exist"),e},nv);function nv(){return null!==ev&&ev.apply(this,arguments)||this}var rv,iv=(n(ov,rv=Xp),ov.prototype.where=function(e,t,n){try{return new ov(this.firestore,Am(this._delegate,(i=t,o=n,r=dg("where",r=e),new xm(r,i,o))))}catch(e){throw Gg(e,/(orderBy|where)\(\)/,"Query.$1()")}var r,i,o},ov.prototype.orderBy=function(e,t){try{return new ov(this.firestore,Am(this._delegate,(void 0===(r=t)&&(r="asc"),n=dg("orderBy",n=e),new Lm(n,r))))}catch(e){throw Gg(e,/(orderBy|where)\(\)/,"Query.$1()")}var n,r},ov.prototype.limit=function(e){try{return new ov(this.firestore,Am(this._delegate,(zp("limit",t=e),new qm("limit",t,"F"))))}catch(e){throw Gg(e,"limit()","Query.limit()")}var t},ov.prototype.limitToLast=function(e){try{return new ov(this.firestore,Am(this._delegate,(zp("limitToLast",t=e),new qm("limitToLast",t,"L"))))}catch(e){throw Gg(e,"limitToLast()","Query.limitToLast()")}var t},ov.prototype.startAt=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];try{return new ov(this.firestore,Am(this._delegate,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return new Vm("startAt",e,!0)}.apply(void 0,e)))}catch(e){throw Gg(e,"startAt()","Query.startAt()")}},ov.prototype.startAfter=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];try{return new ov(this.firestore,Am(this._delegate,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return new Vm("startAfter",e,!1)}.apply(void 0,e)))}catch(e){throw Gg(e,"startAfter()","Query.startAfter()")}},ov.prototype.endBefore=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];try{return new ov(this.firestore,Am(this._delegate,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return new jm("endBefore",e,!0)}.apply(void 0,e)))}catch(e){throw Gg(e,"endBefore()","Query.endBefore()")}},ov.prototype.endAt=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];try{return new ov(this.firestore,Am(this._delegate,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return new jm("endAt",e,!1)}.apply(void 0,e)))}catch(e){throw Gg(e,"endAt()","Query.endAt()")}},ov.prototype.isEqual=function(e){return ag(this._delegate,e._delegate)},ov.prototype.get=function(e){var t=this,e=("cache"===(null==e?void 0:e.source)?function(t){t=jp(t,_m);var n=jp(t.firestore,Ey),e=Pg(n),r=new bm(n);return Rp(e,t._query).then(function(e){return new wg(n,r,t,e)})}:"server"===(null==e?void 0:e.source)?function(t){t=jp(t,_m);var n=jp(t.firestore,Ey),e=Pg(n),r=new bm(n);return Lp(e,t._query,{source:"server"}).then(function(e){return new wg(n,r,t,e)})}:function(t){t=jp(t,_m);var n=jp(t.firestore,Ey),e=Pg(n),r=new bm(n);return Ym(t._query),Lp(e,t._query).then(function(e){return new wg(n,r,t,e)})})(this._delegate);return e.then(function(e){return new lv(t.firestore,new wg(t.firestore._delegate,t._userDataWriter,t._delegate,e._snapshot))})},ov.prototype.onSnapshot=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var r=Wg(e),i=Hg(e,function(e){return new lv(t.firestore,new wg(t.firestore._delegate,t._userDataWriter,t._delegate,e._snapshot))});return Sm(this._delegate,r,i)},ov.prototype.withConverter=function(e){return new ov(this.firestore,this._delegate.withConverter(e))},ov);function ov(e,t){t=rv.call(this,t)||this;return t.firestore=e,t._userDataWriter=new iy(e),t}var av,sv=(n(uv,av=Xp),Object.defineProperty(uv.prototype,"type",{get:function(){return this._delegate.type},enumerable:!1,configurable:!0}),Object.defineProperty(uv.prototype,"doc",{get:function(){return new tv(this._firestore,this._delegate.doc)},enumerable:!1,configurable:!0}),Object.defineProperty(uv.prototype,"oldIndex",{get:function(){return this._delegate.oldIndex},enumerable:!1,configurable:!0}),Object.defineProperty(uv.prototype,"newIndex",{get:function(){return this._delegate.newIndex},enumerable:!1,configurable:!0}),uv);function uv(e,t){t=av.call(this,t)||this;return t._firestore=e,t}var cv,lv=(n(hv,cv=Xp),Object.defineProperty(hv.prototype,"query",{get:function(){return new iv(this._firestore,this._delegate.query)},enumerable:!1,configurable:!0}),Object.defineProperty(hv.prototype,"metadata",{get:function(){return this._delegate.metadata},enumerable:!1,configurable:!0}),Object.defineProperty(hv.prototype,"size",{get:function(){return this._delegate.size},enumerable:!1,configurable:!0}),Object.defineProperty(hv.prototype,"empty",{get:function(){return this._delegate.empty},enumerable:!1,configurable:!0}),Object.defineProperty(hv.prototype,"docs",{get:function(){var t=this;return this._delegate.docs.map(function(e){return new tv(t._firestore,e)})},enumerable:!1,configurable:!0}),hv.prototype.docChanges=function(e){var t=this;return this._delegate.docChanges(e).map(function(e){return new sv(t._firestore,e)})},hv.prototype.forEach=function(t,n){var r=this;this._delegate.forEach(function(e){t.call(n,new tv(r._firestore,e))})},hv.prototype.isEqual=function(e){return Sg(this._delegate,e._delegate)},hv);function hv(e,t){t=cv.call(this,t)||this;return t._firestore=e,t}var fv,dv=(n(pv,fv=iv),Object.defineProperty(pv.prototype,"id",{get:function(){return this._delegate.id},enumerable:!1,configurable:!0}),Object.defineProperty(pv.prototype,"path",{get:function(){return this._delegate.path},enumerable:!1,configurable:!0}),Object.defineProperty(pv.prototype,"parent",{get:function(){var e=this._delegate.parent;return e?new zg(this.firestore,e):null},enumerable:!1,configurable:!0}),pv.prototype.doc=function(e){try{return new zg(this.firestore,void 0===e?tg(this._delegate):tg(this._delegate,e))}catch(e){throw Gg(e,"doc()","CollectionReference.doc()")}},pv.prototype.add=function(e){var t,n,r,i=this;return t=this._delegate,n=e,e=jp(t.firestore,Ey),r=tg(t),n=mv(t._converter,n),Im(e,om(sg(t.firestore),"addDoc",r._key,n,null!==t._converter,{}).toMutations(r._key,js.exists(!1))).then(function(){return r}).then(function(e){return new zg(i.firestore,e)})},pv.prototype.isEqual=function(e){return og(this._delegate,e._delegate)},pv.prototype.withConverter=function(e){return new pv(this.firestore,this._delegate.withConverter(e))},pv);function pv(e,t){var n=fv.call(this,e,t)||this;return n.firestore=e,n._delegate=t,n}function yv(e){return e instanceof Xp&&(e=e._delegate),jp(e,Cm)}function mv(e,t,n){t=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t;return t}var gv,St=(n(vv,gv=Xp),vv.documentId=function(){return new vv(mi.keyField().canonicalString())},vv.prototype.isEqual=function(e){return e instanceof Xp&&(e=e._delegate),e instanceof Wy&&this._delegate._internalPath.isEqual(e._internalPath)},vv);function vv(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return gv.call(this,new(Wy.bind.apply(Wy,a([void 0],e))))||this}var bv,It=(n(wv,bv=Xp),wv.serverTimestamp=function(){var e=new My("serverTimestamp");return e._methodName="FieldValue.serverTimestamp",new wv(e)},wv.delete=function(){var e=new Oy("deleteField");return e._methodName="FieldValue.delete",new wv(e)},wv.arrayUnion=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return new By("arrayUnion",e)}.apply(void 0,e);return n._methodName="FieldValue.arrayUnion",new wv(n)},wv.arrayRemove=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return new Ky("arrayRemove",e)}.apply(void 0,e);return n._methodName="FieldValue.arrayRemove",new wv(n)},wv.increment=function(e){e=new Qy("increment",e);return e._methodName="FieldValue.increment",new wv(e)},wv.prototype.isEqual=function(e){return this._delegate.isEqual(e._delegate)},wv);function wv(){return null!==bv&&bv.apply(this,arguments)||this}var Tv,Sv,Iv={Firestore:Rg,GeoPoint:Gp,Timestamp:Zr,Blob:ey,Transaction:Fg,WriteBatch:Ug,DocumentReference:zg,DocumentSnapshot:$g,Query:iv,QueryDocumentSnapshot:tv,QuerySnapshot:lv,CollectionReference:dv,FieldPath:St,FieldValue:It,setLogLevel:function(e){e=e,qr.setLogLevel(e)},CACHE_SIZE_UNLIMITED:-1};Tv=t.default,Sv=function(e,t){return new Rg(e,new Ey(e,t),new Ng)},Tv.INTERNAL.registerComponent(new Er("firestore",function(e){var t=e.getProvider("app").getImmediate();return Sv(t,e.getProvider("auth-internal"))},"PUBLIC").setServiceProps(Object.assign({},Iv))),Tv.registerVersion("@firebase/firestore","2.0.4-1.0.0-eap-firestore-debug.9c6096f43")}).apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-firestore.js - be sure to load firebase-app.js first.")}});
//# sourceMappingURL=firebase-firestore.js.map
