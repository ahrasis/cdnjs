"use strict";exports.__esModule=!0,exports.default=void 0;var _invariant=_interopRequireDefault(require("fbjs/lib/invariant"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ownKeys(t,e){var i,r=Object.keys(t);return Object.getOwnPropertySymbols&&(i=Object.getOwnPropertySymbols(t),e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,i)),r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(i),!0).forEach(function(e){_defineProperty(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):ownKeys(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var ViewabilityHelper=function(){function e(e){void 0===e&&(e={viewAreaCoveragePercentThreshold:0}),this._hasInteracted=!1,this._timers=new Set,this._viewableIndices=[],this._viewableItems=new Map,this._config=e}var t=e.prototype;return t.dispose=function(){this._timers.forEach(clearTimeout)},t.computeViewableItems=function(e,t,i,r,n){var a=this._config,s=a.itemVisiblePercentThreshold,a=a.viewAreaCoveragePercentThreshold,o=null!=a,l=o?a:s;(0,_invariant.default)(null!=l&&null!=s!=(null!=a),"Must set exactly one of itemVisiblePercentThreshold or viewAreaCoveragePercentThreshold");var c=[];if(0===e)return c;var u=-1,s=n||{first:0,last:e-1},a=s.first,f=s.last;if(e<=f)return console.warn("Invalid render range computing viewability "+JSON.stringify({renderRange:n,itemCount:e})),[];for(var h=a;h<=f;h++){var b=r(h);if(b){var d=b.offset-t,v=d+b.length;if(d<i&&0<v)u=h,_isViewable(o,l,d,v,i,b.length)&&c.push(h);else if(0<=u)break}}return c},t.onUpdate=function(e,t,i,r,n,a,s){var o,l,c=this;this._config.waitForInteraction&&!this._hasInteracted||0===e||!r(0)||(o=[],e&&(o=this.computeViewableItems(e,t,i,r,s)),this._viewableIndices.length===o.length&&this._viewableIndices.every(function(e,t){return e===o[t]})||(this._viewableIndices=o,this._config.minimumViewTime?(l=setTimeout(function(){c._timers.delete(l),c._onUpdateSync(o,a,n)},this._config.minimumViewTime),this._timers.add(l)):this._onUpdateSync(o,a,n)))},t.resetViewableIndices=function(){this._viewableIndices=[]},t.recordInteraction=function(){this._hasInteracted=!0},t._onUpdateSync=function(e,t,i){var r=this;e=e.filter(function(e){return r._viewableIndices.includes(e)});for(var n,a=this._viewableItems,s=new Map(e.map(function(e){e=i(e,!0);return[e.key,e]})),o=[],l=s,c=Array.isArray(l),u=0,l=c?l:l[Symbol.iterator]();;){if(c){if(u>=l.length)break;n=l[u++]}else{if((u=l.next()).done)break;n=u.value}var f=n[0],h=n[1];a.has(f)||o.push(h)}for(var b,d=a,v=Array.isArray(d),p=0,d=v?d:d[Symbol.iterator]();;){if(v){if(p>=d.length)break;b=d[p++]}else{if((p=d.next()).done)break;b=p.value}var _=b[0],w=b[1];s.has(_)||o.push(_objectSpread({},w,{isViewable:!1}))}0<o.length&&(this._viewableItems=s,t({viewableItems:Array.from(s.values()),changed:o,viewabilityConfig:this._config}))},e}();function _isViewable(e,t,i,r,n,a){if(_isEntirelyVisible(i,r,n))return!0;r=_getPixelsVisible(i,r,n);return t<=100*(e?r/n:r/a)}function _getPixelsVisible(e,t,i){e=Math.min(t,i)-Math.max(e,0);return Math.max(0,e)}function _isEntirelyVisible(e,t,i){return 0<=e&&t<=i&&e<t}var _default=ViewabilityHelper;exports.default=ViewabilityHelper,module.exports=exports.default;