"use strict";exports.__esModule=!0,exports.attachListeners=attachListeners,exports.addNode=addNode,exports.removeNode=removeNode,exports.terminateResponder=terminateResponder,exports.getResponderNode=getResponderNode;var _ExecutionEnvironment=require("fbjs/lib/ExecutionEnvironment"),_createResponderEvent=_interopRequireDefault(require("./createResponderEvent")),_ResponderEventTypes=require("./ResponderEventTypes"),_utils=require("./utils"),_ResponderTouchHistoryStore=_interopRequireDefault(require("./ResponderTouchHistoryStore"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var emptyObject={},startRegistration=["onStartShouldSetResponderCapture","onStartShouldSetResponder",{bubbles:!0}],moveRegistration=["onMoveShouldSetResponderCapture","onMoveShouldSetResponder",{bubbles:!0}],scrollRegistration=["onScrollShouldSetResponderCapture","onScrollShouldSetResponder",{bubbles:!1}],shouldSetResponderEvents={touchstart:startRegistration,mousedown:startRegistration,touchmove:moveRegistration,mousemove:moveRegistration,scroll:scrollRegistration},emptyResponder={id:null,idPath:null,node:null},responderListenersMap=new Map,isEmulatingMouseEvents=!1,trackedTouchCount=0,currentResponder={id:null,node:null,idPath:null};function changeCurrentResponder(e){currentResponder=e}function getResponderConfig(e){var n=responderListenersMap.get(e);return null!=n?n:emptyObject}function eventListener(e){var n,t,r,o,s,i,u,a,d,l,c,p,R,g,h,m,v,f,E,T,C,b,_,S,M,y=e.type,N=e.target;"touchstart"===y&&(isEmulatingMouseEvents=!0),("touchmove"===y||1<trackedTouchCount)&&(isEmulatingMouseEvents=!1),"mousedown"===y&&isEmulatingMouseEvents||"mousemove"===y&&isEmulatingMouseEvents||"mousemove"===y&&trackedTouchCount<1||(isEmulatingMouseEvents&&"mouseup"===y?0===trackedTouchCount&&(isEmulatingMouseEvents=!1):(n=(0,_ResponderEventTypes.isStartish)(y)&&(0,_utils.isPrimaryPointerDown)(e),t=(0,_ResponderEventTypes.isMoveish)(y),r=(0,_ResponderEventTypes.isEndish)(y),o=(0,_ResponderEventTypes.isScroll)(y),s=(0,_ResponderEventTypes.isSelectionChange)(y),i=(0,_createResponderEvent.default)(e),(n||t||r)&&(e.touches?trackedTouchCount=e.touches.length:n?trackedTouchCount=1:r&&(trackedTouchCount=0),_ResponderTouchHistoryStore.default.recordTouchTrack(y,i.nativeEvent)),R=(0,_utils.getResponderPaths)(e),u=!1,(n||t||o&&0<trackedTouchCount)&&(d=currentResponder.idPath,l=R.idPath,null!=d&&null!=l&&(R=null!=(c=(0,_utils.getLowestCommonAncestor)(d,l))?(p=l.indexOf(c)+(c===currentResponder.id?1:0),{idPath:l.slice(p),nodePath:R.nodePath.slice(p)}):null),null!=R&&null!=(a=findWantsResponder(R,e,i))&&(attemptTransfer(i,a),u=!0)),null!=currentResponder.id&&null!=currentResponder.node&&(g=currentResponder.id,h=currentResponder.node,v=(m=getResponderConfig(g)).onResponderStart,f=m.onResponderMove,E=m.onResponderEnd,T=m.onResponderRelease,C=m.onResponderTerminate,b=m.onResponderTerminationRequest,i.bubbles=!1,i.cancelable=!1,i.currentTarget=h,n?null!=v&&(i.dispatchConfig.registrationName="onResponderStart",v(i)):t?null!=f&&(i.dispatchConfig.registrationName="onResponderMove",f(i)):(_=(0,_ResponderEventTypes.isCancelish)(y)||"contextmenu"===y||"blur"===y&&N===window||"blur"===y&&N.contains(h)&&e.relatedTarget!==h||o&&0===trackedTouchCount||o&&N.contains(h)&&N!==h||s&&(0,_utils.hasValidSelection)(e),S=r&&!_&&!(0,_utils.hasTargetTouches)(h,e.touches),r&&null!=E&&(i.dispatchConfig.registrationName="onResponderEnd",E(i)),S&&(null!=T&&(i.dispatchConfig.registrationName="onResponderRelease",T(i)),changeCurrentResponder(emptyResponder)),_&&(M=!0,"contextmenu"!==y&&"scroll"!==y&&"selectionchange"!==y||(u||null!=b&&!(i.dispatchConfig.registrationName="onResponderTerminationRequest")===b(i))&&(M=!1),M&&(null!=C&&(i.dispatchConfig.registrationName="onResponderTerminate",C(i)),changeCurrentResponder(emptyResponder),isEmulatingMouseEvents=!1,trackedTouchCount=0))))))}function findWantsResponder(e,n,o){var t=shouldSetResponderEvents[n.type];if(null!=t){for(var s=e.idPath,r=e.nodePath,i=t[0],u=t[1],a=t[2].bubbles,d=function(e,n,t){var r=getResponderConfig(e)[t];if(null!=r&&(o.currentTarget=n,!0===r(o)))return{id:e,node:n,idPath:s.slice(s.indexOf(e))}},l=s.length-1;0<=l;l--){var c=d(s[l],r[l],i);if(null!=c)return c;if(!0===o.isPropagationStopped())return}if(a)for(var p=0;p<s.length;p++){var R=d(s[p],r[p],u);if(null!=R)return R;if(!0===o.isPropagationStopped())return}else{var g=s[0],h=r[0];if(n.target===h)return d(g,h,u)}}}function attemptTransfer(e,n){var t,r,o,s,i=currentResponder.id,u=currentResponder.node,a=n.id,d=n.node,l=getResponderConfig(a),c=l.onResponderGrant,p=l.onResponderReject;e.bubbles=!1,e.cancelable=!1,e.currentTarget=d,null==i?(null!=c&&(e.currentTarget=d,e.dispatchConfig.registrationName="onResponderGrant",c(e)),changeCurrentResponder(n)):(r=(t=getResponderConfig(i)).onResponderTerminate,s=!0,null!=(o=t.onResponderTerminationRequest)&&(e.currentTarget=u,!(e.dispatchConfig.registrationName="onResponderTerminationRequest")===o(e)&&(s=!1)),s?(null!=r&&(e.currentTarget=u,e.dispatchConfig.registrationName="onResponderTerminate",r(e)),null!=c&&(e.currentTarget=d,e.dispatchConfig.registrationName="onResponderGrant",c(e)),changeCurrentResponder(n)):null!=p&&(e.currentTarget=d,e.dispatchConfig.registrationName="onResponderReject",p(e)))}var documentEventsCapturePhase=["blur","scroll"],documentEventsBubblePhase=["mousedown","mousemove","mouseup","dragstart","touchstart","touchmove","touchend","touchcancel","contextmenu","select","selectionchange"];function attachListeners(){_ExecutionEnvironment.canUseDOM&&null==window.__reactResponderSystemActive&&(window.addEventListener("blur",eventListener),documentEventsBubblePhase.forEach(function(e){document.addEventListener(e,eventListener)}),documentEventsCapturePhase.forEach(function(e){document.addEventListener(e,eventListener,!0)}),window.__reactResponderSystemActive=!0)}function addNode(e,n,t){(0,_utils.setResponderId)(n,e),responderListenersMap.set(e,t)}function removeNode(e){currentResponder.id===e&&terminateResponder(),responderListenersMap.has(e)&&responderListenersMap.delete(e)}function terminateResponder(){var e,n,t=currentResponder.id,r=currentResponder.node;null!=t&&null!=r&&(null!=(e=getResponderConfig(t).onResponderTerminate)&&((n=(0,_createResponderEvent.default)({})).currentTarget=r,e(n)),changeCurrentResponder(emptyResponder)),isEmulatingMouseEvents=!1,trackedTouchCount=0}function getResponderNode(){return currentResponder.node}