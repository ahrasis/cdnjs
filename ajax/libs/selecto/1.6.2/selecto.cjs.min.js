"use strict";var Component=require("@egjs/component"),Dragger=require("@daybrush/drag"),frameworkUtils=require("framework-utils"),utils=require("@daybrush/utils"),ChildrenDiffer=require("@egjs/children-differ"),DragScroll=require("@scena/dragscroll"),KeyController=require("keycon"),styled=require("css-styled"),extendStatics=function(t,e){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function __extends(t,e){function n(){this.constructor=t}extendStatics(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var __assign=function(){return(__assign=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function __rest(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(t,r[i])&&(n[r[i]]=t[r[i]]);return n}function __decorate(t,e,n,r){var i,o=arguments.length,s=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;0<=a;a--)(i=t[a])&&(s=(o<3?i(s):3<o?i(e,n,s):i(e,n))||s);return 3<o&&s&&Object.defineProperty(e,n,s),s}function __spreadArrays(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;for(var r=Array(t),i=0,e=0;e<n;e++)for(var o=arguments[e],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r}function getClient(t){if("touches"in t){var e=t.touches[0]||t.changedTouches[0];return{clientX:e.clientX,clientY:e.clientY}}return{clientX:t.clientX,clientY:t.clientY}}function createElement(t,e,n){var r=t.tag,i=t.children,o=t.attributes,s=t.className,a=t.style,c=e||document.createElement(r);for(var l in o)c.setAttribute(l,o[l]);var u=c.children;if(i.forEach(function(t,e){createElement(t,u[e],c)}),s&&s.split(" ").forEach(function(t){utils.hasClass(c,t)||utils.addClass(c,t)}),a){var d=c.style;for(var l in a)d[l]=a[l]}return!e&&n&&n.appendChild(c),c}function h(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var i=e||{},o=i.className,s=i.style;return{tag:t,className:void 0===o?"":o,style:void 0===s?{}:s,attributes:__rest(i,["className","style"]),children:n}}function diffValue(t,e,n){t!==e&&n(t,e)}function getRect(t,e){var n,r=t.distX,i=void 0===r?0:r,o=t.distY,s=void 0===o?0:o,a=t.datas,c=a.startX,l=a.startY;0<e&&(i=(0<=i?1:-1)*(e*(n=Math.sqrt((i*i+s*s)/(1+e*e)))),s=(0<=s?1:-1)*n);var u=Math.min(0,i),d=Math.min(0,s),g=Math.abs(i),f=Math.abs(s),h=c+u,p=l+d;return{left:h,top:p,right:h+g,bottom:p+f,width:g,height:f}}var injector=styled("\n:host {\n    position: fixed;\n    display: none;\n    border: 1px solid #4af;\n    background: rgba(68, 170, 255, 0.5);\n    z-index: 100;\n}\n"),CLASS_NAME="selecto-selection "+injector.className,PROPERTIES=["selectableTargets","selectByClick","selectFromInside","continueSelect","toggleContinueSelect","keyContainer","hitRate","scrollOptions","checkInput","preventDefault","ratio"],OPTIONS=__spreadArrays(["dragContainer","cspNonce"],PROPERTIES),OPTION_TYPES={target:null,container:null,dragContainer:null,selectableTargets:Array,selectByClick:Boolean,selectFromInside:Boolean,continueSelect:Boolean,toggleContinueSelect:Array,keyContainer:null,hitRate:Number,scrollOptions:Object,checkInput:Boolean,preventDefault:Boolean,cspNonce:String,ratio:Number},EVENTS=["dragStart","drag","dragEnd","selectStart","select","selectEnd","keydown","keyup","scroll"],METHODS=["clickTarget","setSelectedTargets","triggerDragStart"],Selecto=function(e){function t(t){void 0===t&&(t={});var S=e.call(this)||this;return S.selectedTargets=[],S.differ=new ChildrenDiffer,S.dragScroll=new DragScroll,S.onDragStart=function(t,e){var n=t.datas,r=t.clientX,i=t.clientY,o=t.inputEvent,s=S.options,a=s.continueSelect,c=s.selectFromInside,l=s.selectByClick,u=S.getSelectableTargets(),d=u.map(function(t){var e=t.getBoundingClientRect(),n=e.left,r=e.top,i=e.width,o=e.height;return{left:n,top:r,right:n+i,bottom:r+o,width:i,height:o}});n.selectableTargets=u,n.selectableRects=d,n.startSelectedTargets=S.selectedTargets;var g={left:r,top:i,right:r,bottom:i,width:0,height:0},f=[];if(c||l){for(var h=e||document.elementFromPoint(r,i);h&&!(-1<u.indexOf(h));)h=h.parentElement;f=h?[h]:[]}var p=0<f.length,y=!c&&p;if(y&&!l)return!1;var v=o.type;if(!(!("mousedown"===v||"touchstart"===v)||S.trigger("dragStart",t)))return!1;if(a?f=S.passSelectedTargets(f):S.selectedTargets=[],S.select(f,g,o,!0),n.startX=r,n.startY=i,n.selectedTargets=f,S.target.style.cssText+="left:0px;top:0px;transform: translate("+r+"px, "+i+"px)",y&&l)return S.onDragEnd(t),o.preventDefault(),!1;"touchstart"===v&&o.preventDefault();var m=S.options.scrollOptions;return m&&m.container&&S.dragScroll.dragStart(t,m),!0},S.onDrag=function(t){var e=S.options.scrollOptions;e&&e.container&&S.dragScroll.drag(t,e)||S.check(t)},S.onDragEnd=function(t){var e=t.datas,n=getRect(t,S.options.ratio);S.dragScroll.dragEnd(),S.target.style.cssText+="display: none;",S.trigger("dragEnd",__assign(__assign({},t),{rect:n})),S.selectEnd(e.startSelectedTargets,e.selectedTargets,n,t),S.selectedTargets=e.selectedTargets},S.onKeyDown=function(t){S.sameCombiKey(t)&&(S.continueSelect=!0,S.trigger("keydown",{}))},S.onKeyUp=function(t){S.sameCombiKey(t,!0)&&(S.continueSelect=!1,S.trigger("keyup",{}))},S.onBlur=function(){S.toggleContinueSelect&&S.continueSelect&&S.trigger("keyup",{})},S.onDocumentSelectStart=function(e){var t,n,r;S.dragger.isFlag()&&((t=S.dragContainer)===window&&(t=document.documentElement),n=t instanceof Element?[t]:[].slice.call(t),r=e.target,n.some(function(t){if(t===r||t.contains(r))return e.preventDefault(),!0}))},S.target=t.target,S.container=t.container,S.options=__assign({target:null,container:null,dragContainer:null,selectableTargets:[],selectByClick:!0,selectFromInside:!0,hitRate:100,continueSelect:!1,toggleContinueSelect:null,keyContainer:null,scrollOptions:void 0,checkInput:!1,preventDefault:!1,cspNonce:"",ratio:0},t),S.initElement(),S.initDragScroll(),S.setKeyController(),S}__extends(t,e);var n=t.prototype;return n.setSelectedTargets=function(t){return this.selectedTargets=t,this.differ=new ChildrenDiffer(t),this},n.getSelectedTargets=function(){return this.selectedTargets},n.setKeyContainer=function(t){var e=this,n=this.options;diffValue(n.keyContainer,t,function(){n.keyContainer=t,e.setKeyController()})},n.setToggleContinueSelect=function(t){var e=this,n=this.options;diffValue(n.toggleContinueSelect,t,function(){n.toggleContinueSelect=t,e.setKeyEvent()})},n.setPreventDefault=function(t){this.dragger.options.preventDefault=t},n.setCheckInput=function(t){this.dragger.options.checkInput=t},n.triggerDragStart=function(t){return this.dragger.triggerDragStart(t),this},n.destroy=function(){this.off(),this.keycon&&this.keycon.destroy(),this.dragger.unset(),this.injectResult.destroy(),utils.removeEvent(document,"selectstart",this.onDocumentSelectStart),this.keycon=null,this.dragger=null,this.injectResult=null,this.target=null,this.container=null,this.options=null},n.clickTarget=function(t,e){var n=getClient(t),r={datas:{},clientX:n.clientX,clientY:n.clientY,inputEvent:t};return this.onDragStart(r,e)&&this.onDragEnd(r),this},n.setKeyController=function(){var t=this.options,e=t.keyContainer,n=t.toggleContinueSelect;this.keycon&&(this.keycon.destroy(),this.keycon=null),n&&(this.keycon=new KeyController(e||window),this.keycon.keydown(this.onKeyDown).keyup(this.onKeyUp).on("blur",this.onBlur))},n.setKeyEvent=function(){this.options.toggleContinueSelect&&!this.keycon&&this.setKeyController()},n.initElement=function(){this.target=createElement(h("div",{className:CLASS_NAME}),this.target,this.container);var t=this.target,e=this.options,n=e.dragContainer,r=e.checkInput,i=e.preventDefault;this.dragContainer="string"==typeof n?[].slice.call(document.querySelectorAll(n)):this.options.dragContainer||this.target.parentNode,this.dragger=new Dragger(this.dragContainer,{container:window,checkInput:r,preventDefault:i,dragstart:this.onDragStart,drag:this.onDrag,dragend:this.onDragEnd}),utils.addEvent(document,"selectstart",this.onDocumentSelectStart),this.injectResult=injector.inject(t,{nonce:this.options.cspNonce})},n.hitTest=function(t,h,p,e,y){var n=this.options,v=n.hitRate,m=n.selectByClick,S=t.left,E=t.top,C=t.right,T=t.bottom;return e.filter(function(t,e){var n=y[e],r=n.left,i=n.top,o=n.right,s=n.bottom,a=r<=h&&h<=o&&i<=p&&p<=s,c=(o-r)*(s-i),l=Math.max(r,S),u=Math.min(o,C),d=Math.max(i,E),g=Math.min(s,T);if(m&&a)return!0;if(u<l||g<d)return!1;var f=Math.round((u-l)*(g-d)/c*100);return v<=f})},n.initDragScroll=function(){var o=this;this.dragScroll.on("scroll",function(t){var e=t.container,n=t.direction;o.trigger("scroll",{container:e,direction:n})}).on("move",function(t){var e=t.offsetX,n=t.offsetY,r=t.inputEvent,i=r.datas;i.startX-=e,i.startY-=n,i.selectableRects.forEach(function(t){t.top-=n,t.bottom-=n,t.left-=e,t.right-=e}),o.dragger.scrollBy(e,n,r.inputEvent,!1),r.distX+=e,r.distY+=n,o.check(r)})},n.getSelectableTargets=function(){var e=[];return this.options.selectableTargets.forEach(function(t){utils.isObject(t)?e.push(t):[].slice.call(document.querySelectorAll(t)).forEach(function(t){e.push(t)})}),e},n.passSelectedTargets=function(t){var e=ChildrenDiffer.diff(this.selectedTargets,t),n=e.list,r=e.prevList,i=e.added,o=e.removed;return i.map(function(t){return n[t]}).concat(o.map(function(t){return r[t]}))},n.select=function(t,e,n,r){var i=this.differ.update(t),o=i.added,s=i.removed,a=i.prevList,c=i.list;r&&this.trigger("selectStart",{selected:t,added:o.map(function(t){return c[t]}),removed:s.map(function(t){return a[t]}),rect:e,inputEvent:n}),(o.length||s.length)&&this.trigger("select",{selected:t,added:o.map(function(t){return c[t]}),removed:s.map(function(t){return a[t]}),rect:e,inputEvent:n})},n.selectEnd=function(t,e,n,r){var i=r.inputEvent,o=r.isDouble,s=ChildrenDiffer.diff(t,e),a=s.added,c=s.removed,l=s.prevList,u=s.list,d=ChildrenDiffer.diff(this.selectedTargets,e),g=d.added,f=d.removed,h=d.prevList,p=d.list,y=i.type,v="mousedown"===y||"touchstart"===y;this.trigger("selectEnd",{selected:e,added:a.map(function(t){return u[t]}),removed:c.map(function(t){return l[t]}),afterAdded:g.map(function(t){return p[t]}),afterRemoved:f.map(function(t){return h[t]}),isDragStart:v,isDouble:!!o,rect:n,inputEvent:i})},n.check=function(t){var e=t.datas,n=t.inputEvent,r=getRect(t,this.options.ratio),i=r.top,o=r.left,s=r.width,a=r.height;this.target.style.cssText+="display: block;left:0px;top:0px;transform: translate("+o+"px, "+i+"px);width:"+s+"px;height:"+a+"px;";var c=this.hitTest(r,e.startX,e.startY,e.selectableTargets,e.selectableRects),l=this.passSelectedTargets(c);this.trigger("drag",__assign(__assign({},t),{rect:r})),this.select(l,r,n),e.selectedTargets=l},n.sameCombiKey=function(t,e){var n=[].concat(this.options.toggleContinueSelect),r=KeyController.getCombi(t.inputEvent,t.key),i=utils.isArray(n[0])?n:[n];if(e){var o=t.key;return i.some(function(t){return t.some(function(t){return t===o})})}return i.some(function(t){return t.every(function(t){return-1<r.indexOf(t)})})},t=__decorate([frameworkUtils.Properties(PROPERTIES,function(t,e){var n={enumerable:!0,configurable:!0,get:function(){return this.options[e]}},r=utils.camelize("set "+e);t[r]?n.set=function(t){this[r](t)}:n.set=function(t){this.options[e]=t},Object.defineProperty(t,e,n)})],t)}(Component),modules={__proto__:null,default:Selecto,OPTIONS:OPTIONS,OPTION_TYPES:OPTION_TYPES,PROPERTIES:PROPERTIES,EVENTS:EVENTS,METHODS:METHODS,CLASS_NAME:CLASS_NAME};for(var name in modules)Selecto[name]=modules[name];module.exports=Selecto;