"use strict";var EventEmitter=require("@scena/event-emitter"),Gesto=require("gesto"),frameworkUtils=require("framework-utils"),utils=require("@daybrush/utils"),childrenDiffer=require("@egjs/children-differ"),DragScroll=require("@scena/dragscroll"),KeyController=require("keycon"),overlapArea=require("overlap-area"),styled=require("css-styled"),extendStatics=function(t,e){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function __extends(t,e){function n(){this.constructor=t}extendStatics(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var __assign=function(){return(__assign=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function __rest(t,e){var n={};for(i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(n[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,i=Object.getOwnPropertySymbols(t);r<i.length;r++)e.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(t,i[r])&&(n[i[r]]=t[i[r]]);return n}function __decorate(t,e,n,r){var i,o=arguments.length,s=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;0<=a;a--)(i=t[a])&&(s=(o<3?i(s):3<o?i(e,n,s):i(e,n))||s);return 3<o&&s&&Object.defineProperty(e,n,s),s}function __spreadArrays(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;for(var r=Array(t),i=0,e=0;e<n;e++)for(var o=arguments[e],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r}function getClient(t){if("touches"in t){var e=t.touches[0]||t.changedTouches[0];return{clientX:e.clientX,clientY:e.clientY}}return{clientX:t.clientX,clientY:t.clientY}}function createElement(t,e,n){var r=t.tag,i=t.children,o=t.attributes,s=t.className,a=t.style,l=e||document.createElement(r);for(u in o)l.setAttribute(u,o[u]);var c=l.children;if(i.forEach(function(t,e){createElement(t,c[e],l)}),s&&s.split(" ").forEach(function(t){utils.hasClass(l,t)||utils.addClass(l,t)}),a){var u,g=l.style;for(u in a)g[u]=a[u]}return!e&&n&&n.appendChild(l),l}function h(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var i=e||{},o=i.className,e=i.style;return{tag:t,className:void 0===o?"":o,style:void 0===e?{}:e,attributes:__rest(i,["className","style"]),children:n}}function diffValue(t,e,n){t!==e&&n(t,e)}function getRect(t,e,n){void 0===n&&(n=t.datas.boundArea);var r=t.distX,i=void 0===r?0:r,o=t.distY,s=void 0===o?0:o,a=t.datas,r=a.startX,o=a.startY;0<e&&(i=(0<=i?1:-1)*(e*(l=Math.sqrt((i*i+s*s)/(1+e*e)))),s=(0<=s?1:-1)*l);var t=Math.abs(i),a=Math.abs(s),l=i<0?r-n.left:n.right-r,n=s<0?o-n.top:n.bottom-o;i=(0<=i?1:-1)*(t=(e=utils.calculateBoundSize([t,a],[0,0],[l,n],!!e))[0]),s=(0<=s?1:-1)*(a=e[1]);i=r+Math.min(0,i),s=o+Math.min(0,s);return{left:i,top:s,right:i+t,bottom:s+a,width:t,height:a}}function getDefaultElementRect(t){var e=t.getBoundingClientRect(),n=e.left,r=e.top,t=e.width,e=e.height;return{pos1:[n,r],pos2:[n+t,r],pos3:[n,r+e],pos4:[n+t,r+e]}}function passTargets(t,e){var t=childrenDiffer.diff(t,e),n=t.list,r=t.prevList,e=t.added,t=t.removed;return e.map(function(t){return n[t]}).concat(t.map(function(t){return r[t]}))}var name,injector=styled("\n:host {\n    position: fixed;\n    display: none;\n    border: 1px solid #4af;\n    background: rgba(68, 170, 255, 0.5);\n    z-index: 100;\n}\n"),CLASS_NAME="selecto-selection "+injector.className,PROPERTIES=["boundContainer","selectableTargets","selectByClick","selectFromInside","continueSelect","toggleContinueSelect","keyContainer","hitRate","scrollOptions","checkInput","preventDefault","ratio","getElementRect"],OPTIONS=__spreadArrays(["dragContainer","cspNonce"],PROPERTIES),OPTION_TYPES={boundContainer:null,target:null,container:null,dragContainer:null,selectableTargets:Array,selectByClick:Boolean,selectFromInside:Boolean,continueSelect:Boolean,toggleContinueSelect:Array,keyContainer:null,hitRate:Number,scrollOptions:Object,checkInput:Boolean,preventDefault:Boolean,cspNonce:String,ratio:Number,getElementRect:Function},EVENTS=["dragStart","drag","dragEnd","selectStart","select","selectEnd","keydown","keyup","scroll"],METHODS=["clickTarget","setSelectedTargets","getElementPoints","getSelectedTargets","findSelectableTargets","triggerDragStart"],Selecto=function(e){function t(t){void 0===t&&(t={});var f=e.call(this)||this;return f.selectedTargets=[],f.dragScroll=new DragScroll,f.onDragStart=function(t,e){var n=t.datas,r=t.clientX,i=t.clientY,o=t.inputEvent,s=f.options,a=s.continueSelect,l=s.selectFromInside,c=s.selectByClick,u=s.boundContainer;f.findSelectableTargets(n),n.startSelectedTargets=f.selectedTargets;s={left:-1/0,top:-1/0,right:1/0,bottom:1/0};u&&(s={left:(g=(utils.isString(u)?document.querySelector(u):!0===u?f.container:u).getBoundingClientRect()).left,top:g.top,right:g.right,bottom:g.bottom}),n.boundArea=s;var u={left:r,top:i,right:r,bottom:i,width:0,height:0},g=[];if(!l||c){for(var d=e||document.elementFromPoint(r,i);d&&!(-1<n.selectableTargets.indexOf(d));)d=d.parentElement;g=d?[d]:[]}s=0<g.length,e=!l&&s;if(e&&!c)return t.stop(),!1;l=o.type,s="mousedown"===l||"touchstart"===l;return!t.isClick&&s&&!f.trigger("dragStart",__assign({},t))?(t.stop(),!1):(a?(g=passTargets(f.selectedTargets,g),n.startPassedTargets=f.selectedTargets):n.startPassedTargets=[],f.select(f.selectedTargets,g,u,o,!0),n.startX=r,n.startY=i,n.selectFlag=!1,n.boundsArea=f.target.style.cssText+="left:0px;top:0px;transform: translate("+r+"px, "+i+"px)",e&&c?o.preventDefault():(n.selectFlag=!0,"touchstart"===l&&o.preventDefault(),(o=f.options.scrollOptions)&&o.container&&f.dragScroll.dragStart(t,o)),!0)},f.onDrag=function(t){if(t.datas.selectFlag){var e=f.options.scrollOptions;if(e&&e.container&&f.dragScroll.drag(t,e))return}f.check(t)},f.onDragEnd=function(t){var e=t.datas,n=t.inputEvent,r=getRect(t,f.options.ratio),i=e.selectFlag;n&&!t.isClick&&f.trigger("dragEnd",__assign(__assign({isDouble:!1,isDrag:!1,isSelect:i},t),{rect:r})),i&&(e.selectFlag=!1,f.dragScroll.dragEnd(),f.target.style.cssText+="display: none;"),f.selectEnd(e.startSelectedTargets,e.startPassedTargets,r,t)},f.onKeyDown=function(t){f.sameCombiKey(t)&&(f.continueSelect=!0,f.trigger("keydown",{}))},f.onKeyUp=function(t){f.sameCombiKey(t,!0)&&(f.continueSelect=!1,f.trigger("keyup",{}))},f.onBlur=function(){f.toggleContinueSelect&&f.continueSelect&&(f.continueSelect=!1,f.trigger("keyup",{}))},f.onDocumentSelectStart=function(e){var t,n;f.gesto.isFlag()&&((t=f.dragContainer)===window&&(t=document.documentElement),t=t instanceof Element?[t]:[].slice.call(t),n=e.target,t.some(function(t){if(t===n||t.contains(n))return e.preventDefault(),!0}))},f.target=t.target,f.container=t.container||document.body,f.options=__assign({target:null,container:null,dragContainer:null,selectableTargets:[],selectByClick:!0,selectFromInside:!0,hitRate:100,continueSelect:!1,toggleContinueSelect:null,keyContainer:null,scrollOptions:void 0,checkInput:!1,preventDefault:!1,boundContainer:!1,getElementRect:getDefaultElementRect,cspNonce:"",ratio:0},t),f.initElement(),f.initDragScroll(),f.setKeyController(),f}__extends(t,e);var n=t.prototype;return n.setSelectedTargets=function(t){return this.selectedTargets=t,this},n.getSelectedTargets=function(){return this.selectedTargets},n.setKeyContainer=function(t){var e=this,n=this.options;diffValue(n.keyContainer,t,function(){n.keyContainer=t,e.setKeyController()})},n.setToggleContinueSelect=function(t){var e=this,n=this.options;diffValue(n.toggleContinueSelect,t,function(){n.toggleContinueSelect=t,e.setKeyEvent()})},n.setPreventDefault=function(t){this.gesto.options.preventDefault=t},n.setCheckInput=function(t){this.gesto.options.checkInput=t},n.triggerDragStart=function(t){return this.gesto.triggerDragStart(t),this},n.destroy=function(){this.off(),this.keycon&&this.keycon.destroy(),this.gesto.unset(),this.injectResult.destroy(),utils.removeEvent(document,"selectstart",this.onDocumentSelectStart),this.keycon=null,this.gesto=null,this.injectResult=null,this.target=null,this.container=null,this.options=null},n.getElementPoints=function(t){var e=this.getElementRect,n=e(t),n=[n.pos1,n.pos2,n.pos4,n.pos3];if(e===getDefaultElementRect)return n;t=t.getBoundingClientRect();return overlapArea.fitPoints(n,t)},n.findSelectableTargets=function(t){var e=this;void 0===t&&(t=this.gesto.getEventDatas());var n=this.getSelectableTargets(),r=n.map(function(t){return e.getElementPoints(t)});t.selectableTargets=n,t.selectablePoints=r},n.clickTarget=function(t,e){var n=getClient(t),t={datas:{selectFlag:!1},clientX:n.clientX,clientY:n.clientY,inputEvent:t,isClick:!0,stop:function(){return!1}};return this.onDragStart(t,e)&&this.onDragEnd(t),this},n.setKeyController=function(){var t=this.options,e=t.keyContainer,t=t.toggleContinueSelect;this.keycon&&(this.keycon.destroy(),this.keycon=null),t&&(this.keycon=new KeyController(e||window),this.keycon.keydown(this.onKeyDown).keyup(this.onKeyUp).on("blur",this.onBlur))},n.setKeyEvent=function(){this.options.toggleContinueSelect&&!this.keycon&&this.setKeyController()},n.initElement=function(){this.target=createElement(h("div",{className:CLASS_NAME}),this.target,this.container);var t=this.target,e=this.options,n=e.dragContainer,r=e.checkInput,e=e.preventDefault;this.dragContainer="string"==typeof n?[].slice.call(document.querySelectorAll(n)):this.options.dragContainer||this.target.parentNode,this.gesto=new Gesto(this.dragContainer,{checkWindowBlur:!0,container:window,checkInput:r,preventDefault:e}).on({dragStart:this.onDragStart,drag:this.onDrag,dragEnd:this.onDragEnd}),utils.addEvent(document,"selectstart",this.onDocumentSelectStart),this.injectResult=injector.inject(t,{nonce:this.options.cspNonce})},n.hitTest=function(t,r,i,e,o){var n=this.options,s=n.hitRate,a=n.selectByClick,l=t.left,c=t.top,n=t.right,t=t.bottom,u=[[l,c],[n,c],[n,t],[l,t]];return e.filter(function(t,e){var n=o[e],e=overlapArea.isInside([r,i],n);if(a&&e)return!0;e=overlapArea.getOverlapPoints(u,n);if(!e.length)return!1;e=overlapArea.getAreaSize(e),n=overlapArea.getAreaSize(n);return utils.between(Math.round(e/n*100),0,100)>=Math.min(100,s)})},n.initDragScroll=function(){var i=this;this.dragScroll.on("scroll",function(t){var e=t.container,t=t.direction;i.trigger("scroll",{container:e,direction:t})}).on("move",function(t){var e=t.offsetX,n=t.offsetY,r=t.inputEvent,t=r.datas;t.startX-=e,t.startY-=n,t.selectablePoints.forEach(function(t){t.forEach(function(t){t[0]-=e,t[1]-=n})}),i.gesto.scrollBy(e,n,r.inputEvent,!1),r.distX+=e,r.distY+=n,i.check(r)})},n.getSelectableTargets=function(){var e=[];return this.options.selectableTargets.forEach(function(t){utils.isObject(t)?e.push(t):[].slice.call(document.querySelectorAll(t)).forEach(function(t){e.push(t)})}),e},n.select=function(t,e,n,r,i){var o=childrenDiffer.diff(t,e),s=o.added,t=o.removed,a=o.prevList,l=o.list;this.selectedTargets=e,i&&this.trigger("selectStart",{selected:e,added:s.map(function(t){return l[t]}),removed:t.map(function(t){return a[t]}),rect:n,inputEvent:r}),(s.length||t.length)&&this.trigger("select",{selected:e,added:s.map(function(t){return l[t]}),removed:t.map(function(t){return a[t]}),rect:n,inputEvent:r})},n.selectEnd=function(t,e,n,r){var i=r.inputEvent,o=r.isDouble,s=childrenDiffer.diff(t,this.selectedTargets),a=s.added,r=s.removed,l=s.prevList,c=s.list,t=childrenDiffer.diff(e,this.selectedTargets),s=t.added,e=t.removed,u=t.prevList,g=t.list,t=i&&i.type,t="mousedown"===t||"touchstart"===t;this.trigger("selectEnd",{selected:this.selectedTargets,added:a.map(function(t){return c[t]}),removed:r.map(function(t){return l[t]}),afterAdded:s.map(function(t){return g[t]}),afterRemoved:e.map(function(t){return u[t]}),isDragStart:t,isDouble:!!o,rect:n,inputEvent:i})},n.check=function(t,e){void 0===e&&(e=getRect(t,this.options.ratio));var n=t.datas,r=t.inputEvent,i=e.top,o=e.left,s=e.width,a=e.height,l=n.selectFlag,c=[],u=[];l&&(this.target.style.cssText+="display: block;left:0px;top:0px;transform: translate("+o+"px, "+i+"px);width:"+s+"px;height:"+a+"px;",a=this.hitTest(e,n.startX,n.startY,n.selectableTargets,n.selectablePoints),c=this.selectedTargets,u=passTargets(n.startPassedTargets,a),this.selectedTargets=u),this.trigger("drag",__assign(__assign({},t),{isSelect:l,rect:e})),l&&this.select(c,u,e,r)},n.sameCombiKey=function(t,e){var n=[].concat(this.options.toggleContinueSelect),r=KeyController.getCombi(t.inputEvent,t.key),n=utils.isArray(n[0])?n:[n];if(e){var i=t.key;return n.some(function(t){return t.some(function(t){return t===i})})}return n.some(function(t){return t.every(function(t){return-1<r.indexOf(t)})})},__decorate([frameworkUtils.Properties(PROPERTIES,function(t,e){var n={enumerable:!0,configurable:!0,get:function(){return this.options[e]}},r=utils.camelize("set "+e);t[r]?n.set=function(t){this[r](t)}:n.set=function(t){this.options[e]=t},Object.defineProperty(t,e,n)})],t)}(EventEmitter),Selecto$1=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Selecto),modules={__proto__:null,default:Selecto$1,OPTIONS:OPTIONS,OPTION_TYPES:OPTION_TYPES,PROPERTIES:PROPERTIES,EVENTS:EVENTS,METHODS:METHODS,CLASS_NAME:CLASS_NAME};for(name in modules)Selecto$1[name]=modules[name];module.exports=Selecto$1;